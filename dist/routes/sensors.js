'use strict';

var express = require('express');
var router = express.Router();
var smartphoneSensors = require('../client/js/sensors/smartphoneSensors');
var Myo = require('myo');
var osc = require('osc');
var lfo = require('waves-lfo/node');
var SG = require('ml-savitzky-golay');
var config = require('../config/default');

/*Adress for sending data to MAX*/
var udpPortMax = new osc.UDPPort({
  localAddress: config.osc.sendAddress,
  localPort: 8082,
  // localPort: config.osc.sendPort,
  metadata: true
});

//Socket for receiving data from client
var socketReceive = new lfo.source.SocketReceive({
  port: config.socketClientToServer.port
  //config.socketServerToClient.port
});

var logger = new lfo.sink.Logger({
  time: false,
  data: true
});

var bridge = new lfo.sink.Bridge({
  processFrame: function processFrame(frame) {
    return sendMessageOSC(frame.data);
  }
});

//socketReceive.connect(logger);
var eventInJerkiness = new lfo.source.EventIn({
  frameType: 'vector',
  frameSize: 1,
  frameRate: 0.01,
  description: ['Jerkiness']
});

eventInJerkiness.init().then(function () {
  eventInJerkiness.start();
  socketReceive.connect(eventInJerkiness);
  //eventInJerkiness.connect(logger);
  eventInJerkiness.connect(bridge);
  //eventInJerkiness.connect(logger);
});

// Open the sockets.
udpPortMax.open();

/* GET users listing. */
router.get('/', function (req, res, next) {
  /*MYO Connection*/
  Myo.connect('com.stolksdorf.myAwesomeApp', require('ws'));
  //Myo.setLockingPolicy("Manual");


  /*MYO starting event handler*/

  //Starting myo
  var myMyo = void 0;
  var time = 0;
  var dt = 0.01;

  Myo.onError = function () {
    console.log("Couldn't connect to Myo Connect");
  };

  Myo.on('connected', function () {
    myMyo = this;
    addEvents(myMyo);
  });

  var addEvents = function addEvents(myMyo) {
    Myo.on('imu', function (data) {
      time += dt;
      var arr = new Float32Array([data.accelerometer.x, data.accelerometer.y, data.accelerometer.z]);
      var frameAccelero = {
        time: time,
        data: arr,
        metadata: null
      };
    });
  };
  res.render('sensors', { title: 'Devices supported: ' });
});

/*Sending fonction*/
//TODO completer la fonction pour envoyer les donn√©es a MAX
function sendMessageOSC(dataSensor) {
  //console.log("dataSensor : " + dataSensor);
  if (dataSensor[0] === 1000 || dataSensor[0] === 2000) {
    console.log("on ou off : " + dataSensor[0]);
    var onOff = 1;
    if (dataSensor[0] === 2000) {
      onOff = 1;
    } else {
      onOff = 0;
    }
    udpPortMax.send({
      address: "/OnOff",
      args: [{
        type: "i",
        value: onOff
      }]
    }, "127.0.0.1", 8081);
  } else if (isNaN(dataSensor[0])) {
    return 'Not a number';
  } else {
    udpPortMax.send({
      address: "/jerkiness",
      args: [{
        type: "f",
        value: dataSensor[0]
      }]
    }, "127.0.0.1", 8081);
    //"127.0.0.1", config.osc.receivePort);
  }
}

module.exports = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlbnNvcnMuanMiXSwibmFtZXMiOlsiZXhwcmVzcyIsInJlcXVpcmUiLCJyb3V0ZXIiLCJSb3V0ZXIiLCJzbWFydHBob25lU2Vuc29ycyIsIk15byIsIm9zYyIsImxmbyIsIlNHIiwiY29uZmlnIiwidWRwUG9ydE1heCIsIlVEUFBvcnQiLCJsb2NhbEFkZHJlc3MiLCJzZW5kQWRkcmVzcyIsImxvY2FsUG9ydCIsIm1ldGFkYXRhIiwic29ja2V0UmVjZWl2ZSIsInNvdXJjZSIsIlNvY2tldFJlY2VpdmUiLCJwb3J0Iiwic29ja2V0Q2xpZW50VG9TZXJ2ZXIiLCJsb2dnZXIiLCJzaW5rIiwiTG9nZ2VyIiwidGltZSIsImRhdGEiLCJicmlkZ2UiLCJCcmlkZ2UiLCJwcm9jZXNzRnJhbWUiLCJmcmFtZSIsInNlbmRNZXNzYWdlT1NDIiwiZXZlbnRJbkplcmtpbmVzcyIsIkV2ZW50SW4iLCJmcmFtZVR5cGUiLCJmcmFtZVNpemUiLCJmcmFtZVJhdGUiLCJkZXNjcmlwdGlvbiIsImluaXQiLCJ0aGVuIiwic3RhcnQiLCJjb25uZWN0Iiwib3BlbiIsImdldCIsInJlcSIsInJlcyIsIm5leHQiLCJteU15byIsImR0Iiwib25FcnJvciIsImNvbnNvbGUiLCJsb2ciLCJvbiIsImFkZEV2ZW50cyIsImFyciIsIkZsb2F0MzJBcnJheSIsImFjY2VsZXJvbWV0ZXIiLCJ4IiwieSIsInoiLCJmcmFtZUFjY2VsZXJvIiwicmVuZGVyIiwidGl0bGUiLCJkYXRhU2Vuc29yIiwib25PZmYiLCJzZW5kIiwiYWRkcmVzcyIsImFyZ3MiLCJ0eXBlIiwidmFsdWUiLCJpc05hTiIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBSUEsVUFBVUMsUUFBUSxTQUFSLENBQWQ7QUFDQSxJQUFJQyxTQUFTRixRQUFRRyxNQUFSLEVBQWI7QUFDQSxJQUFJQyxvQkFBb0JILFFBQVEsd0NBQVIsQ0FBeEI7QUFDQSxJQUFJSSxNQUFNSixRQUFRLEtBQVIsQ0FBVjtBQUNB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LE1BQUlBLFdBQVcsQ0FBWCxNQUFrQixJQUFsQixJQUEyQkEsV0FBVyxDQUFYLE1BQWtCLElBQWpELEVBQXNEO0FBQ3BEYixZQUFRQyxHQUFSLENBQVksaUJBQWtCWSxXQUFXLENBQVgsQ0FBOUI7QUFDQSxRQUFJQyxRQUFRLENBQVo7QUFDQSxRQUFHRCxXQUFXLENBQVgsTUFBa0IsSUFBckIsRUFBMkI7QUFDekJDLGNBQVEsQ0FBUjtBQUNELEtBRkQsTUFHSztBQUNIQSxjQUFRLENBQVI7QUFDRDtBQUNEckQsZUFBV3NELElBQVgsQ0FBZ0I7QUFDZEMsZUFBUyxRQURLO0FBRWRDLFlBQU0sQ0FDSjtBQUNFQyxjQUFNLEdBRFI7QUFFRUMsZUFBT0w7QUFGVCxPQURJO0FBRlEsS0FBaEIsRUFRRyxXQVJILEVBUWdCLElBUmhCO0FBU0QsR0FsQkQsTUFrQk8sSUFBR00sTUFBTVAsV0FBVyxDQUFYLENBQU4sQ0FBSCxFQUF5QjtBQUM5QixXQUFPLGNBQVA7QUFDRCxHQUZNLE1BRUE7QUFDTHBELGVBQVdzRCxJQUFYLENBQWdCO0FBQ2RDLGVBQVMsWUFESztBQUVkQyxZQUFNLENBQ0o7QUFDRUMsY0FBTSxHQURSO0FBRUVDLGVBQU9OLFdBQVcsQ0FBWDtBQUZULE9BREk7QUFGUSxLQUFoQixFQVFHLFdBUkgsRUFRZ0IsSUFSaEI7QUFTQTtBQUNEO0FBRUY7O0FBSURRLE9BQU9DLE9BQVAsR0FBaUJyRSxNQUFqQiIsImZpbGUiOiJzZW5zb3JzLmpzIiwic291cmNlc0NvbnRlbnQiOlsibGV0IGV4cHJlc3MgPSByZXF1aXJlKCdleHByZXNzJyk7XG5sZXQgcm91dGVyID0gZXhwcmVzcy5Sb3V0ZXIoKTtcbmxldCBzbWFydHBob25lU2Vuc29ycyA9IHJlcXVpcmUoJy4uL2NsaWVudC9qcy9zZW5zb3JzL3NtYXJ0cGhvbmVTZW5zb3JzJyk7XG5sZXQgTXlvID0gcmVxdWlyZSgnbXlvJyk7XG5sZXQgb3NjID0gcmVxdWlyZSgnb3NjJyk7XG5sZXQgbGZvID0gcmVxdWlyZSgnd2F2ZXMtbGZvL25vZGUnKTtcbmxldCBTRyA9IHJlcXVpcmUoJ21sLXNhdml0emt5LWdvbGF5Jyk7XG52YXIgY29uZmlnID0gcmVxdWlyZSgnLi4vY29uZmlnL2RlZmF1bHQnKTtcblxuXG4vKkFkcmVzcyBmb3Igc2VuZGluZyBkYXRhIHRvIE1BWCovXG52YXIgdWRwUG9ydE1heCA9IG5ldyBvc2MuVURQUG9ydCh7XG4gIGxvY2FsQWRkcmVzczogY29uZmlnLm9zYy5zZW5kQWRkcmVzcyxcbiAgbG9jYWxQb3J0OiA4MDgyLFxuIC8vIGxvY2FsUG9ydDogY29uZmlnLm9zYy5zZW5kUG9ydCxcbiAgbWV0YWRhdGE6IHRydWVcbn0pO1xuXG4vL1NvY2tldCBmb3IgcmVjZWl2aW5nIGRhdGEgZnJvbSBjbGllbnRcbmNvbnN0IHNvY2tldFJlY2VpdmUgPSBuZXcgbGZvLnNvdXJjZS5Tb2NrZXRSZWNlaXZlKHtcbiAgcG9ydDogY29uZmlnLnNvY2tldENsaWVudFRvU2VydmVyLnBvcnQsXG4gIC8vY29uZmlnLnNvY2tldFNlcnZlclRvQ2xpZW50LnBvcnRcbn0pO1xuXG5cblxuXG5jb25zdCBsb2dnZXIgPSBuZXcgbGZvLnNpbmsuTG9nZ2VyKHtcbiAgdGltZTogZmFsc2UsXG4gIGRhdGE6IHRydWUsXG59KTtcblxuY29uc3QgYnJpZGdlID0gbmV3IGxmby5zaW5rLkJyaWRnZSh7XG4gIHByb2Nlc3NGcmFtZTogKGZyYW1lKSA9PiBzZW5kTWVzc2FnZU9TQyhmcmFtZS5kYXRhKSxcbn0pO1xuXG4vL3NvY2tldFJlY2VpdmUuY29ubmVjdChsb2dnZXIpO1xuY29uc3QgZXZlbnRJbkplcmtpbmVzcyA9IG5ldyBsZm8uc291cmNlLkV2ZW50SW4oe1xuICBmcmFtZVR5cGU6ICd2ZWN0b3InLFxuICBmcmFtZVNpemU6IDEsXG4gIGZyYW1lUmF0ZTogMC4wMSxcbiAgZGVzY3JpcHRpb246IFsnSmVya2luZXNzJ10sXG59KTtcblxuXG5ldmVudEluSmVya2luZXNzLmluaXQoKS50aGVuKCgpID0+IHtcbiAgZXZlbnRJbkplcmtpbmVzcy5zdGFydCgpO1xuICBzb2NrZXRSZWNlaXZlLmNvbm5lY3QoZXZlbnRJbkplcmtpbmVzcyk7XG4gIC8vZXZlbnRJbkplcmtpbmVzcy5jb25uZWN0KGxvZ2dlcik7XG4gIGV2ZW50SW5KZXJraW5lc3MuY29ubmVjdChicmlkZ2UpO1xuICAvL2V2ZW50SW5KZXJraW5lc3MuY29ubmVjdChsb2dnZXIpO1xufSk7XG5cblxuXG4vLyBPcGVuIHRoZSBzb2NrZXRzLlxudWRwUG9ydE1heC5vcGVuKCk7XG5cbi8qIEdFVCB1c2VycyBsaXN0aW5nLiAqL1xucm91dGVyLmdldCgnLycsIGZ1bmN0aW9uKHJlcSwgcmVzLCBuZXh0KSB7XG4gIC8qTVlPIENvbm5lY3Rpb24qL1xuICBNeW8uY29ubmVjdCgnY29tLnN0b2xrc2RvcmYubXlBd2Vzb21lQXBwJywgcmVxdWlyZSgnd3MnKSk7XG4gIC8vTXlvLnNldExvY2tpbmdQb2xpY3koXCJNYW51YWxcIik7XG4gIFxuICBcbiAgLypNWU8gc3RhcnRpbmcgZXZlbnQgaGFuZGxlciovXG5cbi8vU3RhcnRpbmcgbXlvXG4gIGxldCBteU15bztcbiAgdmFyIHRpbWUgPTA7XG4gIHZhciBkdCA9IDAuMDE7XG4gIFxuICBNeW8ub25FcnJvciA9IGZ1bmN0aW9uICgpIHtcbiAgICBjb25zb2xlLmxvZyhcIkNvdWxkbid0IGNvbm5lY3QgdG8gTXlvIENvbm5lY3RcIik7XG4gIH07XG4gIFxuICBNeW8ub24oJ2Nvbm5lY3RlZCcsIGZ1bmN0aW9uKCl7XG4gICAgbXlNeW8gPSB0aGlzO1xuICAgIGFkZEV2ZW50cyhteU15byk7XG4gIH0pO1xuICBcbiAgXG4gIFxuICBsZXQgYWRkRXZlbnRzID0gZnVuY3Rpb24obXlNeW8pIHtcbiAgICBNeW8ub24oJ2ltdScsIGZ1bmN0aW9uIChkYXRhKSB7XG4gICAgICB0aW1lICs9IGR0O1xuICAgICAgbGV0IGFyciA9IG5ldyBGbG9hdDMyQXJyYXkoW2RhdGEuYWNjZWxlcm9tZXRlci54LCBkYXRhLmFjY2VsZXJvbWV0ZXIueSwgZGF0YS5hY2NlbGVyb21ldGVyLnpdKTtcbiAgICAgIGNvbnN0IGZyYW1lQWNjZWxlcm8gPSB7XG4gICAgICAgIHRpbWU6IHRpbWUsXG4gICAgICAgIGRhdGE6IGFycixcbiAgICAgICAgbWV0YWRhdGEgOiAgbnVsbFxuICAgICAgfTtcbiAgICAgIFxuICAgICAgXG4gICAgfSk7XG4gIH07XG4gIHJlcy5yZW5kZXIoJ3NlbnNvcnMnLCB7IHRpdGxlOiAnRGV2aWNlcyBzdXBwb3J0ZWQ6ICd9KTtcbn0pO1xuXG5cblxuXG4vKlNlbmRpbmcgZm9uY3Rpb24qL1xuLy9UT0RPIGNvbXBsZXRlciBsYSBmb25jdGlvbiBwb3VyIGVudm95ZXIgbGVzIGRvbm7DqWVzIGEgTUFYXG5mdW5jdGlvbiBzZW5kTWVzc2FnZU9TQyhkYXRhU2Vuc29yKXtcbiAgLy9jb25zb2xlLmxvZyhcImRhdGFTZW5zb3IgOiBcIiArIGRhdGFTZW5zb3IpO1xuICBpZiggZGF0YVNlbnNvclswXSA9PT0gMTAwMCAgfHwgZGF0YVNlbnNvclswXSA9PT0gMjAwMCl7XG4gICAgY29uc29sZS5sb2coXCJvbiBvdSBvZmYgOiBcIiArICBkYXRhU2Vuc29yWzBdKTtcbiAgICB2YXIgb25PZmYgPSAxO1xuICAgIGlmKGRhdGFTZW5zb3JbMF0gPT09IDIwMDAgKXtcbiAgICAgIG9uT2ZmID0gMTtcbiAgICB9XG4gICAgZWxzZSB7XG4gICAgICBvbk9mZiA9IDA7XG4gICAgfVxuICAgIHVkcFBvcnRNYXguc2VuZCh7XG4gICAgICBhZGRyZXNzOiBcIi9Pbk9mZlwiLFxuICAgICAgYXJnczogW1xuICAgICAgICB7XG4gICAgICAgICAgdHlwZTogXCJpXCIsXG4gICAgICAgICAgdmFsdWU6IG9uT2ZmXG4gICAgICAgIH0sXG4gICAgICBdXG4gICAgfSwgXCIxMjcuMC4wLjFcIiwgODA4MSk7XG4gIH0gZWxzZSBpZihpc05hTihkYXRhU2Vuc29yWzBdKSApe1xuICAgIHJldHVybiAnTm90IGEgbnVtYmVyJztcbiAgfSBlbHNlIHtcbiAgICB1ZHBQb3J0TWF4LnNlbmQoe1xuICAgICAgYWRkcmVzczogXCIvamVya2luZXNzXCIsXG4gICAgICBhcmdzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICB0eXBlOiBcImZcIixcbiAgICAgICAgICB2YWx1ZTogZGF0YVNlbnNvclswXVxuICAgICAgICB9LFxuICAgICAgXVxuICAgIH0sIFwiMTI3LjAuMC4xXCIsIDgwODEpO1xuICAgIC8vXCIxMjcuMC4wLjFcIiwgY29uZmlnLm9zYy5yZWNlaXZlUG9ydCk7XG4gIH1cbiAgXG59XG5cblxuXG5tb2R1bGUuZXhwb3J0cyA9IHJvdXRlcjtcbiJdfQ==