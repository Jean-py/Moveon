'use strict';

var express = require('express');
var router = express.Router();
var smartphoneSensors = require('../client/js/sensors/smartphoneSensors');
var Myo = require('myo');
var osc = require('osc');
var lfo = require('waves-lfo/node');
var SG = require('ml-savitzky-golay');
var config = require('../config/configServer');

/*Adress for sending data to MAX*/
var udpPortMax = new osc.UDPPort({
  localAddress: config.osc.sendAddress,
  localPort: 8082,
  // localPort: config.osc.sendPort,
  metadata: true
});

//Socket for receiving data from client
var socketReceive = new lfo.source.SocketReceive({
  port: config.socketClientToServer.port
  //config.socketServerToClient.port
});

var logger = new lfo.sink.Logger({
  time: false,
  data: true
});

var bridge = new lfo.sink.Bridge({
  processFrame: function processFrame(frame) {
    return sendMessageOSC(frame.data);
  }
});

//socketReceive.connect(logger);
var eventInJerkiness = new lfo.source.EventIn({
  frameType: 'vector',
  frameSize: 1,
  frameRate: 0.01,
  description: ['Jerkiness']
});

eventInJerkiness.init().then(function () {
  eventInJerkiness.start();
  socketReceive.connect(eventInJerkiness);
  //eventInJerkiness.connect(logger);
  eventInJerkiness.connect(bridge);
  //eventInJerkiness.connect(logger);
});

// Open the sockets.
udpPortMax.open();

/* GET users listing. */
router.get('/', function (req, res, next) {
  /*MYO Connection*/
  Myo.connect('com.stolksdorf.myAwesomeApp', require('ws'));
  //Myo.setLockingPolicy("Manual");


  /*MYO starting event handler*/

  //Starting myo
  var myMyo = void 0;
  var time = 0;
  var dt = 0.01;

  Myo.onError = function () {
    console.log("Couldn't connect to Myo Connect");
  };

  Myo.on('connected', function () {
    myMyo = this;
    addEvents(myMyo);
  });

  var addEvents = function addEvents(myMyo) {
    Myo.on('imu', function (data) {
      time += dt;
      var arr = new Float32Array([data.accelerometer.x, data.accelerometer.y, data.accelerometer.z]);
      var frameAccelero = {
        time: time,
        data: arr,
        metadata: null
      };
    });
  };
  res.render('sensors', { title: 'Devices supported: ' });
});

/*Sending fonction*/
//TODO completer la fonction pour envoyer les donn√©es a MAX
function sendMessageOSC(dataSensor) {
  //console.log("dataSensor : " + dataSensor);
  if (dataSensor[0] === 1000 || dataSensor[0] === 2000) {
    console.log("on ou off : " + dataSensor[0]);
    var onOff = 1;
    if (dataSensor[0] === 2000) {
      onOff = 1;
    } else {
      onOff = 0;
    }
    udpPortMax.send({
      address: "/OnOff",
      args: [{
        type: "i",
        value: onOff
      }]
    }, "127.0.0.1", 8081);
  } else if (isNaN(dataSensor[0])) {
    return 'Not a number';
  } else {
    udpPortMax.send({
      address: "/jerkiness",
      args: [{
        type: "f",
        value: dataSensor[0]
      }]
    }, "127.0.0.1", 8081);
    //"127.0.0.1", config.osc.receivePort);
  }
}

module.exports = router;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInNlbnNvcnMuanMiXSwibmFtZXMiOlsiZXhwcmVzcyIsInJlcXVpcmUiLCJyb3V0ZXIiLCJSb3V0ZXIiLCJzbWFydHBob25lU2Vuc29ycyIsIk15byIsIm9zYyIsImxmbyIsIlNHIiwiY29uZmlnIiwidWRwUG9ydE1heCIsIlVEUFBvcnQiLCJsb2NhbEFkZHJlc3MiLCJzZW5kQWRkcmVzcyIsImxvY2FsUG9ydCIsIm1ldGFkYXRhIiwic29ja2V0UmVjZWl2ZSIsInNvdXJjZSIsIlNvY2tldFJlY2VpdmUiLCJwb3J0Iiwic29ja2V0Q2xpZW50VG9TZXJ2ZXIiLCJsb2dnZXIiLCJzaW5rIiwiTG9nZ2VyIiwidGltZSIsImRhdGEiLCJicmlkZ2UiLCJCcmlkZ2UiLCJwcm9jZXNzRnJhbWUiLCJmcmFtZSIsInNlbmRNZXNzYWdlT1NDIiwiZXZlbnRJbkplcmtpbmVzcyIsIkV2ZW50SW4iLCJmcmFtZVR5cGUiLCJmcmFtZVNpemUiLCJmcmFtZVJhdGUiLCJkZXNjcmlwdGlvbiIsImluaXQiLCJ0aGVuIiwic3RhcnQiLCJjb25uZWN0Iiwib3BlbiIsImdldCIsInJlcSIsInJlcyIsIm5leHQiLCJteU15byIsImR0Iiwib25FcnJvciIsImNvbnNvbGUiLCJsb2ciLCJvbiIsImFkZEV2ZW50cyIsImFyciIsIkZsb2F0MzJBcnJheSIsImFjY2VsZXJvbWV0ZXIiLCJ4IiwieSIsInoiLCJmcmFtZUFjY2VsZXJvIiwicmVuZGVyIiwidGl0bGUiLCJkYXRhU2Vuc29yIiwib25PZmYiLCJzZW5kIiwiYWRkcmVzcyIsImFyZ3MiLCJ0eXBlIiwidmFsdWUiLCJpc05hTiIsIm1vZHVsZSIsImV4cG9ydHMiXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBSUEsVUFBVUMsUUFBUSxTQUFSLENBQWQ7QUFDQSxJQUFJQyxTQUFTRixRQUFRRyxNQUFSLEVBQWI7QUFDQSxJQUFJQyxvQkFBb0JILFFBQVEsd0NBQVIsQ0FBeEI7QUFDQSxJQUFJSSxNQUFNSixRQUFRLEtBQVIsQ0FBVjtBQUNB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LE1BQUlBLFdBQVcsQ0FBWCxNQUFrQixJQUFsQixJQUEyQkEsV0FBVyxDQUFYLE1BQWtCLElBQWpELEVBQXNEO0FBQ3BEYixZQUFRQyxHQUFSLENBQVksaUJBQWtCWSxXQUFXLENBQVgsQ0FBOUI7QUFDQSxRQUFJQyxRQUFRLENBQVo7QUFDQSxRQUFHRCxXQUFXLENBQVgsTUFBa0IsSUFBckIsRUFBMkI7QUFDekJDLGNBQVEsQ0FBUjtBQUNELEtBRkQsTUFHSztBQUNIQSxjQUFRLENBQVI7QUFDRDtBQUNEckQsZUFBV3NELElBQVgsQ0FBZ0I7QUFDZEMsZUFBUyxRQURLO0FBRWRDLFlBQU0sQ0FDSjtBQUNFQyxjQUFNLEdBRFI7QUFFRUMsZUFBT0w7QUFGVCxPQURJO0FBRlEsS0FBaEIsRUFRRyxXQVJILEVBUWdCLElBUmhCO0FBU0QsR0FsQkQsTUFrQk8sSUFBR00sTUFBTVAsV0FBVyxDQUFYLENBQU4sQ0FBSCxFQUF5QjtBQUM5QixXQUFPLGNBQVA7QUFDRCxHQUZNLE1BRUE7QUFDTHBELGVBQVdzRCxJQUFYLENBQWdCO0FBQ2RDLGVBQVMsWUFESztBQUVkQyxZQUFNLENBQ0o7QUFDRUMsY0FBTSxHQURSO0FBRUVDLGVBQU9OLFdBQVcsQ0FBWDtBQUZULE9BREk7QUFGUSxLQUFoQixFQVFHLFdBUkgsRUFRZ0IsSUFSaEI7QUFTQTtBQUNEO0FBRUY7O0FBSURRLE9BQU9DLE9BQVAsR0FBaUJyRSxNQUFqQiIsImZpbGUiOiJzZW5zb3JzLmpzIiwic291cmNlc0NvbnRlbnQiOlsibGV0IGV4cHJlc3MgPSByZXF1aXJlKCdleHByZXNzJyk7XG5sZXQgcm91dGVyID0gZXhwcmVzcy5Sb3V0ZXIoKTtcbmxldCBzbWFydHBob25lU2Vuc29ycyA9IHJlcXVpcmUoJy4uL2NsaWVudC9qcy9zZW5zb3JzL3NtYXJ0cGhvbmVTZW5zb3JzJyk7XG5sZXQgTXlvID0gcmVxdWlyZSgnbXlvJyk7XG5sZXQgb3NjID0gcmVxdWlyZSgnb3NjJyk7XG5sZXQgbGZvID0gcmVxdWlyZSgnd2F2ZXMtbGZvL25vZGUnKTtcbmxldCBTRyA9IHJlcXVpcmUoJ21sLXNhdml0emt5LWdvbGF5Jyk7XG52YXIgY29uZmlnID0gcmVxdWlyZSgnLi4vY29uZmlnL2NvbmZpZ1NlcnZlcicpO1xuXG5cbi8qQWRyZXNzIGZvciBzZW5kaW5nIGRhdGEgdG8gTUFYKi9cbnZhciB1ZHBQb3J0TWF4ID0gbmV3IG9zYy5VRFBQb3J0KHtcbiAgbG9jYWxBZGRyZXNzOiBjb25maWcub3NjLnNlbmRBZGRyZXNzLFxuICBsb2NhbFBvcnQ6IDgwODIsXG4gLy8gbG9jYWxQb3J0OiBjb25maWcub3NjLnNlbmRQb3J0LFxuICBtZXRhZGF0YTogdHJ1ZVxufSk7XG5cbi8vU29ja2V0IGZvciByZWNlaXZpbmcgZGF0YSBmcm9tIGNsaWVudFxuY29uc3Qgc29ja2V0UmVjZWl2ZSA9IG5ldyBsZm8uc291cmNlLlNvY2tldFJlY2VpdmUoe1xuICBwb3J0OiBjb25maWcuc29ja2V0Q2xpZW50VG9TZXJ2ZXIucG9ydCxcbiAgLy9jb25maWcuc29ja2V0U2VydmVyVG9DbGllbnQucG9ydFxufSk7XG5cblxuXG5cbmNvbnN0IGxvZ2dlciA9IG5ldyBsZm8uc2luay5Mb2dnZXIoe1xuICB0aW1lOiBmYWxzZSxcbiAgZGF0YTogdHJ1ZSxcbn0pO1xuXG5jb25zdCBicmlkZ2UgPSBuZXcgbGZvLnNpbmsuQnJpZGdlKHtcbiAgcHJvY2Vzc0ZyYW1lOiAoZnJhbWUpID0+IHNlbmRNZXNzYWdlT1NDKGZyYW1lLmRhdGEpLFxufSk7XG5cbi8vc29ja2V0UmVjZWl2ZS5jb25uZWN0KGxvZ2dlcik7XG5jb25zdCBldmVudEluSmVya2luZXNzID0gbmV3IGxmby5zb3VyY2UuRXZlbnRJbih7XG4gIGZyYW1lVHlwZTogJ3ZlY3RvcicsXG4gIGZyYW1lU2l6ZTogMSxcbiAgZnJhbWVSYXRlOiAwLjAxLFxuICBkZXNjcmlwdGlvbjogWydKZXJraW5lc3MnXSxcbn0pO1xuXG5cbmV2ZW50SW5KZXJraW5lc3MuaW5pdCgpLnRoZW4oKCkgPT4ge1xuICBldmVudEluSmVya2luZXNzLnN0YXJ0KCk7XG4gIHNvY2tldFJlY2VpdmUuY29ubmVjdChldmVudEluSmVya2luZXNzKTtcbiAgLy9ldmVudEluSmVya2luZXNzLmNvbm5lY3QobG9nZ2VyKTtcbiAgZXZlbnRJbkplcmtpbmVzcy5jb25uZWN0KGJyaWRnZSk7XG4gIC8vZXZlbnRJbkplcmtpbmVzcy5jb25uZWN0KGxvZ2dlcik7XG59KTtcblxuXG5cbi8vIE9wZW4gdGhlIHNvY2tldHMuXG51ZHBQb3J0TWF4Lm9wZW4oKTtcblxuLyogR0VUIHVzZXJzIGxpc3RpbmcuICovXG5yb3V0ZXIuZ2V0KCcvJywgZnVuY3Rpb24ocmVxLCByZXMsIG5leHQpIHtcbiAgLypNWU8gQ29ubmVjdGlvbiovXG4gIE15by5jb25uZWN0KCdjb20uc3RvbGtzZG9yZi5teUF3ZXNvbWVBcHAnLCByZXF1aXJlKCd3cycpKTtcbiAgLy9NeW8uc2V0TG9ja2luZ1BvbGljeShcIk1hbnVhbFwiKTtcbiAgXG4gIFxuICAvKk1ZTyBzdGFydGluZyBldmVudCBoYW5kbGVyKi9cblxuLy9TdGFydGluZyBteW9cbiAgbGV0IG15TXlvO1xuICB2YXIgdGltZSA9MDtcbiAgdmFyIGR0ID0gMC4wMTtcbiAgXG4gIE15by5vbkVycm9yID0gZnVuY3Rpb24gKCkge1xuICAgIGNvbnNvbGUubG9nKFwiQ291bGRuJ3QgY29ubmVjdCB0byBNeW8gQ29ubmVjdFwiKTtcbiAgfTtcbiAgXG4gIE15by5vbignY29ubmVjdGVkJywgZnVuY3Rpb24oKXtcbiAgICBteU15byA9IHRoaXM7XG4gICAgYWRkRXZlbnRzKG15TXlvKTtcbiAgfSk7XG4gIFxuICBcbiAgXG4gIGxldCBhZGRFdmVudHMgPSBmdW5jdGlvbihteU15bykge1xuICAgIE15by5vbignaW11JywgZnVuY3Rpb24gKGRhdGEpIHtcbiAgICAgIHRpbWUgKz0gZHQ7XG4gICAgICBsZXQgYXJyID0gbmV3IEZsb2F0MzJBcnJheShbZGF0YS5hY2NlbGVyb21ldGVyLngsIGRhdGEuYWNjZWxlcm9tZXRlci55LCBkYXRhLmFjY2VsZXJvbWV0ZXIuel0pO1xuICAgICAgY29uc3QgZnJhbWVBY2NlbGVybyA9IHtcbiAgICAgICAgdGltZTogdGltZSxcbiAgICAgICAgZGF0YTogYXJyLFxuICAgICAgICBtZXRhZGF0YSA6ICBudWxsXG4gICAgICB9O1xuICAgICAgXG4gICAgICBcbiAgICB9KTtcbiAgfTtcbiAgcmVzLnJlbmRlcignc2Vuc29ycycsIHsgdGl0bGU6ICdEZXZpY2VzIHN1cHBvcnRlZDogJ30pO1xufSk7XG5cblxuXG5cbi8qU2VuZGluZyBmb25jdGlvbiovXG4vL1RPRE8gY29tcGxldGVyIGxhIGZvbmN0aW9uIHBvdXIgZW52b3llciBsZXMgZG9ubsOpZXMgYSBNQVhcbmZ1bmN0aW9uIHNlbmRNZXNzYWdlT1NDKGRhdGFTZW5zb3Ipe1xuICAvL2NvbnNvbGUubG9nKFwiZGF0YVNlbnNvciA6IFwiICsgZGF0YVNlbnNvcik7XG4gIGlmKCBkYXRhU2Vuc29yWzBdID09PSAxMDAwICB8fCBkYXRhU2Vuc29yWzBdID09PSAyMDAwKXtcbiAgICBjb25zb2xlLmxvZyhcIm9uIG91IG9mZiA6IFwiICsgIGRhdGFTZW5zb3JbMF0pO1xuICAgIHZhciBvbk9mZiA9IDE7XG4gICAgaWYoZGF0YVNlbnNvclswXSA9PT0gMjAwMCApe1xuICAgICAgb25PZmYgPSAxO1xuICAgIH1cbiAgICBlbHNlIHtcbiAgICAgIG9uT2ZmID0gMDtcbiAgICB9XG4gICAgdWRwUG9ydE1heC5zZW5kKHtcbiAgICAgIGFkZHJlc3M6IFwiL09uT2ZmXCIsXG4gICAgICBhcmdzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICB0eXBlOiBcImlcIixcbiAgICAgICAgICB2YWx1ZTogb25PZmZcbiAgICAgICAgfSxcbiAgICAgIF1cbiAgICB9LCBcIjEyNy4wLjAuMVwiLCA4MDgxKTtcbiAgfSBlbHNlIGlmKGlzTmFOKGRhdGFTZW5zb3JbMF0pICl7XG4gICAgcmV0dXJuICdOb3QgYSBudW1iZXInO1xuICB9IGVsc2Uge1xuICAgIHVkcFBvcnRNYXguc2VuZCh7XG4gICAgICBhZGRyZXNzOiBcIi9qZXJraW5lc3NcIixcbiAgICAgIGFyZ3M6IFtcbiAgICAgICAge1xuICAgICAgICAgIHR5cGU6IFwiZlwiLFxuICAgICAgICAgIHZhbHVlOiBkYXRhU2Vuc29yWzBdXG4gICAgICAgIH0sXG4gICAgICBdXG4gICAgfSwgXCIxMjcuMC4wLjFcIiwgODA4MSk7XG4gICAgLy9cIjEyNy4wLjAuMVwiLCBjb25maWcub3NjLnJlY2VpdmVQb3J0KTtcbiAgfVxuICBcbn1cblxuXG5cbm1vZHVsZS5leHBvcnRzID0gcm91dGVyO1xuIl19