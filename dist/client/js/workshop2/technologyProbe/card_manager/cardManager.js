'use strict';

var numberOfCard = 0;
var arrayCard = [];
//var arrayCardDeleted = [];
var commands = [];

var CardManager = function CardManager() {
  //I implemented a command pattern, see : https://www.dofactory.com/javascript/command-design-pattern
  return {
    //execute a command
    execute: function execute(command) {
      command.execute();
      //We send the command to the server (the server log it into a file, see ./src/server/ServerLogger)
      logger.sendAndLogCommand(command);
      //and we save the command created
      commands.push(command);
    },
    //Undo a command
    undo: function undo() {
      //TODO
      var command = commands.pop();
      command.undo();
    },
    exportCard: function exportCard() {
      console.log("function export card");
      /*------ Create a set of card from a JSON file -------*/
      var arrayItemUpdated = [];
      var listSegment = document.getElementsByClassName('segment');
      //playCard(arrayItem.iDiv, arrayItem.startP);
      console.log(listSegment);

      for (var i = 0; i < listSegment.length; i++) {
        console.log(listSegment[i].id); //second console output
        triggerMouseEvent(listSegment[i], 'mousedown');
      }
      arrayCard.forEach(function (arrayItem) {
        console.log(arrayItem);
        var item = arrayItem.updateInfo();
        arrayItemUpdated.push(item);
        console.log(item);
      });
      var serializedArr = JSON.stringify(arrayItemUpdated);
      console.log("*****  Serialisation of card complete : " + serializedArr);
      download(serializedArr, 'jsonW2log-' + createUniqueId() + '.json', 'text/plain');

      logger.saveSH(serializedArr);
    }, loadSegmentHistoryFromServer: function loadSegmentHistoryFromServer() {

      $.get('/public/logW2Json', function (data) {
        console.log(data);
        var listing = parseDirectoryListing(data);
        $('body').append(JSON.stringify(listing));
      });

      function parseDirectoryListing(text) {
        var docs = text.match(/href="([\w]+)/g) // pull out the hrefs
        .map(function (x) {
          return x.replace('href="', '');
        }); // clean up
        console.log(docs);
        return docs;
      }

      //We charge all the video only one time
      var xhr = new XMLHttpRequest();
      xhr.open('POST', 'src/client/js/workshop2/technologyProbe/card_manager/SHLoaderOverview_view.html', true);
      xhr.onreadystatechange = function () {
        if (this.readyState !== 4) return;

        if (this.status !== 200) return;
        document.getElementById('SHPickerOverviewModal').innerHTML = this.responseText;
      };
      xhr.send();
      xhr.open('GET', 'public/logW2Json/ipad2.json', true);
      xhr.onreadystatechange = function () {
        console.log(this.responseText);
      };
      xhr.send();
    }

  };
};

/*Private function, do not call outside the CardManager*/

function triggerMouseEvent(node, eventType) {
  var clickEvent = document.createEvent('MouseEvents');
  clickEvent.initEvent(eventType, true, true);
  node.dispatchEvent(clickEvent);
}

/**** Functional core of the card manager (create a cart, delete a card and save card) *****/
/**
 * This class manag all the cards created. This is the segment history.
 * @type {HTMLElement | null}
 */
var wrapperCommandAndRange = document.getElementById("wrapperCommandAndRangeid");

function cleanSegmentHistory() {
  console.log("TESTING");
  clearAllTimer();
  arrayCard.forEach(function (e) {
    deleteCardUI(e);
  });
}

function loadJSON() {
  var files = document.getElementById('logFileLoad').files;
  if (!files.length) {
    alert('Please select a file!');
    return;
  }

  var file = files[0];
  var start = 0;
  var stop = file.size - 1;

  var reader = new FileReader();
  var test = 0;
  // If we use onloadend, we need to check the readyState.
  reader.onloadend = function (evt) {
    if (evt.target.readyState == FileReader.DONE) {
      // DONE == 2
      var test = evt.target.result;
      console.log('Read bytes: ', start + 1, ' - ', stop + 1, ' of ', file.size, ' byte file');
      console.log(test);
      var my_JSON_object = JSON.parse(test);

      console.log(my_JSON_object);

      for (var k = 0; k < my_JSON_object.length; k++) {
        addingNewCardsFromJSon(my_JSON_object[k]);
      }
    }
  };
  var blob = file.slice(start, stop + 1);
  reader.readAsBinaryString(blob);
}

//Add a card from a json file
function addingNewCardsFromJSon(cardInfo) {
  if (cardInfo.startP > cardInfo.endP) {
    var transit = cardInfo.startP;
    cardInfo.startP = cardInfo.endP;
    cardInfo.endP = transit;
  }
  if (cardInfo.startP < 0) {
    cardInfo.startP = 0;
  }
  console.log(cardInfo.startP, cardInfo.endP);
  var result = Player.sliderToVideo(cardInfo.startP, cardInfo.endP);
  //console.log(result);
  numberOfCard++;
  if (!cardInfo.deleted) {
    console.log(result.startDuration, result.endDuration, cardInfo.startP, cardInfo.endP, cardInfo);
    var card = Card(result.startDuration, result.endDuration, cardInfo.startP, cardInfo.endP, cardInfo);
    cardManager.execute(new CreateNewCardCommand(card));
    //document.getElementById('divCardBoard').insertBefore(card.iDiv, document.getElementById('divCardBoard').firstChild);
  }
}

/**
 * Adding a card by drag and drop. The card is added in the list of cards
 * Return the card that have been created
 */
function createNewCard(startP, endP) {
  //console.log("TEST / : " + startP + " " + endP);
  if (startP > endP) {
    var transit = startP;
    startP = endP;
    endP = transit;
  }
  var result = Player.sliderToVideo(startP, endP);
  numberOfCard++;
  console.log(result);

  var card = new Card(result.startDuration, result.endDuration, startP, endP);
  cardManager.execute(new CreateNewCardCommand(card));
  return card;
}

function addingNewCard() {
  arrayCard.push(this.card);
  document.getElementById('divCardBoard').insertBefore(this.card.iDiv, document.getElementById('divCardBoard').firstChild);
}

function deleteCard() {
  //Supprime la carte de la liste de carte
  /*for (let i = 0; i < arrayCard.length   ; i++) {
    if(arrayCard[i]  === card){
      var supCard = arrayCard.splice(i,1);
      arrayCardDeleted.push(supCard);
      console.log("deleted card : ");
      console.log(supCard);
      break;
    }
  }*/
  //deleteCardUI(card);
  /*arrayCardDeleted.forEach(function(element) {
    console.log(   element);
  });
  console.log("************************");
  arrayCard.forEach(function(element) {
    console.log(element);
  });*/
  clearAllTimer();
  deleteCardUI(this.card);
  return this.card;
}

function deleteCardUI(card) {
  feedbackOnSliderVideo(false);
  card.iDiv.remove();
  card.deleted = true;
}

function download(content, fileName, contentType) {
  var a = document.createElement("a");

  //a.style.display = "block";
  var file = new Blob([content], {
    type: contentType
  });

  a.href = URL.createObjectURL(file);
  a.download = fileName;
  a.click();
  a.remove();
}

function loadJSONSegmentHistory1() {

  console.log(generateJSONfromvar());

  var generatedJson = generateJSONfromvar();
  var my_JSON_object = JSON.parse(generatedJson);
  console.log(my_JSON_object);
  for (var k = 0; k < my_JSON_object.length; k++) {
    addingNewCardsFromJSon(my_JSON_object[k]);
  }
}

function loadJSONSegmentHistory2() {
  var generatedJson2 = generateJSONfromvar2();
  var my_JSON_object = JSON.parse(generatedJson2);
  console.log(my_JSON_object);
  for (var k = 0; k < my_JSON_object.length; k++) {
    addingNewCardsFromJSon(my_JSON_object[k]);
  }
}

function loadJSONSegmentHistoryTutorial() {
  var generatedJson2 = generateJSONfromvarTuto();
  var my_JSON_object = JSON.parse(generatedJson2);
  console.log(my_JSON_object);
  for (var k = 0; k < my_JSON_object.length; k++) {
    addingNewCardsFromJSon(my_JSON_object[k]);
  }
}

var loadSHHistoryfromSrv = function loadSHHistoryfromSrv() {

  //We charge all the video only one time
  var xhr = new XMLHttpRequest();
  xhr.open('GET', 'src/client/js/workshop2/technologyProbe/card_manager/SHLoaderOverview_view.html', true);
  xhr.onreadystatechange = function () {
    if (this.readyState !== 4) return;
    if (this.status !== 200) return; // or whatever error handling you want
    document.getElementById('SHPickerOverviewModal').innerHTML = this.responseText;
    xhr.send();
    console.log('HAHAHAHA');

    /*
    //Code permettant de charger un SH, il suffit de recuperer tous les SH du server,
    // puis de les entrer dans une div correspondante, Ã a doit faire un overview je pense
    let generatedJson = generateJSONfromvar();
    var my_JSON_object = JSON.parse(generatedJson);
    console.log(my_JSON_object);
    for (let k = 0; k < my_JSON_object.length; k++) {
      addingNewCardsFromJSon(my_JSON_object[k]);
    }*/

    /*var elms = document.getElementById('videoPickerOverviewModal').getElementsByTagName("div");
    var video = document.getElementById('videoEAT');
    var span = document.getElementsByClassName("close")[0];
    
    span.addEventListener( "mousedown" , function() {
      modalVideo.style.display = "none";
    });
    for (var i = 0; i < elms.length; i++) {
      elms[i].addEventListener("mousedown", function (){
        //console.log(this.getElementsByTagName("source")[0].src);
        video.src = this.getElementsByTagName("source")[0].src;
        var notification_feedback = "Video successfully loaded!";
        notificationFeedback(notification_feedback);
        //modalVideo.style.display = "none";
        //modalVideo.style.visibility = "hidden";
      });
    }
    };*/
  };
};
/*

var span = document.getElementsByClassName("close")[1];
var modalSH = document.getElementById('SHPickerOverview');

span.addEventListener( "mousedown" , function() {
  modalSH.style.display = "none";
});*/
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNhcmRNYW5hZ2VyLmpzIl0sIm5hbWVzIjpbIm51bWJlck9mQ2FyZCIsImFycmF5Q2FyZCIsImNvbW1hbmRzIiwiQ2FyZE1hbmFnZXIiLCJleGVjdXRlIiwiY29tbWFuZCIsImxvZ2dlciIsInNlbmRBbmRMb2dDb21tYW5kIiwicHVzaCIsInVuZG8iLCJwb3AiLCJleHBvcnRDYXJkIiwiY29uc29sZSIsImxvZyIsImFycmF5SXRlbVVwZGF0ZWQiLCJsaXN0U2VnbWVudCIsImRvY3VtZW50IiwiZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSIsImkiLCJsZW5ndGgiLCJpZCIsInRyaWdnZXJNb3VzZUV2ZW50IiwiZm9yRWFjaCIsImFycmF5SXRlbSIsIml0ZW0iLCJ1cGRhdGVJbmZvIiwic2VyaWFsaXplZEFyciIsIkpTT04iLCJzdHJpbmdpZnkiLCJkb3dubG9hZCIsImNyZWF0ZVVuaXF1ZUlkIiwic2F2ZVNIIiwibG9hZFNlZ21lbnRIaXN0b3J5RnJvbVNlcnZlciIsIiQiLCJnZXQiLCJkYXRhIiwibGlzdGluZyIsInBhcnNlRGlyZWN0b3J5TGlzdGluZyIsImFwcGVuZCIsInRleHQiLCJkb2NzIiwibWF0Y2giLCJtYXAiLCJ4IiwicmVwbGFjZSIsInhociIsIlhNTEh0dHBSZXF1ZXN0Iiwib3BlbiIsIm9ucmVhZHlzdGF0ZWNoYW5nZSIsInJlYWR5U3RhdGUiLCJzdGF0dXMiLCJnZXRFbGVtZW50QnlJZCIsImlubmVySFRNTCIsInJlc3BvbnNlVGV4dCIsInNlbmQiLCJub2RlIiwiZXZlbnRUeXBlIiwiY2xpY2tFdmVudCIsImNyZWF0ZUV2ZW50IiwiaW5pdEV2ZW50IiwiZGlzcGF0Y2hFdmVudCIsIndyYXBwZXJDb21tYW5kQW5kUmFuZ2UiLCJjbGVhblNlZ21lbnRIaXN0b3J5IiwiY2xlYXJBbGxUaW1lciIsImUiLCJkZWxldGVDYXJkVUkiLCJsb2FkSlNPTiIsImZpbGVzIiwiYWxlcnQiLCJmaWxlIiwic3RhcnQiLCJzdG9wIiwic2l6ZSIsInJlYWRlciIsIkZpbGVSZWFkZXIiLCJ0ZXN0Iiwib25sb2FkZW5kIiwiZXZ0IiwidGFyZ2V0IiwiRE9ORSIsInJlc3VsdCIsIm15X0pTT05fb2JqZWN0IiwicGFyc2UiLCJrIiwiYWRkaW5nTmV3Q2FyZHNGcm9tSlNvbiIsImJsb2IiLCJzbGljZSIsInJlYWRBc0JpbmFyeVN0cmluZyIsImNhcmRJbmZvIiwic3RhcnRQIiwiZW5kUCIsInRyYW5zaXQiLCJQbGF5ZXIiLCJzbGlkZXJUb1ZpZGVvIiwiZGVsZXRlZCIsInN0YXJ0RHVyYXRpb24iLCJlbmREdXJhdGlvbiIsImNhcmQiLCJDYXJkIiwiY2FyZE1hbmFnZXIiLCJDcmVhdGVOZXdDYXJkQ29tbWFuZCIsImNyZWF0ZU5ld0NhcmQiLCJhZGRpbmdOZXdDYXJkIiwiaW5zZXJ0QmVmb3JlIiwiaURpdiIsImZpcnN0Q2hpbGQiLCJkZWxldGVDYXJkIiwiZmVlZGJhY2tPblNsaWRlclZpZGVvIiwicmVtb3ZlIiwiY29udGVudCIsImZpbGVOYW1lIiwiY29udGVudFR5cGUiLCJhIiwiY3JlYXRlRWxlbWVudCIsIkJsb2IiLCJ0eXBlIiwiaHJlZiIsIlVSTCIsImNyZWF0ZU9iamVjdFVSTCIsImNsaWNrIiwibG9hZEpTT05TZWdtZW50SGlzdG9yeTEiLCJnZW5lcmF0ZUpTT05mcm9tdmFyIiwiZ2VuZXJhdGVkSnNvbiIsImxvYWRKU09OU2VnbWVudEhpc3RvcnkyIiwiZ2VuZXJhdGVkSnNvbjIiLCJnZW5lcmF0ZUpTT05mcm9tdmFyMiIsImxvYWRKU09OU2VnbWVudEhpc3RvcnlUdXRvcmlhbCIsImdlbmVyYXRlSlNPTmZyb212YXJUdXRvIiwibG9hZFNISGlzdG9yeWZyb21TcnYiXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBSUEsZUFBZSxDQUFuQjtBQUNBLElBQUlDLFlBQVksRUFBaEI7QUFDQTtBQUNBLElBQUlDLFdBQVcsRUFBZjs7QUFJQSxJQUFJQyxjQUFjLFNBQWRBLFdBQWMsR0FBVztBQUMzQjtBQUNBLFNBQU87QUFDTDtBQUNBQyxhQUFTLGlCQUFTQyxPQUFULEVBQWtCO0FBQzFCQSxjQUFRRCxPQUFSO0FBQ0M7QUFDQUUsYUFBT0MsaUJBQVAsQ0FBeUJGLE9BQXpCO0FBQ0E7QUFDQUgsZUFBU00sSUFBVCxDQUFjSCxPQUFkO0FBQ0QsS0FSSTtBQVNMO0FBQ0FJLFVBQU0sZ0JBQVc7QUFDZjtBQUNBLFVBQUlKLFVBQVVILFNBQVNRLEdBQVQsRUFBZDtBQUNBTCxjQUFRSSxJQUFSO0FBQ0QsS0FkSTtBQWVMRSxnQkFBWSxzQkFBVTtBQUNwQkMsY0FBUUMsR0FBUixDQUFZLHNCQUFaO0FBQ0E7QUFDQSxVQUFJQyxtQkFBbUIsRUFBdkI7QUFDQSxVQUFJQyxjQUFjQyxTQUFTQyxzQkFBVCxDQUFnQyxTQUFoQyxDQUFsQjtBQUNBO0FBQ0FMLGNBQVFDLEdBQVIsQ0FBWUUsV0FBWjs7QUFHQSxXQUFLLElBQUlHLElBQUksQ0FBYixFQUFnQkEsSUFBSUgsWUFBWUksTUFBaEMsRUFBd0NELEdBQXhDLEVBQTZDO0FBQzNDTixnQkFBUUMsR0FBUixDQUFZRSxZQUFZRyxDQUFaLEVBQWVFLEVBQTNCLEVBRDJDLENBQ1g7QUFDaENDLDBCQUFrQk4sWUFBWUcsQ0FBWixDQUFsQixFQUFpQyxXQUFqQztBQUNEO0FBQ0NqQixnQkFBVXFCLE9BQVYsQ0FBa0IsVUFBU0MsU0FBVCxFQUFvQjtBQUNwQ1gsZ0JBQVFDLEdBQVIsQ0FBWVUsU0FBWjtBQUNBLFlBQUlDLE9BQU9ELFVBQVVFLFVBQVYsRUFBWDtBQUNBWCx5QkFBaUJOLElBQWpCLENBQXNCZ0IsSUFBdEI7QUFDQVosZ0JBQVFDLEdBQVIsQ0FBWVcsSUFBWjtBQUNELE9BTEQ7QUFNQSxVQUFJRSxnQkFBZ0JDLEtBQUtDLFNBQUwsQ0FBZWQsZ0JBQWYsQ0FBcEI7QUFDQUYsY0FBUUMsR0FBUixDQUFZLDZDQUE2Q2EsYUFBekQ7QUFDQUcsZUFBU0gsYUFBVCxFQUF3QixlQUFlSSxnQkFBZixHQUFrQyxPQUExRCxFQUFtRSxZQUFuRTs7QUFFQXhCLGFBQU95QixNQUFQLENBQWNMLGFBQWQ7QUFDSCxLQXZDSSxFQXVDRk0sOEJBQThCLHdDQUFVOztBQUd6Q0MsUUFBRUMsR0FBRixDQUFNLG1CQUFOLEVBQTJCLFVBQUNDLElBQUQsRUFDM0I7QUFDRXZCLGdCQUFRQyxHQUFSLENBQVlzQixJQUFaO0FBQ0EsWUFBSUMsVUFBVUMsc0JBQXNCRixJQUF0QixDQUFkO0FBQ0FGLFVBQUUsTUFBRixFQUFVSyxNQUFWLENBQWlCWCxLQUFLQyxTQUFMLENBQWVRLE9BQWYsQ0FBakI7QUFDRCxPQUxEOztBQU9BLGVBQVNDLHFCQUFULENBQStCRSxJQUEvQixFQUNBO0FBQ0UsWUFBSUMsT0FBT0QsS0FDUkUsS0FEUSxDQUNGLGdCQURFLEVBQ2dCO0FBRGhCLFNBRVJDLEdBRlEsQ0FFSixVQUFDQyxDQUFEO0FBQUEsaUJBQU9BLEVBQUVDLE9BQUYsQ0FBVSxRQUFWLEVBQW9CLEVBQXBCLENBQVA7QUFBQSxTQUZJLENBQVgsQ0FERixDQUcwQztBQUN4Q2hDLGdCQUFRQyxHQUFSLENBQVkyQixJQUFaO0FBQ0EsZUFBT0EsSUFBUDtBQUNEOztBQUtEO0FBQ0UsVUFBSUssTUFBTSxJQUFJQyxjQUFKLEVBQVY7QUFDQUQsVUFBSUUsSUFBSixDQUFTLE1BQVQsRUFBaUIsaUZBQWpCLEVBQW9HLElBQXBHO0FBQ0ZGLFVBQUlHLGtCQUFKLEdBQXlCLFlBQVk7QUFDbkMsWUFBSSxLQUFLQyxVQUFMLEtBQW9CLENBQXhCLEVBQ007O0FBRUosWUFBSSxLQUFLQyxNQUFMLEtBQWdCLEdBQXBCLEVBQ0U7QUFDRmxDLGlCQUFTbUMsY0FBVCxDQUF3Qix1QkFBeEIsRUFBaURDLFNBQWpELEdBQTZELEtBQUtDLFlBQWxFO0FBQ0QsT0FQSDtBQVFBUixVQUFJUyxJQUFKO0FBQ0FULFVBQUlFLElBQUosQ0FBUyxLQUFULEVBQWdCLDZCQUFoQixFQUErQyxJQUEvQztBQUNBRixVQUFJRyxrQkFBSixHQUF5QixZQUFZO0FBQ25DcEMsZ0JBQVFDLEdBQVIsQ0FBWSxLQUFLd0MsWUFBakI7QUFDRCxPQUZEO0FBR0FSLFVBQUlTLElBQUo7QUFHRDs7QUFoRkksR0FBUDtBQW9GRCxDQXRGRDs7QUF5RkE7O0FBR0EsU0FBU2pDLGlCQUFULENBQTRCa0MsSUFBNUIsRUFBa0NDLFNBQWxDLEVBQTZDO0FBQzNDLE1BQUlDLGFBQWF6QyxTQUFTMEMsV0FBVCxDQUFzQixhQUF0QixDQUFqQjtBQUNBRCxhQUFXRSxTQUFYLENBQXNCSCxTQUF0QixFQUFpQyxJQUFqQyxFQUF1QyxJQUF2QztBQUNBRCxPQUFLSyxhQUFMLENBQW9CSCxVQUFwQjtBQUNEOztBQUVEO0FBQ0E7Ozs7QUFJQSxJQUFJSSx5QkFBeUI3QyxTQUFTbUMsY0FBVCxDQUF3QiwwQkFBeEIsQ0FBN0I7O0FBSUEsU0FBU1csbUJBQVQsR0FBOEI7QUFDNUJsRCxVQUFRQyxHQUFSLENBQVksU0FBWjtBQUNBa0Q7QUFDQTlELFlBQVVxQixPQUFWLENBQWtCLFVBQVMwQyxDQUFULEVBQVc7QUFDekJDLGlCQUFhRCxDQUFiO0FBQ0gsR0FGRDtBQUdEOztBQUVELFNBQVNFLFFBQVQsR0FBb0I7QUFDbEIsTUFBSUMsUUFBUW5ELFNBQVNtQyxjQUFULENBQXdCLGFBQXhCLEVBQXVDZ0IsS0FBbkQ7QUFDQSxNQUFJLENBQUNBLE1BQU1oRCxNQUFYLEVBQW1CO0FBQ2pCaUQsVUFBTSx1QkFBTjtBQUNBO0FBQ0Q7O0FBRUQsTUFBSUMsT0FBT0YsTUFBTSxDQUFOLENBQVg7QUFDQSxNQUFJRyxRQUFTLENBQWI7QUFDQSxNQUFJQyxPQUFPRixLQUFLRyxJQUFMLEdBQVksQ0FBdkI7O0FBRUEsTUFBSUMsU0FBUyxJQUFJQyxVQUFKLEVBQWI7QUFDQSxNQUFJQyxPQUFPLENBQVg7QUFDQTtBQUNBRixTQUFPRyxTQUFQLEdBQW1CLFVBQVNDLEdBQVQsRUFBYztBQUMvQixRQUFJQSxJQUFJQyxNQUFKLENBQVc3QixVQUFYLElBQXlCeUIsV0FBV0ssSUFBeEMsRUFBOEM7QUFBRTtBQUM5QyxVQUFJSixPQUFPRSxJQUFJQyxNQUFKLENBQVdFLE1BQXRCO0FBQ0FwRSxjQUFRQyxHQUFSLENBQVksY0FBWixFQUE0QnlELFFBQVEsQ0FBcEMsRUFBdUMsS0FBdkMsRUFBOENDLE9BQU8sQ0FBckQsRUFDSSxNQURKLEVBQ1lGLEtBQUtHLElBRGpCLEVBQ3VCLFlBRHZCO0FBRUE1RCxjQUFRQyxHQUFSLENBQVk4RCxJQUFaO0FBQ0EsVUFBSU0saUJBQWlCdEQsS0FBS3VELEtBQUwsQ0FBV1AsSUFBWCxDQUFyQjs7QUFFQS9ELGNBQVFDLEdBQVIsQ0FBWW9FLGNBQVo7O0FBRUEsV0FBSyxJQUFJRSxJQUFJLENBQWIsRUFBZ0JBLElBQUlGLGVBQWU5RCxNQUFuQyxFQUEyQ2dFLEdBQTNDLEVBQWdEO0FBQzlDQywrQkFBdUJILGVBQWVFLENBQWYsQ0FBdkI7QUFDRDtBQUNGO0FBQ0YsR0FkRDtBQWVBLE1BQUlFLE9BQU9oQixLQUFLaUIsS0FBTCxDQUFXaEIsS0FBWCxFQUFrQkMsT0FBTyxDQUF6QixDQUFYO0FBQ0FFLFNBQU9jLGtCQUFQLENBQTBCRixJQUExQjtBQUNEOztBQUVEO0FBQ0EsU0FBU0Qsc0JBQVQsQ0FBZ0NJLFFBQWhDLEVBQTBDO0FBQ3hDLE1BQUlBLFNBQVNDLE1BQVQsR0FBa0JELFNBQVNFLElBQS9CLEVBQXFDO0FBQ25DLFFBQUlDLFVBQVVILFNBQVNDLE1BQXZCO0FBQ0FELGFBQVNDLE1BQVQsR0FBa0JELFNBQVNFLElBQTNCO0FBQ0FGLGFBQVNFLElBQVQsR0FBZ0JDLE9BQWhCO0FBQ0Q7QUFDRCxNQUFJSCxTQUFTQyxNQUFULEdBQWtCLENBQXRCLEVBQXlCO0FBQ3ZCRCxhQUFTQyxNQUFULEdBQWtCLENBQWxCO0FBQ0Q7QUFDRDdFLFVBQVFDLEdBQVIsQ0FBWTJFLFNBQVNDLE1BQXJCLEVBQTZCRCxTQUFTRSxJQUF0QztBQUNBLE1BQUlWLFNBQVNZLE9BQU9DLGFBQVAsQ0FBcUJMLFNBQVNDLE1BQTlCLEVBQXNDRCxTQUFTRSxJQUEvQyxDQUFiO0FBQ0E7QUFDQTFGO0FBQ0EsTUFBSSxDQUFDd0YsU0FBU00sT0FBZCxFQUF1QjtBQUNyQmxGLFlBQVFDLEdBQVIsQ0FBWW1FLE9BQU9lLGFBQW5CLEVBQWtDZixPQUFPZ0IsV0FBekMsRUFBc0RSLFNBQVNDLE1BQS9ELEVBQXVFRCxTQUFTRSxJQUFoRixFQUFzRkYsUUFBdEY7QUFDQSxRQUFJUyxPQUFPQyxLQUFLbEIsT0FBT2UsYUFBWixFQUEyQmYsT0FBT2dCLFdBQWxDLEVBQStDUixTQUFTQyxNQUF4RCxFQUFnRUQsU0FBU0UsSUFBekUsRUFBK0VGLFFBQS9FLENBQVg7QUFDQVcsZ0JBQVkvRixPQUFaLENBQW9CLElBQUlnRyxvQkFBSixDQUF5QkgsSUFBekIsQ0FBcEI7QUFDQTtBQUNEO0FBQ0Y7O0FBRUQ7Ozs7QUFJQSxTQUFTSSxhQUFULENBQXVCWixNQUF2QixFQUErQkMsSUFBL0IsRUFBcUM7QUFDbkM7QUFDQSxNQUFJRCxTQUFTQyxJQUFiLEVBQW1CO0FBQ2pCLFFBQUlDLFVBQVVGLE1BQWQ7QUFDQUEsYUFBU0MsSUFBVDtBQUNBQSxXQUFPQyxPQUFQO0FBQ0Q7QUFDRCxNQUFJWCxTQUFTWSxPQUFPQyxhQUFQLENBQXFCSixNQUFyQixFQUE2QkMsSUFBN0IsQ0FBYjtBQUNBMUY7QUFDQVksVUFBUUMsR0FBUixDQUFZbUUsTUFBWjs7QUFFQSxNQUFJaUIsT0FBTyxJQUFJQyxJQUFKLENBQVNsQixPQUFPZSxhQUFoQixFQUErQmYsT0FBT2dCLFdBQXRDLEVBQW1EUCxNQUFuRCxFQUEyREMsSUFBM0QsQ0FBWDtBQUNBUyxjQUFZL0YsT0FBWixDQUFvQixJQUFJZ0csb0JBQUosQ0FBeUJILElBQXpCLENBQXBCO0FBQ0EsU0FBT0EsSUFBUDtBQUNEOztBQUVELFNBQVNLLGFBQVQsR0FBeUI7QUFDdkJyRyxZQUFVTyxJQUFWLENBQWUsS0FBS3lGLElBQXBCO0FBQ0FqRixXQUFTbUMsY0FBVCxDQUF3QixjQUF4QixFQUF3Q29ELFlBQXhDLENBQXFELEtBQUtOLElBQUwsQ0FBVU8sSUFBL0QsRUFBcUV4RixTQUFTbUMsY0FBVCxDQUF3QixjQUF4QixFQUF3Q3NELFVBQTdHO0FBQ0Q7O0FBRUQsU0FBU0MsVUFBVCxHQUFzQjtBQUNwQjtBQUNBOzs7Ozs7Ozs7QUFTQTtBQUNBOzs7Ozs7O0FBT0EzQztBQUNBRSxlQUFhLEtBQUtnQyxJQUFsQjtBQUNBLFNBQU8sS0FBS0EsSUFBWjtBQUNEOztBQUVELFNBQVNoQyxZQUFULENBQXNCZ0MsSUFBdEIsRUFBNEI7QUFDMUJVLHdCQUFzQixLQUF0QjtBQUNBVixPQUFLTyxJQUFMLENBQVVJLE1BQVY7QUFDQVgsT0FBS0gsT0FBTCxHQUFlLElBQWY7QUFDRDs7QUFFRCxTQUFTakUsUUFBVCxDQUFrQmdGLE9BQWxCLEVBQTJCQyxRQUEzQixFQUFxQ0MsV0FBckMsRUFBa0Q7QUFDaEQsTUFBSUMsSUFBSWhHLFNBQVNpRyxhQUFULENBQXVCLEdBQXZCLENBQVI7O0FBR0Q7QUFDQyxNQUFJNUMsT0FBTyxJQUFJNkMsSUFBSixDQUFTLENBQUNMLE9BQUQsQ0FBVCxFQUFvQjtBQUM3Qk0sVUFBTUo7QUFEdUIsR0FBcEIsQ0FBWDs7QUFJQUMsSUFBRUksSUFBRixHQUFTQyxJQUFJQyxlQUFKLENBQW9CakQsSUFBcEIsQ0FBVDtBQUNBMkMsSUFBRW5GLFFBQUYsR0FBYWlGLFFBQWI7QUFDQUUsSUFBRU8sS0FBRjtBQUNBUCxJQUFFSixNQUFGO0FBS0Q7O0FBSUQsU0FBU1ksdUJBQVQsR0FBbUM7O0FBRTdCNUcsVUFBUUMsR0FBUixDQUFZNEcscUJBQVo7O0FBRUEsTUFBSUMsZ0JBQWdCRCxxQkFBcEI7QUFDQSxNQUFJeEMsaUJBQWlCdEQsS0FBS3VELEtBQUwsQ0FBV3dDLGFBQVgsQ0FBckI7QUFDQTlHLFVBQVFDLEdBQVIsQ0FBWW9FLGNBQVo7QUFDQSxPQUFLLElBQUlFLElBQUksQ0FBYixFQUFnQkEsSUFBSUYsZUFBZTlELE1BQW5DLEVBQTJDZ0UsR0FBM0MsRUFBZ0Q7QUFDOUNDLDJCQUF1QkgsZUFBZUUsQ0FBZixDQUF2QjtBQUNIO0FBRUo7O0FBRUQsU0FBU3dDLHVCQUFULEdBQW1DO0FBQ2pDLE1BQUlDLGlCQUFpQkMsc0JBQXJCO0FBQ0EsTUFBSTVDLGlCQUFpQnRELEtBQUt1RCxLQUFMLENBQVcwQyxjQUFYLENBQXJCO0FBQ0FoSCxVQUFRQyxHQUFSLENBQVlvRSxjQUFaO0FBQ0EsT0FBSyxJQUFJRSxJQUFJLENBQWIsRUFBZ0JBLElBQUlGLGVBQWU5RCxNQUFuQyxFQUEyQ2dFLEdBQTNDLEVBQWdEO0FBQzlDQywyQkFBdUJILGVBQWVFLENBQWYsQ0FBdkI7QUFDRDtBQUNGOztBQUVELFNBQVMyQyw4QkFBVCxHQUEwQztBQUN4QyxNQUFJRixpQkFBaUJHLHlCQUFyQjtBQUNBLE1BQUk5QyxpQkFBaUJ0RCxLQUFLdUQsS0FBTCxDQUFXMEMsY0FBWCxDQUFyQjtBQUNBaEgsVUFBUUMsR0FBUixDQUFZb0UsY0FBWjtBQUNBLE9BQUssSUFBSUUsSUFBSSxDQUFiLEVBQWdCQSxJQUFJRixlQUFlOUQsTUFBbkMsRUFBMkNnRSxHQUEzQyxFQUFnRDtBQUM5Q0MsMkJBQXVCSCxlQUFlRSxDQUFmLENBQXZCO0FBQ0Q7QUFDRjs7QUFHRCxJQUFLNkMsdUJBQXVCLFNBQXZCQSxvQkFBdUIsR0FBVzs7QUFFckM7QUFDQSxNQUFJbkYsTUFBTSxJQUFJQyxjQUFKLEVBQVY7QUFDQUQsTUFBSUUsSUFBSixDQUFTLEtBQVQsRUFBZ0IsaUZBQWhCLEVBQW1HLElBQW5HO0FBQ0FGLE1BQUlHLGtCQUFKLEdBQXlCLFlBQVk7QUFDbkMsUUFBSSxLQUFLQyxVQUFMLEtBQW9CLENBQXhCLEVBQTJCO0FBQzNCLFFBQUksS0FBS0MsTUFBTCxLQUFnQixHQUFwQixFQUF5QixPQUZVLENBRUY7QUFDakNsQyxhQUFTbUMsY0FBVCxDQUF3Qix1QkFBeEIsRUFBaURDLFNBQWpELEdBQTZELEtBQUtDLFlBQWxFO0FBQ0FSLFFBQUlTLElBQUo7QUFDQTFDLFlBQVFDLEdBQVIsQ0FBWSxVQUFaOztBQUVBOzs7Ozs7Ozs7O0FBVUE7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQW9CRCxHQXJDRDtBQXNDRCxDQTNDRDtBQTRDQSIsImZpbGUiOiJjYXJkTWFuYWdlci5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciBudW1iZXJPZkNhcmQgPSAwO1xudmFyIGFycmF5Q2FyZCA9IFtdO1xuLy92YXIgYXJyYXlDYXJkRGVsZXRlZCA9IFtdO1xudmFyIGNvbW1hbmRzID0gW107XG5cblxuXG52YXIgQ2FyZE1hbmFnZXIgPSBmdW5jdGlvbigpIHtcbiAgLy9JIGltcGxlbWVudGVkIGEgY29tbWFuZCBwYXR0ZXJuLCBzZWUgOiBodHRwczovL3d3dy5kb2ZhY3RvcnkuY29tL2phdmFzY3JpcHQvY29tbWFuZC1kZXNpZ24tcGF0dGVyblxuICByZXR1cm4ge1xuICAgIC8vZXhlY3V0ZSBhIGNvbW1hbmRcbiAgICBleGVjdXRlOiBmdW5jdGlvbihjb21tYW5kKSB7XG4gICAgIGNvbW1hbmQuZXhlY3V0ZSgpO1xuICAgICAgLy9XZSBzZW5kIHRoZSBjb21tYW5kIHRvIHRoZSBzZXJ2ZXIgKHRoZSBzZXJ2ZXIgbG9nIGl0IGludG8gYSBmaWxlLCBzZWUgLi9zcmMvc2VydmVyL1NlcnZlckxvZ2dlcilcbiAgICAgIGxvZ2dlci5zZW5kQW5kTG9nQ29tbWFuZChjb21tYW5kKTtcbiAgICAgIC8vYW5kIHdlIHNhdmUgdGhlIGNvbW1hbmQgY3JlYXRlZFxuICAgICAgY29tbWFuZHMucHVzaChjb21tYW5kKTtcbiAgICB9LFxuICAgIC8vVW5kbyBhIGNvbW1hbmRcbiAgICB1bmRvOiBmdW5jdGlvbigpIHtcbiAgICAgIC8vVE9ET1xuICAgICAgdmFyIGNvbW1hbmQgPSBjb21tYW5kcy5wb3AoKTtcbiAgICAgIGNvbW1hbmQudW5kbygpO1xuICAgIH0sXG4gICAgZXhwb3J0Q2FyZDogZnVuY3Rpb24oKXtcbiAgICAgIGNvbnNvbGUubG9nKFwiZnVuY3Rpb24gZXhwb3J0IGNhcmRcIik7XG4gICAgICAvKi0tLS0tLSBDcmVhdGUgYSBzZXQgb2YgY2FyZCBmcm9tIGEgSlNPTiBmaWxlIC0tLS0tLS0qL1xuICAgICAgdmFyIGFycmF5SXRlbVVwZGF0ZWQgPSBbXTtcbiAgICAgIHZhciBsaXN0U2VnbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ3NlZ21lbnQnKTtcbiAgICAgIC8vcGxheUNhcmQoYXJyYXlJdGVtLmlEaXYsIGFycmF5SXRlbS5zdGFydFApO1xuICAgICAgY29uc29sZS5sb2cobGlzdFNlZ21lbnQpO1xuICBcbiAgXG4gICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpc3RTZWdtZW50Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGxpc3RTZWdtZW50W2ldLmlkKTsgLy9zZWNvbmQgY29uc29sZSBvdXRwdXRcbiAgICAgICAgdHJpZ2dlck1vdXNlRXZlbnQobGlzdFNlZ21lbnRbaV0sJ21vdXNlZG93bicpO1xuICAgICAgfVxuICAgICAgICBhcnJheUNhcmQuZm9yRWFjaChmdW5jdGlvbihhcnJheUl0ZW0pIHtcbiAgICAgICAgICBjb25zb2xlLmxvZyhhcnJheUl0ZW0pO1xuICAgICAgICAgIHZhciBpdGVtID0gYXJyYXlJdGVtLnVwZGF0ZUluZm8oKTtcbiAgICAgICAgICBhcnJheUl0ZW1VcGRhdGVkLnB1c2goaXRlbSk7XG4gICAgICAgICAgY29uc29sZS5sb2coaXRlbSk7XG4gICAgICAgIH0pO1xuICAgICAgICB2YXIgc2VyaWFsaXplZEFyciA9IEpTT04uc3RyaW5naWZ5KGFycmF5SXRlbVVwZGF0ZWQpO1xuICAgICAgICBjb25zb2xlLmxvZyhcIioqKioqICBTZXJpYWxpc2F0aW9uIG9mIGNhcmQgY29tcGxldGUgOiBcIiArIHNlcmlhbGl6ZWRBcnIpO1xuICAgICAgICBkb3dubG9hZChzZXJpYWxpemVkQXJyLCAnanNvblcybG9nLScgKyBjcmVhdGVVbmlxdWVJZCgpICsgJy5qc29uJywgJ3RleHQvcGxhaW4nKTtcbiAgICAgICAgXG4gICAgICAgIGxvZ2dlci5zYXZlU0goc2VyaWFsaXplZEFycik7XG4gICAgfSwgbG9hZFNlZ21lbnRIaXN0b3J5RnJvbVNlcnZlcjogZnVuY3Rpb24oKXtcbiAgICBcbiAgICBcbiAgICAgICQuZ2V0KCcvcHVibGljL2xvZ1cySnNvbicsIChkYXRhKSA9PlxuICAgICAge1xuICAgICAgICBjb25zb2xlLmxvZyhkYXRhKTtcbiAgICAgICAgbGV0IGxpc3RpbmcgPSBwYXJzZURpcmVjdG9yeUxpc3RpbmcoZGF0YSk7XG4gICAgICAgICQoJ2JvZHknKS5hcHBlbmQoSlNPTi5zdHJpbmdpZnkobGlzdGluZykpO1xuICAgICAgfSk7XG4gICAgXG4gICAgICBmdW5jdGlvbiBwYXJzZURpcmVjdG9yeUxpc3RpbmcodGV4dClcbiAgICAgIHtcbiAgICAgICAgbGV0IGRvY3MgPSB0ZXh0XG4gICAgICAgICAgLm1hdGNoKC9ocmVmPVwiKFtcXHddKykvZykgLy8gcHVsbCBvdXQgdGhlIGhyZWZzXG4gICAgICAgICAgLm1hcCgoeCkgPT4geC5yZXBsYWNlKCdocmVmPVwiJywgJycpKTsgLy8gY2xlYW4gdXBcbiAgICAgICAgY29uc29sZS5sb2coZG9jcyk7XG4gICAgICAgIHJldHVybiBkb2NzO1xuICAgICAgfVxuICAgIFxuICAgIFxuICAgIFxuICAgIFxuICAgICAgLy9XZSBjaGFyZ2UgYWxsIHRoZSB2aWRlbyBvbmx5IG9uZSB0aW1lXG4gICAgICAgIHZhciB4aHIgPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcbiAgICAgICAgeGhyLm9wZW4oJ1BPU1QnLCAnc3JjL2NsaWVudC9qcy93b3Jrc2hvcDIvdGVjaG5vbG9neVByb2JlL2NhcmRfbWFuYWdlci9TSExvYWRlck92ZXJ2aWV3X3ZpZXcuaHRtbCcsIHRydWUpO1xuICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaWYgKHRoaXMucmVhZHlTdGF0ZSAhPT0gNClcbiAgICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgIFxuICAgICAgICAgIGlmICh0aGlzLnN0YXR1cyAhPT0gMjAwKVxuICAgICAgICAgICAgcmV0dXJuO1xuICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdTSFBpY2tlck92ZXJ2aWV3TW9kYWwnKS5pbm5lckhUTUwgPSB0aGlzLnJlc3BvbnNlVGV4dDtcbiAgICAgICAgfTtcbiAgICAgIHhoci5zZW5kKCk7XG4gICAgICB4aHIub3BlbignR0VUJywgJ3B1YmxpYy9sb2dXMkpzb24vaXBhZDIuanNvbicsIHRydWUpO1xuICAgICAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgY29uc29sZS5sb2codGhpcy5yZXNwb25zZVRleHQpO1xuICAgICAgfTtcbiAgICAgIHhoci5zZW5kKCk7XG4gICAgXG4gICAgXG4gICAgfSxcbiAgICBcbiAgICBcbiAgfVxufTtcblxuXG4vKlByaXZhdGUgZnVuY3Rpb24sIGRvIG5vdCBjYWxsIG91dHNpZGUgdGhlIENhcmRNYW5hZ2VyKi9cblxuXG5mdW5jdGlvbiB0cmlnZ2VyTW91c2VFdmVudCAobm9kZSwgZXZlbnRUeXBlKSB7XG4gIHZhciBjbGlja0V2ZW50ID0gZG9jdW1lbnQuY3JlYXRlRXZlbnQgKCdNb3VzZUV2ZW50cycpO1xuICBjbGlja0V2ZW50LmluaXRFdmVudCAoZXZlbnRUeXBlLCB0cnVlLCB0cnVlKTtcbiAgbm9kZS5kaXNwYXRjaEV2ZW50IChjbGlja0V2ZW50KTtcbn1cblxuLyoqKiogRnVuY3Rpb25hbCBjb3JlIG9mIHRoZSBjYXJkIG1hbmFnZXIgKGNyZWF0ZSBhIGNhcnQsIGRlbGV0ZSBhIGNhcmQgYW5kIHNhdmUgY2FyZCkgKioqKiovXG4vKipcbiAqIFRoaXMgY2xhc3MgbWFuYWcgYWxsIHRoZSBjYXJkcyBjcmVhdGVkLiBUaGlzIGlzIHRoZSBzZWdtZW50IGhpc3RvcnkuXG4gKiBAdHlwZSB7SFRNTEVsZW1lbnQgfCBudWxsfVxuICovXG52YXIgd3JhcHBlckNvbW1hbmRBbmRSYW5nZSA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwid3JhcHBlckNvbW1hbmRBbmRSYW5nZWlkXCIpO1xuXG5cblxuZnVuY3Rpb24gY2xlYW5TZWdtZW50SGlzdG9yeSgpe1xuICBjb25zb2xlLmxvZyhcIlRFU1RJTkdcIik7XG4gIGNsZWFyQWxsVGltZXIoKTtcbiAgYXJyYXlDYXJkLmZvckVhY2goZnVuY3Rpb24oZSl7XG4gICAgICBkZWxldGVDYXJkVUkoZSk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBsb2FkSlNPTigpIHtcbiAgdmFyIGZpbGVzID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xvZ0ZpbGVMb2FkJykuZmlsZXM7XG4gIGlmICghZmlsZXMubGVuZ3RoKSB7XG4gICAgYWxlcnQoJ1BsZWFzZSBzZWxlY3QgYSBmaWxlIScpO1xuICAgIHJldHVybjtcbiAgfVxuICBcbiAgdmFyIGZpbGUgPSBmaWxlc1swXTtcbiAgdmFyIHN0YXJ0ID0gIDA7XG4gIHZhciBzdG9wID0gZmlsZS5zaXplIC0gMTtcbiAgXG4gIHZhciByZWFkZXIgPSBuZXcgRmlsZVJlYWRlcigpO1xuICB2YXIgdGVzdCA9IDA7XG4gIC8vIElmIHdlIHVzZSBvbmxvYWRlbmQsIHdlIG5lZWQgdG8gY2hlY2sgdGhlIHJlYWR5U3RhdGUuXG4gIHJlYWRlci5vbmxvYWRlbmQgPSBmdW5jdGlvbihldnQpIHtcbiAgICBpZiAoZXZ0LnRhcmdldC5yZWFkeVN0YXRlID09IEZpbGVSZWFkZXIuRE9ORSkgeyAvLyBET05FID09IDJcbiAgICAgIHZhciB0ZXN0ID0gZXZ0LnRhcmdldC5yZXN1bHQ7XG4gICAgICBjb25zb2xlLmxvZygnUmVhZCBieXRlczogJywgc3RhcnQgKyAxLCAnIC0gJywgc3RvcCArIDEsXG4gICAgICAgICAgJyBvZiAnLCBmaWxlLnNpemUsICcgYnl0ZSBmaWxlJyApO1xuICAgICAgY29uc29sZS5sb2codGVzdCk7XG4gICAgICB2YXIgbXlfSlNPTl9vYmplY3QgPSBKU09OLnBhcnNlKHRlc3QpO1xuICBcbiAgICAgIGNvbnNvbGUubG9nKG15X0pTT05fb2JqZWN0KTtcbiAgXG4gICAgICBmb3IgKGxldCBrID0gMDsgayA8IG15X0pTT05fb2JqZWN0Lmxlbmd0aDsgaysrKSB7XG4gICAgICAgIGFkZGluZ05ld0NhcmRzRnJvbUpTb24obXlfSlNPTl9vYmplY3Rba10pO1xuICAgICAgfVxuICAgIH1cbiAgfTtcbiAgdmFyIGJsb2IgPSBmaWxlLnNsaWNlKHN0YXJ0LCBzdG9wICsgMSk7XG4gIHJlYWRlci5yZWFkQXNCaW5hcnlTdHJpbmcoYmxvYik7XG59XG5cbi8vQWRkIGEgY2FyZCBmcm9tIGEganNvbiBmaWxlXG5mdW5jdGlvbiBhZGRpbmdOZXdDYXJkc0Zyb21KU29uKGNhcmRJbmZvKSB7XG4gIGlmIChjYXJkSW5mby5zdGFydFAgPiBjYXJkSW5mby5lbmRQKSB7XG4gICAgbGV0IHRyYW5zaXQgPSBjYXJkSW5mby5zdGFydFA7XG4gICAgY2FyZEluZm8uc3RhcnRQID0gY2FyZEluZm8uZW5kUDtcbiAgICBjYXJkSW5mby5lbmRQID0gdHJhbnNpdDtcbiAgfVxuICBpZiAoY2FyZEluZm8uc3RhcnRQIDwgMCkge1xuICAgIGNhcmRJbmZvLnN0YXJ0UCA9IDA7XG4gIH1cbiAgY29uc29sZS5sb2coY2FyZEluZm8uc3RhcnRQLCBjYXJkSW5mby5lbmRQKTtcbiAgbGV0IHJlc3VsdCA9IFBsYXllci5zbGlkZXJUb1ZpZGVvKGNhcmRJbmZvLnN0YXJ0UCwgY2FyZEluZm8uZW5kUCk7XG4gIC8vY29uc29sZS5sb2cocmVzdWx0KTtcbiAgbnVtYmVyT2ZDYXJkKys7XG4gIGlmICghY2FyZEluZm8uZGVsZXRlZCkge1xuICAgIGNvbnNvbGUubG9nKHJlc3VsdC5zdGFydER1cmF0aW9uLCByZXN1bHQuZW5kRHVyYXRpb24sIGNhcmRJbmZvLnN0YXJ0UCwgY2FyZEluZm8uZW5kUCwgY2FyZEluZm8pO1xuICAgIHZhciBjYXJkID0gQ2FyZChyZXN1bHQuc3RhcnREdXJhdGlvbiwgcmVzdWx0LmVuZER1cmF0aW9uLCBjYXJkSW5mby5zdGFydFAsIGNhcmRJbmZvLmVuZFAsIGNhcmRJbmZvKTtcbiAgICBjYXJkTWFuYWdlci5leGVjdXRlKG5ldyBDcmVhdGVOZXdDYXJkQ29tbWFuZChjYXJkKSk7XG4gICAgLy9kb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGl2Q2FyZEJvYXJkJykuaW5zZXJ0QmVmb3JlKGNhcmQuaURpdiwgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RpdkNhcmRCb2FyZCcpLmZpcnN0Q2hpbGQpO1xuICB9XG59XG5cbi8qKlxuICogQWRkaW5nIGEgY2FyZCBieSBkcmFnIGFuZCBkcm9wLiBUaGUgY2FyZCBpcyBhZGRlZCBpbiB0aGUgbGlzdCBvZiBjYXJkc1xuICogUmV0dXJuIHRoZSBjYXJkIHRoYXQgaGF2ZSBiZWVuIGNyZWF0ZWRcbiAqL1xuZnVuY3Rpb24gY3JlYXRlTmV3Q2FyZChzdGFydFAsIGVuZFApIHtcbiAgLy9jb25zb2xlLmxvZyhcIlRFU1QgLyA6IFwiICsgc3RhcnRQICsgXCIgXCIgKyBlbmRQKTtcbiAgaWYgKHN0YXJ0UCA+IGVuZFApIHtcbiAgICBsZXQgdHJhbnNpdCA9IHN0YXJ0UDtcbiAgICBzdGFydFAgPSBlbmRQO1xuICAgIGVuZFAgPSB0cmFuc2l0O1xuICB9XG4gIGxldCByZXN1bHQgPSBQbGF5ZXIuc2xpZGVyVG9WaWRlbyhzdGFydFAsIGVuZFApO1xuICBudW1iZXJPZkNhcmQrKztcbiAgY29uc29sZS5sb2cocmVzdWx0KTtcbiAgXG4gIHZhciBjYXJkID0gbmV3IENhcmQocmVzdWx0LnN0YXJ0RHVyYXRpb24sIHJlc3VsdC5lbmREdXJhdGlvbiwgc3RhcnRQLCBlbmRQKTtcbiAgY2FyZE1hbmFnZXIuZXhlY3V0ZShuZXcgQ3JlYXRlTmV3Q2FyZENvbW1hbmQoY2FyZCkpO1xuICByZXR1cm4gY2FyZDtcbn1cblxuZnVuY3Rpb24gYWRkaW5nTmV3Q2FyZCgpIHtcbiAgYXJyYXlDYXJkLnB1c2godGhpcy5jYXJkKTtcbiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RpdkNhcmRCb2FyZCcpLmluc2VydEJlZm9yZSh0aGlzLmNhcmQuaURpdiwgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RpdkNhcmRCb2FyZCcpLmZpcnN0Q2hpbGQpO1xufVxuXG5mdW5jdGlvbiBkZWxldGVDYXJkKCkge1xuICAvL1N1cHByaW1lIGxhIGNhcnRlIGRlIGxhIGxpc3RlIGRlIGNhcnRlXG4gIC8qZm9yIChsZXQgaSA9IDA7IGkgPCBhcnJheUNhcmQubGVuZ3RoICAgOyBpKyspIHtcbiAgICBpZihhcnJheUNhcmRbaV0gID09PSBjYXJkKXtcbiAgICAgIHZhciBzdXBDYXJkID0gYXJyYXlDYXJkLnNwbGljZShpLDEpO1xuICAgICAgYXJyYXlDYXJkRGVsZXRlZC5wdXNoKHN1cENhcmQpO1xuICAgICAgY29uc29sZS5sb2coXCJkZWxldGVkIGNhcmQgOiBcIik7XG4gICAgICBjb25zb2xlLmxvZyhzdXBDYXJkKTtcbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgfSovXG4gIC8vZGVsZXRlQ2FyZFVJKGNhcmQpO1xuICAvKmFycmF5Q2FyZERlbGV0ZWQuZm9yRWFjaChmdW5jdGlvbihlbGVtZW50KSB7XG4gICAgY29uc29sZS5sb2coICAgZWxlbWVudCk7XG4gIH0pO1xuICBjb25zb2xlLmxvZyhcIioqKioqKioqKioqKioqKioqKioqKioqKlwiKTtcbiAgYXJyYXlDYXJkLmZvckVhY2goZnVuY3Rpb24oZWxlbWVudCkge1xuICAgIGNvbnNvbGUubG9nKGVsZW1lbnQpO1xuICB9KTsqL1xuICBjbGVhckFsbFRpbWVyKCk7XG4gIGRlbGV0ZUNhcmRVSSh0aGlzLmNhcmQpO1xuICByZXR1cm4gdGhpcy5jYXJkO1xufVxuXG5mdW5jdGlvbiBkZWxldGVDYXJkVUkoY2FyZCkge1xuICBmZWVkYmFja09uU2xpZGVyVmlkZW8oZmFsc2UpO1xuICBjYXJkLmlEaXYucmVtb3ZlKCk7XG4gIGNhcmQuZGVsZXRlZCA9IHRydWVcbn1cblxuZnVuY3Rpb24gZG93bmxvYWQoY29udGVudCwgZmlsZU5hbWUsIGNvbnRlbnRUeXBlKSB7XG4gIHZhciBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFcIik7XG4gIFxuICBcbiAvL2Euc3R5bGUuZGlzcGxheSA9IFwiYmxvY2tcIjtcbiAgdmFyIGZpbGUgPSBuZXcgQmxvYihbY29udGVudF0sIHtcbiAgICB0eXBlOiBjb250ZW50VHlwZVxuICB9KTtcbiAgXG4gIGEuaHJlZiA9IFVSTC5jcmVhdGVPYmplY3RVUkwoZmlsZSk7XG4gIGEuZG93bmxvYWQgPSBmaWxlTmFtZTtcbiAgYS5jbGljaygpO1xuICBhLnJlbW92ZSgpO1xuICBcbiAgXG4gIFxuICBcbn1cblxuXG5cbmZ1bmN0aW9uIGxvYWRKU09OU2VnbWVudEhpc3RvcnkxKCkge1xuICBcbiAgICAgIGNvbnNvbGUubG9nKGdlbmVyYXRlSlNPTmZyb212YXIoKSk7XG4gICAgICBcbiAgICAgIGxldCBnZW5lcmF0ZWRKc29uID0gZ2VuZXJhdGVKU09OZnJvbXZhcigpO1xuICAgICAgdmFyIG15X0pTT05fb2JqZWN0ID0gSlNPTi5wYXJzZShnZW5lcmF0ZWRKc29uKTtcbiAgICAgIGNvbnNvbGUubG9nKG15X0pTT05fb2JqZWN0KTtcbiAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgbXlfSlNPTl9vYmplY3QubGVuZ3RoOyBrKyspIHtcbiAgICAgICAgYWRkaW5nTmV3Q2FyZHNGcm9tSlNvbihteV9KU09OX29iamVjdFtrXSk7XG4gICAgfVxuICBcbn1cblxuZnVuY3Rpb24gbG9hZEpTT05TZWdtZW50SGlzdG9yeTIoKSB7XG4gIGxldCBnZW5lcmF0ZWRKc29uMiA9IGdlbmVyYXRlSlNPTmZyb212YXIyKCk7XG4gIHZhciBteV9KU09OX29iamVjdCA9IEpTT04ucGFyc2UoZ2VuZXJhdGVkSnNvbjIpO1xuICBjb25zb2xlLmxvZyhteV9KU09OX29iamVjdCk7XG4gIGZvciAobGV0IGsgPSAwOyBrIDwgbXlfSlNPTl9vYmplY3QubGVuZ3RoOyBrKyspIHtcbiAgICBhZGRpbmdOZXdDYXJkc0Zyb21KU29uKG15X0pTT05fb2JqZWN0W2tdKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBsb2FkSlNPTlNlZ21lbnRIaXN0b3J5VHV0b3JpYWwoKSB7XG4gIGxldCBnZW5lcmF0ZWRKc29uMiA9IGdlbmVyYXRlSlNPTmZyb212YXJUdXRvKCk7XG4gIHZhciBteV9KU09OX29iamVjdCA9IEpTT04ucGFyc2UoZ2VuZXJhdGVkSnNvbjIpO1xuICBjb25zb2xlLmxvZyhteV9KU09OX29iamVjdCk7XG4gIGZvciAobGV0IGsgPSAwOyBrIDwgbXlfSlNPTl9vYmplY3QubGVuZ3RoOyBrKyspIHtcbiAgICBhZGRpbmdOZXdDYXJkc0Zyb21KU29uKG15X0pTT05fb2JqZWN0W2tdKTtcbiAgfVxufVxuXG5cbnZhciAgbG9hZFNISGlzdG9yeWZyb21TcnYgPSBmdW5jdGlvbigpIHtcbiAgXG4gIC8vV2UgY2hhcmdlIGFsbCB0aGUgdmlkZW8gb25seSBvbmUgdGltZVxuICB2YXIgeGhyID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XG4gIHhoci5vcGVuKCdHRVQnLCAnc3JjL2NsaWVudC9qcy93b3Jrc2hvcDIvdGVjaG5vbG9neVByb2JlL2NhcmRfbWFuYWdlci9TSExvYWRlck92ZXJ2aWV3X3ZpZXcuaHRtbCcsIHRydWUpO1xuICB4aHIub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24gKCkge1xuICAgIGlmICh0aGlzLnJlYWR5U3RhdGUgIT09IDQpIHJldHVybjtcbiAgICBpZiAodGhpcy5zdGF0dXMgIT09IDIwMCkgcmV0dXJuOyAvLyBvciB3aGF0ZXZlciBlcnJvciBoYW5kbGluZyB5b3Ugd2FudFxuICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdTSFBpY2tlck92ZXJ2aWV3TW9kYWwnKS5pbm5lckhUTUwgPSB0aGlzLnJlc3BvbnNlVGV4dDtcbiAgICB4aHIuc2VuZCgpO1xuICAgIGNvbnNvbGUubG9nKCdIQUhBSEFIQScpXG4gIFxuICAgIC8qXG4gICAgLy9Db2RlIHBlcm1ldHRhbnQgZGUgY2hhcmdlciB1biBTSCwgaWwgc3VmZml0IGRlIHJlY3VwZXJlciB0b3VzIGxlcyBTSCBkdSBzZXJ2ZXIsXG4gICAgLy8gcHVpcyBkZSBsZXMgZW50cmVyIGRhbnMgdW5lIGRpdiBjb3JyZXNwb25kYW50ZSwgw6BhIGRvaXQgZmFpcmUgdW4gb3ZlcnZpZXcgamUgcGVuc2VcbiAgICBsZXQgZ2VuZXJhdGVkSnNvbiA9IGdlbmVyYXRlSlNPTmZyb212YXIoKTtcbiAgICB2YXIgbXlfSlNPTl9vYmplY3QgPSBKU09OLnBhcnNlKGdlbmVyYXRlZEpzb24pO1xuICAgIGNvbnNvbGUubG9nKG15X0pTT05fb2JqZWN0KTtcbiAgICBmb3IgKGxldCBrID0gMDsgayA8IG15X0pTT05fb2JqZWN0Lmxlbmd0aDsgaysrKSB7XG4gICAgICBhZGRpbmdOZXdDYXJkc0Zyb21KU29uKG15X0pTT05fb2JqZWN0W2tdKTtcbiAgICB9Ki9cbiAgICBcbiAgICAvKnZhciBlbG1zID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3ZpZGVvUGlja2VyT3ZlcnZpZXdNb2RhbCcpLmdldEVsZW1lbnRzQnlUYWdOYW1lKFwiZGl2XCIpO1xuICAgIHZhciB2aWRlbyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd2aWRlb0VBVCcpO1xuICAgIHZhciBzcGFuID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShcImNsb3NlXCIpWzBdO1xuICAgIFxuICAgIHNwYW4uYWRkRXZlbnRMaXN0ZW5lciggXCJtb3VzZWRvd25cIiAsIGZ1bmN0aW9uKCkge1xuICAgICAgbW9kYWxWaWRlby5zdHlsZS5kaXNwbGF5ID0gXCJub25lXCI7XG4gICAgfSk7XG4gICAgZm9yICh2YXIgaSA9IDA7IGkgPCBlbG1zLmxlbmd0aDsgaSsrKSB7XG4gICAgICBlbG1zW2ldLmFkZEV2ZW50TGlzdGVuZXIoXCJtb3VzZWRvd25cIiwgZnVuY3Rpb24gKCl7XG4gICAgICAgIC8vY29uc29sZS5sb2codGhpcy5nZXRFbGVtZW50c0J5VGFnTmFtZShcInNvdXJjZVwiKVswXS5zcmMpO1xuICAgICAgICB2aWRlby5zcmMgPSB0aGlzLmdldEVsZW1lbnRzQnlUYWdOYW1lKFwic291cmNlXCIpWzBdLnNyYztcbiAgICAgICAgdmFyIG5vdGlmaWNhdGlvbl9mZWVkYmFjayA9IFwiVmlkZW8gc3VjY2Vzc2Z1bGx5IGxvYWRlZCFcIjtcbiAgICAgICAgbm90aWZpY2F0aW9uRmVlZGJhY2sobm90aWZpY2F0aW9uX2ZlZWRiYWNrKTtcbiAgICAgICAgLy9tb2RhbFZpZGVvLnN0eWxlLmRpc3BsYXkgPSBcIm5vbmVcIjtcbiAgICAgICAgLy9tb2RhbFZpZGVvLnN0eWxlLnZpc2liaWxpdHkgPSBcImhpZGRlblwiO1xuICAgICAgfSk7XG4gICAgfVxuICB9OyovXG4gIFxuICAgIFxuICB9XG59XG4vKlxuXG52YXIgc3BhbiA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoXCJjbG9zZVwiKVsxXTtcbnZhciBtb2RhbFNIID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ1NIUGlja2VyT3ZlcnZpZXcnKTtcblxuc3Bhbi5hZGRFdmVudExpc3RlbmVyKCBcIm1vdXNlZG93blwiICwgZnVuY3Rpb24oKSB7XG4gIG1vZGFsU0guc3R5bGUuZGlzcGxheSA9IFwibm9uZVwiO1xufSk7Ki9cbiJdfQ==