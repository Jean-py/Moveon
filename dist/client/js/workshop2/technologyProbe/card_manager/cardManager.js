'use strict';

var numberOfCard = 0;
var arrayCard = [];
//var arrayCardDeleted = [];
var commands = [];

var CardManager = function CardManager() {
  //I implemented a command pattern, see : https://www.dofactory.com/javascript/command-design-pattern
  return {
    //execute a command
    execute: function execute(command) {
      command.execute();
      //We send the command to the server (the server log it into a file, see ./src/server/ServerLogger)
      logger.sendAndLogCommand(command);
      //and we save the command created
      commands.push(command);
    },
    //Undo a command
    undo: function undo() {
      //TODO
      var command = commands.pop();
      command.undo();
    },
    exportCard: function exportCard() {
      console.log("function export card");
      /*------ Create a set of card from a JSON file -------*/
      var arrayItemUpdated = [];
      var listSegment = document.getElementsByClassName('segment');
      //playCard(arrayItem.iDiv, arrayItem.startP);
      console.log(listSegment);

      for (var i = 0; i < listSegment.length; i++) {
        console.log(listSegment[i].id); //second console output
        triggerMouseEvent(listSegment[i], 'mousedown');
      }
      arrayCard.forEach(function (arrayItem) {
        console.log(arrayItem);
        var item = arrayItem.updateInfo();
        arrayItemUpdated.push(item);
        console.log(item);
      });
      var serializedArr = JSON.stringify(arrayItemUpdated);
      console.log("*****  Serialisation of card complete : " + serializedArr);
      download(serializedArr, 'jsonW2log-' + createUniqueId() + '.json', 'text/plain');

      logger.saveSH(serializedArr);
    }, loadSegmentHistoryFromServer: function loadSegmentHistoryFromServer() {

      //We charge all the video only one time
      var xhr_view = new XMLHttpRequest();
      xhr_view.open('GET', 'src/client/js/workshop2/technologyProbe/card_manager/SHLoaderOverview_view.html', true);
      var view_SH_html = document.getElementById('SHPickerOverviewModal');

      xhr_view.onreadystatechange = function () {
        if (this.readyState !== 4) return;
        if (this.status !== 200) return; // or whatever error handling you want
        view_SH_html.innerHTML = this.responseText;
      };
      xhr_view.send();

      //We charge all the video only one time


      var xhr_allPath = new XMLHttpRequest();
      xhr_allPath.open('GET', 'src/server/log-SH/SH_all_path.txt', true);

      xhr_allPath.onreadystatechange = function () {
        if (this.readyState !== 4) return;
        if (this.status !== 200) return; // or whatever error handling you want


        var lines = this.responseText.split('\n');
        for (var j = 0; j < lines.length - 1; j++) {
          var xhr_SH = new XMLHttpRequest();
          xhr_SH.open('GET', lines[j], true);
          xhr_SH.onreadystatechange = function () {
            console.log(this.responseText);
          };
          xhr_SH.send();

          var div = document.createElement('div');
          div.className = 'gridSH';
          var split = lines[j].split('/');
          var nameSH = split[split.length - 1];
          console.log(nameSH);

          div.innerHTML = nameSH;
          document.getElementById('SH_list').appendChild(div);
        }
      };
      xhr_allPath.send();
    }

  };
};

/*Private function, do not call outside the CardManager*/

function triggerMouseEvent(node, eventType) {
  var clickEvent = document.createEvent('MouseEvents');
  clickEvent.initEvent(eventType, true, true);
  node.dispatchEvent(clickEvent);
}

/**** Functional core of the card manager (create a cart, delete a card and save card) *****/
/**
 * This class manag all the cards created. This is the segment history.
 * @type {HTMLElement | null}
 */
var wrapperCommandAndRange = document.getElementById("wrapperCommandAndRangeid");

function cleanSegmentHistory() {
  console.log("TESTING");
  clearAllTimer();
  arrayCard.forEach(function (e) {
    deleteCardUI(e);
  });
}

function loadJSON() {
  var files = document.getElementById('logFileLoad').files;
  if (!files.length) {
    alert('Please select a file!');
    return;
  }

  var file = files[0];
  var start = 0;
  var stop = file.size - 1;

  var reader = new FileReader();
  var test = 0;
  // If we use onloadend, we need to check the readyState.
  reader.onloadend = function (evt) {
    if (evt.target.readyState == FileReader.DONE) {
      // DONE == 2
      var test = evt.target.result;
      console.log('Read bytes: ', start + 1, ' - ', stop + 1, ' of ', file.size, ' byte file');
      console.log(test);
      var my_JSON_object = JSON.parse(test);

      console.log(my_JSON_object);

      for (var k = 0; k < my_JSON_object.length; k++) {
        addingNewCardsFromJSon(my_JSON_object[k]);
      }
    }
  };
  var blob = file.slice(start, stop + 1);
  reader.readAsBinaryString(blob);
}

//Add a card from a json file
function addingNewCardsFromJSon(cardInfo) {
  if (cardInfo.startP > cardInfo.endP) {
    var transit = cardInfo.startP;
    cardInfo.startP = cardInfo.endP;
    cardInfo.endP = transit;
  }
  if (cardInfo.startP < 0) {
    cardInfo.startP = 0;
  }
  console.log(cardInfo.startP, cardInfo.endP);
  var result = Player.sliderToVideo(cardInfo.startP, cardInfo.endP);
  //console.log(result);
  numberOfCard++;
  if (!cardInfo.deleted) {
    console.log(result.startDuration, result.endDuration, cardInfo.startP, cardInfo.endP, cardInfo);
    var card = Card(result.startDuration, result.endDuration, cardInfo.startP, cardInfo.endP, cardInfo);
    cardManager.execute(new CreateNewCardCommand(card));
    //document.getElementById('divCardBoard').insertBefore(card.iDiv, document.getElementById('divCardBoard').firstChild);
  }
}

/**
 * Adding a card by drag and drop. The card is added in the list of cards
 * Return the card that have been created
 */
function createNewCard(startP, endP) {
  //console.log("TEST / : " + startP + " " + endP);
  if (startP > endP) {
    var transit = startP;
    startP = endP;
    endP = transit;
  }
  var result = Player.sliderToVideo(startP, endP);
  numberOfCard++;
  console.log(result);

  var card = new Card(result.startDuration, result.endDuration, startP, endP);
  cardManager.execute(new CreateNewCardCommand(card));
  return card;
}

function addingNewCard() {
  arrayCard.push(this.card);
  document.getElementById('divCardBoard').insertBefore(this.card.iDiv, document.getElementById('divCardBoard').firstChild);
}

function deleteCard() {
  //Supprime la carte de la liste de carte
  /*for (let i = 0; i < arrayCard.length   ; i++) {
    if(arrayCard[i]  === card){
      var supCard = arrayCard.splice(i,1);
      arrayCardDeleted.push(supCard);
      console.log("deleted card : ");
      console.log(supCard);
      break;
    }
  }*/
  //deleteCardUI(card);
  /*arrayCardDeleted.forEach(function(element) {
    console.log(   element);
  });
  console.log("************************");
  arrayCard.forEach(function(element) {
    console.log(element);
  });*/
  clearAllTimer();
  deleteCardUI(this.card);
  return this.card;
}

function deleteCardUI(card) {
  feedbackOnSliderVideo(false);
  card.iDiv.remove();
  card.deleted = true;
}

function download(content, fileName, contentType) {
  var a = document.createElement("a");

  //a.style.display = "block";
  var file = new Blob([content], {
    type: contentType
  });

  a.href = URL.createObjectURL(file);
  a.download = fileName;
  a.click();
  a.remove();
}

function loadJSONSegmentHistory1() {

  console.log(generateJSONfromvar());

  var generatedJson = generateJSONfromvar();
  var my_JSON_object = JSON.parse(generatedJson);
  console.log(my_JSON_object);
  for (var k = 0; k < my_JSON_object.length; k++) {
    addingNewCardsFromJSon(my_JSON_object[k]);
  }
}

function loadJSONSegmentHistory2() {
  var generatedJson2 = generateJSONfromvar2();
  var my_JSON_object = JSON.parse(generatedJson2);
  console.log(my_JSON_object);
  for (var k = 0; k < my_JSON_object.length; k++) {
    addingNewCardsFromJSon(my_JSON_object[k]);
  }
}

function loadJSONSegmentHistoryTutorial() {
  var generatedJson2 = generateJSONfromvarTuto();
  var my_JSON_object = JSON.parse(generatedJson2);
  console.log(my_JSON_object);
  for (var k = 0; k < my_JSON_object.length; k++) {
    addingNewCardsFromJSon(my_JSON_object[k]);
  }
}

var loadSHHistoryfromSrv = function loadSHHistoryfromSrv() {

  //We charge all the video only one time
  var xhr = new XMLHttpRequest();
  xhr.open('GET', 'src/client/js/workshop2/technologyProbe/card_manager/SHLoaderOverview_view.html', true);
  xhr.onreadystatechange = function () {
    if (this.readyState !== 4) return;
    if (this.status !== 200) return; // or whatever error handling you want
    document.getElementById('SHPickerOverviewModal').innerHTML = this.responseText;
    xhr.send();
    console.log('HAHAHAHA');

    /*
    //Code permettant de charger un SH, il suffit de recuperer tous les SH du server,
    // puis de les entrer dans une div correspondante, Ã a doit faire un overview je pense
    let generatedJson = generateJSONfromvar();
    var my_JSON_object = JSON.parse(generatedJson);
    console.log(my_JSON_object);
    for (let k = 0; k < my_JSON_object.length; k++) {
      addingNewCardsFromJSon(my_JSON_object[k]);
    }*/

    /*var elms = document.getElementById('videoPickerOverviewModal').getElementsByTagName("div");
    var video = document.getElementById('videoEAT');
    var span = document.getElementsByClassName("close")[0];
    
    span.addEventListener( "mousedown" , function() {
      modalVideo.style.display = "none";
    });
    for (var i = 0; i < elms.length; i++) {
      elms[i].addEventListener("mousedown", function (){
        //console.log(this.getElementsByTagName("source")[0].src);
        video.src = this.getElementsByTagName("source")[0].src;
        var notification_feedback = "Video successfully loaded!";
        notificationFeedback(notification_feedback);
        //modalVideo.style.display = "none";
        //modalVideo.style.visibility = "hidden";
      });
    }
    };*/
  };
};
/*

var span = document.getElementsByClassName("close")[1];
var modalSH = document.getElementById('SHPickerOverview');

span.addEventListener( "mousedown" , function() {
  modalSH.style.display = "none";
});*/
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNhcmRNYW5hZ2VyLmpzIl0sIm5hbWVzIjpbIm51bWJlck9mQ2FyZCIsImFycmF5Q2FyZCIsImNvbW1hbmRzIiwiQ2FyZE1hbmFnZXIiLCJleGVjdXRlIiwiY29tbWFuZCIsImxvZ2dlciIsInNlbmRBbmRMb2dDb21tYW5kIiwicHVzaCIsInVuZG8iLCJwb3AiLCJleHBvcnRDYXJkIiwiY29uc29sZSIsImxvZyIsImFycmF5SXRlbVVwZGF0ZWQiLCJsaXN0U2VnbWVudCIsImRvY3VtZW50IiwiZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSIsImkiLCJsZW5ndGgiLCJpZCIsInRyaWdnZXJNb3VzZUV2ZW50IiwiZm9yRWFjaCIsImFycmF5SXRlbSIsIml0ZW0iLCJ1cGRhdGVJbmZvIiwic2VyaWFsaXplZEFyciIsIkpTT04iLCJzdHJpbmdpZnkiLCJkb3dubG9hZCIsImNyZWF0ZVVuaXF1ZUlkIiwic2F2ZVNIIiwibG9hZFNlZ21lbnRIaXN0b3J5RnJvbVNlcnZlciIsInhocl92aWV3IiwiWE1MSHR0cFJlcXVlc3QiLCJvcGVuIiwidmlld19TSF9odG1sIiwiZ2V0RWxlbWVudEJ5SWQiLCJvbnJlYWR5c3RhdGVjaGFuZ2UiLCJyZWFkeVN0YXRlIiwic3RhdHVzIiwiaW5uZXJIVE1MIiwicmVzcG9uc2VUZXh0Iiwic2VuZCIsInhocl9hbGxQYXRoIiwibGluZXMiLCJzcGxpdCIsImoiLCJ4aHJfU0giLCJkaXYiLCJjcmVhdGVFbGVtZW50IiwiY2xhc3NOYW1lIiwibmFtZVNIIiwiYXBwZW5kQ2hpbGQiLCJub2RlIiwiZXZlbnRUeXBlIiwiY2xpY2tFdmVudCIsImNyZWF0ZUV2ZW50IiwiaW5pdEV2ZW50IiwiZGlzcGF0Y2hFdmVudCIsIndyYXBwZXJDb21tYW5kQW5kUmFuZ2UiLCJjbGVhblNlZ21lbnRIaXN0b3J5IiwiY2xlYXJBbGxUaW1lciIsImUiLCJkZWxldGVDYXJkVUkiLCJsb2FkSlNPTiIsImZpbGVzIiwiYWxlcnQiLCJmaWxlIiwic3RhcnQiLCJzdG9wIiwic2l6ZSIsInJlYWRlciIsIkZpbGVSZWFkZXIiLCJ0ZXN0Iiwib25sb2FkZW5kIiwiZXZ0IiwidGFyZ2V0IiwiRE9ORSIsInJlc3VsdCIsIm15X0pTT05fb2JqZWN0IiwicGFyc2UiLCJrIiwiYWRkaW5nTmV3Q2FyZHNGcm9tSlNvbiIsImJsb2IiLCJzbGljZSIsInJlYWRBc0JpbmFyeVN0cmluZyIsImNhcmRJbmZvIiwic3RhcnRQIiwiZW5kUCIsInRyYW5zaXQiLCJQbGF5ZXIiLCJzbGlkZXJUb1ZpZGVvIiwiZGVsZXRlZCIsInN0YXJ0RHVyYXRpb24iLCJlbmREdXJhdGlvbiIsImNhcmQiLCJDYXJkIiwiY2FyZE1hbmFnZXIiLCJDcmVhdGVOZXdDYXJkQ29tbWFuZCIsImNyZWF0ZU5ld0NhcmQiLCJhZGRpbmdOZXdDYXJkIiwiaW5zZXJ0QmVmb3JlIiwiaURpdiIsImZpcnN0Q2hpbGQiLCJkZWxldGVDYXJkIiwiZmVlZGJhY2tPblNsaWRlclZpZGVvIiwicmVtb3ZlIiwiY29udGVudCIsImZpbGVOYW1lIiwiY29udGVudFR5cGUiLCJhIiwiQmxvYiIsInR5cGUiLCJocmVmIiwiVVJMIiwiY3JlYXRlT2JqZWN0VVJMIiwiY2xpY2siLCJsb2FkSlNPTlNlZ21lbnRIaXN0b3J5MSIsImdlbmVyYXRlSlNPTmZyb212YXIiLCJnZW5lcmF0ZWRKc29uIiwibG9hZEpTT05TZWdtZW50SGlzdG9yeTIiLCJnZW5lcmF0ZWRKc29uMiIsImdlbmVyYXRlSlNPTmZyb212YXIyIiwibG9hZEpTT05TZWdtZW50SGlzdG9yeVR1dG9yaWFsIiwiZ2VuZXJhdGVKU09OZnJvbXZhclR1dG8iLCJsb2FkU0hIaXN0b3J5ZnJvbVNydiIsInhociJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFJQSxlQUFlLENBQW5CO0FBQ0EsSUFBSUMsWUFBWSxFQUFoQjtBQUNBO0FBQ0EsSUFBSUMsV0FBVyxFQUFmOztBQUlBLElBQUlDLGNBQWMsU0FBZEEsV0FBYyxHQUFXO0FBQzNCO0FBQ0EsU0FBTztBQUNMO0FBQ0FDLGFBQVMsaUJB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LEtBQUtDLFVBQUwsS0FBb0IsQ0FBeEIsRUFBMkI7QUFDM0IsUUFBSSxLQUFLQyxNQUFMLEtBQWdCLEdBQXBCLEVBQXlCLE9BRlUsQ0FFRjtBQUNqQ3hCLGFBQVNxQixjQUFULENBQXdCLHVCQUF4QixFQUFpREksU0FBakQsR0FBNkQsS0FBS0MsWUFBbEU7QUFDQXFGLFFBQUlwRixJQUFKO0FBQ0EvQixZQUFRQyxHQUFSLENBQVksVUFBWjs7QUFFQTs7Ozs7Ozs7OztBQVVBOzs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFvQkQsR0FyQ0Q7QUFzQ0QsQ0EzQ0Q7QUE0Q0EiLCJmaWxlIjoiY2FyZE1hbmFnZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgbnVtYmVyT2ZDYXJkID0gMDtcbnZhciBhcnJheUNhcmQgPSBbXTtcbi8vdmFyIGFycmF5Q2FyZERlbGV0ZWQgPSBbXTtcbnZhciBjb21tYW5kcyA9IFtdO1xuXG5cblxudmFyIENhcmRNYW5hZ2VyID0gZnVuY3Rpb24oKSB7XG4gIC8vSSBpbXBsZW1lbnRlZCBhIGNvbW1hbmQgcGF0dGVybiwgc2VlIDogaHR0cHM6Ly93d3cuZG9mYWN0b3J5LmNvbS9qYXZhc2NyaXB0L2NvbW1hbmQtZGVzaWduLXBhdHRlcm5cbiAgcmV0dXJuIHtcbiAgICAvL2V4ZWN1dGUgYSBjb21tYW5kXG4gICAgZXhlY3V0ZTogZnVuY3Rpb24oY29tbWFuZCkge1xuICAgICBjb21tYW5kLmV4ZWN1dGUoKTtcbiAgICAgIC8vV2Ugc2VuZCB0aGUgY29tbWFuZCB0byB0aGUgc2VydmVyICh0aGUgc2VydmVyIGxvZyBpdCBpbnRvIGEgZmlsZSwgc2VlIC4vc3JjL3NlcnZlci9TZXJ2ZXJMb2dnZXIpXG4gICAgICBsb2dnZXIuc2VuZEFuZExvZ0NvbW1hbmQoY29tbWFuZCk7XG4gICAgICAvL2FuZCB3ZSBzYXZlIHRoZSBjb21tYW5kIGNyZWF0ZWRcbiAgICAgIGNvbW1hbmRzLnB1c2goY29tbWFuZCk7XG4gICAgfSxcbiAgICAvL1VuZG8gYSBjb21tYW5kXG4gICAgdW5kbzogZnVuY3Rpb24oKSB7XG4gICAgICAvL1RPRE9cbiAgICAgIHZhciBjb21tYW5kID0gY29tbWFuZHMucG9wKCk7XG4gICAgICBjb21tYW5kLnVuZG8oKTtcbiAgICB9LFxuICAgIGV4cG9ydENhcmQ6IGZ1bmN0aW9uKCl7XG4gICAgICBjb25zb2xlLmxvZyhcImZ1bmN0aW9uIGV4cG9ydCBjYXJkXCIpO1xuICAgICAgLyotLS0tLS0gQ3JlYXRlIGEgc2V0IG9mIGNhcmQgZnJvbSBhIEpTT04gZmlsZSAtLS0tLS0tKi9cbiAgICAgIHZhciBhcnJheUl0ZW1VcGRhdGVkID0gW107XG4gICAgICB2YXIgbGlzdFNlZ21lbnQgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKCdzZWdtZW50Jyk7XG4gICAgICAvL3BsYXlDYXJkKGFycmF5SXRlbS5pRGl2LCBhcnJheUl0ZW0uc3RhcnRQKTtcbiAgICAgIGNvbnNvbGUubG9nKGxpc3RTZWdtZW50KTtcbiAgICAgIFxuICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCBsaXN0U2VnbWVudC5sZW5ndGg7IGkrKykge1xuICAgICAgICBjb25zb2xlLmxvZyhsaXN0U2VnbWVudFtpXS5pZCk7IC8vc2Vjb25kIGNvbnNvbGUgb3V0cHV0XG4gICAgICAgIHRyaWdnZXJNb3VzZUV2ZW50KGxpc3RTZWdtZW50W2ldLCdtb3VzZWRvd24nKTtcbiAgICAgIH1cbiAgICAgICAgYXJyYXlDYXJkLmZvckVhY2goZnVuY3Rpb24oYXJyYXlJdGVtKSB7XG4gICAgICAgICAgY29uc29sZS5sb2coYXJyYXlJdGVtKTtcbiAgICAgICAgICB2YXIgaXRlbSA9IGFycmF5SXRlbS51cGRhdGVJbmZvKCk7XG4gICAgICAgICAgYXJyYXlJdGVtVXBkYXRlZC5wdXNoKGl0ZW0pO1xuICAgICAgICAgIGNvbnNvbGUubG9nKGl0ZW0pO1xuICAgICAgICB9KTtcbiAgICAgICAgdmFyIHNlcmlhbGl6ZWRBcnIgPSBKU09OLnN0cmluZ2lmeShhcnJheUl0ZW1VcGRhdGVkKTtcbiAgICAgICAgY29uc29sZS5sb2coXCIqKioqKiAgU2VyaWFsaXNhdGlvbiBvZiBjYXJkIGNvbXBsZXRlIDogXCIgKyBzZXJpYWxpemVkQXJyKTtcbiAgICAgICAgZG93bmxvYWQoc2VyaWFsaXplZEFyciwgJ2pzb25XMmxvZy0nICsgY3JlYXRlVW5pcXVlSWQoKSArICcuanNvbicsICd0ZXh0L3BsYWluJyk7XG4gICAgICAgIFxuICAgICAgICBsb2dnZXIuc2F2ZVNIKHNlcmlhbGl6ZWRBcnIpO1xuICAgIH0sIGxvYWRTZWdtZW50SGlzdG9yeUZyb21TZXJ2ZXI6IGZ1bmN0aW9uKCl7XG4gICAgXG4gICAgXG4gICAgXG4gICAgICAvL1dlIGNoYXJnZSBhbGwgdGhlIHZpZGVvIG9ubHkgb25lIHRpbWVcbiAgICAgIHZhciB4aHJfdmlldyA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuICAgICAgeGhyX3ZpZXcub3BlbignR0VUJywgJ3NyYy9jbGllbnQvanMvd29ya3Nob3AyL3RlY2hub2xvZ3lQcm9iZS9jYXJkX21hbmFnZXIvU0hMb2FkZXJPdmVydmlld192aWV3Lmh0bWwnLCB0cnVlKTtcbiAgICAgIHZhciB2aWV3X1NIX2h0bWwgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnU0hQaWNrZXJPdmVydmlld01vZGFsJyk7XG4gICAgXG4gICAgICB4aHJfdmlldy5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbiAoKSB7XG4gICAgICAgIGlmICh0aGlzLnJlYWR5U3RhdGUhPT00KSByZXR1cm47XG4gICAgICAgIGlmICh0aGlzLnN0YXR1cyE9PTIwMCkgcmV0dXJuOyAvLyBvciB3aGF0ZXZlciBlcnJvciBoYW5kbGluZyB5b3Ugd2FudFxuICAgICAgICB2aWV3X1NIX2h0bWwuaW5uZXJIVE1MPSB0aGlzLnJlc3BvbnNlVGV4dDtcbiAgICAgIH07XG4gICAgICB4aHJfdmlldy5zZW5kKCk7XG4gICAgXG4gICAgICAvL1dlIGNoYXJnZSBhbGwgdGhlIHZpZGVvIG9ubHkgb25lIHRpbWVcbiAgICAgIFxuICAgICAgXG4gICAgICB2YXIgeGhyX2FsbFBhdGggPSBuZXcgWE1MSHR0cFJlcXVlc3QoKTtcbiAgICAgIHhocl9hbGxQYXRoLm9wZW4oJ0dFVCcsICdzcmMvc2VydmVyL2xvZy1TSC9TSF9hbGxfcGF0aC50eHQnLCB0cnVlKTtcbiAgICBcbiAgICAgIHhocl9hbGxQYXRoLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaWYgKHRoaXMucmVhZHlTdGF0ZSE9PTQpIHJldHVybjtcbiAgICAgICAgaWYgKHRoaXMuc3RhdHVzIT09MjAwKSByZXR1cm47IC8vIG9yIHdoYXRldmVyIGVycm9yIGhhbmRsaW5nIHlvdSB3YW50XG4gICAgICAgIFxuICAgICAgICBcbiAgICAgICAgdmFyIGxpbmVzID0gdGhpcy5yZXNwb25zZVRleHQuc3BsaXQoJ1xcbicpO1xuICAgICAgICBmb3IodmFyIGogPSAwOyBqIDwgbGluZXMubGVuZ3RoLTE7IGorKyl7XG4gICAgICAgICAgdmFyIHhocl9TSCA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuICAgICAgICAgIHhocl9TSC5vcGVuKCdHRVQnLCBsaW5lc1tqXSwgdHJ1ZSk7XG4gICAgICAgICAgeGhyX1NILm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKHRoaXMucmVzcG9uc2VUZXh0KTtcbiAgICAgICAgICB9O1xuICAgICAgICAgIHhocl9TSC5zZW5kKCk7XG4gICAgICAgICAgXG4gICAgICAgICBcbiAgICAgICAgICBcbiAgICAgICAgICB2YXIgZGl2ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnZGl2Jyk7XG4gICAgICAgICAgZGl2LmNsYXNzTmFtZSA9ICdncmlkU0gnO1xuICAgICAgICAgIHZhciBzcGxpdCA9IGxpbmVzW2pdLnNwbGl0KCcvJyk7XG4gICAgICAgICAgdmFyIG5hbWVTSCA9IHNwbGl0W3NwbGl0Lmxlbmd0aC0xXTtcbiAgICAgICAgICBjb25zb2xlLmxvZyhuYW1lU0gpO1xuICBcbiAgICAgICAgICBkaXYuaW5uZXJIVE1MID0gbmFtZVNIO1xuICAgICAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdTSF9saXN0JykuYXBwZW5kQ2hpbGQoZGl2KTtcbiAgICAgICAgICAgIFxuICAgICAgICB9XG4gIFxuICAgICAgfTtcbiAgICAgIHhocl9hbGxQYXRoLnNlbmQoKTtcbiAgICBcbiAgICAgIFxuICAgIFxuICAgIH0sXG4gICAgXG4gICAgXG4gIH1cbn07XG5cblxuLypQcml2YXRlIGZ1bmN0aW9uLCBkbyBub3QgY2FsbCBvdXRzaWRlIHRoZSBDYXJkTWFuYWdlciovXG5cblxuZnVuY3Rpb24gdHJpZ2dlck1vdXNlRXZlbnQgKG5vZGUsIGV2ZW50VHlwZSkge1xuICB2YXIgY2xpY2tFdmVudCA9IGRvY3VtZW50LmNyZWF0ZUV2ZW50ICgnTW91c2VFdmVudHMnKTtcbiAgY2xpY2tFdmVudC5pbml0RXZlbnQgKGV2ZW50VHlwZSwgdHJ1ZSwgdHJ1ZSk7XG4gIG5vZGUuZGlzcGF0Y2hFdmVudCAoY2xpY2tFdmVudCk7XG59XG5cbi8qKioqIEZ1bmN0aW9uYWwgY29yZSBvZiB0aGUgY2FyZCBtYW5hZ2VyIChjcmVhdGUgYSBjYXJ0LCBkZWxldGUgYSBjYXJkIGFuZCBzYXZlIGNhcmQpICoqKioqL1xuLyoqXG4gKiBUaGlzIGNsYXNzIG1hbmFnIGFsbCB0aGUgY2FyZHMgY3JlYXRlZC4gVGhpcyBpcyB0aGUgc2VnbWVudCBoaXN0b3J5LlxuICogQHR5cGUge0hUTUxFbGVtZW50IHwgbnVsbH1cbiAqL1xudmFyIHdyYXBwZXJDb21tYW5kQW5kUmFuZ2UgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcIndyYXBwZXJDb21tYW5kQW5kUmFuZ2VpZFwiKTtcblxuXG5cbmZ1bmN0aW9uIGNsZWFuU2VnbWVudEhpc3RvcnkoKXtcbiAgY29uc29sZS5sb2coXCJURVNUSU5HXCIpO1xuICBjbGVhckFsbFRpbWVyKCk7XG4gIGFycmF5Q2FyZC5mb3JFYWNoKGZ1bmN0aW9uKGUpe1xuICAgICAgZGVsZXRlQ2FyZFVJKGUpO1xuICB9KTtcbn1cblxuZnVuY3Rpb24gbG9hZEpTT04oKSB7XG4gIHZhciBmaWxlcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdsb2dGaWxlTG9hZCcpLmZpbGVzO1xuICBpZiAoIWZpbGVzLmxlbmd0aCkge1xuICAgIGFsZXJ0KCdQbGVhc2Ugc2VsZWN0IGEgZmlsZSEnKTtcbiAgICByZXR1cm47XG4gIH1cbiAgXG4gIHZhciBmaWxlID0gZmlsZXNbMF07XG4gIHZhciBzdGFydCA9ICAwO1xuICB2YXIgc3RvcCA9IGZpbGUuc2l6ZSAtIDE7XG4gIFxuICB2YXIgcmVhZGVyID0gbmV3IEZpbGVSZWFkZXIoKTtcbiAgdmFyIHRlc3QgPSAwO1xuICAvLyBJZiB3ZSB1c2Ugb25sb2FkZW5kLCB3ZSBuZWVkIHRvIGNoZWNrIHRoZSByZWFkeVN0YXRlLlxuICByZWFkZXIub25sb2FkZW5kID0gZnVuY3Rpb24oZXZ0KSB7XG4gICAgaWYgKGV2dC50YXJnZXQucmVhZHlTdGF0ZSA9PSBGaWxlUmVhZGVyLkRPTkUpIHsgLy8gRE9ORSA9PSAyXG4gICAgICB2YXIgdGVzdCA9IGV2dC50YXJnZXQucmVzdWx0O1xuICAgICAgY29uc29sZS5sb2coJ1JlYWQgYnl0ZXM6ICcsIHN0YXJ0ICsgMSwgJyAtICcsIHN0b3AgKyAxLFxuICAgICAgICAgICcgb2YgJywgZmlsZS5zaXplLCAnIGJ5dGUgZmlsZScgKTtcbiAgICAgIGNvbnNvbGUubG9nKHRlc3QpO1xuICAgICAgdmFyIG15X0pTT05fb2JqZWN0ID0gSlNPTi5wYXJzZSh0ZXN0KTtcbiAgXG4gICAgICBjb25zb2xlLmxvZyhteV9KU09OX29iamVjdCk7XG4gIFxuICAgICAgZm9yIChsZXQgayA9IDA7IGsgPCBteV9KU09OX29iamVjdC5sZW5ndGg7IGsrKykge1xuICAgICAgICBhZGRpbmdOZXdDYXJkc0Zyb21KU29uKG15X0pTT05fb2JqZWN0W2tdKTtcbiAgICAgIH1cbiAgICB9XG4gIH07XG4gIHZhciBibG9iID0gZmlsZS5zbGljZShzdGFydCwgc3RvcCArIDEpO1xuICByZWFkZXIucmVhZEFzQmluYXJ5U3RyaW5nKGJsb2IpO1xufVxuXG4vL0FkZCBhIGNhcmQgZnJvbSBhIGpzb24gZmlsZVxuZnVuY3Rpb24gYWRkaW5nTmV3Q2FyZHNGcm9tSlNvbihjYXJkSW5mbykge1xuICBpZiAoY2FyZEluZm8uc3RhcnRQID4gY2FyZEluZm8uZW5kUCkge1xuICAgIGxldCB0cmFuc2l0ID0gY2FyZEluZm8uc3RhcnRQO1xuICAgIGNhcmRJbmZvLnN0YXJ0UCA9IGNhcmRJbmZvLmVuZFA7XG4gICAgY2FyZEluZm8uZW5kUCA9IHRyYW5zaXQ7XG4gIH1cbiAgaWYgKGNhcmRJbmZvLnN0YXJ0UCA8IDApIHtcbiAgICBjYXJkSW5mby5zdGFydFAgPSAwO1xuICB9XG4gIGNvbnNvbGUubG9nKGNhcmRJbmZvLnN0YXJ0UCwgY2FyZEluZm8uZW5kUCk7XG4gIGxldCByZXN1bHQgPSBQbGF5ZXIuc2xpZGVyVG9WaWRlbyhjYXJkSW5mby5zdGFydFAsIGNhcmRJbmZvLmVuZFApO1xuICAvL2NvbnNvbGUubG9nKHJlc3VsdCk7XG4gIG51bWJlck9mQ2FyZCsrO1xuICBpZiAoIWNhcmRJbmZvLmRlbGV0ZWQpIHtcbiAgICBjb25zb2xlLmxvZyhyZXN1bHQuc3RhcnREdXJhdGlvbiwgcmVzdWx0LmVuZER1cmF0aW9uLCBjYXJkSW5mby5zdGFydFAsIGNhcmRJbmZvLmVuZFAsIGNhcmRJbmZvKTtcbiAgICB2YXIgY2FyZCA9IENhcmQocmVzdWx0LnN0YXJ0RHVyYXRpb24sIHJlc3VsdC5lbmREdXJhdGlvbiwgY2FyZEluZm8uc3RhcnRQLCBjYXJkSW5mby5lbmRQLCBjYXJkSW5mbyk7XG4gICAgY2FyZE1hbmFnZXIuZXhlY3V0ZShuZXcgQ3JlYXRlTmV3Q2FyZENvbW1hbmQoY2FyZCkpO1xuICAgIC8vZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RpdkNhcmRCb2FyZCcpLmluc2VydEJlZm9yZShjYXJkLmlEaXYsIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkaXZDYXJkQm9hcmQnKS5maXJzdENoaWxkKTtcbiAgfVxufVxuXG4vKipcbiAqIEFkZGluZyBhIGNhcmQgYnkgZHJhZyBhbmQgZHJvcC4gVGhlIGNhcmQgaXMgYWRkZWQgaW4gdGhlIGxpc3Qgb2YgY2FyZHNcbiAqIFJldHVybiB0aGUgY2FyZCB0aGF0IGhhdmUgYmVlbiBjcmVhdGVkXG4gKi9cbmZ1bmN0aW9uIGNyZWF0ZU5ld0NhcmQoc3RhcnRQLCBlbmRQKSB7XG4gIC8vY29uc29sZS5sb2coXCJURVNUIC8gOiBcIiArIHN0YXJ0UCArIFwiIFwiICsgZW5kUCk7XG4gIGlmIChzdGFydFAgPiBlbmRQKSB7XG4gICAgbGV0IHRyYW5zaXQgPSBzdGFydFA7XG4gICAgc3RhcnRQID0gZW5kUDtcbiAgICBlbmRQID0gdHJhbnNpdDtcbiAgfVxuICBsZXQgcmVzdWx0ID0gUGxheWVyLnNsaWRlclRvVmlkZW8oc3RhcnRQLCBlbmRQKTtcbiAgbnVtYmVyT2ZDYXJkKys7XG4gIGNvbnNvbGUubG9nKHJlc3VsdCk7XG4gIFxuICB2YXIgY2FyZCA9IG5ldyBDYXJkKHJlc3VsdC5zdGFydER1cmF0aW9uLCByZXN1bHQuZW5kRHVyYXRpb24sIHN0YXJ0UCwgZW5kUCk7XG4gIGNhcmRNYW5hZ2VyLmV4ZWN1dGUobmV3IENyZWF0ZU5ld0NhcmRDb21tYW5kKGNhcmQpKTtcbiAgcmV0dXJuIGNhcmQ7XG59XG5cbmZ1bmN0aW9uIGFkZGluZ05ld0NhcmQoKSB7XG4gIGFycmF5Q2FyZC5wdXNoKHRoaXMuY2FyZCk7XG4gIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkaXZDYXJkQm9hcmQnKS5pbnNlcnRCZWZvcmUodGhpcy5jYXJkLmlEaXYsIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkaXZDYXJkQm9hcmQnKS5maXJzdENoaWxkKTtcbn1cblxuZnVuY3Rpb24gZGVsZXRlQ2FyZCgpIHtcbiAgLy9TdXBwcmltZSBsYSBjYXJ0ZSBkZSBsYSBsaXN0ZSBkZSBjYXJ0ZVxuICAvKmZvciAobGV0IGkgPSAwOyBpIDwgYXJyYXlDYXJkLmxlbmd0aCAgIDsgaSsrKSB7XG4gICAgaWYoYXJyYXlDYXJkW2ldICA9PT0gY2FyZCl7XG4gICAgICB2YXIgc3VwQ2FyZCA9IGFycmF5Q2FyZC5zcGxpY2UoaSwxKTtcbiAgICAgIGFycmF5Q2FyZERlbGV0ZWQucHVzaChzdXBDYXJkKTtcbiAgICAgIGNvbnNvbGUubG9nKFwiZGVsZXRlZCBjYXJkIDogXCIpO1xuICAgICAgY29uc29sZS5sb2coc3VwQ2FyZCk7XG4gICAgICBicmVhaztcbiAgICB9XG4gIH0qL1xuICAvL2RlbGV0ZUNhcmRVSShjYXJkKTtcbiAgLyphcnJheUNhcmREZWxldGVkLmZvckVhY2goZnVuY3Rpb24oZWxlbWVudCkge1xuICAgIGNvbnNvbGUubG9nKCAgIGVsZW1lbnQpO1xuICB9KTtcbiAgY29uc29sZS5sb2coXCIqKioqKioqKioqKioqKioqKioqKioqKipcIik7XG4gIGFycmF5Q2FyZC5mb3JFYWNoKGZ1bmN0aW9uKGVsZW1lbnQpIHtcbiAgICBjb25zb2xlLmxvZyhlbGVtZW50KTtcbiAgfSk7Ki9cbiAgY2xlYXJBbGxUaW1lcigpO1xuICBkZWxldGVDYXJkVUkodGhpcy5jYXJkKTtcbiAgcmV0dXJuIHRoaXMuY2FyZDtcbn1cblxuZnVuY3Rpb24gZGVsZXRlQ2FyZFVJKGNhcmQpIHtcbiAgZmVlZGJhY2tPblNsaWRlclZpZGVvKGZhbHNlKTtcbiAgY2FyZC5pRGl2LnJlbW92ZSgpO1xuICBjYXJkLmRlbGV0ZWQgPSB0cnVlXG59XG5cbmZ1bmN0aW9uIGRvd25sb2FkKGNvbnRlbnQsIGZpbGVOYW1lLCBjb250ZW50VHlwZSkge1xuICB2YXIgYSA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoXCJhXCIpO1xuICBcbiAgXG4gLy9hLnN0eWxlLmRpc3BsYXkgPSBcImJsb2NrXCI7XG4gIHZhciBmaWxlID0gbmV3IEJsb2IoW2NvbnRlbnRdLCB7XG4gICAgdHlwZTogY29udGVudFR5cGVcbiAgfSk7XG4gIFxuICBhLmhyZWYgPSBVUkwuY3JlYXRlT2JqZWN0VVJMKGZpbGUpO1xuICBhLmRvd25sb2FkID0gZmlsZU5hbWU7XG4gIGEuY2xpY2soKTtcbiAgYS5yZW1vdmUoKTtcbiAgXG4gIFxuICBcbiAgXG59XG5cblxuXG5mdW5jdGlvbiBsb2FkSlNPTlNlZ21lbnRIaXN0b3J5MSgpIHtcbiAgXG4gICAgICBjb25zb2xlLmxvZyhnZW5lcmF0ZUpTT05mcm9tdmFyKCkpO1xuICAgICAgXG4gICAgICBsZXQgZ2VuZXJhdGVkSnNvbiA9IGdlbmVyYXRlSlNPTmZyb212YXIoKTtcbiAgICAgIHZhciBteV9KU09OX29iamVjdCA9IEpTT04ucGFyc2UoZ2VuZXJhdGVkSnNvbik7XG4gICAgICBjb25zb2xlLmxvZyhteV9KU09OX29iamVjdCk7XG4gICAgICBmb3IgKGxldCBrID0gMDsgayA8IG15X0pTT05fb2JqZWN0Lmxlbmd0aDsgaysrKSB7XG4gICAgICAgIGFkZGluZ05ld0NhcmRzRnJvbUpTb24obXlfSlNPTl9vYmplY3Rba10pO1xuICAgIH1cbiAgXG59XG5cbmZ1bmN0aW9uIGxvYWRKU09OU2VnbWVudEhpc3RvcnkyKCkge1xuICBsZXQgZ2VuZXJhdGVkSnNvbjIgPSBnZW5lcmF0ZUpTT05mcm9tdmFyMigpO1xuICB2YXIgbXlfSlNPTl9vYmplY3QgPSBKU09OLnBhcnNlKGdlbmVyYXRlZEpzb24yKTtcbiAgY29uc29sZS5sb2cobXlfSlNPTl9vYmplY3QpO1xuICBmb3IgKGxldCBrID0gMDsgayA8IG15X0pTT05fb2JqZWN0Lmxlbmd0aDsgaysrKSB7XG4gICAgYWRkaW5nTmV3Q2FyZHNGcm9tSlNvbihteV9KU09OX29iamVjdFtrXSk7XG4gIH1cbn1cblxuZnVuY3Rpb24gbG9hZEpTT05TZWdtZW50SGlzdG9yeVR1dG9yaWFsKCkge1xuICBsZXQgZ2VuZXJhdGVkSnNvbjIgPSBnZW5lcmF0ZUpTT05mcm9tdmFyVHV0bygpO1xuICB2YXIgbXlfSlNPTl9vYmplY3QgPSBKU09OLnBhcnNlKGdlbmVyYXRlZEpzb24yKTtcbiAgY29uc29sZS5sb2cobXlfSlNPTl9vYmplY3QpO1xuICBmb3IgKGxldCBrID0gMDsgayA8IG15X0pTT05fb2JqZWN0Lmxlbmd0aDsgaysrKSB7XG4gICAgYWRkaW5nTmV3Q2FyZHNGcm9tSlNvbihteV9KU09OX29iamVjdFtrXSk7XG4gIH1cbn1cblxuXG52YXIgIGxvYWRTSEhpc3Rvcnlmcm9tU3J2ID0gZnVuY3Rpb24oKSB7XG4gIFxuICAvL1dlIGNoYXJnZSBhbGwgdGhlIHZpZGVvIG9ubHkgb25lIHRpbWVcbiAgdmFyIHhociA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuICB4aHIub3BlbignR0VUJywgJ3NyYy9jbGllbnQvanMvd29ya3Nob3AyL3RlY2hub2xvZ3lQcm9iZS9jYXJkX21hbmFnZXIvU0hMb2FkZXJPdmVydmlld192aWV3Lmh0bWwnLCB0cnVlKTtcbiAgeGhyLm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uICgpIHtcbiAgICBpZiAodGhpcy5yZWFkeVN0YXRlICE9PSA0KSByZXR1cm47XG4gICAgaWYgKHRoaXMuc3RhdHVzICE9PSAyMDApIHJldHVybjsgLy8gb3Igd2hhdGV2ZXIgZXJyb3IgaGFuZGxpbmcgeW91IHdhbnRcbiAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnU0hQaWNrZXJPdmVydmlld01vZGFsJykuaW5uZXJIVE1MID0gdGhpcy5yZXNwb25zZVRleHQ7XG4gICAgeGhyLnNlbmQoKTtcbiAgICBjb25zb2xlLmxvZygnSEFIQUhBSEEnKVxuICBcbiAgICAvKlxuICAgIC8vQ29kZSBwZXJtZXR0YW50IGRlIGNoYXJnZXIgdW4gU0gsIGlsIHN1ZmZpdCBkZSByZWN1cGVyZXIgdG91cyBsZXMgU0ggZHUgc2VydmVyLFxuICAgIC8vIHB1aXMgZGUgbGVzIGVudHJlciBkYW5zIHVuZSBkaXYgY29ycmVzcG9uZGFudGUsIMOgYSBkb2l0IGZhaXJlIHVuIG92ZXJ2aWV3IGplIHBlbnNlXG4gICAgbGV0IGdlbmVyYXRlZEpzb24gPSBnZW5lcmF0ZUpTT05mcm9tdmFyKCk7XG4gICAgdmFyIG15X0pTT05fb2JqZWN0ID0gSlNPTi5wYXJzZShnZW5lcmF0ZWRKc29uKTtcbiAgICBjb25zb2xlLmxvZyhteV9KU09OX29iamVjdCk7XG4gICAgZm9yIChsZXQgayA9IDA7IGsgPCBteV9KU09OX29iamVjdC5sZW5ndGg7IGsrKykge1xuICAgICAgYWRkaW5nTmV3Q2FyZHNGcm9tSlNvbihteV9KU09OX29iamVjdFtrXSk7XG4gICAgfSovXG4gICAgXG4gICAgLyp2YXIgZWxtcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCd2aWRlb1BpY2tlck92ZXJ2aWV3TW9kYWwnKS5nZXRFbGVtZW50c0J5VGFnTmFtZShcImRpdlwiKTtcbiAgICB2YXIgdmlkZW8gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgndmlkZW9FQVQnKTtcbiAgICB2YXIgc3BhbiA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoXCJjbG9zZVwiKVswXTtcbiAgICBcbiAgICBzcGFuLmFkZEV2ZW50TGlzdGVuZXIoIFwibW91c2Vkb3duXCIgLCBmdW5jdGlvbigpIHtcbiAgICAgIG1vZGFsVmlkZW8uc3R5bGUuZGlzcGxheSA9IFwibm9uZVwiO1xuICAgIH0pO1xuICAgIGZvciAodmFyIGkgPSAwOyBpIDwgZWxtcy5sZW5ndGg7IGkrKykge1xuICAgICAgZWxtc1tpXS5hZGRFdmVudExpc3RlbmVyKFwibW91c2Vkb3duXCIsIGZ1bmN0aW9uICgpe1xuICAgICAgICAvL2NvbnNvbGUubG9nKHRoaXMuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJzb3VyY2VcIilbMF0uc3JjKTtcbiAgICAgICAgdmlkZW8uc3JjID0gdGhpcy5nZXRFbGVtZW50c0J5VGFnTmFtZShcInNvdXJjZVwiKVswXS5zcmM7XG4gICAgICAgIHZhciBub3RpZmljYXRpb25fZmVlZGJhY2sgPSBcIlZpZGVvIHN1Y2Nlc3NmdWxseSBsb2FkZWQhXCI7XG4gICAgICAgIG5vdGlmaWNhdGlvbkZlZWRiYWNrKG5vdGlmaWNhdGlvbl9mZWVkYmFjayk7XG4gICAgICAgIC8vbW9kYWxWaWRlby5zdHlsZS5kaXNwbGF5ID0gXCJub25lXCI7XG4gICAgICAgIC8vbW9kYWxWaWRlby5zdHlsZS52aXNpYmlsaXR5ID0gXCJoaWRkZW5cIjtcbiAgICAgIH0pO1xuICAgIH1cbiAgfTsqL1xuICBcbiAgICBcbiAgfVxufVxuLypcblxudmFyIHNwYW4gPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKFwiY2xvc2VcIilbMV07XG52YXIgbW9kYWxTSCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdTSFBpY2tlck92ZXJ2aWV3Jyk7XG5cbnNwYW4uYWRkRXZlbnRMaXN0ZW5lciggXCJtb3VzZWRvd25cIiAsIGZ1bmN0aW9uKCkge1xuICBtb2RhbFNILnN0eWxlLmRpc3BsYXkgPSBcIm5vbmVcIjtcbn0pOyovXG4iXX0=