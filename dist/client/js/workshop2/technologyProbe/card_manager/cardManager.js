'use strict';

var numberOfCard = 0;
var arrayCard = [];
//var arrayCardDeleted = [];
var commands = [];

var CardManager = function CardManager() {
  //I implemented a command pattern, see : https://www.dofactory.com/javascript/command-design-pattern
  return {
    //execute a command
    execute: function execute(command) {
      //if this is a delete command then card is an argument of the command
      /*switch (command.execute.name){
        case "deleteCard" : {
          command.execute(command.card);
          break;
        }
        case "createNewCard" :
          command.execute(command.startP, command.endP);
          break;
        default:
          command.execute();
          break;
      }*/
      command.execute();
      //We send the command to the server (the server log it into a file, see ./src/server/ServerLogger)
      logger.sendAndLogCommand(command);
      //and we save the command created
      commands.push(command);
    },
    //Undo a command
    undo: function undo() {
      //TODO
      var command = commands.pop();
      command.undo();
    },
    exportCard: function exportCard() {
      /*------ Create a set of card from a JSON file -------*/
      var arrayItemUpdated = [];
      var listSegment = document.getElementsByClassName('segment');
      //playCard(arrayItem.iDiv, arrayItem.startP);
      console.log(listSegment);

      for (var i = 0; i < listSegment.length; i++) {
        console.log(listSegment[i].id); //second console output
        triggerMouseEvent(listSegment[i], 'mousedown');
      }

      // var item = arrayItem.updateInfo();
      // triggerMouseEvent( a, "mousedown");
      arrayCard.forEach(function (arrayItem) {
        console.log(arrayItem);
        var item = arrayItem.updateInfo();
        arrayItemUpdated.push(item);
        console.log(item);
      });
      var serializedArr = JSON.stringify(arrayItemUpdated);
      console.log("*****  Serialisation of card complete : " + serializedArr);
      download(serializedArr, 'jsonW2log-' + createUniqueId() + '.json', 'text/plain');

      logger.saveSH(serializedArr);
    }

  };
};

function triggerMouseEvent(node, eventType) {
  var clickEvent = document.createEvent('MouseEvents');
  clickEvent.initEvent(eventType, true, true);
  node.dispatchEvent(clickEvent);
}

/**** Functional core of the card manager (create a cart, delete a card and save card) *****/
/**
 * This class manag all the cards created. This is the segment history.
 * @type {HTMLElement | null}
 */
var wrapperCommandAndRange = document.getElementById("wrapperCommandAndRangeid");

//TODO Save and load button, do no delete
/*saveLogBtn.addEventListener("touchend",function (e) {
  console.log("saving log");
  arrayCard.forEach(function (arrayItem) {
   // arrayItem.updateInfo();
    //arrayItem.
  });
  exportCardsJSon();
  textSaveLog.innerText = "Log saved!" ;
});

loadLogBtn.onclick = function () {
  loadJSON(null);
};

loadLogBtn.addEventListener("mouseup",function (e) {
  //console.log("AAAAAA");
  //var mydata = JSON.parse(data);
  //console.log( loadLogBtn.value);
});



/*



//dragElement(document.getElementById("card1"));


addCard.addEventListener('click', function (e) {
  createNewCard();
});*/

function cleanSegmentHistory() {
  console.log("TESTING");
  clearAllTimer();
  arrayCard.forEach(function (e) {
    deleteCardUI(e);
  });
}

function loadJSON() {
  var files = document.getElementById('logFileLoad').files;
  if (!files.length) {
    alert('Please select a file!');
    return;
  }

  var file = files[0];
  var start = 0;
  var stop = file.size - 1;

  var reader = new FileReader();
  var test = 0;
  // If we use onloadend, we need to check the readyState.
  reader.onloadend = function (evt) {
    if (evt.target.readyState == FileReader.DONE) {
      // DONE == 2
      var test = evt.target.result;
      console.log('Read bytes: ', start + 1, ' - ', stop + 1, ' of ', file.size, ' byte file');
      console.log(test);
      var my_JSON_object = JSON.parse(test);

      console.log(my_JSON_object);

      for (var k = 0; k < my_JSON_object.length; k++) {
        addingNewCardsFromJSon(my_JSON_object[k]);
      }
    }
  };
  var blob = file.slice(start, stop + 1);
  reader.readAsBinaryString(blob);
}

//Add a card from a json file
function addingNewCardsFromJSon(cardInfo) {
  if (cardInfo.startP > cardInfo.endP) {
    var transit = cardInfo.startP;
    cardInfo.startP = cardInfo.endP;
    cardInfo.endP = transit;
  }
  if (cardInfo.startP < 0) {
    cardInfo.startP = 0;
  }
  var result = Player.sliderToVideo(cardInfo.startP, cardInfo.endP);
  console.log(result);
  numberOfCard++;
  if (!cardInfo.deleted) {
    console.log(result.startDuration, result.endDuration, cardInfo.startP, cardInfo.endP, cardInfo);
    var card = Card(result.startDuration, result.endDuration, cardInfo.startP, cardInfo.endP, cardInfo);
    cardManager.execute(new CreateNewCardCommand(card));
    //document.getElementById('divCardBoard').insertBefore(card.iDiv, document.getElementById('divCardBoard').firstChild);
  }
}

/**
 * Adding a card by drag and drop. The card is added in the list of cards
 * Return the card that have been created
 */
function createNewCard(startP, endP) {
  //console.log("TEST / : " + startP + " " + endP);
  if (startP > endP) {
    var transit = startP;
    startP = endP;
    endP = transit;
  }
  var result = Player.sliderToVideo(startP, endP);
  numberOfCard++;
  console.log(result);

  var card = new Card(result.startDuration, result.endDuration, startP, endP);
  cardManager.execute(new CreateNewCardCommand(card));
  return card;
}

function addingNewCard() {
  arrayCard.push(this.card);
  document.getElementById('divCardBoard').insertBefore(this.card.iDiv, document.getElementById('divCardBoard').firstChild);
}

function deleteCard() {
  //Supprime la carte de la liste de carte
  /*for (let i = 0; i < arrayCard.length   ; i++) {
    if(arrayCard[i]  === card){
      var supCard = arrayCard.splice(i,1);
      arrayCardDeleted.push(supCard);
      console.log("deleted card : ");
      console.log(supCard);
      break;
    }
  }*/
  //deleteCardUI(card);
  /*arrayCardDeleted.forEach(function(element) {
    console.log(   element);
  });
  console.log("************************");
  arrayCard.forEach(function(element) {
    console.log(element);
  });*/
  clearAllTimer();
  deleteCardUI(this.card);
  return this.card;
}

function deleteCardUI(card) {
  feedbackOnSliderVideo(false);
  card.iDiv.remove();
  card.deleted = true;
}

function download(content, fileName, contentType) {
  var a = document.createElement("a");

  //a.style.display = "block";
  var file = new Blob([content], {
    type: contentType
  });

  a.href = URL.createObjectURL(file);
  a.download = fileName;
  a.click();
  a.remove();
}

function loadJSONSegmentHistory1() {

  console.log(generateJSONfromvar());

  var generatedJson = generateJSONfromvar();
  var my_JSON_object = JSON.parse(generatedJson);
  console.log(my_JSON_object);
  for (var k = 0; k < my_JSON_object.length; k++) {

    addingNewCardsFromJSon(my_JSON_object[k]);
  }
}

function loadJSONSegmentHistory2() {
  var generatedJson2 = generateJSONfromvar2();

  var my_JSON_object = JSON.parse(generatedJson2);
  console.log(my_JSON_object);
  for (var k = 0; k < my_JSON_object.length; k++) {
    addingNewCardsFromJSon(my_JSON_object[k]);
  }
}

function loadJSONSegmentHistoryTutorial() {
  var generatedJson2 = generateJSONfromvarTuto();

  var my_JSON_object = JSON.parse(generatedJson2);
  console.log(my_JSON_object);
  for (var k = 0; k < my_JSON_object.length; k++) {
    addingNewCardsFromJSon(my_JSON_object[k]);
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNhcmRNYW5hZ2VyLmpzIl0sIm5hbWVzIjpbIm51bWJlck9mQ2FyZCIsImFycmF5Q2FyZCIsImNvbW1hbmRzIiwiQ2FyZE1hbmFnZXIiLCJleGVjdXRlIiwiY29tbWFuZCIsImxvZ2dlciIsInNlbmRBbmRMb2dDb21tYW5kIiwicHVzaCIsInVuZG8iLCJwb3AiLCJleHBvcnRDYXJkIiwiYXJyYXlJdGVtVXBkYXRlZCIsImxpc3RTZWdtZW50IiwiZG9jdW1lbnQiLCJnZXRFbGVtZW50c0J5Q2xhc3NOYW1lIiwiY29uc29sZSIsImxvZyIsImkiLCJsZW5ndGgiLCJpZCIsInRyaWdnZXJNb3VzZUV2ZW50IiwiZm9yRWFjaCIsImFycmF5SXRlbSIsIml0ZW0iLCJ1cGRhdGVJbmZvIiwic2VyaWFsaXplZEFyciIsIkpTT04iLCJzdHJpbmdpZnkiLCJkb3dubG9hZCIsImNyZWF0ZVVuaXF1ZUlkIiwic2F2ZVNIIiwibm9kZSIsImV2ZW50VHlwZSIsImNsaWNrRXZlbnQiLCJjcmVhdGVFdmVudCIsImluaXRFdmVudCIsImRpc3BhdGNoRXZlbnQiLCJ3cmFwcGVyQ29tbWFuZEFuZFJhbmdlIiwiZ2V0RWxlbWVudEJ5SWQiLCJjbGVhblNlZ21lbnRIaXN0b3J5IiwiY2xlYXJBbGxUaW1lciIsImUiLCJkZWxldGVDYXJkVUkiLCJsb2FkSlNPTiIsImZpbGVzIiwiYWxlcnQiLCJmaWxlIiwic3RhcnQiLCJzdG9wIiwic2l6ZSIsInJlYWRlciIsIkZpbGVSZWFkZXIiLCJ0ZXN0Iiwib25sb2FkZW5kIiwiZXZ0IiwidGFyZ2V0IiwicmVhZHlTdGF0ZSIsIkRPTkUiLCJyZXN1bHQiLCJteV9KU09OX29iamVjdCIsInBhcnNlIiwiayIsImFkZGluZ05ld0NhcmRzRnJvbUpTb24iLCJibG9iIiwic2xpY2UiLCJyZWFkQXNCaW5hcnlTdHJpbmciLCJjYXJkSW5mbyIsInN0YXJ0UCIsImVuZFAiLCJ0cmFuc2l0IiwiUGxheWVyIiwic2xpZGVyVG9WaWRlbyIsImRlbGV0ZWQiLCJzdGFydER1cmF0aW9uIiwiZW5kRHVyYXRpb24iLCJjYXJkIiwiQ2FyZCIsImNhcmRNYW5hZ2VyIiwiQ3JlYXRlTmV3Q2FyZENvbW1hbmQiLCJjcmVhdGVOZXdDYXJkIiwiYWRkaW5nTmV3Q2FyZCIsImluc2VydEJlZm9yZSIsImlEaXYiLCJmaXJzdENoaWxkIiwiZGVsZXRlQ2FyZCIsImZlZWRiYWNrT25TbGlkZXJWaWRlbyIsInJlbW92ZSIsImNvbnRlbnQiLCJmaWxlTmFtZSIsImNvbnRlbnRUeXBlIiwiYSIsImNyZWF0ZUVsZW1lbnQiLCJCbG9iIiwidHlwZSIsImhyZWYiLCJVUkwiLCJjcmVhdGVPYmplY3RVUkwiLCJjbGljayIsImxvYWRKU09OU2VnbWVudEhpc3RvcnkxIiwiZ2VuZXJhdGVKU09OZnJvbXZhciIsImdlbmVyYXRlZEpzb24iLCJsb2FkSlNPTlNlZ21lbnRIaXN0b3J5MiIsImdlbmVyYXRlZEpzb24yIiwiZ2VuZXJhdGVKU09OZnJvbXZhcjIiLCJsb2FkSlNPTlNlZ21lbnRIaXN0b3J5VHV0b3JpYWwiLCJnZW5lcmF0ZUpTT05mcm9tdmFyVHV0byJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxJQUFJQSxlQUFlLENBQW5CO0FBQ0EsSUFBSUMsWUFBWSxFQUFoQjtBQUNBO0FBQ0EsSUFBSUMsV0FBVyxFQUFmOztBQUdBLElBQUlDLGNBQWMsU0FBZEEsV0FBYyxHQUFXO0FBQzNCO0FBQ0EsU0FBTztBQUNMO0FBQ0FDLGFBQVMsaUJBQVNDLE9BQVQsRUFBa0I7QUFDekI7QUFDQTs7Ozs7Ozs7Ozs7O0FBWURBLGNBQVFELE9BQVI7QUFDQztBQUNBRSxhQUFPQyxpQkFBUCxDQUF5QkYsT0FBekI7QUFDQTtBQUNBSCxlQUFTTSxJQUFULENBQWNILE9BQWQ7QUFDRCxLQXJCSTtBQXNCTDtBQUNBSSxVQUFNLGdCQUFXO0FBQ2Y7QUFDQSxVQUFJSixVQUFVSCxTQUFTUSxHQUFULEVBQWQ7QUFDQUwsY0FBUUksSUFBUjtBQUNELEtBM0JJO0FBNEJMRSxnQkFBWSxzQkFBVTtBQUNwQjtBQUNFLFVBQUlD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LFVBQVFDLEdBQVIsQ0FBWTJDLGNBQVo7QUFDQSxPQUFLLElBQUlFLElBQUksQ0FBYixFQUFnQkEsSUFBSUYsZUFBZXpDLE1BQW5DLEVBQTJDMkMsR0FBM0MsRUFBZ0Q7QUFDOUNDLDJCQUF1QkgsZUFBZUUsQ0FBZixDQUF2QjtBQUVEO0FBRUYiLCJmaWxlIjoiY2FyZE1hbmFnZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgbnVtYmVyT2ZDYXJkID0gMDtcbnZhciBhcnJheUNhcmQgPSBbXTtcbi8vdmFyIGFycmF5Q2FyZERlbGV0ZWQgPSBbXTtcbnZhciBjb21tYW5kcyA9IFtdO1xuXG5cbnZhciBDYXJkTWFuYWdlciA9IGZ1bmN0aW9uKCkge1xuICAvL0kgaW1wbGVtZW50ZWQgYSBjb21tYW5kIHBhdHRlcm4sIHNlZSA6IGh0dHBzOi8vd3d3LmRvZmFjdG9yeS5jb20vamF2YXNjcmlwdC9jb21tYW5kLWRlc2lnbi1wYXR0ZXJuXG4gIHJldHVybiB7XG4gICAgLy9leGVjdXRlIGEgY29tbWFuZFxuICAgIGV4ZWN1dGU6IGZ1bmN0aW9uKGNvbW1hbmQpIHtcbiAgICAgIC8vaWYgdGhpcyBpcyBhIGRlbGV0ZSBjb21tYW5kIHRoZW4gY2FyZCBpcyBhbiBhcmd1bWVudCBvZiB0aGUgY29tbWFuZFxuICAgICAgLypzd2l0Y2ggKGNvbW1hbmQuZXhlY3V0ZS5uYW1lKXtcbiAgICAgICAgY2FzZSBcImRlbGV0ZUNhcmRcIiA6IHtcbiAgICAgICAgICBjb21tYW5kLmV4ZWN1dGUoY29tbWFuZC5jYXJkKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBjYXNlIFwiY3JlYXRlTmV3Q2FyZFwiIDpcbiAgICAgICAgICBjb21tYW5kLmV4ZWN1dGUoY29tbWFuZC5zdGFydFAsIGNvbW1hbmQuZW5kUCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgY29tbWFuZC5leGVjdXRlKCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICB9Ki9cbiAgICAgY29tbWFuZC5leGVjdXRlKCk7XG4gICAgICAvL1dlIHNlbmQgdGhlIGNvbW1hbmQgdG8gdGhlIHNlcnZlciAodGhlIHNlcnZlciBsb2cgaXQgaW50byBhIGZpbGUsIHNlZSAuL3NyYy9zZXJ2ZXIvU2VydmVyTG9nZ2VyKVxuICAgICAgbG9nZ2VyLnNlbmRBbmRMb2dDb21tYW5kKGNvbW1hbmQpO1xuICAgICAgLy9hbmQgd2Ugc2F2ZSB0aGUgY29tbWFuZCBjcmVhdGVkXG4gICAgICBjb21tYW5kcy5wdXNoKGNvbW1hbmQpO1xuICAgIH0sXG4gICAgLy9VbmRvIGEgY29tbWFuZFxuICAgIHVuZG86IGZ1bmN0aW9uKCkge1xuICAgICAgLy9UT0RPXG4gICAgICB2YXIgY29tbWFuZCA9IGNvbW1hbmRzLnBvcCgpO1xuICAgICAgY29tbWFuZC51bmRvKCk7XG4gICAgfSxcbiAgICBleHBvcnRDYXJkOiBmdW5jdGlvbigpe1xuICAgICAgLyotLS0tLS0gQ3JlYXRlIGEgc2V0IG9mIGNhcmQgZnJvbSBhIEpTT04gZmlsZSAtLS0tLS0tKi9cbiAgICAgICAgdmFyIGFycmF5SXRlbVVwZGF0ZWQgPSBbXTtcbiAgICAgIHZhciBsaXN0U2VnbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ3NlZ21lbnQnKTtcbiAgICAgIC8vcGxheUNhcmQoYXJyYXlJdGVtLmlEaXYsIGFycmF5SXRlbS5zdGFydFApO1xuICAgICAgY29uc29sZS5sb2cobGlzdFNlZ21lbnQpO1xuICBcbiAgXG4gICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpc3RTZWdtZW50Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGxpc3RTZWdtZW50W2ldLmlkKTsgLy9zZWNvbmQgY29uc29sZSBvdXRwdXRcbiAgICAgICAgdHJpZ2dlck1vdXNlRXZlbnQobGlzdFNlZ21lbnRbaV0sJ21vdXNlZG93bicpO1xuICAgICAgfVxuICAgICBcbiAgICAgLy8gdmFyIGl0ZW0gPSBhcnJheUl0ZW0udXBkYXRlSW5mbygpO1xuICAgICAvLyB0cmlnZ2VyTW91c2VFdmVudCggYSwgXCJtb3VzZWRvd25cIik7XG4gICAgICAgIGFycmF5Q2FyZC5mb3JFYWNoKGZ1bmN0aW9uKGFycmF5SXRlbSkge1xuICAgICAgICAgIGNvbnNvbGUubG9nKGFycmF5SXRlbSk7XG4gICAgICAgICAgdmFyIGl0ZW0gPSBhcnJheUl0ZW0udXBkYXRlSW5mbygpO1xuICAgICAgICAgIGFycmF5SXRlbVVwZGF0ZWQucHVzaChpdGVtKTtcbiAgICAgICAgICBjb25zb2xlLmxvZyhpdGVtKTtcbiAgICAgICAgfSk7XG4gICAgICAgIHZhciBzZXJpYWxpemVkQXJyID0gSlNPTi5zdHJpbmdpZnkoYXJyYXlJdGVtVXBkYXRlZCk7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiKioqKiogIFNlcmlhbGlzYXRpb24gb2YgY2FyZCBjb21wbGV0ZSA6IFwiICsgc2VyaWFsaXplZEFycik7XG4gICAgICAgIGRvd25sb2FkKHNlcmlhbGl6ZWRBcnIsICdqc29uVzJsb2ctJyArIGNyZWF0ZVVuaXF1ZUlkKCkgKyAnLmpzb24nLCAndGV4dC9wbGFpbicpO1xuICAgICAgICBcbiAgICAgICAgbG9nZ2VyLnNhdmVTSChzZXJpYWxpemVkQXJyKTtcbiAgICB9XG4gICAgXG4gIH1cbn07XG5cbmZ1bmN0aW9uIHRyaWdnZXJNb3VzZUV2ZW50IChub2RlLCBldmVudFR5cGUpIHtcbiAgdmFyIGNsaWNrRXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCAoJ01vdXNlRXZlbnRzJyk7XG4gIGNsaWNrRXZlbnQuaW5pdEV2ZW50IChldmVudFR5cGUsIHRydWUsIHRydWUpO1xuICBub2RlLmRpc3BhdGNoRXZlbnQgKGNsaWNrRXZlbnQpO1xufVxuXG4vKioqKiBGdW5jdGlvbmFsIGNvcmUgb2YgdGhlIGNhcmQgbWFuYWdlciAoY3JlYXRlIGEgY2FydCwgZGVsZXRlIGEgY2FyZCBhbmQgc2F2ZSBjYXJkKSAqKioqKi9cbi8qKlxuICogVGhpcyBjbGFzcyBtYW5hZyBhbGwgdGhlIGNhcmRzIGNyZWF0ZWQuIFRoaXMgaXMgdGhlIHNlZ21lbnQgaGlzdG9yeS5cbiAqIEB0eXBlIHtIVE1MRWxlbWVudCB8IG51bGx9XG4gKi9cbnZhciB3cmFwcGVyQ29tbWFuZEFuZFJhbmdlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJ3cmFwcGVyQ29tbWFuZEFuZFJhbmdlaWRcIik7XG5cbi8vVE9ETyBTYXZlIGFuZCBsb2FkIGJ1dHRvbiwgZG8gbm8gZGVsZXRlXG4vKnNhdmVMb2dCdG4uYWRkRXZlbnRMaXN0ZW5lcihcInRvdWNoZW5kXCIsZnVuY3Rpb24gKGUpIHtcbiAgY29uc29sZS5sb2coXCJzYXZpbmcgbG9nXCIpO1xuICBhcnJheUNhcmQuZm9yRWFjaChmdW5jdGlvbiAoYXJyYXlJdGVtKSB7XG4gICAvLyBhcnJheUl0ZW0udXBkYXRlSW5mbygpO1xuICAgIC8vYXJyYXlJdGVtLlxuICB9KTtcbiAgZXhwb3J0Q2FyZHNKU29uKCk7XG4gIHRleHRTYXZlTG9nLmlubmVyVGV4dCA9IFwiTG9nIHNhdmVkIVwiIDtcbn0pO1xuXG5sb2FkTG9nQnRuLm9uY2xpY2sgPSBmdW5jdGlvbiAoKSB7XG4gIGxvYWRKU09OKG51bGwpO1xufTtcblxubG9hZExvZ0J0bi5hZGRFdmVudExpc3RlbmVyKFwibW91c2V1cFwiLGZ1bmN0aW9uIChlKSB7XG4gIC8vY29uc29sZS5sb2coXCJBQUFBQUFcIik7XG4gIC8vdmFyIG15ZGF0YSA9IEpTT04ucGFyc2UoZGF0YSk7XG4gIC8vY29uc29sZS5sb2coIGxvYWRMb2dCdG4udmFsdWUpO1xufSk7XG5cblxuXG4vKlxuXG5cblxuLy9kcmFnRWxlbWVudChkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImNhcmQxXCIpKTtcblxuXG5hZGRDYXJkLmFkZEV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgZnVuY3Rpb24gKGUpIHtcbiAgY3JlYXRlTmV3Q2FyZCgpO1xufSk7Ki9cblxuXG5mdW5jdGlvbiBjbGVhblNlZ21lbnRIaXN0b3J5KCl7XG4gIGNvbnNvbGUubG9nKFwiVEVTVElOR1wiKTtcbiAgY2xlYXJBbGxUaW1lcigpO1xuICBhcnJheUNhcmQuZm9yRWFjaChmdW5jdGlvbihlKXtcbiAgICAgIGRlbGV0ZUNhcmRVSShlKTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGxvYWRKU09OKCkge1xuICB2YXIgZmlsZXMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbG9nRmlsZUxvYWQnKS5maWxlcztcbiAgaWYgKCFmaWxlcy5sZW5ndGgpIHtcbiAgICBhbGVydCgnUGxlYXNlIHNlbGVjdCBhIGZpbGUhJyk7XG4gICAgcmV0dXJuO1xuICB9XG4gIFxuICB2YXIgZmlsZSA9IGZpbGVzWzBdO1xuICB2YXIgc3RhcnQgPSAgMDtcbiAgdmFyIHN0b3AgPSBmaWxlLnNpemUgLSAxO1xuICBcbiAgdmFyIHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7XG4gIHZhciB0ZXN0ID0gMDtcbiAgLy8gSWYgd2UgdXNlIG9ubG9hZGVuZCwgd2UgbmVlZCB0byBjaGVjayB0aGUgcmVhZHlTdGF0ZS5cbiAgcmVhZGVyLm9ubG9hZGVuZCA9IGZ1bmN0aW9uKGV2dCkge1xuICAgIGlmIChldnQudGFyZ2V0LnJlYWR5U3RhdGUgPT0gRmlsZVJlYWRlci5ET05FKSB7IC8vIERPTkUgPT0gMlxuICAgICAgdmFyIHRlc3QgPSBldnQudGFyZ2V0LnJlc3VsdDtcbiAgICAgIGNvbnNvbGUubG9nKCdSZWFkIGJ5dGVzOiAnLCBzdGFydCArIDEsICcgLSAnLCBzdG9wICsgMSxcbiAgICAgICAgICAnIG9mICcsIGZpbGUuc2l6ZSwgJyBieXRlIGZpbGUnICk7XG4gICAgICBjb25zb2xlLmxvZyh0ZXN0KTtcbiAgICAgIHZhciBteV9KU09OX29iamVjdCA9IEpTT04ucGFyc2UodGVzdCk7XG4gIFxuICAgICAgY29uc29sZS5sb2cobXlfSlNPTl9vYmplY3QpO1xuICBcbiAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgbXlfSlNPTl9vYmplY3QubGVuZ3RoOyBrKyspIHtcbiAgICAgICAgYWRkaW5nTmV3Q2FyZHNGcm9tSlNvbihteV9KU09OX29iamVjdFtrXSk7XG4gICAgICB9XG4gICAgfVxuICB9O1xuICB2YXIgYmxvYiA9IGZpbGUuc2xpY2Uoc3RhcnQsIHN0b3AgKyAxKTtcbiAgcmVhZGVyLnJlYWRBc0JpbmFyeVN0cmluZyhibG9iKTtcbn1cblxuLy9BZGQgYSBjYXJkIGZyb20gYSBqc29uIGZpbGVcbmZ1bmN0aW9uIGFkZGluZ05ld0NhcmRzRnJvbUpTb24oY2FyZEluZm8pIHtcbiAgaWYgKGNhcmRJbmZvLnN0YXJ0UCA+IGNhcmRJbmZvLmVuZFApIHtcbiAgICBsZXQgdHJhbnNpdCA9IGNhcmRJbmZvLnN0YXJ0UDtcbiAgICBjYXJkSW5mby5zdGFydFAgPSBjYXJkSW5mby5lbmRQO1xuICAgIGNhcmRJbmZvLmVuZFAgPSB0cmFuc2l0O1xuICB9XG4gIGlmIChjYXJkSW5mby5zdGFydFAgPCAwKSB7XG4gICAgY2FyZEluZm8uc3RhcnRQID0gMDtcbiAgfVxuICBsZXQgcmVzdWx0ID0gUGxheWVyLnNsaWRlclRvVmlkZW8oY2FyZEluZm8uc3RhcnRQLCBjYXJkSW5mby5lbmRQKTtcbiAgY29uc29sZS5sb2cocmVzdWx0KTtcbiAgbnVtYmVyT2ZDYXJkKys7XG4gIGlmICghY2FyZEluZm8uZGVsZXRlZCkge1xuICAgIGNvbnNvbGUubG9nKHJlc3VsdC5zdGFydER1cmF0aW9uLCByZXN1bHQuZW5kRHVyYXRpb24sIGNhcmRJbmZvLnN0YXJ0UCwgY2FyZEluZm8uZW5kUCwgY2FyZEluZm8pO1xuICAgIHZhciBjYXJkID0gQ2FyZChyZXN1bHQuc3RhcnREdXJhdGlvbiwgcmVzdWx0LmVuZER1cmF0aW9uLCBjYXJkSW5mby5zdGFydFAsIGNhcmRJbmZvLmVuZFAsIGNhcmRJbmZvKTtcbiAgICBjYXJkTWFuYWdlci5leGVjdXRlKG5ldyBDcmVhdGVOZXdDYXJkQ29tbWFuZChjYXJkKSk7XG4gICAgLy9kb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnZGl2Q2FyZEJvYXJkJykuaW5zZXJ0QmVmb3JlKGNhcmQuaURpdiwgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RpdkNhcmRCb2FyZCcpLmZpcnN0Q2hpbGQpO1xuICB9XG59XG5cbi8qKlxuICogQWRkaW5nIGEgY2FyZCBieSBkcmFnIGFuZCBkcm9wLiBUaGUgY2FyZCBpcyBhZGRlZCBpbiB0aGUgbGlzdCBvZiBjYXJkc1xuICogUmV0dXJuIHRoZSBjYXJkIHRoYXQgaGF2ZSBiZWVuIGNyZWF0ZWRcbiAqL1xuZnVuY3Rpb24gY3JlYXRlTmV3Q2FyZChzdGFydFAsIGVuZFApIHtcbiAgLy9jb25zb2xlLmxvZyhcIlRFU1QgLyA6IFwiICsgc3RhcnRQICsgXCIgXCIgKyBlbmRQKTtcbiAgaWYgKHN0YXJ0UCA+IGVuZFApIHtcbiAgICBsZXQgdHJhbnNpdCA9IHN0YXJ0UDtcbiAgICBzdGFydFAgPSBlbmRQO1xuICAgIGVuZFAgPSB0cmFuc2l0O1xuICB9XG4gIGxldCByZXN1bHQgPSBQbGF5ZXIuc2xpZGVyVG9WaWRlbyhzdGFydFAsIGVuZFApO1xuICBudW1iZXJPZkNhcmQrKztcbiAgY29uc29sZS5sb2cocmVzdWx0KTtcbiAgXG4gIHZhciBjYXJkID0gbmV3IENhcmQocmVzdWx0LnN0YXJ0RHVyYXRpb24sIHJlc3VsdC5lbmREdXJhdGlvbiwgc3RhcnRQLCBlbmRQKTtcbiAgY2FyZE1hbmFnZXIuZXhlY3V0ZShuZXcgQ3JlYXRlTmV3Q2FyZENvbW1hbmQoY2FyZCkpO1xuICByZXR1cm4gY2FyZDtcbn1cblxuZnVuY3Rpb24gYWRkaW5nTmV3Q2FyZCgpIHtcbiAgYXJyYXlDYXJkLnB1c2godGhpcy5jYXJkKTtcbiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RpdkNhcmRCb2FyZCcpLmluc2VydEJlZm9yZSh0aGlzLmNhcmQuaURpdiwgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RpdkNhcmRCb2FyZCcpLmZpcnN0Q2hpbGQpO1xufVxuXG5mdW5jdGlvbiBkZWxldGVDYXJkKCkge1xuICAvL1N1cHByaW1lIGxhIGNhcnRlIGRlIGxhIGxpc3RlIGRlIGNhcnRlXG4gIC8qZm9yIChsZXQgaSA9IDA7IGkgPCBhcnJheUNhcmQubGVuZ3RoICAgOyBpKyspIHtcbiAgICBpZihhcnJheUNhcmRbaV0gID09PSBjYXJkKXtcbiAgICAgIHZhciBzdXBDYXJkID0gYXJyYXlDYXJkLnNwbGljZShpLDEpO1xuICAgICAgYXJyYXlDYXJkRGVsZXRlZC5wdXNoKHN1cENhcmQpO1xuICAgICAgY29uc29sZS5sb2coXCJkZWxldGVkIGNhcmQgOiBcIik7XG4gICAgICBjb25zb2xlLmxvZyhzdXBDYXJkKTtcbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgfSovXG4gIC8vZGVsZXRlQ2FyZFVJKGNhcmQpO1xuICAvKmFycmF5Q2FyZERlbGV0ZWQuZm9yRWFjaChmdW5jdGlvbihlbGVtZW50KSB7XG4gICAgY29uc29sZS5sb2coICAgZWxlbWVudCk7XG4gIH0pO1xuICBjb25zb2xlLmxvZyhcIioqKioqKioqKioqKioqKioqKioqKioqKlwiKTtcbiAgYXJyYXlDYXJkLmZvckVhY2goZnVuY3Rpb24oZWxlbWVudCkge1xuICAgIGNvbnNvbGUubG9nKGVsZW1lbnQpO1xuICB9KTsqL1xuICBjbGVhckFsbFRpbWVyKCk7XG4gIGRlbGV0ZUNhcmRVSSh0aGlzLmNhcmQpO1xuICByZXR1cm4gdGhpcy5jYXJkO1xufVxuXG5mdW5jdGlvbiBkZWxldGVDYXJkVUkoY2FyZCkge1xuICBmZWVkYmFja09uU2xpZGVyVmlkZW8oZmFsc2UpO1xuICBjYXJkLmlEaXYucmVtb3ZlKCk7XG4gIGNhcmQuZGVsZXRlZCA9IHRydWVcbn1cblxuZnVuY3Rpb24gZG93bmxvYWQoY29udGVudCwgZmlsZU5hbWUsIGNvbnRlbnRUeXBlKSB7XG4gIHZhciBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFcIik7XG4gIFxuICBcbiAvL2Euc3R5bGUuZGlzcGxheSA9IFwiYmxvY2tcIjtcbiAgdmFyIGZpbGUgPSBuZXcgQmxvYihbY29udGVudF0sIHtcbiAgICB0eXBlOiBjb250ZW50VHlwZVxuICB9KTtcbiAgXG4gIGEuaHJlZiA9IFVSTC5jcmVhdGVPYmplY3RVUkwoZmlsZSk7XG4gIGEuZG93bmxvYWQgPSBmaWxlTmFtZTtcbiAgYS5jbGljaygpO1xuICBhLnJlbW92ZSgpO1xuICBcbiAgXG4gIFxuICBcbn1cblxuXG5cbmZ1bmN0aW9uIGxvYWRKU09OU2VnbWVudEhpc3RvcnkxKCkge1xuICBcbiAgICAgIGNvbnNvbGUubG9nKGdlbmVyYXRlSlNPTmZyb212YXIoKSk7XG4gICAgICBcbiAgICAgIGxldCBnZW5lcmF0ZWRKc29uID0gZ2VuZXJhdGVKU09OZnJvbXZhcigpO1xuICAgICAgdmFyIG15X0pTT05fb2JqZWN0ID0gSlNPTi5wYXJzZShnZW5lcmF0ZWRKc29uKTtcbiAgICAgIGNvbnNvbGUubG9nKG15X0pTT05fb2JqZWN0KTtcbiAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgbXlfSlNPTl9vYmplY3QubGVuZ3RoOyBrKyspIHtcbiAgICAgICAgXG4gICAgICAgIGFkZGluZ05ld0NhcmRzRnJvbUpTb24obXlfSlNPTl9vYmplY3Rba10pO1xuICAgICAgXG4gICAgfVxuICBcbn1cblxuZnVuY3Rpb24gbG9hZEpTT05TZWdtZW50SGlzdG9yeTIoKSB7XG4gIGxldCBnZW5lcmF0ZWRKc29uMiA9IGdlbmVyYXRlSlNPTmZyb212YXIyKCk7XG4gIFxuICB2YXIgbXlfSlNPTl9vYmplY3QgPSBKU09OLnBhcnNlKGdlbmVyYXRlZEpzb24yKTtcbiAgY29uc29sZS5sb2cobXlfSlNPTl9vYmplY3QpO1xuICBmb3IgKGxldCBrID0gMDsgayA8IG15X0pTT05fb2JqZWN0Lmxlbmd0aDsgaysrKSB7XG4gICAgYWRkaW5nTmV3Q2FyZHNGcm9tSlNvbihteV9KU09OX29iamVjdFtrXSk7XG4gICAgXG4gIH1cbiAgXG59XG5cbmZ1bmN0aW9uIGxvYWRKU09OU2VnbWVudEhpc3RvcnlUdXRvcmlhbCgpIHtcbiAgbGV0IGdlbmVyYXRlZEpzb24yID0gZ2VuZXJhdGVKU09OZnJvbXZhclR1dG8oKTtcbiAgXG4gIHZhciBteV9KU09OX29iamVjdCA9IEpTT04ucGFyc2UoZ2VuZXJhdGVkSnNvbjIpO1xuICBjb25zb2xlLmxvZyhteV9KU09OX29iamVjdCk7XG4gIGZvciAobGV0IGsgPSAwOyBrIDwgbXlfSlNPTl9vYmplY3QubGVuZ3RoOyBrKyspIHtcbiAgICBhZGRpbmdOZXdDYXJkc0Zyb21KU29uKG15X0pTT05fb2JqZWN0W2tdKTtcbiAgICBcbiAgfVxuICBcbn1cbiJdfQ==