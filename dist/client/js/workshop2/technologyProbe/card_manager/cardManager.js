'use strict';

var numberOfCard = 0;
var arrayCard = [];
//var arrayCardDeleted = [];
var commands = [];

var CardManager = function CardManager() {
  //I implemented a command pattern, see : https://www.dofactory.com/javascript/command-design-pattern
  return {
    //execute a command
    execute: function execute(command) {
      command.execute();
      //We send the command to the server (the server log it into a file, see ./src/server/ServerLogger)
      logger.sendAndLogCommand(command);
      //and we save the command created
      commands.push(command);
    },
    //Undo a command
    undo: function undo() {
      var command = commands.pop();
      command.undo();
    },
    exportCard: function exportCard() {
      console.log("function export card");
      /*------ Create a set of card from a JSON file -------*/
      var arrayItemUpdated = [];
      var listSegment = document.getElementsByClassName('segment');
      //playCard(arrayItem.iDiv, arrayItem.startP);
      console.log(listSegment);

      for (var i = 0; i < listSegment.length; i++) {
        console.log(listSegment[i].id); //second console output
        triggerMouseEvent(listSegment[i], 'mousedown');
      }
      arrayCard.forEach(function (arrayItem) {
        console.log(arrayItem);
        var item = arrayItem.updateInfo();
        arrayItemUpdated.push(item);
        console.log(item);
      });
      var serializedArr = JSON.stringify(arrayItemUpdated);
      console.log("*****  Serialisation of card complete : " + serializedArr);
      download(serializedArr, 'jsonW2log-' + createUniqueId() + '.json', 'text/plain');

      logger.saveSH(serializedArr);
    }, loadSegmentHistoryFromServer: function loadSegmentHistoryFromServer() {
      //We charge all the video only one time
      var xhr_view = new XMLHttpRequest();
      xhr_view.open('GET', 'src/client/js/workshop2/technologyProbe/card_manager/SHLoaderOverview_view.html', true);
      var view_SH_html = document.getElementById('SHPickerOverviewModal');

      xhr_view.onreadystatechange = function () {
        if (this.readyState !== 4) return;
        if (this.status !== 200) return; // or whatever error handling you want
        view_SH_html.innerHTML = this.responseText;
      };
      xhr_view.send();

      //We charge all the video only one time


      var xhr_allPath = new XMLHttpRequest();
      xhr_allPath.open('GET', 'src/server/log-SH/SH_all_path.txt', true);

      xhr_allPath.onreadystatechange = function () {
        if (this.readyState !== 4) return;
        if (this.status !== 200) return; // or whatever error handling you want


        var lines = this.responseText.split('\n');
        for (var j = 0; j < lines.length - 1; j++) {
          var xhr_SH = new XMLHttpRequest();
          xhr_SH.open('GET', lines[j], true);
          xhr_SH.onreadystatechange = function () {
            //console.log(this.responseText);
            //Ici il faut lire les fichier json et crÃ©er un appercu de chaque
          };
          xhr_SH.send();
          var div = document.createElement('div');
          div.className = 'gridSH';
          var split = lines[j].split('/');
          //get only the name
          var nameSH = split[split.length - 1];
          console.log(nameSH);
          div.innerHTML = nameSH;
          document.getElementById('SH_list').appendChild(div);
          div.setAttribute("nameSH", lines[j]);
          div.addEventListener("mousedown", function () {
            console.log(this.getAttribute("nameSH"));
            loadJSONSegmentHistory(this.getAttribute("nameSH"));
          });
        }
      };
      xhr_allPath.send();
    }
  };
};

/*Private function, do not call outside the CardManager*/

function triggerMouseEvent(node, eventType) {
  var clickEvent = document.createEvent('MouseEvents');
  clickEvent.initEvent(eventType, true, true);
  node.dispatchEvent(clickEvent);
}

/**** Functional core of the card manager (create a cart, delete a card and save card) *****/
/**
 * This class manag all the cards created. This is the segment history.
 * @type {HTMLElement | null}
 */
var wrapperCommandAndRange = document.getElementById("wrapperCommandAndRangeid");

function cleanSegmentHistory() {
  console.log("TESTING");
  clearAllTimer();
  arrayCard.forEach(function (e) {
    deleteCardUI(e);
  });
}

function loadJSON() {
  var files = document.getElementById('logFileLoad').files;
  if (!files.length) {
    alert('Please select a file!');
    return;
  }

  var file = files[0];
  var start = 0;
  var stop = file.size - 1;

  var reader = new FileReader();
  var test = 0;
  // If we use onloadend, we need to check the readyState.
  reader.onloadend = function (evt) {
    if (evt.target.readyState == FileReader.DONE) {
      // DONE == 2
      var test = evt.target.result;
      console.log('Read bytes: ', start + 1, ' - ', stop + 1, ' of ', file.size, ' byte file');
      console.log(test);
      var my_JSON_object = JSON.parse(test);

      console.log(my_JSON_object);

      for (var k = 0; k < my_JSON_object.length; k++) {
        addingNewCardsFromJSon(my_JSON_object[k]);
      }
    }
  };
  var blob = file.slice(start, stop + 1);
  reader.readAsBinaryString(blob);
}

//Add a card from a json file
function addingNewCardsFromJSon(cardInfo) {
  if (cardInfo.startP > cardInfo.endP) {
    var transit = cardInfo.startP;
    cardInfo.startP = cardInfo.endP;
    cardInfo.endP = transit;
  }
  if (cardInfo.startP < 0) {
    cardInfo.startP = 0;
  }
  console.log(cardInfo.startP, cardInfo.endP);
  var result = { startDuration: cardInfo.startP, endDuration: cardInfo.endP };

  //let result = player.sliderToVideo(cardInfo.startP, cardInfo.endP);
  //console.log(result);
  numberOfCard++;
  if (!cardInfo.deleted) {
    console.log(result.startDuration, result.endDuration, cardInfo.startP, cardInfo.endP, cardInfo);
    var card = Card(result.startDuration, result.endDuration, cardInfo.startP, cardInfo.endP, cardInfo);
    cardManager.execute(new CreateNewCardCommand(card));
    //document.getElementById('divCardBoard').insertBefore(card.iDiv, document.getElementById('divCardBoard').firstChild);
  }
}

/**
 * Adding a card by drag and drop. The card is added in the list of cards
 * Return the card that have been created
 */
function createNewCard(startP, endP, positionStart, positionStop) {
  //console.log("TEST / : " + startP + " " + endP, positionStart, positionStop);
  //The two cases if we create a segment backward
  if (parseFloat(positionStart) > parseFloat(positionStop)) {
    var transit = positionStart;
    positionStart = positionStop;
    positionStop = transit;
  }
  if (parseFloat(startP) > parseFloat(endP)) {
    var _transit = startP;
    startP = endP;
    endP = _transit;
  }
  var result = { startDuration: startP, endDuration: endP };
  numberOfCard++;
  console.log(result.startDuration, result.endDuration, positionStart, positionStop);

  var card = new Card(result.startDuration, result.endDuration, positionStart, positionStop);
  //var card2 = new Card(startP, endP, startP, endP);
  cardManager.execute(new CreateNewCardCommand(card));
  //cardManager.execute(new CreateNewCardCommand(card2));
  return card;
}

function addingNewCard() {
  arrayCard.push(this.card);
  document.getElementById('divCardBoard').insertBefore(this.card.iDiv, document.getElementById('divCardBoard').firstChild);
}

function deleteCard() {
  //Supprime la carte de la liste de carte
  /*for (let i = 0; i < arrayCard.length   ; i++) {
    if(arrayCard[i]  === card){
      var supCard = arrayCard.splice(i,1);
      arrayCardDeleted.push(supCard);
      console.log("deleted card : ");
      console.log(supCard);
      break;
    }
  }*/
  //deleteCardUI(card);
  /*arrayCardDeleted.forEach(function(element) {
    console.log(   element);
  });
  console.log("************************");
  arrayCard.forEach(function(element) {
    console.log(element);
  });*/
  clearAllTimer();
  deleteCardUI(this.card);
  return this.card;
}

function deleteCardUI(card) {
  feedbackOnSliderVideo(false);
  card.iDiv.remove();
  card.deleted = true;
}

function download(content, fileName, contentType) {
  var a = document.createElement("a");

  //a.style.display = "block";
  var file = new Blob([content], {
    type: contentType
  });

  a.href = URL.createObjectURL(file);
  a.download = fileName;
  a.click();
  a.remove();
}

function loadJSONSegmentHistory1() {

  console.log(generateJSONfromvar());

  var generatedJson = generateJSONfromvar();
  var my_JSON_object = JSON.parse(generatedJson);
  console.log(my_JSON_object);
  for (var k = 0; k < my_JSON_object.length; k++) {
    addingNewCardsFromJSon(my_JSON_object[k]);
  }
}

function loadJSONSegmentHistory2() {
  var generatedJson2 = generateJSONfromvar2();
  var my_JSON_object = JSON.parse(generatedJson2);
  console.log(my_JSON_object);
  for (var k = 0; k < my_JSON_object.length; k++) {
    addingNewCardsFromJSon(my_JSON_object[k]);
  }
}

function loadJSONSegmentHistory(SH_path) {

  var xhr_SH = new XMLHttpRequest();
  xhr_SH.open('GET', SH_path, true);

  xhr_SH.onreadystatechange = function () {
    if (this.readyState !== 4) return;
    if (this.status !== 200) return; // or whatever error handling you want
    console.log(this.responseText);
    var generatedJson2 = this.responseText;

    var my_JSON_object = JSON.parse(generatedJson2);
    console.log(my_JSON_object);
    for (var k = 0; k < my_JSON_object.length; k++) {
      addingNewCardsFromJSon(my_JSON_object[k]);
    }
  };
  xhr_SH.send();

  var elms = document.getElementById('SHPickerOverview');
  var span = document.getElementsByClassName("close")[1];

  span.addEventListener("mousedown", function () {
    elms.style.display = "none";
  });
}

function feedbackOnSliderVideo(visibility, startDurationParam, endDurationParam) {
  if (visibility) {
    segmentFeedback.divGraphicalObject.style.visibility = "visible";
    //TODO
    segmentFeedback.width = 0;
    segmentFeedback.startPostion = 0;
    segmentFeedback.width = 0;
    segmentFeedback.startPostion = 0;
  } else {
    segmentFeedback.divGraphicalObject.style.visibility = "hidden";
    //TODO
    segmentFeedback.width = 0;
    segmentFeedback.startPostion = 0;
    segmentFeedback.width = 0;
    segmentFeedback.startPostion = 0;
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImNhcmRNYW5hZ2VyLmpzIl0sIm5hbWVzIjpbIm51bWJlck9mQ2FyZCIsImFycmF5Q2FyZCIsImNvbW1hbmRzIiwiQ2FyZE1hbmFnZXIiLCJleGVjdXRlIiwiY29tbWFuZCIsImxvZ2dlciIsInNlbmRBbmRMb2dDb21tYW5kIiwicHVzaCIsInVuZG8iLCJwb3AiLCJleHBvcnRDYXJkIiwiY29uc29sZSIsImxvZyIsImFycmF5SXRlbVVwZGF0ZWQiLCJsaXN0U2VnbWVudCIsImRvY3VtZW50IiwiZ2V0RWxlbWVudHNCeUNsYXNzTmFtZSIsImkiLCJsZW5ndGgiLCJpZCIsInRyaWdnZXJNb3VzZUV2ZW50IiwiZm9yRWFjaCIsImFycmF5SXRlbSIsIml0ZW0iLCJ1cGRhdGVJbmZvIiwic2VyaWFsaXplZEFyciIsIkpTT04iLCJzdHJpbmdpZnkiLCJkb3dubG9hZCIsImNyZWF0ZVVuaXF1ZUlkIiwic2F2ZVNIIiwibG9hZFNlZ21lbnRIaXN0b3J5RnJvbVNlcnZlciIsInhocl92aWV3IiwiWE1MSHR0cFJlcXVlc3QiLCJvcGVuIiwidmlld19TSF9odG1sIiwiZ2V0RWxlbWVudEJ5SWQiLCJvbnJlYWR5c3RhdGVjaGFuZ2UiLCJyZWFkeVN0YXRlIiwic3RhdHVzIiwiaW5uZXJIVE1MIiwicmVzcG9uc2VUZXh0Iiwic2VuZCIsInhocl9hbGxQYXRoIiwibGluZXMiLCJzcGxpdCIsImoiLCJ4aHJfU0giLCJkaXYiLCJjcmVhdGVFbGVtZW50IiwiY2xhc3NOYW1lIiwibmFtZVNIIiwiYXBwZW5kQ2hpbGQiLCJzZXRBdHRyaWJ1dGUiLCJhZGRFdmVudExpc3RlbmVyIiwiZ2V0QXR0cmlidXRlIiwibG9hZEpTT05TZWdtZW50SGlzdG9yeSIsIm5vZGUiLCJldmVudFR5cGUiLCJjbGlja0V2ZW50IiwiY3JlYXRlRXZlbnQiLCJpbml0RXZlbnQiLCJkaXNwYXRjaEV2ZW50Iiwid3JhcHBlckNvbW1hbmRBbmRSYW5nZSIsImNsZWFuU2VnbWVudEhpc3RvcnkiLCJjbGVhckFsbFRpbWVyIiwiZSIsImRlbGV0ZUNhcmRVSSIsImxvYWRKU09OIiwiZmlsZXMiLCJhbGVydCIsImZpbGUiLCJzdGFydCIsInN0b3AiLCJzaXplIiwicmVhZGVyIiwiRmlsZVJlYWRlciIsInRlc3QiLCJvbmxvYWRlbmQiLCJldnQiLCJ0YXJnZXQiLCJET05FIiwicmVzdWx0IiwibXlfSlNPTl9vYmplY3QiLCJwYXJzZSIsImsiLCJhZGRpbmdOZXdDYXJkc0Zyb21KU29uIiwiYmxvYiIsInNsaWNlIiwicmVhZEFzQmluYXJ5U3RyaW5nIiwiY2FyZEluZm8iLCJzdGFydFAiLCJlbmRQIiwidHJhbnNpdCIsInN0YXJ0RHVyYXRpb24iLCJlbmREdXJhdGlvbiIsImRlbGV0ZWQiLCJjYXJkIiwiQ2FyZCIsImNhcmRNYW5hZ2VyIiwiQ3JlYXRlTmV3Q2FyZENvbW1hbmQiLCJjcmVhdGVOZXdDYXJkIiwicG9zaXRpb25TdGFydCIsInBvc2l0aW9uU3RvcCIsInBhcnNlRmxvYXQiLCJhZGRpbmdOZXdDYXJkIiwiaW5zZXJ0QmVmb3JlIiwiaURpdiIsImZpcnN0Q2hpbGQiLCJkZWxldGVDYXJkIiwiZmVlZGJhY2tPblNsaWRlclZpZGVvIiwicmVtb3ZlIiwiY29udGVudCIsImZpbGVOYW1lIiwiY29udGVudFR5cGUiLCJhIiwiQmxvYiIsInR5cGUiLCJocmVmIiwiVVJMIiwiY3JlYXRlT2JqZWN0VVJMIiwiY2xpY2siLCJsb2FkSlNPTlNlZ21lbnRIaXN0b3J5MSIsImdlbmVyYXRlSlNPTmZyb212YXIiLCJnZW5lcmF0ZWRKc29uIiwibG9hZEpTT05TZWdtZW50SGlzdG9yeTIiLCJnZW5lcmF0ZWRKc29uMiIsImdlbmVyYXRlSlNPTmZyb212YXIyIiwiU0hfcGF0aCIsImVsbXMiLCJzcGFuIiwic3R5bGUiLCJkaXNwbGF5IiwidmlzaWJpbGl0eSIsInN0YXJ0RHVyYXRpb25QYXJhbSIsImVuZER1cmF0aW9uUGFyYW0iLCJzZWdtZW50RmVlZGJhY2siLCJkaXZHcmFwaGljYWxPYmplY3QiLCJ3aWR0aCIsInN0YXJ0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QXFCLE1BQXJCO0FBQ0QsR0FGRDtBQUlEOztBQUtELFNBQVV0QixxQkFBVixDQUFnQ3VCLFVBQWhDLEVBQTJDQyxrQkFBM0MsRUFBOERDLGdCQUE5RCxFQUErRTtBQUM3RSxNQUFHRixVQUFILEVBQWM7QUFDWkcsb0JBQWdCQyxrQkFBaEIsQ0FBbUNOLEtBQW5DLENBQXlDRSxVQUF6QyxHQUFzRCxTQUF0RDtBQUNBO0FBQ0FHLG9CQUFnQkUsS0FBaEIsR0FBd0IsQ0FBeEI7QUFDQUYsb0JBQWdCRyxZQUFoQixHQUE4QixDQUE5QjtBQUNBSCxvQkFBZ0JFLEtBQWhCLEdBQXdCLENBQXhCO0FBQ0FGLG9CQUFnQkcsWUFBaEIsR0FBK0IsQ0FBL0I7QUFDRCxHQVBELE1BT087QUFDTEgsb0JBQWdCQyxrQkFBaEIsQ0FBbUNOLEtBQW5DLENBQXlDRSxVQUF6QyxHQUFzRCxRQUF0RDtBQUNBO0FBQ0FHLG9CQUFnQkUsS0FBaEIsR0FBd0IsQ0FBeEI7QUFDQUYsb0JBQWdCRyxZQUFoQixHQUE4QixDQUE5QjtBQUNBSCxvQkFBZ0JFLEtBQWhCLEdBQXdCLENBQXhCO0FBQ0FGLG9CQUFnQkcsWUFBaEIsR0FBK0IsQ0FBL0I7QUFDRDtBQUNGIiwiZmlsZSI6ImNhcmRNYW5hZ2VyLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIG51bWJlck9mQ2FyZCA9IDA7XG52YXIgYXJyYXlDYXJkID0gW107XG4vL3ZhciBhcnJheUNhcmREZWxldGVkID0gW107XG52YXIgY29tbWFuZHMgPSBbXTtcblxuXG5cbnZhciBDYXJkTWFuYWdlciA9IGZ1bmN0aW9uKCkge1xuICAvL0kgaW1wbGVtZW50ZWQgYSBjb21tYW5kIHBhdHRlcm4sIHNlZSA6IGh0dHBzOi8vd3d3LmRvZmFjdG9yeS5jb20vamF2YXNjcmlwdC9jb21tYW5kLWRlc2lnbi1wYXR0ZXJuXG4gIHJldHVybiB7XG4gICAgLy9leGVjdXRlIGEgY29tbWFuZFxuICAgIGV4ZWN1dGU6IGZ1bmN0aW9uKGNvbW1hbmQpIHtcbiAgICAgY29tbWFuZC5leGVjdXRlKCk7XG4gICAgICAvL1dlIHNlbmQgdGhlIGNvbW1hbmQgdG8gdGhlIHNlcnZlciAodGhlIHNlcnZlciBsb2cgaXQgaW50byBhIGZpbGUsIHNlZSAuL3NyYy9zZXJ2ZXIvU2VydmVyTG9nZ2VyKVxuICAgICAgbG9nZ2VyLnNlbmRBbmRMb2dDb21tYW5kKGNvbW1hbmQpO1xuICAgICAgLy9hbmQgd2Ugc2F2ZSB0aGUgY29tbWFuZCBjcmVhdGVkXG4gICAgICBjb21tYW5kcy5wdXNoKGNvbW1hbmQpO1xuICAgIH0sXG4gICAgLy9VbmRvIGEgY29tbWFuZFxuICAgIHVuZG86IGZ1bmN0aW9uKCkge1xuICAgICAgdmFyIGNvbW1hbmQgPSBjb21tYW5kcy5wb3AoKTtcbiAgICAgIGNvbW1hbmQudW5kbygpO1xuICAgIH0sXG4gICAgZXhwb3J0Q2FyZDogZnVuY3Rpb24oKXtcbiAgICAgIGNvbnNvbGUubG9nKFwiZnVuY3Rpb24gZXhwb3J0IGNhcmRcIik7XG4gICAgICAvKi0tLS0tLSBDcmVhdGUgYSBzZXQgb2YgY2FyZCBmcm9tIGEgSlNPTiBmaWxlIC0tLS0tLS0qL1xuICAgICAgdmFyIGFycmF5SXRlbVVwZGF0ZWQgPSBbXTtcbiAgICAgIHZhciBsaXN0U2VnbWVudCA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoJ3NlZ21lbnQnKTtcbiAgICAgIC8vcGxheUNhcmQoYXJyYXlJdGVtLmlEaXYsIGFycmF5SXRlbS5zdGFydFApO1xuICAgICAgY29uc29sZS5sb2cobGlzdFNlZ21lbnQpO1xuICAgICAgXG4gICAgICBmb3IgKHZhciBpID0gMDsgaSA8IGxpc3RTZWdtZW50Lmxlbmd0aDsgaSsrKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGxpc3RTZWdtZW50W2ldLmlkKTsgLy9zZWNvbmQgY29uc29sZSBvdXRwdXRcbiAgICAgICAgdHJpZ2dlck1vdXNlRXZlbnQobGlzdFNlZ21lbnRbaV0sJ21vdXNlZG93bicpO1xuICAgICAgfVxuICAgICAgICBhcnJheUNhcmQuZm9yRWFjaChmdW5jdGlvbihhcnJheUl0ZW0pIHtcbiAgICAgICAgICBjb25zb2xlLmxvZyhhcnJheUl0ZW0pO1xuICAgICAgICAgIHZhciBpdGVtID0gYXJyYXlJdGVtLnVwZGF0ZUluZm8oKTtcbiAgICAgICAgICBhcnJheUl0ZW1VcGRhdGVkLnB1c2goaXRlbSk7XG4gICAgICAgICAgY29uc29sZS5sb2coaXRlbSk7XG4gICAgICAgIH0pO1xuICAgICAgICB2YXIgc2VyaWFsaXplZEFyciA9IEpTT04uc3RyaW5naWZ5KGFycmF5SXRlbVVwZGF0ZWQpO1xuICAgICAgICBjb25zb2xlLmxvZyhcIioqKioqICBTZXJpYWxpc2F0aW9uIG9mIGNhcmQgY29tcGxldGUgOiBcIiArIHNlcmlhbGl6ZWRBcnIpO1xuICAgICAgICBkb3dubG9hZChzZXJpYWxpemVkQXJyLCAnanNvblcybG9nLScgKyBjcmVhdGVVbmlxdWVJZCgpICsgJy5qc29uJywgJ3RleHQvcGxhaW4nKTtcbiAgICAgICAgXG4gICAgICAgIGxvZ2dlci5zYXZlU0goc2VyaWFsaXplZEFycik7XG4gICAgfSwgbG9hZFNlZ21lbnRIaXN0b3J5RnJvbVNlcnZlcjogZnVuY3Rpb24oKXtcbiAgICAgIC8vV2UgY2hhcmdlIGFsbCB0aGUgdmlkZW8gb25seSBvbmUgdGltZVxuICAgICAgdmFyIHhocl92aWV3ID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XG4gICAgICB4aHJfdmlldy5vcGVuKCdHRVQnLCAnc3JjL2NsaWVudC9qcy93b3Jrc2hvcDIvdGVjaG5vbG9neVByb2JlL2NhcmRfbWFuYWdlci9TSExvYWRlck92ZXJ2aWV3X3ZpZXcuaHRtbCcsIHRydWUpO1xuICAgICAgdmFyIHZpZXdfU0hfaHRtbCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdTSFBpY2tlck92ZXJ2aWV3TW9kYWwnKTtcbiAgICBcbiAgICAgIHhocl92aWV3Lm9ucmVhZHlzdGF0ZWNoYW5nZSA9IGZ1bmN0aW9uICgpIHtcbiAgICAgICAgaWYgKHRoaXMucmVhZHlTdGF0ZSE9PTQpIHJldHVybjtcbiAgICAgICAgaWYgKHRoaXMuc3RhdHVzIT09MjAwKSByZXR1cm47IC8vIG9yIHdoYXRldmVyIGVycm9yIGhhbmRsaW5nIHlvdSB3YW50XG4gICAgICAgIHZpZXdfU0hfaHRtbC5pbm5lckhUTUw9IHRoaXMucmVzcG9uc2VUZXh0O1xuICAgICAgfTtcbiAgICAgIHhocl92aWV3LnNlbmQoKTtcbiAgICBcbiAgICAgIC8vV2UgY2hhcmdlIGFsbCB0aGUgdmlkZW8gb25seSBvbmUgdGltZVxuICAgICAgXG4gICAgICBcbiAgICAgIHZhciB4aHJfYWxsUGF0aCA9IG5ldyBYTUxIdHRwUmVxdWVzdCgpO1xuICAgICAgeGhyX2FsbFBhdGgub3BlbignR0VUJywgJ3NyYy9zZXJ2ZXIvbG9nLVNIL1NIX2FsbF9wYXRoLnR4dCcsIHRydWUpO1xuICAgIFxuICAgICAgeGhyX2FsbFBhdGgub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24gKCkge1xuICAgICAgICBpZiAodGhpcy5yZWFkeVN0YXRlIT09NCkgcmV0dXJuO1xuICAgICAgICBpZiAodGhpcy5zdGF0dXMhPT0yMDApIHJldHVybjsgLy8gb3Igd2hhdGV2ZXIgZXJyb3IgaGFuZGxpbmcgeW91IHdhbnRcbiAgICAgICAgXG4gICAgICAgIFxuICAgICAgICB2YXIgbGluZXMgPSB0aGlzLnJlc3BvbnNlVGV4dC5zcGxpdCgnXFxuJyk7XG4gICAgICAgIGZvcih2YXIgaiA9IDA7IGogPCBsaW5lcy5sZW5ndGgtMTsgaisrKXtcbiAgICAgICAgICB2YXIgeGhyX1NIID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XG4gICAgICAgICAgeGhyX1NILm9wZW4oJ0dFVCcsIGxpbmVzW2pdLCB0cnVlKTtcbiAgICAgICAgICB4aHJfU0gub25yZWFkeXN0YXRlY2hhbmdlID0gZnVuY3Rpb24gKCkge1xuICAgICAgICAgICAgY29uc29sZS5sb2codGhpcy5yZXNwb25zZVRleHQpO1xuICAgICAgICAgICAgLy9JY2kgaWwgZmF1dCBsaXJlIGxlcyBmaWNoaWVyIGpzb24gZXQgY3LDqWVyIHVuIGFwcGVyY3UgZGUgY2hhcXVlXG4gICAgICAgICAgICBcbiAgICAgICAgICB9O1xuICAgICAgICAgIHhocl9TSC5zZW5kKCk7XG4gICAgICAgICAgdmFyIGRpdiA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQoJ2RpdicpO1xuICAgICAgICAgIGRpdi5jbGFzc05hbWUgPSAnZ3JpZFNIJztcbiAgICAgICAgICB2YXIgc3BsaXQgPSBsaW5lc1tqXS5zcGxpdCgnLycpO1xuICAgICAgICAgIC8vZ2V0IG9ubHkgdGhlIG5hbWVcbiAgICAgICAgICB2YXIgbmFtZVNIID0gc3BsaXRbc3BsaXQubGVuZ3RoLTFdO1xuICAgICAgICAgIGNvbnNvbGUubG9nKG5hbWVTSCk7XG4gICAgICAgICAgZGl2LmlubmVySFRNTCA9IG5hbWVTSDtcbiAgICAgICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnU0hfbGlzdCcpLmFwcGVuZENoaWxkKGRpdik7XG4gICAgICAgICAgZGl2LnNldEF0dHJpYnV0ZShcIm5hbWVTSFwiLGxpbmVzW2pdICk7XG4gICAgICAgICAgZGl2LmFkZEV2ZW50TGlzdGVuZXIoXCJtb3VzZWRvd25cIixmdW5jdGlvbiAoKSB7XG4gICAgICAgICAgICBjb25zb2xlLmxvZyh0aGlzLmdldEF0dHJpYnV0ZShcIm5hbWVTSFwiKSk7XG4gICAgICAgICAgICBsb2FkSlNPTlNlZ21lbnRIaXN0b3J5KHRoaXMuZ2V0QXR0cmlidXRlKFwibmFtZVNIXCIpKTtcbiAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgfTtcbiAgICAgIHhocl9hbGxQYXRoLnNlbmQoKTtcbiAgICB9LFxuICB9XG59O1xuXG5cbi8qUHJpdmF0ZSBmdW5jdGlvbiwgZG8gbm90IGNhbGwgb3V0c2lkZSB0aGUgQ2FyZE1hbmFnZXIqL1xuXG5cbmZ1bmN0aW9uIHRyaWdnZXJNb3VzZUV2ZW50IChub2RlLCBldmVudFR5cGUpIHtcbiAgdmFyIGNsaWNrRXZlbnQgPSBkb2N1bWVudC5jcmVhdGVFdmVudCAoJ01vdXNlRXZlbnRzJyk7XG4gIGNsaWNrRXZlbnQuaW5pdEV2ZW50IChldmVudFR5cGUsIHRydWUsIHRydWUpO1xuICBub2RlLmRpc3BhdGNoRXZlbnQgKGNsaWNrRXZlbnQpO1xufVxuXG4vKioqKiBGdW5jdGlvbmFsIGNvcmUgb2YgdGhlIGNhcmQgbWFuYWdlciAoY3JlYXRlIGEgY2FydCwgZGVsZXRlIGEgY2FyZCBhbmQgc2F2ZSBjYXJkKSAqKioqKi9cbi8qKlxuICogVGhpcyBjbGFzcyBtYW5hZyBhbGwgdGhlIGNhcmRzIGNyZWF0ZWQuIFRoaXMgaXMgdGhlIHNlZ21lbnQgaGlzdG9yeS5cbiAqIEB0eXBlIHtIVE1MRWxlbWVudCB8IG51bGx9XG4gKi9cbnZhciB3cmFwcGVyQ29tbWFuZEFuZFJhbmdlID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJ3cmFwcGVyQ29tbWFuZEFuZFJhbmdlaWRcIik7XG5cblxuXG5mdW5jdGlvbiBjbGVhblNlZ21lbnRIaXN0b3J5KCl7XG4gIGNvbnNvbGUubG9nKFwiVEVTVElOR1wiKTtcbiAgY2xlYXJBbGxUaW1lcigpO1xuICBhcnJheUNhcmQuZm9yRWFjaChmdW5jdGlvbihlKXtcbiAgICAgIGRlbGV0ZUNhcmRVSShlKTtcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIGxvYWRKU09OKCkge1xuICB2YXIgZmlsZXMgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgnbG9nRmlsZUxvYWQnKS5maWxlcztcbiAgaWYgKCFmaWxlcy5sZW5ndGgpIHtcbiAgICBhbGVydCgnUGxlYXNlIHNlbGVjdCBhIGZpbGUhJyk7XG4gICAgcmV0dXJuO1xuICB9XG4gIFxuICB2YXIgZmlsZSA9IGZpbGVzWzBdO1xuICB2YXIgc3RhcnQgPSAgMDtcbiAgdmFyIHN0b3AgPSBmaWxlLnNpemUgLSAxO1xuICBcbiAgdmFyIHJlYWRlciA9IG5ldyBGaWxlUmVhZGVyKCk7XG4gIHZhciB0ZXN0ID0gMDtcbiAgLy8gSWYgd2UgdXNlIG9ubG9hZGVuZCwgd2UgbmVlZCB0byBjaGVjayB0aGUgcmVhZHlTdGF0ZS5cbiAgcmVhZGVyLm9ubG9hZGVuZCA9IGZ1bmN0aW9uKGV2dCkge1xuICAgIGlmIChldnQudGFyZ2V0LnJlYWR5U3RhdGUgPT0gRmlsZVJlYWRlci5ET05FKSB7IC8vIERPTkUgPT0gMlxuICAgICAgdmFyIHRlc3QgPSBldnQudGFyZ2V0LnJlc3VsdDtcbiAgICAgIGNvbnNvbGUubG9nKCdSZWFkIGJ5dGVzOiAnLCBzdGFydCArIDEsICcgLSAnLCBzdG9wICsgMSxcbiAgICAgICAgICAnIG9mICcsIGZpbGUuc2l6ZSwgJyBieXRlIGZpbGUnICk7XG4gICAgICBjb25zb2xlLmxvZyh0ZXN0KTtcbiAgICAgIHZhciBteV9KU09OX29iamVjdCA9IEpTT04ucGFyc2UodGVzdCk7XG4gIFxuICAgICAgY29uc29sZS5sb2cobXlfSlNPTl9vYmplY3QpO1xuICBcbiAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgbXlfSlNPTl9vYmplY3QubGVuZ3RoOyBrKyspIHtcbiAgICAgICAgYWRkaW5nTmV3Q2FyZHNGcm9tSlNvbihteV9KU09OX29iamVjdFtrXSk7XG4gICAgICB9XG4gICAgfVxuICB9O1xuICB2YXIgYmxvYiA9IGZpbGUuc2xpY2Uoc3RhcnQsIHN0b3AgKyAxKTtcbiAgcmVhZGVyLnJlYWRBc0JpbmFyeVN0cmluZyhibG9iKTtcbn1cblxuLy9BZGQgYSBjYXJkIGZyb20gYSBqc29uIGZpbGVcbmZ1bmN0aW9uIGFkZGluZ05ld0NhcmRzRnJvbUpTb24oY2FyZEluZm8pIHtcbiAgaWYgKGNhcmRJbmZvLnN0YXJ0UCA+IGNhcmRJbmZvLmVuZFApIHtcbiAgICBsZXQgdHJhbnNpdCA9IGNhcmRJbmZvLnN0YXJ0UDtcbiAgICBjYXJkSW5mby5zdGFydFAgPSBjYXJkSW5mby5lbmRQO1xuICAgIGNhcmRJbmZvLmVuZFAgPSB0cmFuc2l0O1xuICB9XG4gIGlmIChjYXJkSW5mby5zdGFydFAgPCAwKSB7XG4gICAgY2FyZEluZm8uc3RhcnRQID0gMDtcbiAgfVxuICBjb25zb2xlLmxvZyhjYXJkSW5mby5zdGFydFAsIGNhcmRJbmZvLmVuZFApO1xuICB2YXIgcmVzdWx0ID0ge3N0YXJ0RHVyYXRpb24gOiBjYXJkSW5mby5zdGFydFAsIGVuZER1cmF0aW9uIDogY2FyZEluZm8uZW5kUH07XG4gIFxuICAvL2xldCByZXN1bHQgPSBwbGF5ZXIuc2xpZGVyVG9WaWRlbyhjYXJkSW5mby5zdGFydFAsIGNhcmRJbmZvLmVuZFApO1xuICAvL2NvbnNvbGUubG9nKHJlc3VsdCk7XG4gIG51bWJlck9mQ2FyZCsrO1xuICBpZiAoIWNhcmRJbmZvLmRlbGV0ZWQpIHtcbiAgICBjb25zb2xlLmxvZyhyZXN1bHQuc3RhcnREdXJhdGlvbiwgcmVzdWx0LmVuZER1cmF0aW9uLCBjYXJkSW5mby5zdGFydFAsIGNhcmRJbmZvLmVuZFAsIGNhcmRJbmZvKTtcbiAgICB2YXIgY2FyZCA9IENhcmQocmVzdWx0LnN0YXJ0RHVyYXRpb24sIHJlc3VsdC5lbmREdXJhdGlvbiwgY2FyZEluZm8uc3RhcnRQLCBjYXJkSW5mby5lbmRQLCBjYXJkSW5mbyk7XG4gICAgY2FyZE1hbmFnZXIuZXhlY3V0ZShuZXcgQ3JlYXRlTmV3Q2FyZENvbW1hbmQoY2FyZCkpO1xuICAgIC8vZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RpdkNhcmRCb2FyZCcpLmluc2VydEJlZm9yZShjYXJkLmlEaXYsIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdkaXZDYXJkQm9hcmQnKS5maXJzdENoaWxkKTtcbiAgfVxufVxuXG4vKipcbiAqIEFkZGluZyBhIGNhcmQgYnkgZHJhZyBhbmQgZHJvcC4gVGhlIGNhcmQgaXMgYWRkZWQgaW4gdGhlIGxpc3Qgb2YgY2FyZHNcbiAqIFJldHVybiB0aGUgY2FyZCB0aGF0IGhhdmUgYmVlbiBjcmVhdGVkXG4gKi9cbmZ1bmN0aW9uIGNyZWF0ZU5ld0NhcmQoc3RhcnRQLCBlbmRQLHBvc2l0aW9uU3RhcnQsIHBvc2l0aW9uU3RvcCkge1xuICAvL2NvbnNvbGUubG9nKFwiVEVTVCAvIDogXCIgKyBzdGFydFAgKyBcIiBcIiArIGVuZFAsIHBvc2l0aW9uU3RhcnQsIHBvc2l0aW9uU3RvcCk7XG4gIC8vVGhlIHR3byBjYXNlcyBpZiB3ZSBjcmVhdGUgYSBzZWdtZW50IGJhY2t3YXJkXG4gIGlmIChwYXJzZUZsb2F0KHBvc2l0aW9uU3RhcnQpID4gcGFyc2VGbG9hdChwb3NpdGlvblN0b3ApKSB7XG4gICAgbGV0IHRyYW5zaXQgPSBwb3NpdGlvblN0YXJ0O1xuICAgIHBvc2l0aW9uU3RhcnQgPSBwb3NpdGlvblN0b3A7XG4gICAgcG9zaXRpb25TdG9wID0gdHJhbnNpdDtcbiAgfVxuICBpZiAocGFyc2VGbG9hdChzdGFydFApID4gcGFyc2VGbG9hdChlbmRQKSkge1xuICAgIGxldCB0cmFuc2l0ID0gc3RhcnRQO1xuICAgIHN0YXJ0UCA9IGVuZFA7XG4gICAgZW5kUCA9IHRyYW5zaXQ7XG4gIH1cbiAgdmFyIHJlc3VsdCA9IHtzdGFydER1cmF0aW9uIDogc3RhcnRQLCBlbmREdXJhdGlvbiA6IGVuZFB9O1xuICBudW1iZXJPZkNhcmQrKztcbiAgY29uc29sZS5sb2cocmVzdWx0LnN0YXJ0RHVyYXRpb24sIHJlc3VsdC5lbmREdXJhdGlvbiwgcG9zaXRpb25TdGFydCwgcG9zaXRpb25TdG9wKTtcbiAgXG4gIHZhciBjYXJkID0gbmV3IENhcmQocmVzdWx0LnN0YXJ0RHVyYXRpb24sIHJlc3VsdC5lbmREdXJhdGlvbiwgcG9zaXRpb25TdGFydCwgcG9zaXRpb25TdG9wKTtcbiAgLy92YXIgY2FyZDIgPSBuZXcgQ2FyZChzdGFydFAsIGVuZFAsIHN0YXJ0UCwgZW5kUCk7XG4gIGNhcmRNYW5hZ2VyLmV4ZWN1dGUobmV3IENyZWF0ZU5ld0NhcmRDb21tYW5kKGNhcmQpKTtcbiAgLy9jYXJkTWFuYWdlci5leGVjdXRlKG5ldyBDcmVhdGVOZXdDYXJkQ29tbWFuZChjYXJkMikpO1xuICByZXR1cm4gY2FyZDtcbn1cblxuZnVuY3Rpb24gYWRkaW5nTmV3Q2FyZCgpIHtcbiAgYXJyYXlDYXJkLnB1c2godGhpcy5jYXJkKTtcbiAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RpdkNhcmRCb2FyZCcpLmluc2VydEJlZm9yZSh0aGlzLmNhcmQuaURpdiwgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2RpdkNhcmRCb2FyZCcpLmZpcnN0Q2hpbGQpO1xufVxuXG5mdW5jdGlvbiBkZWxldGVDYXJkKCkge1xuICAvL1N1cHByaW1lIGxhIGNhcnRlIGRlIGxhIGxpc3RlIGRlIGNhcnRlXG4gIC8qZm9yIChsZXQgaSA9IDA7IGkgPCBhcnJheUNhcmQubGVuZ3RoICAgOyBpKyspIHtcbiAgICBpZihhcnJheUNhcmRbaV0gID09PSBjYXJkKXtcbiAgICAgIHZhciBzdXBDYXJkID0gYXJyYXlDYXJkLnNwbGljZShpLDEpO1xuICAgICAgYXJyYXlDYXJkRGVsZXRlZC5wdXNoKHN1cENhcmQpO1xuICAgICAgY29uc29sZS5sb2coXCJkZWxldGVkIGNhcmQgOiBcIik7XG4gICAgICBjb25zb2xlLmxvZyhzdXBDYXJkKTtcbiAgICAgIGJyZWFrO1xuICAgIH1cbiAgfSovXG4gIC8vZGVsZXRlQ2FyZFVJKGNhcmQpO1xuICAvKmFycmF5Q2FyZERlbGV0ZWQuZm9yRWFjaChmdW5jdGlvbihlbGVtZW50KSB7XG4gICAgY29uc29sZS5sb2coICAgZWxlbWVudCk7XG4gIH0pO1xuICBjb25zb2xlLmxvZyhcIioqKioqKioqKioqKioqKioqKioqKioqKlwiKTtcbiAgYXJyYXlDYXJkLmZvckVhY2goZnVuY3Rpb24oZWxlbWVudCkge1xuICAgIGNvbnNvbGUubG9nKGVsZW1lbnQpO1xuICB9KTsqL1xuICBjbGVhckFsbFRpbWVyKCk7XG4gIGRlbGV0ZUNhcmRVSSh0aGlzLmNhcmQpO1xuICByZXR1cm4gdGhpcy5jYXJkO1xufVxuXG5mdW5jdGlvbiBkZWxldGVDYXJkVUkoY2FyZCkge1xuICBmZWVkYmFja09uU2xpZGVyVmlkZW8oZmFsc2UpO1xuICBjYXJkLmlEaXYucmVtb3ZlKCk7XG4gIGNhcmQuZGVsZXRlZCA9IHRydWVcbn1cblxuZnVuY3Rpb24gZG93bmxvYWQoY29udGVudCwgZmlsZU5hbWUsIGNvbnRlbnRUeXBlKSB7XG4gIHZhciBhID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudChcImFcIik7XG4gIFxuICBcbiAvL2Euc3R5bGUuZGlzcGxheSA9IFwiYmxvY2tcIjtcbiAgdmFyIGZpbGUgPSBuZXcgQmxvYihbY29udGVudF0sIHtcbiAgICB0eXBlOiBjb250ZW50VHlwZVxuICB9KTtcbiAgXG4gIGEuaHJlZiA9IFVSTC5jcmVhdGVPYmplY3RVUkwoZmlsZSk7XG4gIGEuZG93bmxvYWQgPSBmaWxlTmFtZTtcbiAgYS5jbGljaygpO1xuICBhLnJlbW92ZSgpO1xuICBcbiAgXG4gIFxuICBcbn1cblxuXG5cbmZ1bmN0aW9uIGxvYWRKU09OU2VnbWVudEhpc3RvcnkxKCkge1xuICBcbiAgICAgIGNvbnNvbGUubG9nKGdlbmVyYXRlSlNPTmZyb212YXIoKSk7XG4gICAgICBcbiAgICAgIGxldCBnZW5lcmF0ZWRKc29uID0gZ2VuZXJhdGVKU09OZnJvbXZhcigpO1xuICAgICAgdmFyIG15X0pTT05fb2JqZWN0ID0gSlNPTi5wYXJzZShnZW5lcmF0ZWRKc29uKTtcbiAgICAgIGNvbnNvbGUubG9nKG15X0pTT05fb2JqZWN0KTtcbiAgICAgIGZvciAobGV0IGsgPSAwOyBrIDwgbXlfSlNPTl9vYmplY3QubGVuZ3RoOyBrKyspIHtcbiAgICAgICAgYWRkaW5nTmV3Q2FyZHNGcm9tSlNvbihteV9KU09OX29iamVjdFtrXSk7XG4gICAgfVxuICBcbn1cblxuZnVuY3Rpb24gbG9hZEpTT05TZWdtZW50SGlzdG9yeTIoKSB7XG4gIGxldCBnZW5lcmF0ZWRKc29uMiA9IGdlbmVyYXRlSlNPTmZyb212YXIyKCk7XG4gIHZhciBteV9KU09OX29iamVjdCA9IEpTT04ucGFyc2UoZ2VuZXJhdGVkSnNvbjIpO1xuICBjb25zb2xlLmxvZyhteV9KU09OX29iamVjdCk7XG4gIGZvciAobGV0IGsgPSAwOyBrIDwgbXlfSlNPTl9vYmplY3QubGVuZ3RoOyBrKyspIHtcbiAgICBhZGRpbmdOZXdDYXJkc0Zyb21KU29uKG15X0pTT05fb2JqZWN0W2tdKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBsb2FkSlNPTlNlZ21lbnRIaXN0b3J5KFNIX3BhdGgpIHtcbiAgXG4gIFxuICB2YXIgeGhyX1NIID0gbmV3IFhNTEh0dHBSZXF1ZXN0KCk7XG4gIHhocl9TSC5vcGVuKCdHRVQnLCBTSF9wYXRoLCB0cnVlKTtcbiAgXG4gIHhocl9TSC5vbnJlYWR5c3RhdGVjaGFuZ2UgPSBmdW5jdGlvbiAoKSB7XG4gICAgaWYgKHRoaXMucmVhZHlTdGF0ZSE9PTQpIHJldHVybjtcbiAgICBpZiAodGhpcy5zdGF0dXMhPT0yMDApIHJldHVybjsgLy8gb3Igd2hhdGV2ZXIgZXJyb3IgaGFuZGxpbmcgeW91IHdhbnRcbiAgICBjb25zb2xlLmxvZyh0aGlzLnJlc3BvbnNlVGV4dCk7XG4gICAgbGV0IGdlbmVyYXRlZEpzb24yID0gdGhpcy5yZXNwb25zZVRleHQ7XG4gICAgXG4gICAgdmFyIG15X0pTT05fb2JqZWN0ID0gSlNPTi5wYXJzZShnZW5lcmF0ZWRKc29uMik7XG4gICAgY29uc29sZS5sb2cobXlfSlNPTl9vYmplY3QpO1xuICAgIGZvciAobGV0IGsgPSAwOyBrIDwgbXlfSlNPTl9vYmplY3QubGVuZ3RoOyBrKyspIHtcbiAgICAgIGFkZGluZ05ld0NhcmRzRnJvbUpTb24obXlfSlNPTl9vYmplY3Rba10pO1xuICAgIH1cbiAgIFxuICB9O1xuICB4aHJfU0guc2VuZCgpO1xuICBcbiAgXG4gIHZhciBlbG1zID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ1NIUGlja2VyT3ZlcnZpZXcnKTtcbiAgdmFyIHNwYW4gPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKFwiY2xvc2VcIilbMV07XG4gIFxuICBzcGFuLmFkZEV2ZW50TGlzdGVuZXIoIFwibW91c2Vkb3duXCIgLCBmdW5jdGlvbigpIHtcbiAgICBlbG1zLnN0eWxlLmRpc3BsYXkgPSBcIm5vbmVcIjtcbiAgfSk7XG4gIFxufVxuXG5cblxuXG5mdW5jdGlvbiAgZmVlZGJhY2tPblNsaWRlclZpZGVvKHZpc2liaWxpdHksc3RhcnREdXJhdGlvblBhcmFtLGVuZER1cmF0aW9uUGFyYW0pe1xuICBpZih2aXNpYmlsaXR5KXtcbiAgICBzZWdtZW50RmVlZGJhY2suZGl2R3JhcGhpY2FsT2JqZWN0LnN0eWxlLnZpc2liaWxpdHkgPSBcInZpc2libGVcIjtcbiAgICAvL1RPRE9cbiAgICBzZWdtZW50RmVlZGJhY2sud2lkdGggPSAwO1xuICAgIHNlZ21lbnRGZWVkYmFjay5zdGFydFBvc3Rpb24gPTA7XG4gICAgc2VnbWVudEZlZWRiYWNrLndpZHRoID0gMDtcbiAgICBzZWdtZW50RmVlZGJhY2suc3RhcnRQb3N0aW9uID0gMDtcbiAgfSBlbHNlIHtcbiAgICBzZWdtZW50RmVlZGJhY2suZGl2R3JhcGhpY2FsT2JqZWN0LnN0eWxlLnZpc2liaWxpdHkgPSBcImhpZGRlblwiO1xuICAgIC8vVE9ET1xuICAgIHNlZ21lbnRGZWVkYmFjay53aWR0aCA9IDA7XG4gICAgc2VnbWVudEZlZWRiYWNrLnN0YXJ0UG9zdGlvbiA9MDtcbiAgICBzZWdtZW50RmVlZGJhY2sud2lkdGggPSAwO1xuICAgIHNlZ21lbnRGZWVkYmFjay5zdGFydFBvc3Rpb24gPSAwO1xuICB9XG59XG4iXX0=