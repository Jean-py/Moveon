"use strict";

var video = document.getElementById("videoEAT");

var videotime = 0;
var timeupdater = null;
var onChangeTimer = null;

var wrapperVideo = document.getElementById("idVideo");
var speedrate = 1;
// Buttons
var playButton = document.getElementById("play-pause");
var muteButton = document.getElementById("mute");
// Sliders
var knobMin = document.getElementById("range-slider_handle-min");
var rangeSliderTrack = document.getElementById("rangeSliderTrack");

var divCardBoard = document.getElementById("divCardBoard");
var body = document.getElementsByTagName("BODY")[0];

//Je ne saiss pas comment rendre cette ligne automatique pour l'isntant car la taille est en auto...
var WIDTH_RANGE_SLIDER_TRACK = "960px";
//Donc pour l'instant je reste comme Ã§a
rangeSliderTrack.style.width = WIDTH_RANGE_SLIDER_TRACK;

var isPlayingCard = false;

var commands = [];
/**
 * Access point to the functional core, you can just execute command from here
 * @return {{execute: execute}}
 * @constructor
 */
var VideoFunctionalCoreManagerYT = function VideoFunctionalCoreManagerYT() {
  //This is a command pattern, see : https://www.dofactory.com/javascript/command-design-pattern
  return {
    //execute a command
    execute: function execute(command) {
      //console.log("executing : ");
      //console.log(command);

      switch (command.execute.name) {
        case "repetPartOfVideo":
          {
            command.execute(command.start, command.end, command.numberOfRepetition, command.speedRate);
            break;
          }
        case "updateKnobAndVideoComputer":
          command.execute(command.e);
          break;

        default:
          command.execute();
          break;
      }

      //We send the command to the server (the server log it into a file, see ./src/server/ServerLogger)
      logger.sendAndLogCommand(command);
      //and we save the command created
      commands.push(command);
    }
    //We did not implemented undo redo for this manager, because undo play pause is kind of useless right?

  };
};

var player = null;

// 2. This code loads the IFrame Player API code asynchronously.
var tag = document.createElement('script');

var url_yt_chooser = document.getElementById("yt_chooser");

url_yt_chooser.addEventListener("blur", setVideo, { passive: true });
tag.src = "https://www.youtube.com/iframe_api";
var firstScriptTag = document.getElementsByTagName('script')[0];

firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

var id_yt_video = 'CqLL96nHUo4';
//    after the API code downloads.
// 4. The API will call this function when the video player is ready.
function onYouTubeIframeAPIReady() {

  player = new YT.Player('yt_player', {
    height: '540',
    width: '960',
    videoId: id_yt_video,
    playerVars: { 'controls': 2, 'autoplay': 0, 'modestbranding': 1, 'showinfo': 0, 'fs': 0, 'rel': 0 },
    events: {
      'onReady': onPlayerReady
    }
  });
}

// 5. The API calls this function when the player's state changes.
//    The function indicates that when playing a video (state=1),
//    the player should play for six seconds and then stop.
/*var done = false;
function onPlayerStateCha  nge(event) {
  if (event.data == YT.PlayerState.PLAYING && !done) {
    setTimeout(stopVideo, 6000);
    done = true;
  }
}*/
function stopVideo() {
  //player.stopVideo();
}

function setVideo() {
  var id_yt_video = yt_url_to_id(url_yt_chooser.value);
  player.loadVideoById(id_yt_video, 0, "large");

  console.log(id_yt_video);
}

function yt_url_to_id(url) {
  var regExp = /^.*(youtu\.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
  var match = url.match(regExp);
  if (match && match[2].length == 11) {
    return match[2];
  } else {
    //error
  }
}

var play = function play() {
  console.log("play video in youtube wrapper");
  playButton.src = '/media/workshop2/videoCommand/pauseButton.png';
  player.playVideo();
};

var pause = function pause() {
  player.pauseVideo();
  playButton.src = '/media/workshop2/videoCommand/playButton.png';
  console.log("pause video in youtube wrapper");
};

var muteButtonCallback = function muteButtonCallback() {
  if (player.isMuted()) {
    // Mute the video
    player.unMute();
    // Update the button text
    muteButton.innerHTML = "Unmute";
  } else {
    // Unmute the video
    player.mute();
    //this.src="/media/workshop2/videoCommand/volumeFull.png";
    // Update the button text
    muteButton.innerHTML = "Mute";
  }
};

var repetPartOfVideo = function repetPartOfVideo(start, end, numberOfRepetition, speedRate) {
  console.log("function  - repetPartOfVideo", start, end, numberOfRepetition, speedRate);
  //console.log(start,end, numberOfRepetition,speedRate);
  isPlayingCard = true;
  player.setPlaybackRate(speedRate);
  player.seekTo(start, true);
  var repet = numberOfRepetition;

  //console.log("function  - repetPartOfVideo [play part] l87 videoCommand");
  player.playVideo();
  window.clearInterval(timeupdater);
  function testRepet() {

    console.log("updateTime");
    var oldTime = videotime;

    if (isPlayingCard) {
      if (end > start && repet > 0) {
        if (player.getCurrentTime() > end) {
          repet--;
          player.seekTo(start, true);
          console.log("nb repet : ", repet);
        }
      } else {
        //player.ontimeupdate = null;
        feedbackOnSliderVideo(false);
        player.setPlaybackRate(1);

        clearTimeout(timeupdater);
      }
    }
  }
  timeupdater = setInterval(testRepet, 100);
};

function updateTimerVideoYT() {
  var minutes = Math.floor(player.getCurrentTime() / 60);
  var seconds = Math.floor(player.getCurrentTime() - minutes * 60);
  var minutesVideo = Math.floor(player.getDuration() / 60);

  var secondsVideo = Math.floor(player.getDuration() - minutes * 60);
  if (seconds < 10) {
    seconds = "0" + seconds;
  }
  timerVideo.innerHTML = minutes + ":" + seconds + "/" + minutesVideo + ":" + secondsVideo;
};

//Update knob on a laptop
var updateKnobAndVideoComputer = function updateKnobAndVideoComputer(e) {
  clearAllTimer();
  //take into account offset on the left of the scroll bar (body scroll and centering the wrapper)

  // var pos = (e.pageX  - this.offsetLeft) / this.offsetWidth;
  //    video.currentTime = pos * video.duration;
  var offsetLeftSlider = wrapperCommandAndRangeid.offsetLeft - body.scrollLeft; //- window.scrollLeft  ;

  currentValueKnob = (e.pageX - offsetLeftSlider) * player.getDuration() / NUMBER_OF_TICK;
  if (currentValueKnob < player.getDuration() && currentValueKnob >= 0) {
    player.seekTo(currentValueKnob, true);
    //knobMin.style.left = e.pageX - (offsetLeftSlider + WIDTH_MID_KNOB_MIN / 2) + "px";
    if (segmentFeedback.displayed) {
      if (player.getCurrentTime() > segmentFeedback.endDurationVideo) {
        feedbackOnSliderVideo(false);
      }
    }
  }
};

//Update knob on a tablet
var updateKnobAndVideo = function updateKnobAndVideo(event) {
  clearAllTimer();
  //  var offsetLeftSlider = wrapperCommandAndRangeid.offsetLeft+rangeSliderTrack.offsetLeft + dividCommandeVideo.offsetLeft;
  var offsetLeftSlider = wrapperCommandAndRangeid.offsetLeft; //-   ;
  //console.log("aa :  " +  body );
  var ctime = Math.round(((event.targetTouches[0] ? event.targetTouches[0].pageX : event.changedTouches[event.changedTouches.length - 1].pageX) - offsetLeftSlider) * player.getDuration() / NUMBER_OF_TICK);
  player.seekTo(ctime);
  //Update know position
  knobMin.style.left = (event.targetTouches[0] ? event.targetTouches[0].pageX : event.changedTouches[event.changedTouches.length - 1].pageX) - offsetLeftSlider + "px";
  if (segmentFeedback.displayed) {
    if (player.getCurrentTime() > segmentFeedback.endDurationVideo) {
      feedbackOnSliderVideo(false);
    }
  }
};

// when the player is ready, start checking the current time every 100 ms.
function onPlayerReady(event) {
  event.target.playVideo();
  function updateTime() {
    currentValueKnob = NUMBER_OF_TICK / player.getDuration() * player.getCurrentTime() + rangeSliderTrack.offsetLeft;
    // knobMin.style.left = currentValueKnob-(KNOB_WIDTH/2)+ "px" ;
    knobMin.style.left = currentValueKnob - KNOB_WIDTH / 2 + "px";

    //videoSlider.value = (NUMBER_OF_TICK / video.duration) * video.currentTime;
    updateTimerVideoYT();
  }
  onChangeTimer = setInterval(updateTime, 50);

  //document.getElementsByClassName("ytp-load-progress")[0].addEventListener('mouseover' , function(e) {console.log("test mouse enter")} , {passive: true} );
}

function clearAllTimer() {
  window.clearInterval(timerRepetition);
  window.clearInterval(timeupdater);
  isPlayingCard = false;
  player.setPlaybackRate(1);
  feedbackOnSliderVideo(false);
}

var playPausecallback = function playPausecallback(e) {
  //console.log("callback play-pause, e : " + e);
  /*if(e != null && e !== undefined){
    e.preventDefault();
  }*/
  if (player.getPlayerState() == 0 || player.getPlayerState() == -1 || player.getPlayerState() == 2) {
    videoFunctionalCoreManager.execute(new PlayCommand());
    //play();
  } else {
    //pause();
    videoFunctionalCoreManager.execute(new PauseCommand());
  }
};

function feedbackOnSliderVideo(onOff) {
  segmentFeedback.endPosition = parseInt(segmentFeedback.startPostion) + parseInt(segmentFeedback.width);
  var sliderToV = sliderToVideo(segmentFeedback.startPostion, segmentFeedback.endPosition);
  segmentFeedback.startDurationVideo = sliderToV.startDuration;
  segmentFeedback.endDurationVideo = sliderToV.endDuration;
  segmentFeedback.displayed = onOff;
  if (onOff) {
    //segmentFeedback.divGraphicalObject.style.marginLeft = segmentFeedback.startPostion;
    //minus 2 because we need to get 2 frame before the segment
    segmentFeedback.divGraphicalObject.style.marginLeft = parseInt(segmentFeedback.startPostion) + "px"; //  segmentFeedback.startPostion;
    segmentFeedback.divGraphicalObject.style.visibility = "visible";
    segmentFeedback.divGraphicalObject.style.width = segmentFeedback.width;
  } else {
    segmentFeedback.divGraphicalObject.style.visibility = "hidden";
  }
}

//start position on the slider and end position on the slider
function sliderToVideo(startP, endP) {
  if (startP < 0) {
    startP = 0;
  }
  var startDuration = Math.round(startP * player.getDuration() / NUMBER_OF_TICK);
  var endDuration = Math.round(endP * player.getDuration() / NUMBER_OF_TICK);

  return {
    startDuration: startDuration,
    endDuration: endDuration
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInlvdXR1YmVfd3JhcHBlci5qcyJdLCJuYW1lcyI6WyJ2aWRlbyIsImRvY3VtZW50IiwiZ2V0RWxlbWVudEJ5SWQiLCJ2aWRlb3RpbWUiLCJ0aW1ldXBkYXRlciIsIm9uQ2hhbmdlVGltZXIiLCJ3cmFwcGVyVmlkZW8iLCJzcGVlZHJhdGUiLCJwbGF5QnV0dG9uIiwibXV0ZUJ1dHRvbiIsImtub2JNaW4iLCJyYW5nZVNsaWRlclRyYWNrIiwiZGl2Q2FyZEJvYXJkIiwiYm9keSIsImdldEVsZW1lbnRzQnlUYWdOYW1lIiwiV0lEVEhfUkFOR0VfU0xJREVSX1RSQUNLIiwic3R5bGUiLCJ3aWR0aCIsImlzUGxheWluZ0NhcmQiLCJjb21tYW5kcyIsIlZpZGVvRnVuY3Rpb25hbENvcmVNYW5hZ2VyWVQiLCJleGVjdXRlIiwiY29tbWFuZCIsIm5hbWUiLCJzdGFydCIsImVuZCIsIm51bWJlck9mUmVwZXRpdGlvbiIsInNwZWVkUmF0ZSIsImUiLCJsb2dnZXIiLCJzZW5kQW5kTG9nQ29tbWFuZCIsInB1c2giLCJwbGF5ZXIiLCJ0YWciLCJjcmVhdGVFbGVtZW50IiwidXJsX3l0X2Nob29zZXIiLCJhZGRFdmVudExpc3RlbmVyIiwic2V0VmlkZW8iLCJwYXNzaXZlIiwic3JjIiwiZmlyc3RTY3JpcHRUYWciLCJwYXJlbnROb2RlIiwiaW5zZXJ0QmVmb3JlIiwiaWRfeXRfdmlkZW8iLCJvbllvdVR1YmVJZnJhbWVBUElSZWFkeSIsIllUIiwiUGxheWVyIiwiaGVpZ2h0IiwidmlkZW9JZCIsInBsYXllclZhcnMiLCJldmVudHMiLCJvblBsYXllclJlYWR5Iiwic3RvcFZpZGVvIiwieXRfdXJsX3RvX2lkIiwidmFsdWUiLCJsb2FkVmlkZW9CeUlkIiwiY29uc29sZSIsImxvZyIsInVybCIsInJlZ0V4cCIsIm1hdGNoIiwibGVuZ3RoIiwicGxheSIsInBsYXlWaWRlbyIsInBhdXNlIiwicGF1c2VWaWRlbyIsIm11dGVCdXR0b25DYWxsYmFjayIsImlzTXV0ZWQiLCJ1bk11dGUiLCJpbm5lckhUTUwiLCJtdXRlIiwicmVwZXRQYXJ0T2ZWaWRlbyIsInNldFBsYXliYWNrUmF0ZSIsInNlZWtUbyIsInJlcGV0Iiwid2luZG93IiwiY2xlYXJJbnRlcnZhbCIsInRlc3RSZXBldCIsIm9sZFRpbWUiLCJnZXRDdXJyZW50VGltZSIsImZlZWRiYWNrT25TbGlkZXJWaWRlbyIsImNsZWFyVGltZW91dCIsInNldEludGVydmFsIiwidXBkYXRlVGltZXJWaWRlb1lUIiwibWludXRlcyIsIk1hdGgiLCJmbG9vciIsInNlY29uZHMiLCJtaW51dGVzVmlkZW8iLCJnZXREdXJhdGlvbiIsInNlY29uZHNWaWRlbyIsInRpbWVyVmlkZW8iLCJ1cGRhdGVLbm9iQW5kVmlkZW9Db21wdXRlciIsImNsZWFyQWxsVGltZXIiLCJvZmZzZXRMZWZ0U2xpZGVyIiwid3JhcHBlckNvbW1hbmRBbmRSYW5nZWlkIiwib2Zmc2V0TGVmdCIsInNjcm9sbExlZnQiLCJjdXJyZW50VmFsdWVLbm9iIiwicGFnZVgiLCJOVU1CRVJfT0ZfVElDSyIsInNlZ21lbnRGZWVkYmFjayIsImRpc3BsYXllZCIsImVuZER1cmF0aW9uVmlkZW8iLCJ1cGRhdGVLbm9iQW5kVmlkZW8iLCJldmVudCIsImN0aW1lIiwicm91bmQiLCJ0YXJnZXRUb3VjaGVzIiwiY2hhbmdlZFRvdWNoZXMiLCJsZWZ0IiwidGFyZ2V0IiwidXBkYXRlVGltZSIsIktOT0JfV0lEVEgiLCJ0aW1lclJlcGV0aXRpb24iLCJwbGF5UGF1c2VjYWxsYmFjayIsImdldFBsYXllclN0YXRlIiwidmlkZW9GdW5jdGlvbmFsQ29yZU1hbmFnZXIiLCJQbGF5Q29tbWFuZCIsIlBhdXNlQ29tbWFuZCIsIm9uT2ZmIiwiZW5kUG9zaXRpb24iLCJwYXJzZUludCIsInN0YXJ0UG9zdGlvbiIsInNsaWRlclRvViIsInNsaWRlclRvVmlkZW8iLCJzdGFydER1cmF0aW9uVmlkZW8iLCJzdGFydER1cmF0aW9uIiwiZW5kRHVyYXRpb24iLCJkaXZHcmFwaGljYWxPYmplY3QiLCJt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QUE0QmtCLEtBQTVCO0FBQ0EsTUFBSUEsS0FBSixFQUFXO0FBQ1Q7QUFDQTtBQUNBbkIsb0JBQWdCNEIsa0JBQWhCLENBQW1DakgsS0FBbkMsQ0FBeUNrSCxVQUF6QyxHQUFzRFIsU0FBU3JCLGdCQUFnQnNCLFlBQXpCLElBQTBDLElBQWhHLENBSFMsQ0FHNkY7QUFDdEd0QixvQkFBZ0I0QixrQkFBaEIsQ0FBbUNqSCxLQUFuQyxDQUF5Q21ILFVBQXpDLEdBQXNELFNBQXREO0FBQ0E5QixvQkFBZ0I0QixrQkFBaEIsQ0FBbUNqSCxLQUFuQyxDQUF5Q0MsS0FBekMsR0FBaURvRixnQkFBZ0JwRixLQUFqRTtBQUNELEdBTkQsTUFNTztBQUNMb0Ysb0JBQWdCNEIsa0JBQWhCLENBQW1DakgsS0FBbkMsQ0FBeUNtSCxVQUF6QyxHQUFzRCxRQUF0RDtBQUNEO0FBQ0Y7O0FBRUQ7QUFDQSxTQUFTTixhQUFULENBQXVCTyxNQUF2QixFQUErQkMsSUFBL0IsRUFBcUM7QUFDbkMsTUFBR0QsU0FBUyxDQUFaLEVBQWU7QUFDYkEsYUFBUyxDQUFUO0FBQ0Q7QUFDRCxNQUFJTCxnQkFBZ0IxQyxLQUFLc0IsS0FBTCxDQUFheUIsU0FBU3BHLE9BQU95RCxXQUFQLEVBQVYsR0FBa0NXLGNBQTlDLENBQXBCO0FBQ0EsTUFBSTRCLGNBQWMzQyxLQUFLc0IsS0FBTCxDQUFhMEIsT0FBT3JHLE9BQU95RCxXQUFQLEVBQVIsR0FBZ0NXLGNBQTVDLENBQWxCOztBQUVBLFNBQU87QUFDTDJCLG1CQUFlQSxhQURWO0FBRUxDLGlCQUFhQTtBQUZSLEdBQVA7QUFJRCIsImZpbGUiOiJ5b3V0dWJlX3dyYXBwZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJ2YXIgdmlkZW8gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInZpZGVvRUFUXCIpO1xuXG52YXIgdmlkZW90aW1lID0gMDtcbnZhciB0aW1ldXBkYXRlciA9IG51bGw7XG52YXIgb25DaGFuZ2VUaW1lciA9IG51bGw7XG5cbnZhciB3cmFwcGVyVmlkZW8gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImlkVmlkZW9cIik7XG52YXIgc3BlZWRyYXRlID0gMTtcbi8vIEJ1dHRvbnNcbnZhciBwbGF5QnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJwbGF5LXBhdXNlXCIpO1xudmFyIG11dGVCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcIm11dGVcIik7XG4vLyBTbGlkZXJzXG52YXIga25vYk1pbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwicmFuZ2Utc2xpZGVyX2hhbmRsZS1taW5cIik7XG52YXIgcmFuZ2VTbGlkZXJUcmFjayA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwicmFuZ2VTbGlkZXJUcmFja1wiKTtcblxudmFyIGRpdkNhcmRCb2FyZCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiZGl2Q2FyZEJvYXJkXCIpO1xudmFyIGJvZHkgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZShcIkJPRFlcIilbMF07XG5cbi8vSmUgbmUgc2Fpc3MgcGFzIGNvbW1lbnQgcmVuZHJlIGNldHRlIGxpZ25lIGF1dG9tYXRpcXVlIHBvdXIgbCdpc250YW50IGNhciBsYSB0YWlsbGUgZXN0IGVuIGF1dG8uLi5cbnZhciBXSURUSF9SQU5HRV9TTElERVJfVFJBQ0sgPSBcIjk2MHB4XCI7XG4vL0RvbmMgcG91ciBsJ2luc3RhbnQgamUgcmVzdGUgY29tbWUgw6dhXG5yYW5nZVNsaWRlclRyYWNrLnN0eWxlLndpZHRoID0gV0lEVEhfUkFOR0VfU0xJREVSX1RSQUNLO1xuXG52YXIgaXNQbGF5aW5nQ2FyZCA9IGZhbHNlO1xuXG5cblxudmFyIGNvbW1hbmRzID0gW107XG4vKipcbiAqIEFjY2VzcyBwb2ludCB0byB0aGUgZnVuY3Rpb25hbCBjb3JlLCB5b3UgY2FuIGp1c3QgZXhlY3V0ZSBjb21tYW5kIGZyb20gaGVyZVxuICogQHJldHVybiB7e2V4ZWN1dGU6IGV4ZWN1dGV9fVxuICogQGNvbnN0cnVjdG9yXG4gKi9cbnZhciBWaWRlb0Z1bmN0aW9uYWxDb3JlTWFuYWdlcllUID0gZnVuY3Rpb24oKSB7XG4gIC8vVGhpcyBpcyBhIGNvbW1hbmQgcGF0dGVybiwgc2VlIDogaHR0cHM6Ly93d3cuZG9mYWN0b3J5LmNvbS9qYXZhc2NyaXB0L2NvbW1hbmQtZGVzaWduLXBhdHRlcm5cbiAgcmV0dXJuIHtcbiAgICAvL2V4ZWN1dGUgYSBjb21tYW5kXG4gICAgZXhlY3V0ZTogZnVuY3Rpb24oY29tbWFuZCkge1xuICAgICAgLy9jb25zb2xlLmxvZyhcImV4ZWN1dGluZyA6IFwiKTtcbiAgICAgIC8vY29uc29sZS5sb2coY29tbWFuZCk7XG4gICAgICBcbiAgICAgIHN3aXRjaCAoY29tbWFuZC5leGVjdXRlLm5hbWUpe1xuICAgICAgICBjYXNlIFwicmVwZXRQYXJ0T2ZWaWRlb1wiIDoge1xuICAgICAgICAgIGNvbW1hbmQuZXhlY3V0ZShjb21tYW5kLnN0YXJ0LGNvbW1hbmQuZW5kLGNvbW1hbmQubnVtYmVyT2ZSZXBldGl0aW9uLGNvbW1hbmQuc3BlZWRSYXRlKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBjYXNlIFwidXBkYXRlS25vYkFuZFZpZGVvQ29tcHV0ZXJcIiA6XG4gICAgICAgICAgY29tbWFuZC5leGVjdXRlKGNvbW1hbmQuZSk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIFxuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIGNvbW1hbmQuZXhlY3V0ZSgpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgXG4gICAgICAvL1dlIHNlbmQgdGhlIGNvbW1hbmQgdG8gdGhlIHNlcnZlciAodGhlIHNlcnZlciBsb2cgaXQgaW50byBhIGZpbGUsIHNlZSAuL3NyYy9zZXJ2ZXIvU2VydmVyTG9nZ2VyKVxuICAgICAgbG9nZ2VyLnNlbmRBbmRMb2dDb21tYW5kKGNvbW1hbmQpO1xuICAgICAgLy9hbmQgd2Ugc2F2ZSB0aGUgY29tbWFuZCBjcmVhdGVkXG4gICAgICBjb21tYW5kcy5wdXNoKGNvbW1hbmQpO1xuICAgIH1cbiAgICAvL1dlIGRpZCBub3QgaW1wbGVtZW50ZWQgdW5kbyByZWRvIGZvciB0aGlzIG1hbmFnZXIsIGJlY2F1c2UgdW5kbyBwbGF5IHBhdXNlIGlzIGtpbmQgb2YgdXNlbGVzcyByaWdodD9cbiAgICBcbiAgfVxufTtcblxuXG5cblxuXG5cbnZhciBwbGF5ZXIgPSBudWxsO1xuXG4vLyAyLiBUaGlzIGNvZGUgbG9hZHMgdGhlIElGcmFtZSBQbGF5ZXIgQVBJIGNvZGUgYXN5bmNocm9ub3VzbHkuXG52YXIgdGFnID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCgnc2NyaXB0Jyk7XG5cbnZhciB1cmxfeXRfY2hvb3NlciA9ICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInl0X2Nob29zZXJcIik7XG5cblxudXJsX3l0X2Nob29zZXIuYWRkRXZlbnRMaXN0ZW5lcihcImJsdXJcIixzZXRWaWRlbywge3Bhc3NpdmU6IHRydWV9KTtcbnRhZy5zcmMgPSBcImh0dHBzOi8vd3d3LnlvdXR1YmUuY29tL2lmcmFtZV9hcGlcIjtcbnZhciBmaXJzdFNjcmlwdFRhZyA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKCdzY3JpcHQnKVswXTtcblxuZmlyc3RTY3JpcHRUYWcucGFyZW50Tm9kZS5pbnNlcnRCZWZvcmUodGFnLCBmaXJzdFNjcmlwdFRhZyk7XG5cbnZhciBpZF95dF92aWRlbyA9ICdDcUxMOTZuSFVvNCc7XG4vLyAgICBhZnRlciB0aGUgQVBJIGNvZGUgZG93bmxvYWRzLlxuLy8gNC4gVGhlIEFQSSB3aWxsIGNhbGwgdGhpcyBmdW5jdGlvbiB3aGVuIHRoZSB2aWRlbyBwbGF5ZXIgaXMgcmVhZHkuXG5mdW5jdGlvbiBvbllvdVR1YmVJZnJhbWVBUElSZWFkeSgpIHtcblxuXG5cbiAgcGxheWVyPSBuZXcgWVQuUGxheWVyKCd5dF9wbGF5ZXInLCB7XG4gICAgaGVpZ2h0OiAnNTQwJyxcbiAgICB3aWR0aDogJzk2MCcsXG4gICAgdmlkZW9JZDogaWRfeXRfdmlkZW8sXG4gICAgcGxheWVyVmFyczogeyAgJ2NvbnRyb2xzJzogMiwgJ2F1dG9wbGF5JyA6IDAgLCAnbW9kZXN0YnJhbmRpbmcnIDogMSwgJ3Nob3dpbmZvJyA6IDAsICdmcycgOiAwLCAncmVsJyA6IDAgfSxcbiAgICBldmVudHM6IHtcbiAgICAgICdvblJlYWR5Jzogb25QbGF5ZXJSZWFkeSxcbiAgICB9XG4gIH0pO1xuXG59XG5cblxuXG5cbi8vIDUuIFRoZSBBUEkgY2FsbHMgdGhpcyBmdW5jdGlvbiB3aGVuIHRoZSBwbGF5ZXIncyBzdGF0ZSBjaGFuZ2VzLlxuLy8gICAgVGhlIGZ1bmN0aW9uIGluZGljYXRlcyB0aGF0IHdoZW4gcGxheWluZyBhIHZpZGVvIChzdGF0ZT0xKSxcbi8vICAgIHRoZSBwbGF5ZXIgc2hvdWxkIHBsYXkgZm9yIHNpeCBzZWNvbmRzIGFuZCB0aGVuIHN0b3AuXG4vKnZhciBkb25lID0gZmFsc2U7XG5mdW5jdGlvbiBvblBsYXllclN0YXRlQ2hhICBuZ2UoZXZlbnQpIHtcbiAgaWYgKGV2ZW50LmRhdGEgPT0gWVQuUGxheWVyU3RhdGUuUExBWUlORyAmJiAhZG9uZSkge1xuICAgIHNldFRpbWVvdXQoc3RvcFZpZGVvLCA2MDAwKTtcbiAgICBkb25lID0gdHJ1ZTtcbiAgfVxufSovXG5mdW5jdGlvbiBzdG9wVmlkZW8oKSB7XG4gIC8vcGxheWVyLnN0b3BWaWRlbygpO1xufVxuXG5cbmZ1bmN0aW9uIHNldFZpZGVvKCl7XG4gIHZhciBpZF95dF92aWRlbyA9IHl0X3VybF90b19pZCh1cmxfeXRfY2hvb3Nlci52YWx1ZSk7XG4gIHBsYXllci5sb2FkVmlkZW9CeUlkKGlkX3l0X3ZpZGVvLCAwLCBcImxhcmdlXCIpO1xuIFxuICBjb25zb2xlLmxvZyhpZF95dF92aWRlbylcbn1cblxuZnVuY3Rpb24geXRfdXJsX3RvX2lkKHVybCl7XG4gIHZhciByZWdFeHAgPSAvXi4qKHlvdXR1XFwuYmVcXC98dlxcL3x1XFwvXFx3XFwvfGVtYmVkXFwvfHdhdGNoXFw/dj18XFwmdj0pKFteI1xcJlxcP10qKS4qLztcbiAgdmFyIG1hdGNoID0gdXJsLm1hdGNoKHJlZ0V4cCk7XG4gIGlmIChtYXRjaCAmJiBtYXRjaFsyXS5sZW5ndGggPT0gMTEpIHtcbiAgICByZXR1cm4gbWF0Y2hbMl07XG4gIH0gZWxzZSB7XG4gICAgLy9lcnJvclxuICB9XG59XG5cblxuXG5cbnZhciBwbGF5ID0gZnVuY3Rpb24gKCl7XG4gIGNvbnNvbGUubG9nKFwicGxheSB2aWRlbyBpbiB5b3V0dWJlIHdyYXBwZXJcIik7XG4gIHBsYXlCdXR0b24uc3JjID0gJy9tZWRpYS93b3Jrc2hvcDIvdmlkZW9Db21tYW5kL3BhdXNlQnV0dG9uLnBuZyc7XG4gIHBsYXllci5wbGF5VmlkZW8oKTtcbn1cblxudmFyIHBhdXNlID0gZnVuY3Rpb24gKCl7XG4gIHBsYXllci5wYXVzZVZpZGVvKCk7XG4gIHBsYXlCdXR0b24uc3JjPScvbWVkaWEvd29ya3Nob3AyL3ZpZGVvQ29tbWFuZC9wbGF5QnV0dG9uLnBuZyc7XG4gIGNvbnNvbGUubG9nKFwicGF1c2UgdmlkZW8gaW4geW91dHViZSB3cmFwcGVyXCIpO1xufVxuXG52YXIgbXV0ZUJ1dHRvbkNhbGxiYWNrID0gZnVuY3Rpb24gKCl7XG4gIGlmIChwbGF5ZXIuaXNNdXRlZCgpKSB7XG4gICAgLy8gTXV0ZSB0aGUgdmlkZW9cbiAgICBwbGF5ZXIudW5NdXRlKCk7XG4gICAgLy8gVXBkYXRlIHRoZSBidXR0b24gdGV4dFxuICAgIG11dGVCdXR0b24uaW5uZXJIVE1MID0gXCJVbm11dGVcIjtcbiAgfSBlbHNlIHtcbiAgICAvLyBVbm11dGUgdGhlIHZpZGVvXG4gICAgcGxheWVyLm11dGUoKTtcbiAgICAvL3RoaXMuc3JjPVwiL21lZGlhL3dvcmtzaG9wMi92aWRlb0NvbW1hbmQvdm9sdW1lRnVsbC5wbmdcIjtcbiAgICAvLyBVcGRhdGUgdGhlIGJ1dHRvbiB0ZXh0XG4gICAgbXV0ZUJ1dHRvbi5pbm5lckhUTUwgPSBcIk11dGVcIjtcbiAgfVxufVxuXG5cblxudmFyIHJlcGV0UGFydE9mVmlkZW8gPSBmdW5jdGlvbiAoc3RhcnQsZW5kLCBudW1iZXJPZlJlcGV0aXRpb24sc3BlZWRSYXRlKSB7XG4gICBjb25zb2xlLmxvZyhcImZ1bmN0aW9uICAtIHJlcGV0UGFydE9mVmlkZW9cIiAsIHN0YXJ0LGVuZCwgbnVtYmVyT2ZSZXBldGl0aW9uLHNwZWVkUmF0ZSk7XG4gIC8vY29uc29sZS5sb2coc3RhcnQsZW5kLCBudW1iZXJPZlJlcGV0aXRpb24sc3BlZWRSYXRlKTtcbiAgaXNQbGF5aW5nQ2FyZCA9IHRydWU7XG4gIHBsYXllci5zZXRQbGF5YmFja1JhdGUoc3BlZWRSYXRlKTtcbiAgcGxheWVyLnNlZWtUbyhzdGFydCwgdHJ1ZSk7XG4gIHZhciByZXBldCA9IG51bWJlck9mUmVwZXRpdGlvbjtcbiAgXG4gIC8vY29uc29sZS5sb2coXCJmdW5jdGlvbiAgLSByZXBldFBhcnRPZlZpZGVvIFtwbGF5IHBhcnRdIGw4NyB2aWRlb0NvbW1hbmRcIik7XG4gIHBsYXllci5wbGF5VmlkZW8oKTtcbiAgd2luZG93LmNsZWFySW50ZXJ2YWwodGltZXVwZGF0ZXIpO1xuICBmdW5jdGlvbiB0ZXN0UmVwZXQoKSB7XG4gICAgXG4gICAgY29uc29sZS5sb2coXCJ1cGRhdGVUaW1lXCIpO1xuICAgIHZhciBvbGRUaW1lID0gdmlkZW90aW1lO1xuICAgIFxuICAgICAgaWYoaXNQbGF5aW5nQ2FyZCl7XG4gICAgICAgIGlmICgoZW5kID4gc3RhcnQgKSAmJiAgcmVwZXQgPiAwICkge1xuICAgICAgICAgIGlmIChwbGF5ZXIuZ2V0Q3VycmVudFRpbWUoKSA+IGVuZCkge1xuICAgICAgICAgICAgcmVwZXQtLTtcbiAgICAgICAgICAgIHBsYXllci5zZWVrVG8oc3RhcnQsIHRydWUpO1xuICAgICAgICAgICAgY29uc29sZS5sb2coXCJuYiByZXBldCA6IFwiLCByZXBldCk7XG4gICAgICAgICAgfVxuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIC8vcGxheWVyLm9udGltZXVwZGF0ZSA9IG51bGw7XG4gICAgICAgICAgZmVlZGJhY2tPblNsaWRlclZpZGVvKGZhbHNlKTtcbiAgICAgICAgICBwbGF5ZXIuc2V0UGxheWJhY2tSYXRlKDEpO1xuICBcbiAgICAgICAgICBjbGVhclRpbWVvdXQodGltZXVwZGF0ZXIpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgXG4gIH1cbiAgdGltZXVwZGF0ZXIgPSBzZXRJbnRlcnZhbCh0ZXN0UmVwZXQsIDEwMCk7XG4gIFxuICBcbiAgXG4gXG59O1xuXG5cbmZ1bmN0aW9uIHVwZGF0ZVRpbWVyVmlkZW9ZVCgpIHtcbiAgbGV0IG1pbnV0ZXMgPSBNYXRoLmZsb29yKHBsYXllci5nZXRDdXJyZW50VGltZSgpIC8gNjApO1xuICBsZXQgc2Vjb25kcyA9IE1hdGguZmxvb3IocGxheWVyLmdldEN1cnJlbnRUaW1lKCkgLSBtaW51dGVzICogNjApO1xuICBsZXQgbWludXRlc1ZpZGVvID0gTWF0aC5mbG9vcihwbGF5ZXIuZ2V0RHVyYXRpb24oKSAvIDYwKTtcbiAgXG4gIGxldCBzZWNvbmRzVmlkZW8gPSBNYXRoLmZsb29yKHBsYXllci5nZXREdXJhdGlvbigpIC0gbWludXRlcyAqIDYwKTtcbiAgaWYgKHNlY29uZHMgPCAxMCkge1xuICAgIHNlY29uZHMgPSBcIjBcIiArIHNlY29uZHM7XG4gIH1cbiAgdGltZXJWaWRlby5pbm5lckhUTUwgPSBtaW51dGVzICsgXCI6XCIgKyBzZWNvbmRzICsgXCIvXCIgKyAgbWludXRlc1ZpZGVvICsgXCI6XCIgKyBzZWNvbmRzVmlkZW8gO1xufTtcblxuXG4vL1VwZGF0ZSBrbm9iIG9uIGEgbGFwdG9wXG52YXIgdXBkYXRlS25vYkFuZFZpZGVvQ29tcHV0ZXIgPSBmdW5jdGlvbihlKSB7XG4gIGNsZWFyQWxsVGltZXIoKTtcbiAgLy90YWtlIGludG8gYWNjb3VudCBvZmZzZXQgb24gdGhlIGxlZnQgb2YgdGhlIHNjcm9sbCBiYXIgKGJvZHkgc2Nyb2xsIGFuZCBjZW50ZXJpbmcgdGhlIHdyYXBwZXIpXG4gIFxuICAvLyB2YXIgcG9zID0gKGUucGFnZVggIC0gdGhpcy5vZmZzZXRMZWZ0KSAvIHRoaXMub2Zmc2V0V2lkdGg7XG4gIC8vICAgIHZpZGVvLmN1cnJlbnRUaW1lID0gcG9zICogdmlkZW8uZHVyYXRpb247XG4gIHZhciBvZmZzZXRMZWZ0U2xpZGVyID0gd3JhcHBlckNvbW1hbmRBbmRSYW5nZWlkLm9mZnNldExlZnQgLSBib2R5LnNjcm9sbExlZnQ7IC8vLSB3aW5kb3cuc2Nyb2xsTGVmdCAgO1xuICBcbiAgY3VycmVudFZhbHVlS25vYiA9ICgoZS5wYWdlWCAtIG9mZnNldExlZnRTbGlkZXIpICogcGxheWVyLmdldER1cmF0aW9uKCkpIC8gTlVNQkVSX09GX1RJQ0s7XG4gIGlmIChjdXJyZW50VmFsdWVLbm9iIDwgcGxheWVyLmdldER1cmF0aW9uKCkgJiYgY3VycmVudFZhbHVlS25vYiA+PSAwKSB7XG4gICAgcGxheWVyLnNlZWtUbyhjdXJyZW50VmFsdWVLbm9iLCB0cnVlKTtcbiAgICAvL2tub2JNaW4uc3R5bGUubGVmdCA9IGUucGFnZVggLSAob2Zmc2V0TGVmdFNsaWRlciArIFdJRFRIX01JRF9LTk9CX01JTiAvIDIpICsgXCJweFwiO1xuICAgIGlmIChzZWdtZW50RmVlZGJhY2suZGlzcGxheWVkKSB7XG4gICAgICBpZiAocGxheWVyLmdldEN1cnJlbnRUaW1lKCkgPiBzZWdtZW50RmVlZGJhY2suZW5kRHVyYXRpb25WaWRlbykge1xuICAgICAgICBmZWVkYmFja09uU2xpZGVyVmlkZW8oZmFsc2UpO1xuICAgICAgfVxuICAgIH1cbiAgfVxufTtcblxuLy9VcGRhdGUga25vYiBvbiBhIHRhYmxldFxudmFyIHVwZGF0ZUtub2JBbmRWaWRlbyA9IGZ1bmN0aW9uKGV2ZW50KSB7XG4gIGNsZWFyQWxsVGltZXIoKTtcbiAgLy8gIHZhciBvZmZzZXRMZWZ0U2xpZGVyID0gd3JhcHBlckNvbW1hbmRBbmRSYW5nZWlkLm9mZnNldExlZnQrcmFuZ2VTbGlkZXJUcmFjay5vZmZzZXRMZWZ0ICsgZGl2aWRDb21tYW5kZVZpZGVvLm9mZnNldExlZnQ7XG4gIHZhciBvZmZzZXRMZWZ0U2xpZGVyID0gd3JhcHBlckNvbW1hbmRBbmRSYW5nZWlkLm9mZnNldExlZnQ7IC8vLSAgIDtcbiAgLy9jb25zb2xlLmxvZyhcImFhIDogIFwiICsgIGJvZHkgKTtcbiAgdmFyIGN0aW1lID0gTWF0aC5yb3VuZCgoKChldmVudC50YXJnZXRUb3VjaGVzWzBdID8gZXZlbnQudGFyZ2V0VG91Y2hlc1swXS5wYWdlWCA6IGV2ZW50LmNoYW5nZWRUb3VjaGVzW2V2ZW50LmNoYW5nZWRUb3VjaGVzLmxlbmd0aCAtIDFdLnBhZ2VYKSAtIChvZmZzZXRMZWZ0U2xpZGVyKSkgKiBwbGF5ZXIuZ2V0RHVyYXRpb24oKSkgLyBOVU1CRVJfT0ZfVElDSyApO1xuICBwbGF5ZXIuc2Vla1RvKGN0aW1lKTtcbiAgLy9VcGRhdGUga25vdyBwb3NpdGlvblxuICBrbm9iTWluLnN0eWxlLmxlZnQgPSAoKCgoZXZlbnQudGFyZ2V0VG91Y2hlc1swXSA/IGV2ZW50LnRhcmdldFRvdWNoZXNbMF0ucGFnZVggOiBldmVudC5jaGFuZ2VkVG91Y2hlc1tldmVudC5jaGFuZ2VkVG91Y2hlcy5sZW5ndGggLSAxXS5wYWdlWCkpIC0gb2Zmc2V0TGVmdFNsaWRlcikpICsgXCJweFwiO1xuICBpZiAoc2VnbWVudEZlZWRiYWNrLmRpc3BsYXllZCkge1xuICAgIGlmIChwbGF5ZXIuZ2V0Q3VycmVudFRpbWUoKSA+IHNlZ21lbnRGZWVkYmFjay5lbmREdXJhdGlvblZpZGVvKSB7XG4gICAgICBmZWVkYmFja09uU2xpZGVyVmlkZW8oZmFsc2UpO1xuICAgIH1cbiAgfVxufTtcblxuXG4vLyB3aGVuIHRoZSBwbGF5ZXIgaXMgcmVhZHksIHN0YXJ0IGNoZWNraW5nIHRoZSBjdXJyZW50IHRpbWUgZXZlcnkgMTAwIG1zLlxuZnVuY3Rpb24gb25QbGF5ZXJSZWFkeShldmVudCkge1xuICBldmVudC50YXJnZXQucGxheVZpZGVvKCk7XG4gIGZ1bmN0aW9uIHVwZGF0ZVRpbWUoKSB7XG4gICAgICAgIGN1cnJlbnRWYWx1ZUtub2IgPSAoKChOVU1CRVJfT0ZfVElDSyAvIHBsYXllci5nZXREdXJhdGlvbigpKSAqIHBsYXllci5nZXRDdXJyZW50VGltZSgpKSArIHJhbmdlU2xpZGVyVHJhY2sub2Zmc2V0TGVmdCk7XG4gICAgICAgIC8vIGtub2JNaW4uc3R5bGUubGVmdCA9IGN1cnJlbnRWYWx1ZUtub2ItKEtOT0JfV0lEVEgvMikrIFwicHhcIiA7XG4gICAgICAgIGtub2JNaW4uc3R5bGUubGVmdCA9IGN1cnJlbnRWYWx1ZUtub2IgLSAoS05PQl9XSURUSCAvIDIpICsgXCJweFwiO1xuICAgICAgXG4gICAgICAvL3ZpZGVvU2xpZGVyLnZhbHVlID0gKE5VTUJFUl9PRl9USUNLIC8gdmlkZW8uZHVyYXRpb24pICogdmlkZW8uY3VycmVudFRpbWU7XG4gICAgICB1cGRhdGVUaW1lclZpZGVvWVQoKTtcbiAgICBcbiAgfVxuICBvbkNoYW5nZVRpbWVyID0gc2V0SW50ZXJ2YWwodXBkYXRlVGltZSwgNTApO1xuICBcbiAgXG4gIC8vZG9jdW1lbnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShcInl0cC1sb2FkLXByb2dyZXNzXCIpWzBdLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlb3ZlcicgLCBmdW5jdGlvbihlKSB7Y29uc29sZS5sb2coXCJ0ZXN0IG1vdXNlIGVudGVyXCIpfSAsIHtwYXNzaXZlOiB0cnVlfSApO1xufVxuXG5cblxuZnVuY3Rpb24gY2xlYXJBbGxUaW1lcigpIHtcbiAgd2luZG93LmNsZWFySW50ZXJ2YWwodGltZXJSZXBldGl0aW9uKTtcbiAgd2luZG93LmNsZWFySW50ZXJ2YWwodGltZXVwZGF0ZXIpO1xuICBpc1BsYXlpbmdDYXJkID0gZmFsc2U7XG4gIHBsYXllci5zZXRQbGF5YmFja1JhdGUoIDEpO1xuICBmZWVkYmFja09uU2xpZGVyVmlkZW8oZmFsc2UpO1xufVxuXG5cblxudmFyIHBsYXlQYXVzZWNhbGxiYWNrID0gZnVuY3Rpb24oZSl7XG4gIC8vY29uc29sZS5sb2coXCJjYWxsYmFjayBwbGF5LXBhdXNlLCBlIDogXCIgKyBlKTtcbiAgLyppZihlICE9IG51bGwgJiYgZSAhPT0gdW5kZWZpbmVkKXtcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gIH0qL1xuICBpZiAocGxheWVyLmdldFBsYXllclN0YXRlKCkgPT0gMCB8fCBwbGF5ZXIuZ2V0UGxheWVyU3RhdGUoKSA9PSAtMSB8fCBwbGF5ZXIuZ2V0UGxheWVyU3RhdGUoKSA9PSAyICApIHtcbiAgICB2aWRlb0Z1bmN0aW9uYWxDb3JlTWFuYWdlci5leGVjdXRlKG5ldyBQbGF5Q29tbWFuZCgpKTtcbiAgICAvL3BsYXkoKTtcbiAgfSBlbHNlIHtcbiAgICAvL3BhdXNlKCk7XG4gICAgdmlkZW9GdW5jdGlvbmFsQ29yZU1hbmFnZXIuZXhlY3V0ZShuZXcgUGF1c2VDb21tYW5kKCkpO1xuICAgIFxuICB9XG59O1xuXG5cblxuXG5mdW5jdGlvbiBmZWVkYmFja09uU2xpZGVyVmlkZW8ob25PZmYpIHtcbiAgc2VnbWVudEZlZWRiYWNrLmVuZFBvc2l0aW9uID0gcGFyc2VJbnQoc2VnbWVudEZlZWRiYWNrLnN0YXJ0UG9zdGlvbikgKyBwYXJzZUludChzZWdtZW50RmVlZGJhY2sud2lkdGgpO1xuICB2YXIgc2xpZGVyVG9WID0gc2xpZGVyVG9WaWRlbyhzZWdtZW50RmVlZGJhY2suc3RhcnRQb3N0aW9uLCBzZWdtZW50RmVlZGJhY2suZW5kUG9zaXRpb24pO1xuICBzZWdtZW50RmVlZGJhY2suc3RhcnREdXJhdGlvblZpZGVvID0gc2xpZGVyVG9WLnN0YXJ0RHVyYXRpb247XG4gIHNlZ21lbnRGZWVkYmFjay5lbmREdXJhdGlvblZpZGVvID0gc2xpZGVyVG9WLmVuZER1cmF0aW9uO1xuICBzZWdtZW50RmVlZGJhY2suZGlzcGxheWVkID0gb25PZmY7XG4gIGlmIChvbk9mZikge1xuICAgIC8vc2VnbWVudEZlZWRiYWNrLmRpdkdyYXBoaWNhbE9iamVjdC5zdHlsZS5tYXJnaW5MZWZ0ID0gc2VnbWVudEZlZWRiYWNrLnN0YXJ0UG9zdGlvbjtcbiAgICAvL21pbnVzIDIgYmVjYXVzZSB3ZSBuZWVkIHRvIGdldCAyIGZyYW1lIGJlZm9yZSB0aGUgc2VnbWVudFxuICAgIHNlZ21lbnRGZWVkYmFjay5kaXZHcmFwaGljYWxPYmplY3Quc3R5bGUubWFyZ2luTGVmdCA9IHBhcnNlSW50KHNlZ21lbnRGZWVkYmFjay5zdGFydFBvc3Rpb24pICArIFwicHhcIjsgLy8gIHNlZ21lbnRGZWVkYmFjay5zdGFydFBvc3Rpb247XG4gICAgc2VnbWVudEZlZWRiYWNrLmRpdkdyYXBoaWNhbE9iamVjdC5zdHlsZS52aXNpYmlsaXR5ID0gXCJ2aXNpYmxlXCI7XG4gICAgc2VnbWVudEZlZWRiYWNrLmRpdkdyYXBoaWNhbE9iamVjdC5zdHlsZS53aWR0aCA9IHNlZ21lbnRGZWVkYmFjay53aWR0aDtcbiAgfSBlbHNlIHtcbiAgICBzZWdtZW50RmVlZGJhY2suZGl2R3JhcGhpY2FsT2JqZWN0LnN0eWxlLnZpc2liaWxpdHkgPSBcImhpZGRlblwiO1xuICB9XG59XG5cbi8vc3RhcnQgcG9zaXRpb24gb24gdGhlIHNsaWRlciBhbmQgZW5kIHBvc2l0aW9uIG9uIHRoZSBzbGlkZXJcbmZ1bmN0aW9uIHNsaWRlclRvVmlkZW8oc3RhcnRQLCBlbmRQKSB7XG4gIGlmKHN0YXJ0UCA8IDAgKXtcbiAgICBzdGFydFAgPSAwO1xuICB9XG4gIHZhciBzdGFydER1cmF0aW9uID0gTWF0aC5yb3VuZCgoKHN0YXJ0UCAqIHBsYXllci5nZXREdXJhdGlvbigpKSAvIE5VTUJFUl9PRl9USUNLKSk7XG4gIHZhciBlbmREdXJhdGlvbiA9IE1hdGgucm91bmQoKChlbmRQICogcGxheWVyLmdldER1cmF0aW9uKCkpIC8gTlVNQkVSX09GX1RJQ0spKTtcbiAgXG4gIHJldHVybiB7XG4gICAgc3RhcnREdXJhdGlvbjogc3RhcnREdXJhdGlvbixcbiAgICBlbmREdXJhdGlvbjogZW5kRHVyYXRpb25cbiAgfTtcbn1cblxuIl19