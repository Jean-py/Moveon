"use strict";

var video = document.getElementById("videoEAT");
var wrapperVideo = document.getElementById("idVideo");
var speedrate = 1;
// Buttons
var playButton = document.getElementById("play-pause");
var muteButton = document.getElementById("mute");
// Sliders
var knobMin = document.getElementById("range-slider_handle-min");
var rangeSliderTrack = document.getElementById("rangeSliderTrack");

var divCardBoard = document.getElementById("divCardBoard");
var body = document.getElementsByTagName("BODY")[0];

//Je ne saiss pas comment rendre cette ligne automatique pour l'isntant car la taille est en auto...
var WIDTH_RANGE_SLIDER_TRACK = "960px";
//Donc pour l'instant je reste comme Ã§a
rangeSliderTrack.style.width = WIDTH_RANGE_SLIDER_TRACK;

var isPlayingCard = false;

var commands = [];
/**
 * Access point to the functional core, you can just execute command from here
 * @return {{execute: execute}}
 * @constructor
 */
var VideoFunctionalCoreManager = function VideoFunctionalCoreManager() {
  //This is a command pattern, see : https://www.dofactory.com/javascript/command-design-pattern
  return {
    //execute a command
    execute: function execute(command) {
      //console.log("executing : ");
      //console.log(command);

      switch (command.execute.name) {
        case "repetPartOfVideo":
          {
            command.execute(command.start, command.end, command.numberOfRepetition, command.speedRate);
            break;
          }
        case "updateKnobAndVideoComputer":
          command.execute(command.e);
          break;

        default:
          command.execute();
          break;
      }

      //We send the command to the server (the server log it into a file, see ./src/server/ServerLogger)
      logger.sendAndLogCommand(command);
      //and we save the command created
      commands.push(command);
    }
    //We did not implemented undo redo for this manager, because undo play pause is kind of useless right?

  };
};

//On load of the page
window.addEventListener("load", function () {
  //The size of the controller is the same than the size of the video

  setTimeout(function () {
    // This hides the address bar:
    video.load();
    window.scrollTo(0, 1);

    var ua = navigator.userAgent.toLowerCase();
    if (ua.indexOf('safari') != -1) {
      if (ua.indexOf('chrome') > -1) {
        //video.src = "./public/media/EAT3.webm";
      } else {
        //alert("2") // Safari
        console.log("test safari");
        video.src = "../../../public/media/workshop2/EAT3.mp4";
        console.log("test safari : " + video.src);
        video.load();
      }
    }
  }, 0);
});
window.addEventListener("scroll", function (event) {
  topWindow = this.scrollY;
  leftWindow = this.scrollX;
  // console.log("window scroll : " + leftWindow);
}, false);

body.addEventListener("scroll", function (event) {
  topBody = this.scrollY;
  leftBody = this.scrollX;
  //console.log(" body : "+  body.scrollLeft  );
}, false);

/**
 * Callback used *
 *-------------------------------
 * DO NOT USE THESE FUNCTIONS WITHOUT A COMMAND!
 * The following code should be considered as private
/*------------------------------- */

var muteButtonCallback = function muteButtonCallback(e) {
  if (video.muted === false) {
    // Mute the video
    video.muted = true;
    // Update the button text
    muteButton.innerHTML = "Unmute";
  } else {
    // Unmute the video
    video.muted = false;
    //this.src="/media/workshop2/videoCommand/volumeFull.png";
    // Update the button text
    muteButton.innerHTML = "Mute";
  }
};

var repetPartOfVideo = function repetPartOfVideo(start, end, numberOfRepetition, speedRate) {
  // console.log("function  - repetPartOfVideo" , start,end, numberOfRepetition,speedRate);
  isPlayingCard = true;
  video.playbackRate = speedRate;
  video.currentTime = start;
  var repet = numberOfRepetition;

  video.ontimeupdate = function () {
    if (isPlayingCard) {
      if (end > start && repet > 0) {
        if (video.currentTime > end) {
          repet--;
          video.currentTime = start;
          //console.log("function  - repetPartOfVideo [play part] l87 videoCommand");
          play();
        }
      } else {
        video.ontimeupdate = null;
        feedbackOnSliderVideo(false);
        video.playbackRate = 1;
      }
    }
  };
};

function clearAllTimer() {
  window.clearInterval(timerRepetition);
  isPlayingCard = false;
  video.playbackRate = 1;
  feedbackOnSliderVideo(false);
}

var play = function play() {
  setTimeout(function () {
    var playPromise = video.play();
    if (playPromise !== undefined) {
      playPromise.then(function (value) {
        video.play();
        playButton.src = '/media/workshop2/videoCommand/pauseButton.png';
      }).catch(function (e) {
        console.log(e);
        video.load();
        //video.pause();
      });
    }
  }, 250);
};

var pause = function pause() {
  //console.log("appel a pause");
  video.pause();
  playButton.src = '/media/workshop2/videoCommand/playButton.png';
};

var playPausecallback = function playPausecallback(e) {
  //console.log("callback play-pause, e : " + e);
  /*if(e != null && e !== undefined){
    e.preventDefault();
  }*/
  if (video.paused || video.ended) {
    videoFunctionalCoreManager.execute(new PlayCommand());
    //play();
  } else {
    //pause();
    videoFunctionalCoreManager.execute(new PauseCommand());
  }
};

//Update knob on a tablet
var updateKnobAndVideo = function updateKnobAndVideo(event) {
  //  var offsetLeftSlider = wrapperCommandAndRangeid.offsetLeft+rangeSliderTrack.offsetLeft + dividCommandeVideo.offsetLeft;
  var offsetLeftSlider = wrapperCommandAndRangeid.offsetLeft; //-   ;
  //console.log("aa :  " +  body );

  video.currentTime = Math.round(((event.targetTouches[0] ? event.targetTouches[0].pageX : event.changedTouches[event.changedTouches.length - 1].pageX) - offsetLeftSlider) * video.duration / NUMBER_OF_TICK);
  //Update know position
  knobMin.style.left = (event.targetTouches[0] ? event.targetTouches[0].pageX : event.changedTouches[event.changedTouches.length - 1].pageX) - offsetLeftSlider + "px";
  if (segmentFeedback.displayed) {
    if (video.currentTime > segmentFeedback.endDurationVideo) {
      feedbackOnSliderVideo(false);
    }
  }
};

//Update knob on a laptop
var updateKnobAndVideoComputer = function updateKnobAndVideoComputer(e) {
  //take into account offset on the left of the scroll bar (body scroll and centering the wrapper)

  // var pos = (e.pageX  - this.offsetLeft) / this.offsetWidth;
  //    video.currentTime = pos * video.duration;
  var offsetLeftSlider = wrapperCommandAndRangeid.offsetLeft - body.scrollLeft; //- window.scrollLeft  ;
  currentValueKnob = (e.pageX - offsetLeftSlider) * video.duration / NUMBER_OF_TICK;
  if (currentValueKnob < video.duration && currentValueKnob >= 0) {
    video.currentTime = (e.pageX - offsetLeftSlider) * video.duration / NUMBER_OF_TICK;
    knobMin.style.left = e.pageX - (offsetLeftSlider + WIDTH_MID_KNOB_MIN / 2) + "px";
    if (segmentFeedback.displayed) {
      if (video.currentTime > segmentFeedback.endDurationVideo) {
        feedbackOnSliderVideo(false);
      }
    }
  }
};

function feedbackOnSliderVideo(onOff) {
  segmentFeedback.endPosition = parseInt(segmentFeedback.startPostion) + parseInt(segmentFeedback.width);
  var sliderToV = sliderToVideo(segmentFeedback.startPostion, segmentFeedback.endPosition);
  segmentFeedback.startDurationVideo = sliderToV.startDuration;
  segmentFeedback.endDurationVideo = sliderToV.endDuration;
  segmentFeedback.displayed = onOff;
  if (onOff) {
    //segmentFeedback.divGraphicalObject.style.marginLeft = segmentFeedback.startPostion;
    //minus 2 because we need to get 2 frame before the segment
    segmentFeedback.divGraphicalObject.style.marginLeft = parseInt(segmentFeedback.startPostion) - 7 + "px"; //  segmentFeedback.startPostion;
    segmentFeedback.divGraphicalObject.style.visibility = "visible";
    segmentFeedback.divGraphicalObject.style.width = segmentFeedback.width;
  } else {
    segmentFeedback.divGraphicalObject.style.visibility = "hidden";
  }
}

function updateTimerVideo() {
  var minutes = Math.floor(video.currentTime / 60);
  var seconds = Math.floor(video.currentTime - minutes * 60);
  if (seconds < 10) seconds = "0" + seconds;
  timerVideo.innerHTML = minutes + ":" + seconds + "/" + videoDuration;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInZpZGVvRnVuY3Rpb25hbENvcmUuanMiXSwibmFtZXMiOlsidmlkZW8iLCJkb2N1bWVudCIsImdldEVsZW1lbnRCeUlkIiwid3JhcHBlclZpZGVvIiwic3BlZWRyYXRlIiwicGxheUJ1dHRvbiIsIm11dGVCdXR0b24iLCJrbm9iTWluIiwicmFuZ2VTbGlkZXJUcmFjayIsImRpdkNhcmRCb2FyZCIsImJvZHkiLCJnZXRFbGVtZW50c0J5VGFnTmFtZSIsIldJRFRIX1JBTkdFX1NMSURFUl9UUkFDSyIsInN0eWxlIiwid2lkdGgiLCJpc1BsYXlpbmdDYXJkIiwiY29tbWFuZHMiLCJWaWRlb0Z1bmN0aW9uYWxDb3JlTWFuYWdlciIsImV4ZWN1dGUiLCJjb21tYW5kIiwibmFtZSIsInN0YXJ0IiwiZW5kIiwibnVtYmVyT2ZSZXBldGl0aW9uIiwic3BlZWRSYXRlIiwiZSIsImxvZ2dlciIsInNlbmRBbmRMb2dDb21tYW5kIiwicHVzaCIsIndpbmRvdyIsImFkZEV2ZW50TGlzdGVuZXIiLCJzZXRUaW1lb3V0IiwibG9hZCIsInNjcm9sbFRvIiwidWEiLCJuYXZpZ2F0b3IiLCJ1c2VyQWdlbnQiLCJ0b0xvd2VyQ2FzZSIsImluZGV4T2YiLCJjb25zb2xlIiwibG9nIiwic3JjIiwiZXZlbnQiLCJ0b3BXaW5kb3ciLCJzY3JvbGxZIiwibGVmdFdpbmRvdyIsInNjcm9sbFgiLCJ0b3BCb2R5IiwibGVmdEJvZHkiLCJtdXRlQnV0dG9uQ2FsbGJhY2siLCJtdXRlZCIsImlubmVySFRNTCIsInJlcGV0UGFydE9mVmlkZW8iLCJwbGF5YmFja1JhdGUiLCJjdXJyZW50VGltZSIsInJlcGV0Iiwib250aW1ldXBkYXRlIiwicGxheSIsImZlZWRiYWNrT25TbGlkZXJWaWRlbyIsImNsZWFyQWxsVGltZXIiLCJjbGVhckludGVydmFsIiwidGltZXJSZXBldGl0aW9uIiwicGxheVByb21pc2UiLCJ1bmRlZmluZWQiLCJ0aGVuIiwidmFsdWUiLCJjYXRjaCIsInBhdXNlIiwicGxheVBhdXNlY2FsbGJhY2siLCJwYXVzZWQiLCJlbmRlZCIsInZpZGVvRnVuY3Rpb25hbENvcmVNYW5hZ2VyIiwiUGxheUNvbW1hbmQiLCJQYXVzZUNvbW1hbmQiLCJ1cGRhdGVLbm9iQW5kVmlkZW8iLCJvZmZzZXRMZWZ0U2xpZGVyIiwid3JhcHBlckNvbW1hbmRBbmRSYW5nZWlkIiwib2Zmc2V0TGVmdCIsIk1hdGgiLCJyb3VuZCIsInRhcmdldFRvdWNoZXMiLCJwYWdlWCIsImNoYW5nZWRUb3VjaGVzIiwibGVuZ3RoIiwiZHVyYXRpb24iLCJOVU1CRVJfT0ZfVElDSyIsImxlZnQiLCJzZWdtZW50RmVlZGJhY2siLCJkaXNwbGF5ZWQiLCJlbmREdXJhdGlvblZpZGVvIiwidXBkYXRlS25vYkFuZFZpZGVvQ29tcHV0ZXIiLCJzY3JvbGxMZWZ0IiwiY3VycmVudFZhbHVlS25vYiIsIldJRFRIX01JRF9LTk9CX01JTiIsIm9uT2ZmIiwiZW5kUG9zaXRpb24iLCJwYXJzZUludCIsInN0YXJ0UG9zdGlvbiIsInNsaWRlclRvViIsInNsaWRlclRvVmlkZW8iLCJzdGFydER1cmF0aW9uVmlkZW8iLCJzdGFydER1cmF0aW9uIiwiZW5kRHVyYXRpb24iLCJkaXZHcmFwaGljYWxPYmplY3QiLCJtYXJnaW5MZWZ0IiwidmlzaWJpbGl0eSIsInVwZGF0ZVRpbWVyVmlkZW8iLCJtaW51dGVzIiwiZmxvb3IiLCJzZWNvbmRzIiwidGltZXJWaWRlbyIsInZpZGVvRHVyYXRpb24iXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBSUEsUUFBUUMsU0FBU0MsY0FBVCxDQUF3QixVQUF4QixDQUFaO0FBQ0EsSUFBSUMsZUFBZUYsU0FBU0MsY0FBVCxDQUF3QixTQUF4QixDQUFuQjtBQUNBLElBQUlFLFlBQVksQ0FBaEI7QUFDQTtBQUNBLElBQUlDLGFBQWFKLFNBQVNDLGNBQVQsQ0FBd0IsWUFBeEIsQ0FBakI7QUFDQSxJQUFJSSxhQUFhTCxTQUFTQyxjQUFULENBQXdCLE1BQXhCLENBQWpCO0FBQ0E7QUFDQSxJQUFJSyxVQUFVTixTQUFT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T0FBaEIsR0FBMEIsR0FBMUIsR0FBZ0NFLGFBQXZEO0FBQ0QiLCJmaWxlIjoidmlkZW9GdW5jdGlvbmFsQ29yZS5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciB2aWRlbyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwidmlkZW9FQVRcIik7XG52YXIgd3JhcHBlclZpZGVvID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJpZFZpZGVvXCIpO1xudmFyIHNwZWVkcmF0ZSA9IDE7XG4vLyBCdXR0b25zXG52YXIgcGxheUJ1dHRvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwicGxheS1wYXVzZVwiKTtcbnZhciBtdXRlQnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJtdXRlXCIpO1xuLy8gU2xpZGVyc1xudmFyIGtub2JNaW4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInJhbmdlLXNsaWRlcl9oYW5kbGUtbWluXCIpO1xudmFyIHJhbmdlU2xpZGVyVHJhY2sgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInJhbmdlU2xpZGVyVHJhY2tcIik7XG5cbnZhciBkaXZDYXJkQm9hcmQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImRpdkNhcmRCb2FyZFwiKTtcbnZhciBib2R5ID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJCT0RZXCIpWzBdO1xuXG4vL0plIG5lIHNhaXNzIHBhcyBjb21tZW50IHJlbmRyZSBjZXR0ZSBsaWduZSBhdXRvbWF0aXF1ZSBwb3VyIGwnaXNudGFudCBjYXIgbGEgdGFpbGxlIGVzdCBlbiBhdXRvLi4uXG52YXIgV0lEVEhfUkFOR0VfU0xJREVSX1RSQUNLID0gXCI5NjBweFwiO1xuLy9Eb25jIHBvdXIgbCdpbnN0YW50IGplIHJlc3RlIGNvbW1lIMOnYVxucmFuZ2VTbGlkZXJUcmFjay5zdHlsZS53aWR0aCA9IFdJRFRIX1JBTkdFX1NMSURFUl9UUkFDSztcblxudmFyIGlzUGxheWluZ0NhcmQgPSBmYWxzZTtcblxudmFyIGNvbW1hbmRzID0gW107XG4vKipcbiAqIEFjY2VzcyBwb2ludCB0byB0aGUgZnVuY3Rpb25hbCBjb3JlLCB5b3UgY2FuIGp1c3QgZXhlY3V0ZSBjb21tYW5kIGZyb20gaGVyZVxuICogQHJldHVybiB7e2V4ZWN1dGU6IGV4ZWN1dGV9fVxuICogQGNvbnN0cnVjdG9yXG4gKi9cbnZhciBWaWRlb0Z1bmN0aW9uYWxDb3JlTWFuYWdlciA9IGZ1bmN0aW9uKCkge1xuICAvL1RoaXMgaXMgYSBjb21tYW5kIHBhdHRlcm4sIHNlZSA6IGh0dHBzOi8vd3d3LmRvZmFjdG9yeS5jb20vamF2YXNjcmlwdC9jb21tYW5kLWRlc2lnbi1wYXR0ZXJuXG4gIHJldHVybiB7XG4gICAgLy9leGVjdXRlIGEgY29tbWFuZFxuICAgIGV4ZWN1dGU6IGZ1bmN0aW9uKGNvbW1hbmQpIHtcbiAgICAgIC8vY29uc29sZS5sb2coXCJleGVjdXRpbmcgOiBcIik7XG4gICAgICAvL2NvbnNvbGUubG9nKGNvbW1hbmQpO1xuICAgICAgXG4gICAgICBzd2l0Y2ggKGNvbW1hbmQuZXhlY3V0ZS5uYW1lKXtcbiAgICAgICAgY2FzZSBcInJlcGV0UGFydE9mVmlkZW9cIiA6IHtcbiAgICAgICAgICBjb21tYW5kLmV4ZWN1dGUoY29tbWFuZC5zdGFydCxjb21tYW5kLmVuZCxjb21tYW5kLm51bWJlck9mUmVwZXRpdGlvbixjb21tYW5kLnNwZWVkUmF0ZSk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgY2FzZSBcInVwZGF0ZUtub2JBbmRWaWRlb0NvbXB1dGVyXCIgOlxuICAgICAgICAgIGNvbW1hbmQuZXhlY3V0ZShjb21tYW5kLmUpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICBjb21tYW5kLmV4ZWN1dGUoKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgXG4gICAgICAvL1dlIHNlbmQgdGhlIGNvbW1hbmQgdG8gdGhlIHNlcnZlciAodGhlIHNlcnZlciBsb2cgaXQgaW50byBhIGZpbGUsIHNlZSAuL3NyYy9zZXJ2ZXIvU2VydmVyTG9nZ2VyKVxuICAgICAgbG9nZ2VyLnNlbmRBbmRMb2dDb21tYW5kKGNvbW1hbmQpO1xuICAgICAgLy9hbmQgd2Ugc2F2ZSB0aGUgY29tbWFuZCBjcmVhdGVkXG4gICAgICBjb21tYW5kcy5wdXNoKGNvbW1hbmQpO1xuICAgIH1cbiAgICAvL1dlIGRpZCBub3QgaW1wbGVtZW50ZWQgdW5kbyByZWRvIGZvciB0aGlzIG1hbmFnZXIsIGJlY2F1c2UgdW5kbyBwbGF5IHBhdXNlIGlzIGtpbmQgb2YgdXNlbGVzcyByaWdodD9cbiAgICBcbiAgfVxufTtcblxuXG4vL09uIGxvYWQgb2YgdGhlIHBhZ2VcbndpbmRvdy5hZGRFdmVudExpc3RlbmVyKFwibG9hZFwiLGZ1bmN0aW9uKCkge1xuICAvL1RoZSBzaXplIG9mIHRoZSBjb250cm9sbGVyIGlzIHRoZSBzYW1lIHRoYW4gdGhlIHNpemUgb2YgdGhlIHZpZGVvXG4gIFxuICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7XG4gICAgLy8gVGhpcyBoaWRlcyB0aGUgYWRkcmVzcyBiYXI6XG4gICAgdmlkZW8ubG9hZCgpO1xuICAgIHdpbmRvdy5zY3JvbGxUbygwLCAxKTtcbiAgICBcbiAgICB2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCk7XG4gICAgaWYgKHVhLmluZGV4T2YoJ3NhZmFyaScpICE9IC0xKSB7XG4gICAgICBpZiAodWEuaW5kZXhPZignY2hyb21lJykgPiAtMSkge1xuICAgICAgICAvL3ZpZGVvLnNyYyA9IFwiLi9wdWJsaWMvbWVkaWEvRUFUMy53ZWJtXCI7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvL2FsZXJ0KFwiMlwiKSAvLyBTYWZhcmlcbiAgICAgICAgY29uc29sZS5sb2coXCJ0ZXN0IHNhZmFyaVwiKTtcbiAgICAgICAgdmlkZW8uc3JjID0gXCIuLi8uLi8uLi9wdWJsaWMvbWVkaWEvd29ya3Nob3AyL0VBVDMubXA0XCI7XG4gICAgICAgIGNvbnNvbGUubG9nKFwidGVzdCBzYWZhcmkgOiBcIiArIHZpZGVvLnNyYyk7XG4gICAgICAgIHZpZGVvLmxvYWQoKTtcbiAgICAgIH1cbiAgICB9XG4gIH0sIDApO1xufSk7XG53aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihcInNjcm9sbFwiLCBmdW5jdGlvbihldmVudCkge1xuICB0b3BXaW5kb3cgPSB0aGlzLnNjcm9sbFk7XG4gIGxlZnRXaW5kb3cgPXRoaXMuc2Nyb2xsWDtcbiAgLy8gY29uc29sZS5sb2coXCJ3aW5kb3cgc2Nyb2xsIDogXCIgKyBsZWZ0V2luZG93KTtcbn0sIGZhbHNlKTtcblxuYm9keS5hZGRFdmVudExpc3RlbmVyKFwic2Nyb2xsXCIsIGZ1bmN0aW9uKGV2ZW50KSB7XG4gIHRvcEJvZHkgPSAgdGhpcy5zY3JvbGxZO1xuICBsZWZ0Qm9keSA9IHRoaXMuc2Nyb2xsWDtcbiAgLy9jb25zb2xlLmxvZyhcIiBib2R5IDogXCIrICBib2R5LnNjcm9sbExlZnQgICk7XG59LCBmYWxzZSk7XG5cblxuLyoqXG4gKiBDYWxsYmFjayB1c2VkICpcbiAqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICogRE8gTk9UIFVTRSBUSEVTRSBGVU5DVElPTlMgV0lUSE9VVCBBIENPTU1BTkQhXG4gKiBUaGUgZm9sbG93aW5nIGNvZGUgc2hvdWxkIGJlIGNvbnNpZGVyZWQgYXMgcHJpdmF0ZVxuLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovXG5cbnZhciBtdXRlQnV0dG9uQ2FsbGJhY2sgPSBmdW5jdGlvbihlKXtcbiAgaWYgKHZpZGVvLm11dGVkID09PSBmYWxzZSkge1xuICAgIC8vIE11dGUgdGhlIHZpZGVvXG4gICAgdmlkZW8ubXV0ZWQgPSB0cnVlO1xuICAgIC8vIFVwZGF0ZSB0aGUgYnV0dG9uIHRleHRcbiAgICBtdXRlQnV0dG9uLmlubmVySFRNTCA9IFwiVW5tdXRlXCI7XG4gIH0gZWxzZSB7XG4gICAgLy8gVW5tdXRlIHRoZSB2aWRlb1xuICAgIHZpZGVvLm11dGVkID0gZmFsc2U7XG4gICAgLy90aGlzLnNyYz1cIi9tZWRpYS93b3Jrc2hvcDIvdmlkZW9Db21tYW5kL3ZvbHVtZUZ1bGwucG5nXCI7XG4gICAgLy8gVXBkYXRlIHRoZSBidXR0b24gdGV4dFxuICAgIG11dGVCdXR0b24uaW5uZXJIVE1MID0gXCJNdXRlXCI7XG4gIH1cbn07XG5cbnZhciByZXBldFBhcnRPZlZpZGVvID0gZnVuY3Rpb24gKHN0YXJ0LGVuZCwgbnVtYmVyT2ZSZXBldGl0aW9uLHNwZWVkUmF0ZSkge1xuICAvLyBjb25zb2xlLmxvZyhcImZ1bmN0aW9uICAtIHJlcGV0UGFydE9mVmlkZW9cIiAsIHN0YXJ0LGVuZCwgbnVtYmVyT2ZSZXBldGl0aW9uLHNwZWVkUmF0ZSk7XG4gICBpc1BsYXlpbmdDYXJkID0gdHJ1ZTtcbiAgdmlkZW8ucGxheWJhY2tSYXRlID0gc3BlZWRSYXRlO1xuICB2aWRlby5jdXJyZW50VGltZSA9IHN0YXJ0O1xuICB2YXIgcmVwZXQgPSBudW1iZXJPZlJlcGV0aXRpb247XG4gIFxuICB2aWRlby5vbnRpbWV1cGRhdGUgPSBmdW5jdGlvbigpIHtcbiAgICBpZihpc1BsYXlpbmdDYXJkKXtcbiAgICAgIGlmICgoZW5kID4gc3RhcnQgKSAmJiAgcmVwZXQgPiAwICkge1xuICAgICAgICBpZiAodmlkZW8uY3VycmVudFRpbWUgPiBlbmQpIHtcbiAgICAgICAgICByZXBldC0tO1xuICAgICAgICAgIHZpZGVvLmN1cnJlbnRUaW1lID0gc3RhcnQ7XG4gICAgICAgICAgICAvL2NvbnNvbGUubG9nKFwiZnVuY3Rpb24gIC0gcmVwZXRQYXJ0T2ZWaWRlbyBbcGxheSBwYXJ0XSBsODcgdmlkZW9Db21tYW5kXCIpO1xuICAgICAgICAgICAgcGxheSgpO1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB2aWRlby5vbnRpbWV1cGRhdGUgPSBudWxsO1xuICAgICAgICBmZWVkYmFja09uU2xpZGVyVmlkZW8oZmFsc2UpO1xuICAgICAgICB2aWRlby5wbGF5YmFja1JhdGUgPSAxO1xuICAgICAgfVxuICAgIH1cbiAgfTtcbn07XG5cbmZ1bmN0aW9uIGNsZWFyQWxsVGltZXIoKSB7XG4gIHdpbmRvdy5jbGVhckludGVydmFsKHRpbWVyUmVwZXRpdGlvbik7XG4gIGlzUGxheWluZ0NhcmQgPSBmYWxzZTtcbiAgdmlkZW8ucGxheWJhY2tSYXRlID0gMTtcbiAgZmVlZGJhY2tPblNsaWRlclZpZGVvKGZhbHNlKTtcbn1cblxuXG52YXIgcGxheSA9IGZ1bmN0aW9uICgpIHtcbiAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgdmFyIHBsYXlQcm9taXNlID0gdmlkZW8ucGxheSgpO1xuICAgIGlmIChwbGF5UHJvbWlzZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBwbGF5UHJvbWlzZS50aGVuKGZ1bmN0aW9uICh2YWx1ZSkge1xuICAgICAgICB2aWRlby5wbGF5KCk7XG4gICAgICAgIHBsYXlCdXR0b24uc3JjID0gJy9tZWRpYS93b3Jrc2hvcDIvdmlkZW9Db21tYW5kL3BhdXNlQnV0dG9uLnBuZyc7XG4gICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZSkge1xuICAgICAgICBjb25zb2xlLmxvZyhlKTtcbiAgICAgICAgdmlkZW8ubG9hZCgpO1xuICAgICAgICAvL3ZpZGVvLnBhdXNlKCk7XG4gICAgICB9KVxuICAgIFxuICAgIH1cbiAgfSwyNTApO1xufTtcblxudmFyIHBhdXNlID0gZnVuY3Rpb24gKCkge1xuICAvL2NvbnNvbGUubG9nKFwiYXBwZWwgYSBwYXVzZVwiKTtcbiAgdmlkZW8ucGF1c2UoKTtcbiAgcGxheUJ1dHRvbi5zcmM9Jy9tZWRpYS93b3Jrc2hvcDIvdmlkZW9Db21tYW5kL3BsYXlCdXR0b24ucG5nJztcbn07XG5cbnZhciBwbGF5UGF1c2VjYWxsYmFjayA9IGZ1bmN0aW9uKGUpe1xuICAvL2NvbnNvbGUubG9nKFwiY2FsbGJhY2sgcGxheS1wYXVzZSwgZSA6IFwiICsgZSk7XG4gIC8qaWYoZSAhPSBudWxsICYmIGUgIT09IHVuZGVmaW5lZCl7XG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICB9Ki9cbiAgaWYgKHZpZGVvLnBhdXNlZCB8fCB2aWRlby5lbmRlZCApIHtcbiAgICB2aWRlb0Z1bmN0aW9uYWxDb3JlTWFuYWdlci5leGVjdXRlKG5ldyBQbGF5Q29tbWFuZCgpKTtcbiAgICAvL3BsYXkoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy9wYXVzZSgpO1xuICAgIHZpZGVvRnVuY3Rpb25hbENvcmVNYW5hZ2VyLmV4ZWN1dGUobmV3IFBhdXNlQ29tbWFuZCgpKTtcbiAgXG4gIH1cbn07XG5cblxuLy9VcGRhdGUga25vYiBvbiBhIHRhYmxldFxudmFyIHVwZGF0ZUtub2JBbmRWaWRlbyA9IGZ1bmN0aW9uKGV2ZW50KSB7XG4gIC8vICB2YXIgb2Zmc2V0TGVmdFNsaWRlciA9IHdyYXBwZXJDb21tYW5kQW5kUmFuZ2VpZC5vZmZzZXRMZWZ0K3JhbmdlU2xpZGVyVHJhY2sub2Zmc2V0TGVmdCArIGRpdmlkQ29tbWFuZGVWaWRlby5vZmZzZXRMZWZ0O1xuICB2YXIgb2Zmc2V0TGVmdFNsaWRlciA9IHdyYXBwZXJDb21tYW5kQW5kUmFuZ2VpZC5vZmZzZXRMZWZ0OyAvLy0gICA7XG4gIC8vY29uc29sZS5sb2coXCJhYSA6ICBcIiArICBib2R5ICk7XG4gIFxuICB2aWRlby5jdXJyZW50VGltZSA9IE1hdGgucm91bmQoKCgoZXZlbnQudGFyZ2V0VG91Y2hlc1swXSA/IGV2ZW50LnRhcmdldFRvdWNoZXNbMF0ucGFnZVggOiBldmVudC5jaGFuZ2VkVG91Y2hlc1tldmVudC5jaGFuZ2VkVG91Y2hlcy5sZW5ndGggLSAxXS5wYWdlWCkgLSAob2Zmc2V0TGVmdFNsaWRlcikpICogdmlkZW8uZHVyYXRpb24pIC8gTlVNQkVSX09GX1RJQ0spO1xuICAvL1VwZGF0ZSBrbm93IHBvc2l0aW9uXG4gIGtub2JNaW4uc3R5bGUubGVmdCA9ICgoKChldmVudC50YXJnZXRUb3VjaGVzWzBdID8gZXZlbnQudGFyZ2V0VG91Y2hlc1swXS5wYWdlWCA6IGV2ZW50LmNoYW5nZWRUb3VjaGVzW2V2ZW50LmNoYW5nZWRUb3VjaGVzLmxlbmd0aCAtIDFdLnBhZ2VYKSkgLSBvZmZzZXRMZWZ0U2xpZGVyKSkgKyBcInB4XCI7XG4gIGlmIChzZWdtZW50RmVlZGJhY2suZGlzcGxheWVkKSB7XG4gICAgaWYgKHZpZGVvLmN1cnJlbnRUaW1lID4gc2VnbWVudEZlZWRiYWNrLmVuZER1cmF0aW9uVmlkZW8pIHtcbiAgICAgIGZlZWRiYWNrT25TbGlkZXJWaWRlbyhmYWxzZSk7XG4gICAgfVxuICB9XG59O1xuXG4vL1VwZGF0ZSBrbm9iIG9uIGEgbGFwdG9wXG52YXIgdXBkYXRlS25vYkFuZFZpZGVvQ29tcHV0ZXIgPSBmdW5jdGlvbihlKSB7XG4gIC8vdGFrZSBpbnRvIGFjY291bnQgb2Zmc2V0IG9uIHRoZSBsZWZ0IG9mIHRoZSBzY3JvbGwgYmFyIChib2R5IHNjcm9sbCBhbmQgY2VudGVyaW5nIHRoZSB3cmFwcGVyKVxuICBcbiAvLyB2YXIgcG9zID0gKGUucGFnZVggIC0gdGhpcy5vZmZzZXRMZWZ0KSAvIHRoaXMub2Zmc2V0V2lkdGg7XG4gIC8vICAgIHZpZGVvLmN1cnJlbnRUaW1lID0gcG9zICogdmlkZW8uZHVyYXRpb247XG4gIHZhciBvZmZzZXRMZWZ0U2xpZGVyID0gd3JhcHBlckNvbW1hbmRBbmRSYW5nZWlkLm9mZnNldExlZnQgLSBib2R5LnNjcm9sbExlZnQ7IC8vLSB3aW5kb3cuc2Nyb2xsTGVmdCAgO1xuICBjdXJyZW50VmFsdWVLbm9iID0gKChlLnBhZ2VYIC0gb2Zmc2V0TGVmdFNsaWRlcikgKiB2aWRlby5kdXJhdGlvbikgLyBOVU1CRVJfT0ZfVElDSztcbiAgaWYgKGN1cnJlbnRWYWx1ZUtub2IgPCB2aWRlby5kdXJhdGlvbiAmJiBjdXJyZW50VmFsdWVLbm9iID49IDApIHtcbiAgICB2aWRlby5jdXJyZW50VGltZSA9ICgoZS5wYWdlWCAtIG9mZnNldExlZnRTbGlkZXIpICogdmlkZW8uZHVyYXRpb24pIC8gTlVNQkVSX09GX1RJQ0s7XG4gICAga25vYk1pbi5zdHlsZS5sZWZ0ID0gZS5wYWdlWCAtIChvZmZzZXRMZWZ0U2xpZGVyICsgV0lEVEhfTUlEX0tOT0JfTUlOIC8gMikgKyBcInB4XCI7XG4gICAgaWYgKHNlZ21lbnRGZWVkYmFjay5kaXNwbGF5ZWQpIHtcbiAgICAgIGlmICh2aWRlby5jdXJyZW50VGltZSA+IHNlZ21lbnRGZWVkYmFjay5lbmREdXJhdGlvblZpZGVvKSB7XG4gICAgICAgIGZlZWRiYWNrT25TbGlkZXJWaWRlbyhmYWxzZSk7XG4gICAgICB9XG4gICAgfVxuICB9XG59O1xuXG5mdW5jdGlvbiBmZWVkYmFja09uU2xpZGVyVmlkZW8ob25PZmYpIHtcbiAgc2VnbWVudEZlZWRiYWNrLmVuZFBvc2l0aW9uID0gcGFyc2VJbnQoc2VnbWVudEZlZWRiYWNrLnN0YXJ0UG9zdGlvbikgKyBwYXJzZUludChzZWdtZW50RmVlZGJhY2sud2lkdGgpO1xuICB2YXIgc2xpZGVyVG9WID0gc2xpZGVyVG9WaWRlbyhzZWdtZW50RmVlZGJhY2suc3RhcnRQb3N0aW9uLCBzZWdtZW50RmVlZGJhY2suZW5kUG9zaXRpb24pO1xuICBzZWdtZW50RmVlZGJhY2suc3RhcnREdXJhdGlvblZpZGVvID0gc2xpZGVyVG9WLnN0YXJ0RHVyYXRpb247XG4gIHNlZ21lbnRGZWVkYmFjay5lbmREdXJhdGlvblZpZGVvID0gc2xpZGVyVG9WLmVuZER1cmF0aW9uO1xuICBzZWdtZW50RmVlZGJhY2suZGlzcGxheWVkID0gb25PZmY7XG4gIGlmIChvbk9mZikge1xuICAgIC8vc2VnbWVudEZlZWRiYWNrLmRpdkdyYXBoaWNhbE9iamVjdC5zdHlsZS5tYXJnaW5MZWZ0ID0gc2VnbWVudEZlZWRiYWNrLnN0YXJ0UG9zdGlvbjtcbiAgICAvL21pbnVzIDIgYmVjYXVzZSB3ZSBuZWVkIHRvIGdldCAyIGZyYW1lIGJlZm9yZSB0aGUgc2VnbWVudFxuICAgIHNlZ21lbnRGZWVkYmFjay5kaXZHcmFwaGljYWxPYmplY3Quc3R5bGUubWFyZ2luTGVmdCA9IHBhcnNlSW50KHNlZ21lbnRGZWVkYmFjay5zdGFydFBvc3Rpb24pIC0gNyArIFwicHhcIjsgLy8gIHNlZ21lbnRGZWVkYmFjay5zdGFydFBvc3Rpb247XG4gICAgc2VnbWVudEZlZWRiYWNrLmRpdkdyYXBoaWNhbE9iamVjdC5zdHlsZS52aXNpYmlsaXR5ID0gXCJ2aXNpYmxlXCI7XG4gICAgc2VnbWVudEZlZWRiYWNrLmRpdkdyYXBoaWNhbE9iamVjdC5zdHlsZS53aWR0aCA9IHNlZ21lbnRGZWVkYmFjay53aWR0aDtcbiAgfSBlbHNlIHtcbiAgICBzZWdtZW50RmVlZGJhY2suZGl2R3JhcGhpY2FsT2JqZWN0LnN0eWxlLnZpc2liaWxpdHkgPSBcImhpZGRlblwiO1xuICB9XG59XG5cblxuZnVuY3Rpb24gdXBkYXRlVGltZXJWaWRlbygpIHtcbiAgbGV0IG1pbnV0ZXMgPSBNYXRoLmZsb29yKHZpZGVvLmN1cnJlbnRUaW1lIC8gNjApO1xuICBsZXQgc2Vjb25kcyA9IE1hdGguZmxvb3IodmlkZW8uY3VycmVudFRpbWUgLSBtaW51dGVzICogNjApO1xuICBpZiAoc2Vjb25kcyA8IDEwKVxuICAgIHNlY29uZHMgPSBcIjBcIiArIHNlY29uZHM7XG4gIHRpbWVyVmlkZW8uaW5uZXJIVE1MID0gbWludXRlcyArIFwiOlwiICsgc2Vjb25kcyArIFwiL1wiICsgdmlkZW9EdXJhdGlvbjtcbn0iXX0=