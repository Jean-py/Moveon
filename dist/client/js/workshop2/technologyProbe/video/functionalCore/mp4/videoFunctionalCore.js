"use strict";

var speedrate = 1;
// Buttons
var playButton = document.getElementById("play-pause");
var muteButton = document.getElementById("mute");
// Sliders
var knobMin = document.getElementById("range-slider_handle-min");
var rangeSliderTrack = document.getElementById("rangeSliderTrack");

var divCardBoard = document.getElementById("divCardBoard");
var body = document.getElementsByTagName("BODY")[0];

//Je ne saiss pas comment rendre cette ligne automatique pour l'isntant, pourtant la taille est en auto...
var WIDTH_RANGE_SLIDER_TRACK = "960px";
//Donc pour l'instant je reste comme Ã§a
if (rangeSliderTrack != null) rangeSliderTrack.style.width = WIDTH_RANGE_SLIDER_TRACK;

var isPlayingCard = false;

var mirrored = false;

var commands = [];
/**
 * Access point to the functional core, you can just execute command from here
 * @return {{execute: execute}}
 * @constructor
 */
var VideoFunctionalCoreManager = function VideoFunctionalCoreManager() {
  //This is a command pattern, see : https://www.dofactory.com/javascript/command-design-pattern
  return {
    //execute a command
    execute: function execute(command) {
      switch (command.execute.name) {
        case "repetPartOfVideo":
          {
            command.execute(command.start, command.end, command.numberOfRepetition, command.speedRate);
            break;
          }
        case "updateKnobAndVideoComputer":
          command.execute(command.e);
          break;
        default:
          command.execute();
          break;
      }
      //We send the command to the server (the server log it into a file, see ./src/server/ServerLogger)
      logger.sendAndLogCommand(command);
      //and we save the command created
      commands.push(command);
    }
    //We did not implemented undo redo for this manager, because undo play pause is kind of useless right?
  };
};

//On load of the page
window.addEventListener("load", function () {
  //The size of the controller is the same than the size of the video
  setTimeout(function () {
    // This hides the address bar:
    //console.log(videovjs);
    //videovjs.load();
    window.scrollTo(0, 1);

    var ua = navigator.userAgent.toLowerCase();
    if (ua.indexOf('safari') != -1) {
      if (ua.indexOf('chrome') > -1) {} else {
        video_current.load();
      }
    }
  }, 0);
});
window.addEventListener("scroll", function (event) {
  topWindow = this.scrollY;
  leftWindow = this.scrollX;
  // console.log("window scroll : " + leftWindow);
}, false);

body.addEventListener("scroll", function (event) {
  topBody = this.scrollY;
  leftBody = this.scrollX;
  //console.log(" body : "+  body.scrollLeft  );
}, false);

/**
 * Callback used *
 *-------------------------------
 * DO NOT USE THESE FUNCTIONS WITHOUT A COMMAND!
 * The following code should be considered as private
/*------------------------------- */

var muteButtonCallback = function muteButtonCallback(e) {
  if (video_current.muted === false) {
    // Mute the video
    video_current.muted = true;
    // Update the button text
    muteButton.innerHTML = "Unmute";
  } else {
    // Unmute the video
    video_current.muted = false;
    // Update the button text
    muteButton.innerHTML = "Mute";
  }
};

var repetPartOfVideo = function repetPartOfVideo(start, end, numberOfRepetition, speedRate) {
  // console.log("function  - repetPartOfVideo" , start,end, numberOfRepetition,speedRate);
  isPlayingCard = true;
  // faster speed initially
  video_current.playbackRate(speedRate);
  video_current.currentTime(start);

  // video_current.playbackRate(speedRate);


  //video_current.playbackRate( speedRate);

  var repet = numberOfRepetition;

  //console.log("function  - repetPartOfVideo [play part] l87 videoCommand");
  play();
  video_current.ontimeupdate = function () {
    if (isPlayingCard) {
      if (end > start && repet > 0) {
        if (video_current.currentTime > end) {
          repet--;
          video_current.currentTime = start;
        }
      } else {
        video_current.ontimeupdate = null;
        feedbackOnSliderVideo(false);
        video_current.playbackRate(1);
      }
    }
  };
};

function clearAllTimer() {
  window.clearInterval(timerRepetition);
  isPlayingCard = false;
  video_current.playbackRate(1);
  //feedbackOnSliderVideo(false);
}

var play = function play() {
  video_current.play();
};

var pause = function pause() {
  //console.log("appesl a pause");
  video_current.pause();
};

var seekTo = function seekTo(startDurationParam) {
  if (startDurationParam < video_current.currentTime) video_current.currentTime = startDurationParam;
};

var playPausecallback = function playPausecallback(e) {
  //console.log("callback play-pause, e : " + e);
  /*if(e != null && e !== undefined){
    e.preventDefault();
  }*/
  //if (video_current.paused || video_current.ended ) {

  if (video_current.paused()) {
    videoFunctionalCoreManager.execute(new PlayCommand());
  } else {
    videoFunctionalCoreManager.execute(new PauseCommand());
  }
};

var mirror = function mirror() {
  if (mirrored) {

    document.getElementsByClassName("vjs-tech")[0].style.transform = "rotateY(" + 0 + "deg)";
    mirrored = false;
  } else {
    document.getElementsByClassName("vjs-tech")[0].style.transform = "rotateY(" + 180 + "deg)";

    video_current.style = 'rotateY(' + 180 + 'deg)';
    mirrored = true;
  }
};

var setSource = function setSource(source) {
  video_current.src = source;
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInZpZGVvRnVuY3Rpb25hbENvcmUuanMiXSwibmFtZXMiOlsic3BlZWRyYXRlIiwicGxheUJ1dHRvbiIsImRvY3VtZW50IiwiZ2V0RWxlbWVudEJ5SWQiLCJtdXRlQnV0dG9uIiwia25vYk1pbiIsInJhbmdlU2xpZGVyVHJhY2siLCJkaXZDYXJkQm9hcmQiLCJib2R5IiwiZ2V0RWxlbWVudHNCeVRhZ05hbWUiLCJXSURUSF9SQU5HRV9TTElERVJfVFJBQ0siLCJzdHlsZSIsIndpZHRoIiwiaXNQbGF5aW5nQ2FyZCIsIm1pcnJvcmVkIiwiY29tbWFuZHMiLCJWaWRlb0Z1bmN0aW9uYWxDb3JlTWFuYWdlciIsImV4ZWN1dGUiLCJjb21tYW5kIiwibmFtZSIsInN0YXJ0IiwiZW5kIiwibnVtYmVyT2ZSZXBldGl0aW9uIiwic3BlZWRSYXRlIiwiZSIsImxvZ2dlciIsInNlbmRBbmRMb2dDb21tYW5kIiwicHVzaCIsIndpbmRvdyIsImFkZEV2ZW50TGlzdGVuZXIiLCJzZXRUaW1lb3V0Iiwic2Nyb2xsVG8iLCJ1YSIsIm5hdmlnYXRvciIsInVzZXJBZ2VudCIsInRvTG93ZXJDYXNlIiwiaW5kZXhPZiIsInZpZGVvX2N1cnJlbnQiLCJsb2FkIiwiZXZlbnQiLCJ0b3BXaW5kb3ciLCJzY3JvbGxZIiwibGVmdFdpbmRvdyIsInNjcm9sbFgiLCJ0b3BCb2R5IiwibGVmdEJvZHkiLCJtdXRlQnV0dG9uQ2FsbGJhY2siLCJtdXRlZCIsImlubmVySFRNTCIsInJlcGV0UGFydE9mVmlkZW8iLCJwbGF5YmFja1JhdGUiLCJjdXJyZW50VGltZSIsInJlcGV0IiwicGxheSIsIm9udGltZXVwZGF0ZSIsImZlZWRiYWNrT25TbGlkZXJWaWRlbyIsImNsZWFyQWxsVGltZXIiLCJjbGVhckludGVydmFsIiwidGltZXJSZXBldGl0aW9uIiwicGF1c2UiLCJzZWVrVG8iLCJzdGFydER1cmF0aW9uUGFyYW0iLCJwbGF5UGF1c2VjYWxsYmFjayIsInBhdXNlZCIsInZpZGVvRnVuY3Rpb25hbENvcmVNYW5hZ2VyIiwiUGxheUNvbW1hbmQiLCJQYXVzZUNvbW1hbmQiLCJtaXJyb3IiLCJnZXRFbGVtZW50c0J5Q2xhc3NOYW1lIiwidHJhbnNmb3JtIiwic2V0U291cmNlIiwic291cmNlIiwic3JjIl0sIm1hcHBpbmdzIjoiOztBQUNBLElBQUlBLFlBQVksQ0FBaEI7QUFDQTtBQUNBLElBQUlDLGFBQWFDLFNBQVNDLGNBQVQsQ0FBd0IsWUFBeEIsQ0FBakI7QUFDQSxJQUFJQyxhQUFhRixTQUFTQyxjQUFULENBQXdCLE1BQXhCLENBQWpCO0FBQ0E7QUFDQSxJQUFJRSxVQUFVSCxTQUFTQyxjQUFULENBQXdCLHlCQUF4QixDQUFkO0FBQ0EsSUFBSUcsbUJBQW1CSixTQUFTQyxjQUFULENBQXdCLGtCQUF4QixDQUF2Qjs7QUFFQSxJQUFJSSxlQUFlTCxTQUFTQyxjQUFULENBQXdCLGNBQXhCLENBQW5CO0FBQ0EsSUFBSUssT0FBT04sU0FBU08sb0JBQVQsQ0FBOEIsTUFBOUIsRUFBc0MsQ0FBdEMsQ0FBWDs7QUFFQTtBQUNBLElBQUlDLDJCQUEyQixPQUEvQjtBQUNBO0FBQ0EsSUFBR0osb0JBQW9CLElBQXZCLEVBQ0VBLGlCQUFpQkssS0FBakIsQ0FBdUJDLEtBQXZCLEdBQStCRix3QkFBL0I7O0FBRUYsSUFBSUcsZ0JBQWdCLEtBQXBCOztBQUVBLElBQUlDLFdBQVcsS0FBZjs7QUFFQSxJQUFJQyxXQUFXLEVBQWY7QUFDQTs7Ozs7QUFLQSxJQUFJQyw2QkFBNkIsU0FBN0JBLDBCQUE2QixHQUFXO0FBQzFDO0FBQ0EsU0FBTztBQUNMO0FBQ0FDLGFBQVMsaUJBQVNDLE9BQVQsRUFBa0I7QUFDekIsY0FBUUEsUUFBUUQsT0FBUixDQUFnQkUsSUFBeEI7QUFDRSxhQUFLLGtCQUFMO0FBQTBCO0FBQ3hCRCxvQkFBUUQsT0FBUixDQUFnQkMsUUFBUUUsS0FBeEIsRUFBOEJGLFFBQVFHLEdBQXRDLEVBQTBDSCxRQUFRSSxrQkFBbEQsRUFBcUVKLFFBQVFLLFNBQTdFO0FBQ0E7QUFDRDtBQUNELGFBQUss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bmFsQ29yZS5qcyIsInNvdXJjZXNDb250ZW50IjpbIlxudmFyIHNwZWVkcmF0ZSA9IDE7XG4vLyBCdXR0b25zXG52YXIgcGxheUJ1dHRvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwicGxheS1wYXVzZVwiKTtcbnZhciBtdXRlQnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJtdXRlXCIpO1xuLy8gU2xpZGVyc1xudmFyIGtub2JNaW4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInJhbmdlLXNsaWRlcl9oYW5kbGUtbWluXCIpO1xudmFyIHJhbmdlU2xpZGVyVHJhY2sgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInJhbmdlU2xpZGVyVHJhY2tcIik7XG5cbnZhciBkaXZDYXJkQm9hcmQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImRpdkNhcmRCb2FyZFwiKTtcbnZhciBib2R5ID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJCT0RZXCIpWzBdO1xuXG4vL0plIG5lIHNhaXNzIHBhcyBjb21tZW50IHJlbmRyZSBjZXR0ZSBsaWduZSBhdXRvbWF0aXF1ZSBwb3VyIGwnaXNudGFudCwgcG91cnRhbnQgbGEgdGFpbGxlIGVzdCBlbiBhdXRvLi4uXG52YXIgV0lEVEhfUkFOR0VfU0xJREVSX1RSQUNLID0gXCI5NjBweFwiO1xuLy9Eb25jIHBvdXIgbCdpbnN0YW50IGplIHJlc3RlIGNvbW1lIMOnYVxuaWYocmFuZ2VTbGlkZXJUcmFjayAhPSBudWxsKVxuICByYW5nZVNsaWRlclRyYWNrLnN0eWxlLndpZHRoID0gV0lEVEhfUkFOR0VfU0xJREVSX1RSQUNLO1xuXG52YXIgaXNQbGF5aW5nQ2FyZCA9IGZhbHNlO1xuXG52YXIgbWlycm9yZWQgPSBmYWxzZTtcblxudmFyIGNvbW1hbmRzID0gW107XG4vKipcbiAqIEFjY2VzcyBwb2ludCB0byB0aGUgZnVuY3Rpb25hbCBjb3JlLCB5b3UgY2FuIGp1c3QgZXhlY3V0ZSBjb21tYW5kIGZyb20gaGVyZVxuICogQHJldHVybiB7e2V4ZWN1dGU6IGV4ZWN1dGV9fVxuICogQGNvbnN0cnVjdG9yXG4gKi9cbnZhciBWaWRlb0Z1bmN0aW9uYWxDb3JlTWFuYWdlciA9IGZ1bmN0aW9uKCkge1xuICAvL1RoaXMgaXMgYSBjb21tYW5kIHBhdHRlcm4sIHNlZSA6IGh0dHBzOi8vd3d3LmRvZmFjdG9yeS5jb20vamF2YXNjcmlwdC9jb21tYW5kLWRlc2lnbi1wYXR0ZXJuXG4gIHJldHVybiB7XG4gICAgLy9leGVjdXRlIGEgY29tbWFuZFxuICAgIGV4ZWN1dGU6IGZ1bmN0aW9uKGNvbW1hbmQpIHtcbiAgICAgIHN3aXRjaCAoY29tbWFuZC5leGVjdXRlLm5hbWUpe1xuICAgICAgICBjYXNlIFwicmVwZXRQYXJ0T2ZWaWRlb1wiIDoge1xuICAgICAgICAgIGNvbW1hbmQuZXhlY3V0ZShjb21tYW5kLnN0YXJ0LGNvbW1hbmQuZW5kLGNvbW1hbmQubnVtYmVyT2ZSZXBldGl0aW9uLGNvbW1hbmQuc3BlZWRSYXRlKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBjYXNlIFwidXBkYXRlS25vYkFuZFZpZGVvQ29tcHV0ZXJcIiA6XG4gICAgICAgICAgY29tbWFuZC5leGVjdXRlKGNvbW1hbmQuZSk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgY29tbWFuZC5leGVjdXRlKCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICAvL1dlIHNlbmQgdGhlIGNvbW1hbmQgdG8gdGhlIHNlcnZlciAodGhlIHNlcnZlciBsb2cgaXQgaW50byBhIGZpbGUsIHNlZSAuL3NyYy9zZXJ2ZXIvU2VydmVyTG9nZ2VyKVxuICAgICAgbG9nZ2VyLnNlbmRBbmRMb2dDb21tYW5kKGNvbW1hbmQpO1xuICAgICAgLy9hbmQgd2Ugc2F2ZSB0aGUgY29tbWFuZCBjcmVhdGVkXG4gICAgICBjb21tYW5kcy5wdXNoKGNvbW1hbmQpO1xuICAgIH1cbiAgICAvL1dlIGRpZCBub3QgaW1wbGVtZW50ZWQgdW5kbyByZWRvIGZvciB0aGlzIG1hbmFnZXIsIGJlY2F1c2UgdW5kbyBwbGF5IHBhdXNlIGlzIGtpbmQgb2YgdXNlbGVzcyByaWdodD9cbiAgfVxufTtcblxuXG4vL09uIGxvYWQgb2YgdGhlIHBhZ2VcbndpbmRvdy5hZGRFdmVudExpc3RlbmVyKFwibG9hZFwiLGZ1bmN0aW9uKCkge1xuICAvL1RoZSBzaXplIG9mIHRoZSBjb250cm9sbGVyIGlzIHRoZSBzYW1lIHRoYW4gdGhlIHNpemUgb2YgdGhlIHZpZGVvXG4gIHNldFRpbWVvdXQoZnVuY3Rpb24oKXtcbiAgICAvLyBUaGlzIGhpZGVzIHRoZSBhZGRyZXNzIGJhcjpcbiAgICAvL2NvbnNvbGUubG9nKHZpZGVvdmpzKTtcbiAgICAvL3ZpZGVvdmpzLmxvYWQoKTtcbiAgICB3aW5kb3cuc2Nyb2xsVG8oMCwgMSk7XG4gICAgXG4gICAgdmFyIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpO1xuICAgIGlmICh1YS5pbmRleE9mKCdzYWZhcmknKSAhPSAtMSkge1xuICAgICAgaWYgKHVhLmluZGV4T2YoJ2Nocm9tZScpID4gLTEpIHtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHZpZGVvX2N1cnJlbnQubG9hZCgpO1xuICAgICAgICBcbiAgICAgIH1cbiAgICB9XG4gIH0sIDApO1xufSk7XG53aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihcInNjcm9sbFwiLCBmdW5jdGlvbihldmVudCkge1xuICB0b3BXaW5kb3cgPSB0aGlzLnNjcm9sbFk7XG4gIGxlZnRXaW5kb3cgPXRoaXMuc2Nyb2xsWDtcbiAgLy8gY29uc29sZS5sb2coXCJ3aW5kb3cgc2Nyb2xsIDogXCIgKyBsZWZ0V2luZG93KTtcbn0sIGZhbHNlKTtcblxuYm9keS5hZGRFdmVudExpc3RlbmVyKFwic2Nyb2xsXCIsIGZ1bmN0aW9uKGV2ZW50KSB7XG4gIHRvcEJvZHkgPSAgdGhpcy5zY3JvbGxZO1xuICBsZWZ0Qm9keSA9IHRoaXMuc2Nyb2xsWDtcbiAgLy9jb25zb2xlLmxvZyhcIiBib2R5IDogXCIrICBib2R5LnNjcm9sbExlZnQgICk7XG59LCBmYWxzZSk7XG5cblxuLyoqXG4gKiBDYWxsYmFjayB1c2VkICpcbiAqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICogRE8gTk9UIFVTRSBUSEVTRSBGVU5DVElPTlMgV0lUSE9VVCBBIENPTU1BTkQhXG4gKiBUaGUgZm9sbG93aW5nIGNvZGUgc2hvdWxkIGJlIGNvbnNpZGVyZWQgYXMgcHJpdmF0ZVxuLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovXG5cbnZhciBtdXRlQnV0dG9uQ2FsbGJhY2sgPSBmdW5jdGlvbihlKXtcbiAgaWYgKHZpZGVvX2N1cnJlbnQubXV0ZWQgPT09IGZhbHNlKSB7XG4gICAgLy8gTXV0ZSB0aGUgdmlkZW9cbiAgICB2aWRlb19jdXJyZW50Lm11dGVkID0gdHJ1ZTtcbiAgICAvLyBVcGRhdGUgdGhlIGJ1dHRvbiB0ZXh0XG4gICAgbXV0ZUJ1dHRvbi5pbm5lckhUTUwgPSBcIlVubXV0ZVwiO1xuICB9IGVsc2Uge1xuICAgIC8vIFVubXV0ZSB0aGUgdmlkZW9cbiAgICB2aWRlb19jdXJyZW50Lm11dGVkID0gZmFsc2U7XG4gICAgLy8gVXBkYXRlIHRoZSBidXR0b24gdGV4dFxuICAgIG11dGVCdXR0b24uaW5uZXJIVE1MID0gXCJNdXRlXCI7XG4gIH1cbn07XG5cbnZhciByZXBldFBhcnRPZlZpZGVvID0gZnVuY3Rpb24gKHN0YXJ0LGVuZCwgbnVtYmVyT2ZSZXBldGl0aW9uLHNwZWVkUmF0ZSkge1xuICAvLyBjb25zb2xlLmxvZyhcImZ1bmN0aW9uICAtIHJlcGV0UGFydE9mVmlkZW9cIiAsIHN0YXJ0LGVuZCwgbnVtYmVyT2ZSZXBldGl0aW9uLHNwZWVkUmF0ZSk7XG4gIGlzUGxheWluZ0NhcmQgPSB0cnVlO1xuICAgIC8vIGZhc3RlciBzcGVlZCBpbml0aWFsbHlcbiAgICB2aWRlb19jdXJyZW50LnBsYXliYWNrUmF0ZShzcGVlZFJhdGUpO1xuICAgIHZpZGVvX2N1cnJlbnQuY3VycmVudFRpbWUoc3RhcnQpO1xuXG4gIFxuICBcbiAgIC8vIHZpZGVvX2N1cnJlbnQucGxheWJhY2tSYXRlKHNwZWVkUmF0ZSk7XG4gICBcbiAgXG4gIC8vdmlkZW9fY3VycmVudC5wbGF5YmFja1JhdGUoIHNwZWVkUmF0ZSk7XG4gXG4gIHZhciByZXBldCA9IG51bWJlck9mUmVwZXRpdGlvbjtcbiAgXG4gIC8vY29uc29sZS5sb2coXCJmdW5jdGlvbiAgLSByZXBldFBhcnRPZlZpZGVvIFtwbGF5IHBhcnRdIGw4NyB2aWRlb0NvbW1hbmRcIik7XG4gIHBsYXkoKTtcbiAgdmlkZW9fY3VycmVudC5vbnRpbWV1cGRhdGUgPSBmdW5jdGlvbigpIHtcbiAgICBpZihpc1BsYXlpbmdDYXJkKXtcbiAgICAgIGlmICgoZW5kID4gc3RhcnQgKSAmJiAgcmVwZXQgPiAwICkge1xuICAgICAgICBpZiAodmlkZW9fY3VycmVudC5jdXJyZW50VGltZSAgID4gZW5kKSB7XG4gICAgICAgICAgcmVwZXQtLTtcbiAgICAgICAgICB2aWRlb19jdXJyZW50LmN1cnJlbnRUaW1lID0gc3RhcnQ7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHZpZGVvX2N1cnJlbnQub250aW1ldXBkYXRlID0gbnVsbDtcbiAgICAgICAgZmVlZGJhY2tPblNsaWRlclZpZGVvKGZhbHNlKTtcbiAgICAgICAgdmlkZW9fY3VycmVudC5wbGF5YmFja1JhdGUoIDEpO1xuICAgICAgfVxuICAgIH1cbiAgfTtcbn07XG5cbmZ1bmN0aW9uIGNsZWFyQWxsVGltZXIoKSB7XG4gIHdpbmRvdy5jbGVhckludGVydmFsKHRpbWVyUmVwZXRpdGlvbik7XG4gIGlzUGxheWluZ0NhcmQgPSBmYWxzZTtcbiAgdmlkZW9fY3VycmVudC5wbGF5YmFja1JhdGUoIDEpO1xuICAvL2ZlZWRiYWNrT25TbGlkZXJWaWRlbyhmYWxzZSk7XG59XG5cblxudmFyIHBsYXkgPSBmdW5jdGlvbiAoKSB7XG4gIHZpZGVvX2N1cnJlbnQucGxheSgpO1xufTtcblxudmFyIHBhdXNlID0gZnVuY3Rpb24gKCkge1xuICAvL2NvbnNvbGUubG9nKFwiYXBwZXNsIGEgcGF1c2VcIik7XG4gIHZpZGVvX2N1cnJlbnQucGF1c2UoKTtcbn07XG5cbnZhciBzZWVrVG8gPSBmdW5jdGlvbihzdGFydER1cmF0aW9uUGFyYW0pe1xuICBpZihzdGFydER1cmF0aW9uUGFyYW0gPCB2aWRlb19jdXJyZW50LmN1cnJlbnRUaW1lIClcbiAgICB2aWRlb19jdXJyZW50LmN1cnJlbnRUaW1lID0gc3RhcnREdXJhdGlvblBhcmFtO1xufTtcblxudmFyIHBsYXlQYXVzZWNhbGxiYWNrID0gZnVuY3Rpb24oZSl7XG4gIC8vY29uc29sZS5sb2coXCJjYWxsYmFjayBwbGF5LXBhdXNlLCBlIDogXCIgKyBlKTtcbiAgLyppZihlICE9IG51bGwgJiYgZSAhPT0gdW5kZWZpbmVkKXtcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gIH0qL1xuICAvL2lmICh2aWRlb19jdXJyZW50LnBhdXNlZCB8fCB2aWRlb19jdXJyZW50LmVuZGVkICkge1xuICBcbiAgICBpZiAodmlkZW9fY3VycmVudC5wYXVzZWQoKSkge1xuICAgICB2aWRlb0Z1bmN0aW9uYWxDb3JlTWFuYWdlci5leGVjdXRlKG5ldyBQbGF5Q29tbWFuZCgpKTtcbiAgICB9IGVsc2Uge1xuICAgIHZpZGVvRnVuY3Rpb25hbENvcmVNYW5hZ2VyLmV4ZWN1dGUobmV3IFBhdXNlQ29tbWFuZCgpKTtcbiAgfVxufTtcblxudmFyIG1pcnJvciA9IGZ1bmN0aW9uICgpIHtcbiAgaWYobWlycm9yZWQpe1xuICAgIFxuICAgIGRvY3VtZW50LmdldEVsZW1lbnRzQnlDbGFzc05hbWUoXCJ2anMtdGVjaFwiKVswXS5zdHlsZS50cmFuc2Zvcm0gPSBcInJvdGF0ZVkoXCIrIDAgK1wiZGVnKVwiO1xuICAgIG1pcnJvcmVkID0gZmFsc2U7XG4gIH0gZWxzZSB7XG4gICAgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShcInZqcy10ZWNoXCIpWzBdLnN0eWxlLnRyYW5zZm9ybSA9IFwicm90YXRlWShcIisgMTgwICtcImRlZylcIjtcbiAgXG4gICAgdmlkZW9fY3VycmVudC5zdHlsZSA9ICdyb3RhdGVZKCcrIDE4MCArJ2RlZyknO1xuICAgIG1pcnJvcmVkID0gdHJ1ZTtcbiAgfVxufTtcblxudmFyIHNldFNvdXJjZSA9IGZ1bmN0aW9uKHNvdXJjZSl7XG4gIHZpZGVvX2N1cnJlbnQuc3JjID0gc291cmNlO1xufTtcblxuXG4iXX0=