"use strict";

var speedrate = 1;
// Buttons
var playButton = document.getElementById("play-pause");
var muteButton = document.getElementById("mute");
// Sliders
var knobMin = document.getElementById("range-slider_handle-min");
var rangeSliderTrack = document.getElementById("rangeSliderTrack");

var divCardBoard = document.getElementById("divCardBoard");
var body = document.getElementsByTagName("BODY")[0];

//Je ne saiss pas comment rendre cette ligne automatique pour l'isntant, pourtant la taille est en auto...
var WIDTH_RANGE_SLIDER_TRACK = "960px";
//Donc pour l'instant je reste comme Ã§a
if (rangeSliderTrack != null) rangeSliderTrack.style.width = WIDTH_RANGE_SLIDER_TRACK;

var isPlayingCard = false;

var mirrored = false;

var commands = [];
/**
 * Access point to the functional core, you can just execute command from here
 * @return {{execute: execute}}
 * @constructor
 */
var VideoFunctionalCoreManager = function VideoFunctionalCoreManager() {
  //This is a command pattern, see : https://www.dofactory.com/javascript/command-design-pattern
  return {
    //execute a command
    execute: function execute(command) {
      switch (command.execute.name) {
        case "repetPartOfVideo":
          {
            command.execute(command.start, command.end, command.numberOfRepetition, command.speedRate);
            break;
          }
        case "updateKnobAndVideoComputer":
          command.execute(command.e);
          break;
        default:
          command.execute();
          break;
      }
      //We send the command to the server (the server log it into a file, see ./src/server/ServerLogger)
      logger.sendAndLogCommand(command);
      //and we save the command created
      commands.push(command);
    }
    //We did not implemented undo redo for this manager, because undo play pause is kind of useless right?
  };
};

//On load of the page
window.addEventListener("load", function () {
  //The size of the controller is the same than the size of the video
  setTimeout(function () {
    // This hides the address bar:
    //console.log(videovjs);
    //videovjs.load();
    window.scrollTo(0, 1);

    var ua = navigator.userAgent.toLowerCase();
    if (ua.indexOf('safari') != -1) {
      if (ua.indexOf('chrome') > -1) {} else {
        video_current.load();
      }
    }
  }, 0);
});
window.addEventListener("scroll", function (event) {
  topWindow = this.scrollY;
  leftWindow = this.scrollX;
  // console.log("window scroll : " + leftWindow);
}, false);

body.addEventListener("scroll", function (event) {
  topBody = this.scrollY;
  leftBody = this.scrollX;
  //console.log(" body : "+  body.scrollLeft  );
}, false);

/**
 * Callback used *
 *-------------------------------
 * DO NOT USE THESE FUNCTIONS WITHOUT A COMMAND!
 * The following code should be considered as private
/*------------------------------- */

var muteButtonCallback = function muteButtonCallback(e) {
  if (video_current.muted === false) {
    // Mute the video
    video_current.muted = true;
    // Update the button text
    muteButton.innerHTML = "Unmute";
  } else {
    // Unmute the video
    video_current.muted = false;
    // Update the button text
    muteButton.innerHTML = "Mute";
  }
};

var repetPartOfVideo = function repetPartOfVideo(start, end, numberOfRepetition, speedRate) {
  // console.log("function  - repetPartOfVideo" , start,end, numberOfRepetition,speedRate);
  isPlayingCard = true;
  // faster speed initially
  video_current.playbackRate(speedRate);
  video_current.currentTime(start);

  var repet = numberOfRepetition;

  //console.log("function  - repetPartOfVideo [play part] l87 videoCommand");
  play();
  video_current.ontimeupdate = function () {
    if (isPlayingCard) {
      if (end > start && repet > 0) {
        if (video_current.currentTime() > end) {
          repet--;
          video_current.currentTime(start);
        }
      } else {
        video_current.ontimeupdate = null;
        feedbackOnSliderVideo(false);
        video_current.playbackRate(1);
      }
    }
  };
};

function clearAllTimer() {
  window.clearInterval(timerRepetition);
  isPlayingCard = false;
  video_current.playbackRate(1);
  //feedbackOnSliderVideo(false);
}

var play = function play() {
  video_current.play();
};

var pause = function pause() {
  //console.log("appesl a pause");
  video_current.pause();
};

var seekTo = function seekTo(startDurationParam) {
  if (startDurationParam < video_current.currentTime()) video_current.currentTime(startDurationParam);
};

var playPausecallback = function playPausecallback(e) {
  //console.log("callback play-pause, e : " + e);
  /*if(e != null && e !== undefined){
    e.preventDefault();
  }*/
  //if (video_current.paused || video_current.ended ) {

  if (video_current.paused()) {
    videoFunctionalCoreManager.execute(new PlayCommand());
  } else {
    videoFunctionalCoreManager.execute(new PauseCommand());
  }
};

var mirror = function mirror() {
  if (mirrored) {

    document.getElementsByClassName("vjs-tech")[0].style.transform = "rotateY(" + 0 + "deg)";
    mirrored = false;
  } else {
    document.getElementsByClassName("vjs-tech")[0].style.transform = "rotateY(" + 180 + "deg)";

    video_current.style = 'rotateY(' + 180 + 'deg)';
    mirrored = true;
  }
};

var setSource = function setSource(source) {
  video_current.src = source;
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInZpZGVvRnVuY3Rpb25hbENvcmUuanMiXSwibmFtZXMiOlsic3BlZWRyYXRlIiwicGxheUJ1dHRvbiIsImRvY3VtZW50IiwiZ2V0RWxlbWVudEJ5SWQiLCJtdXRlQnV0dG9uIiwia25vYk1pbiIsInJhbmdlU2xpZGVyVHJhY2siLCJkaXZDYXJkQm9hcmQiLCJib2R5IiwiZ2V0RWxlbWVudHNCeVRhZ05hbWUiLCJXSURUSF9SQU5HRV9TTElERVJfVFJBQ0siLCJzdHlsZSIsIndpZHRoIiwiaXNQbGF5aW5nQ2FyZCIsIm1pcnJvcmVkIiwiY29tbWFuZHMiLCJWaWRlb0Z1bmN0aW9uYWxDb3JlTWFuYWdlciIsImV4ZWN1dGUiLCJjb21tYW5kIiwibmFtZSIsInN0YXJ0IiwiZW5kIiwibnVtYmVyT2ZSZXBldGl0aW9uIiwic3BlZWRSYXRlIiwiZSIsImxvZ2dlciIsInNlbmRBbmRMb2dDb21tYW5kIiwicHVzaCIsIndpbmRvdyIsImFkZEV2ZW50TGlzdGVuZXIiLCJzZXRUaW1lb3V0Iiwic2Nyb2xsVG8iLCJ1YSIsIm5hdmlnYXRvciIsInVzZXJBZ2VudCIsInRvTG93ZXJDYXNlIiwiaW5kZXhPZiIsInZpZGVvX2N1cnJlbnQiLCJsb2FkIiwiZXZlbnQiLCJ0b3BXaW5kb3ciLCJzY3JvbGxZIiwibGVmdFdpbmRvdyIsInNjcm9sbFgiLCJ0b3BCb2R5IiwibGVmdEJvZHkiLCJtdXRlQnV0dG9uQ2FsbGJhY2siLCJtdXRlZCIsImlubmVySFRNTCIsInJlcGV0UGFydE9mVmlkZW8iLCJwbGF5YmFja1JhdGUiLCJjdXJyZW50VGltZSIsInJlcGV0IiwicGxheSIsIm9udGltZXVwZGF0ZSIsImZlZWRiYWNrT25TbGlkZXJWaWRlbyIsImNsZWFyQWxsVGltZXIiLCJjbGVhckludGVydmFsIiwidGltZXJSZXBldGl0aW9uIiwicGF1c2UiLCJzZWVrVG8iLCJzdGFydER1cmF0aW9uUGFyYW0iLCJwbGF5UGF1c2VjYWxsYmFjayIsInBhdXNlZCIsInZpZGVvRnVuY3Rpb25hbENvcmVNYW5hZ2VyIiwiUGxheUNvbW1hbmQiLCJQYXVzZUNvbW1hbmQiLCJtaXJyb3IiLCJnZXRFbGVtZW50c0J5Q2xhc3NOYW1lIiwidHJhbnNmb3JtIiwic2V0U291cmNlIiwic291cmNlIiwic3JjIl0sIm1hcHBpbmdzIjoiOztBQUNBLElBQUlBLFlBQVksQ0FBaEI7QUFDQTtBQUNBLElBQUlDLGFBQWFDLFNBQVNDLGNBQVQsQ0FBd0IsWUFBeEIsQ0FBakI7QUFDQSxJQUFJQyxhQUFhRixTQUFTQyxjQUFULENBQXdCLE1BQXhCLENBQWpCO0FBQ0E7QUFDQSxJQUFJRSxVQUFVSCxTQUFTQyxjQUFULENBQXdCLHlCQUF4QixDQUFkO0FBQ0EsSUFBSUcsbUJBQW1CSixTQUFTQyxjQUFULENBQXdCLGtCQUF4QixDQUF2Qjs7QUFFQSxJQUFJSSxlQUFlTCxTQUFTQyxjQUFULENBQXdCLGNBQXhCLENBQW5CO0FBQ0EsSUFBSUssT0FBT04sU0FBU08sb0JBQVQsQ0FBOEIsTUFBOUIsRUFBc0MsQ0FBdEMsQ0FBWDs7QUFFQTtBQUNBLElBQUlDLDJCQUEyQixPQUEvQjtBQUNBO0FBQ0EsSUFBR0osb0JBQW9CLElBQXZCLEVBQ0VBLGlCQUFpQkssS0FBakIsQ0FBdUJDLEtBQXZCLEdBQStCRix3QkFBL0I7O0FBRUYsSUFBSUcsZ0JBQWdCLEtBQXBCOztBQUVBLElBQUlDLFdBQVcsS0FBZjs7QUFFQSxJQUFJQyxXQUFXLEVBQWY7QUFDQTs7Ozs7QUFLQSxJQUFJQyw2QkFBNkIsU0FBN0JBLDBCQUE2QixHQUFXO0FBQzFDO0FBQ0EsU0FBTztBQUNMO0FBQ0FDLGFBQVMsaUJBQVNDLE9BQVQsRUFBa0I7QUFDekIsY0FBUUEsUUFBUUQsT0FBUixDQUFnQkUsSUFBeEI7QUFDRSxhQUFLLGtCQUFMO0FBQTBCO0FBQ3hCRCxvQkFBUUQsT0FBUixDQUFnQkMsUUFBUUUsS0FBeEIsRUFBOEJGLFFBQVFHLEdBQXRDLEVBQTBDSCxRQUFRSSxrQkFBbEQsRUFBcUVKLFFBQVFLLFNBQTdFO0FBQ0E7QUFDRDtBQUNELGFBQUss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anMiLCJzb3VyY2VzQ29udGVudCI6WyJcbnZhciBzcGVlZHJhdGUgPSAxO1xuLy8gQnV0dG9uc1xudmFyIHBsYXlCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInBsYXktcGF1c2VcIik7XG52YXIgbXV0ZUJ1dHRvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwibXV0ZVwiKTtcbi8vIFNsaWRlcnNcbnZhciBrbm9iTWluID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJyYW5nZS1zbGlkZXJfaGFuZGxlLW1pblwiKTtcbnZhciByYW5nZVNsaWRlclRyYWNrID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJyYW5nZVNsaWRlclRyYWNrXCIpO1xuXG52YXIgZGl2Q2FyZEJvYXJkID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJkaXZDYXJkQm9hcmRcIik7XG52YXIgYm9keSA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKFwiQk9EWVwiKVswXTtcblxuLy9KZSBuZSBzYWlzcyBwYXMgY29tbWVudCByZW5kcmUgY2V0dGUgbGlnbmUgYXV0b21hdGlxdWUgcG91ciBsJ2lzbnRhbnQsIHBvdXJ0YW50IGxhIHRhaWxsZSBlc3QgZW4gYXV0by4uLlxudmFyIFdJRFRIX1JBTkdFX1NMSURFUl9UUkFDSyA9IFwiOTYwcHhcIjtcbi8vRG9uYyBwb3VyIGwnaW5zdGFudCBqZSByZXN0ZSBjb21tZSDDp2FcbmlmKHJhbmdlU2xpZGVyVHJhY2sgIT0gbnVsbClcbiAgcmFuZ2VTbGlkZXJUcmFjay5zdHlsZS53aWR0aCA9IFdJRFRIX1JBTkdFX1NMSURFUl9UUkFDSztcblxudmFyIGlzUGxheWluZ0NhcmQgPSBmYWxzZTtcblxudmFyIG1pcnJvcmVkID0gZmFsc2U7XG5cbnZhciBjb21tYW5kcyA9IFtdO1xuLyoqXG4gKiBBY2Nlc3MgcG9pbnQgdG8gdGhlIGZ1bmN0aW9uYWwgY29yZSwgeW91IGNhbiBqdXN0IGV4ZWN1dGUgY29tbWFuZCBmcm9tIGhlcmVcbiAqIEByZXR1cm4ge3tleGVjdXRlOiBleGVjdXRlfX1cbiAqIEBjb25zdHJ1Y3RvclxuICovXG52YXIgVmlkZW9GdW5jdGlvbmFsQ29yZU1hbmFnZXIgPSBmdW5jdGlvbigpIHtcbiAgLy9UaGlzIGlzIGEgY29tbWFuZCBwYXR0ZXJuLCBzZWUgOiBodHRwczovL3d3dy5kb2ZhY3RvcnkuY29tL2phdmFzY3JpcHQvY29tbWFuZC1kZXNpZ24tcGF0dGVyblxuICByZXR1cm4ge1xuICAgIC8vZXhlY3V0ZSBhIGNvbW1hbmRcbiAgICBleGVjdXRlOiBmdW5jdGlvbihjb21tYW5kKSB7XG4gICAgICBzd2l0Y2ggKGNvbW1hbmQuZXhlY3V0ZS5uYW1lKXtcbiAgICAgICAgY2FzZSBcInJlcGV0UGFydE9mVmlkZW9cIiA6IHtcbiAgICAgICAgICBjb21tYW5kLmV4ZWN1dGUoY29tbWFuZC5zdGFydCxjb21tYW5kLmVuZCxjb21tYW5kLm51bWJlck9mUmVwZXRpdGlvbixjb21tYW5kLnNwZWVkUmF0ZSk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgY2FzZSBcInVwZGF0ZUtub2JBbmRWaWRlb0NvbXB1dGVyXCIgOlxuICAgICAgICAgIGNvbW1hbmQuZXhlY3V0ZShjb21tYW5kLmUpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgIGNvbW1hbmQuZXhlY3V0ZSgpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgICAgLy9XZSBzZW5kIHRoZSBjb21tYW5kIHRvIHRoZSBzZXJ2ZXIgKHRoZSBzZXJ2ZXIgbG9nIGl0IGludG8gYSBmaWxlLCBzZWUgLi9zcmMvc2VydmVyL1NlcnZlckxvZ2dlcilcbiAgICAgIGxvZ2dlci5zZW5kQW5kTG9nQ29tbWFuZChjb21tYW5kKTtcbiAgICAgIC8vYW5kIHdlIHNhdmUgdGhlIGNvbW1hbmQgY3JlYXRlZFxuICAgICAgY29tbWFuZHMucHVzaChjb21tYW5kKTtcbiAgICB9XG4gICAgLy9XZSBkaWQgbm90IGltcGxlbWVudGVkIHVuZG8gcmVkbyBmb3IgdGhpcyBtYW5hZ2VyLCBiZWNhdXNlIHVuZG8gcGxheSBwYXVzZSBpcyBraW5kIG9mIHVzZWxlc3MgcmlnaHQ/XG4gIH1cbn07XG5cblxuLy9PbiBsb2FkIG9mIHRoZSBwYWdlXG53aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihcImxvYWRcIixmdW5jdGlvbigpIHtcbiAgLy9UaGUgc2l6ZSBvZiB0aGUgY29udHJvbGxlciBpcyB0aGUgc2FtZSB0aGFuIHRoZSBzaXplIG9mIHRoZSB2aWRlb1xuICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7XG4gICAgLy8gVGhpcyBoaWRlcyB0aGUgYWRkcmVzcyBiYXI6XG4gICAgLy9jb25zb2xlLmxvZyh2aWRlb3Zqcyk7XG4gICAgLy92aWRlb3Zqcy5sb2FkKCk7XG4gICAgd2luZG93LnNjcm9sbFRvKDAsIDEpO1xuICAgIFxuICAgIHZhciB1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKTtcbiAgICBpZiAodWEuaW5kZXhPZignc2FmYXJpJykgIT0gLTEpIHtcbiAgICAgIGlmICh1YS5pbmRleE9mKCdjaHJvbWUnKSA+IC0xKSB7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB2aWRlb19jdXJyZW50LmxvYWQoKTtcbiAgICAgICAgXG4gICAgICB9XG4gICAgfVxuICB9LCAwKTtcbn0pO1xud2luZG93LmFkZEV2ZW50TGlzdGVuZXIoXCJzY3JvbGxcIiwgZnVuY3Rpb24oZXZlbnQpIHtcbiAgdG9wV2luZG93ID0gdGhpcy5zY3JvbGxZO1xuICBsZWZ0V2luZG93ID10aGlzLnNjcm9sbFg7XG4gIC8vIGNvbnNvbGUubG9nKFwid2luZG93IHNjcm9sbCA6IFwiICsgbGVmdFdpbmRvdyk7XG59LCBmYWxzZSk7XG5cbmJvZHkuYWRkRXZlbnRMaXN0ZW5lcihcInNjcm9sbFwiLCBmdW5jdGlvbihldmVudCkge1xuICB0b3BCb2R5ID0gIHRoaXMuc2Nyb2xsWTtcbiAgbGVmdEJvZHkgPSB0aGlzLnNjcm9sbFg7XG4gIC8vY29uc29sZS5sb2coXCIgYm9keSA6IFwiKyAgYm9keS5zY3JvbGxMZWZ0ICApO1xufSwgZmFsc2UpO1xuXG5cbi8qKlxuICogQ2FsbGJhY2sgdXNlZCAqXG4gKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS1cbiAqIERPIE5PVCBVU0UgVEhFU0UgRlVOQ1RJT05TIFdJVEhPVVQgQSBDT01NQU5EIVxuICogVGhlIGZvbGxvd2luZyBjb2RlIHNob3VsZCBiZSBjb25zaWRlcmVkIGFzIHByaXZhdGVcbi8qLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLSAqL1xuXG52YXIgbXV0ZUJ1dHRvbkNhbGxiYWNrID0gZnVuY3Rpb24oZSl7XG4gIGlmICh2aWRlb19jdXJyZW50Lm11dGVkID09PSBmYWxzZSkge1xuICAgIC8vIE11dGUgdGhlIHZpZGVvXG4gICAgdmlkZW9fY3VycmVudC5tdXRlZCA9IHRydWU7XG4gICAgLy8gVXBkYXRlIHRoZSBidXR0b24gdGV4dFxuICAgIG11dGVCdXR0b24uaW5uZXJIVE1MID0gXCJVbm11dGVcIjtcbiAgfSBlbHNlIHtcbiAgICAvLyBVbm11dGUgdGhlIHZpZGVvXG4gICAgdmlkZW9fY3VycmVudC5tdXRlZCA9IGZhbHNlO1xuICAgIC8vIFVwZGF0ZSB0aGUgYnV0dG9uIHRleHRcbiAgICBtdXRlQnV0dG9uLmlubmVySFRNTCA9IFwiTXV0ZVwiO1xuICB9XG59O1xuXG52YXIgcmVwZXRQYXJ0T2ZWaWRlbyA9IGZ1bmN0aW9uIChzdGFydCxlbmQsIG51bWJlck9mUmVwZXRpdGlvbixzcGVlZFJhdGUpIHtcbiAgLy8gY29uc29sZS5sb2coXCJmdW5jdGlvbiAgLSByZXBldFBhcnRPZlZpZGVvXCIgLCBzdGFydCxlbmQsIG51bWJlck9mUmVwZXRpdGlvbixzcGVlZFJhdGUpO1xuICBpc1BsYXlpbmdDYXJkID0gdHJ1ZTtcbiAgICAvLyBmYXN0ZXIgc3BlZWQgaW5pdGlhbGx5XG4gIHZpZGVvX2N1cnJlbnQucGxheWJhY2tSYXRlKHNwZWVkUmF0ZSk7XG4gIHZpZGVvX2N1cnJlbnQuY3VycmVudFRpbWUoc3RhcnQpO1xuICAgIFxuICB2YXIgcmVwZXQgPSBudW1iZXJPZlJlcGV0aXRpb247XG4gIFxuICAvL2NvbnNvbGUubG9nKFwiZnVuY3Rpb24gIC0gcmVwZXRQYXJ0T2ZWaWRlbyBbcGxheSBwYXJ0XSBsODcgdmlkZW9Db21tYW5kXCIpO1xuICBwbGF5KCk7XG4gIHZpZGVvX2N1cnJlbnQub250aW1ldXBkYXRlID0gZnVuY3Rpb24oKSB7XG4gICAgaWYoaXNQbGF5aW5nQ2FyZCl7XG4gICAgICBpZiAoKGVuZCA+IHN0YXJ0ICkgJiYgIHJlcGV0ID4gMCApIHtcbiAgICAgICAgaWYgKHZpZGVvX2N1cnJlbnQuY3VycmVudFRpbWUoKSAgID4gZW5kKSB7XG4gICAgICAgICAgcmVwZXQtLTtcbiAgICAgICAgICB2aWRlb19jdXJyZW50LmN1cnJlbnRUaW1lKHN0YXJ0KTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdmlkZW9fY3VycmVudC5vbnRpbWV1cGRhdGUgPSBudWxsO1xuICAgICAgICBmZWVkYmFja09uU2xpZGVyVmlkZW8oZmFsc2UpO1xuICAgICAgICB2aWRlb19jdXJyZW50LnBsYXliYWNrUmF0ZSgxKTtcbiAgICAgIH1cbiAgICB9XG4gIH07XG59O1xuXG5mdW5jdGlvbiBjbGVhckFsbFRpbWVyKCkge1xuICB3aW5kb3cuY2xlYXJJbnRlcnZhbCh0aW1lclJlcGV0aXRpb24pO1xuICBpc1BsYXlpbmdDYXJkID0gZmFsc2U7XG4gIHZpZGVvX2N1cnJlbnQucGxheWJhY2tSYXRlKCAxKTtcbiAgLy9mZWVkYmFja09uU2xpZGVyVmlkZW8oZmFsc2UpO1xufVxuXG5cbnZhciBwbGF5ID0gZnVuY3Rpb24gKCkge1xuICB2aWRlb19jdXJyZW50LnBsYXkoKTtcbn07XG5cbnZhciBwYXVzZSA9IGZ1bmN0aW9uICgpIHtcbiAgLy9jb25zb2xlLmxvZyhcImFwcGVzbCBhIHBhdXNlXCIpO1xuICB2aWRlb19jdXJyZW50LnBhdXNlKCk7XG59O1xuXG52YXIgc2Vla1RvID0gZnVuY3Rpb24oc3RhcnREdXJhdGlvblBhcmFtKXtcbiAgaWYoc3RhcnREdXJhdGlvblBhcmFtIDwgdmlkZW9fY3VycmVudC5jdXJyZW50VGltZSgpIClcbiAgICB2aWRlb19jdXJyZW50LmN1cnJlbnRUaW1lKHN0YXJ0RHVyYXRpb25QYXJhbSk7XG59O1xuXG52YXIgcGxheVBhdXNlY2FsbGJhY2sgPSBmdW5jdGlvbihlKXtcbiAgLy9jb25zb2xlLmxvZyhcImNhbGxiYWNrIHBsYXktcGF1c2UsIGUgOiBcIiArIGUpO1xuICAvKmlmKGUgIT0gbnVsbCAmJiBlICE9PSB1bmRlZmluZWQpe1xuICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgfSovXG4gIC8vaWYgKHZpZGVvX2N1cnJlbnQucGF1c2VkIHx8IHZpZGVvX2N1cnJlbnQuZW5kZWQgKSB7XG4gIFxuICAgIGlmICh2aWRlb19jdXJyZW50LnBhdXNlZCgpKSB7XG4gICAgIHZpZGVvRnVuY3Rpb25hbENvcmVNYW5hZ2VyLmV4ZWN1dGUobmV3IFBsYXlDb21tYW5kKCkpO1xuICAgIH0gZWxzZSB7XG4gICAgdmlkZW9GdW5jdGlvbmFsQ29yZU1hbmFnZXIuZXhlY3V0ZShuZXcgUGF1c2VDb21tYW5kKCkpO1xuICB9XG59O1xuXG52YXIgbWlycm9yID0gZnVuY3Rpb24gKCkge1xuICBpZihtaXJyb3JlZCl7XG4gICAgXG4gICAgZG9jdW1lbnQuZ2V0RWxlbWVudHNCeUNsYXNzTmFtZShcInZqcy10ZWNoXCIpWzBdLnN0eWxlLnRyYW5zZm9ybSA9IFwicm90YXRlWShcIisgMCArXCJkZWcpXCI7XG4gICAgbWlycm9yZWQgPSBmYWxzZTtcbiAgfSBlbHNlIHtcbiAgICBkb2N1bWVudC5nZXRFbGVtZW50c0J5Q2xhc3NOYW1lKFwidmpzLXRlY2hcIilbMF0uc3R5bGUudHJhbnNmb3JtID0gXCJyb3RhdGVZKFwiKyAxODAgK1wiZGVnKVwiO1xuICBcbiAgICB2aWRlb19jdXJyZW50LnN0eWxlID0gJ3JvdGF0ZVkoJysgMTgwICsnZGVnKSc7XG4gICAgbWlycm9yZWQgPSB0cnVlO1xuICB9XG59O1xuXG52YXIgc2V0U291cmNlID0gZnVuY3Rpb24oc291cmNlKXtcbiAgdmlkZW9fY3VycmVudC5zcmMgPSBzb3VyY2U7XG59O1xuXG5cbiJdfQ==