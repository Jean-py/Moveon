"use strict";

/**
 * Deprecated if using the youtube api instead of loaded video
 * @type {HTMLElement | null}
 */

var video = document.getElementById("videoEAT");

var wrapperVideo = document.getElementById("idVideo");
var speedrate = 1;
// Buttons
var playButton = document.getElementById("play-pause");
var muteButton = document.getElementById("mute");
// Sliders
var knobMin = document.getElementById("range-slider_handle-min");
var rangeSliderTrack = document.getElementById("rangeSliderTrack");

var divCardBoard = document.getElementById("divCardBoard");
var body = document.getElementsByTagName("BODY")[0];

//Je ne saiss pas comment rendre cette ligne automatique pour l'isntant car la taille est en auto...
var WIDTH_RANGE_SLIDER_TRACK = "960px";
//Donc pour l'instant je reste comme Ã§a
rangeSliderTrack.style.width = WIDTH_RANGE_SLIDER_TRACK;

var isPlayingCard = false;

var commands = [];
/**
 * Access point to the functional core, you can just execute command from here
 * @return {{execute: execute}}
 * @constructor
 */
var VideoFunctionalCoreManager = function VideoFunctionalCoreManager() {
  //This is a command pattern, see : https://www.dofactory.com/javascript/command-design-pattern
  return {
    //execute a command
    execute: function execute(command) {
      switch (command.execute.name) {
        case "repetPartOfVideo":
          {
            command.execute(command.start, command.end, command.numberOfRepetition, command.speedRate);
            break;
          }
        case "updateKnobAndVideoComputer":
          command.execute(command.e);
          break;

        default:
          command.execute();
          break;
      }

      //We send the command to the server (the server log it into a file, see ./src/server/ServerLogger)
      logger.sendAndLogCommand(command);
      //and we save the command created
      commands.push(command);
    }
    //We did not implemented undo redo for this manager, because undo play pause is kind of useless right?
  };
};

//On load of the page
window.addEventListener("load", function () {
  //The size of the controller is the same than the size of the video
  setTimeout(function () {
    // This hides the address bar:
    video.load();
    window.scrollTo(0, 1);

    var ua = navigator.userAgent.toLowerCase();
    if (ua.indexOf('safari') != -1) {
      if (ua.indexOf('chrome') > -1) {
        //video.src = "./public/media/EAT3.webm";
      } else {
        //alert("2") // Safari
        console.log("test safari");
        video.src = "../../../public/media/workshop2/EAT3.mp4";
        console.log("test safari : " + video.src);
        video.load();
      }
    }
  }, 0);
});
window.addEventListener("scroll", function (event) {
  topWindow = this.scrollY;
  leftWindow = this.scrollX;
  // console.log("window scroll : " + leftWindow);
}, false);

body.addEventListener("scroll", function (event) {
  topBody = this.scrollY;
  leftBody = this.scrollX;
  //console.log(" body : "+  body.scrollLeft  );
}, false);

/**
 * Callback used *
 *-------------------------------
 * DO NOT USE THESE FUNCTIONS WITHOUT A COMMAND!
 * The following code should be considered as private
/*------------------------------- */

var muteButtonCallback = function muteButtonCallback(e) {
  if (video.muted === false) {
    // Mute the video
    video.muted = true;
    // Update the button text
    muteButton.innerHTML = "Unmute";
  } else {
    // Unmute the video
    video.muted = false;
    //this.src="/media/workshop2/videoCommand/volumeFull.png";
    // Update the button text
    muteButton.innerHTML = "Mute";
  }
};

var repetPartOfVideo = function repetPartOfVideo(start, end, numberOfRepetition, speedRate) {
  // console.log("function  - repetPartOfVideo" , start,end, numberOfRepetition,speedRate);
  isPlayingCard = true;
  video.playbackRate = speedRate;
  video.currentTime = start;
  var repet = numberOfRepetition;

  //console.log("function  - repetPartOfVideo [play part] l87 videoCommand");
  play();
  video.ontimeupdate = function () {
    if (isPlayingCard) {
      if (end > start && repet > 0) {
        if (video.currentTime > end) {
          repet--;
          video.currentTime = start;
        }
      } else {
        video.ontimeupdate = null;
        feedbackOnSliderVideo(false);
        video.playbackRate = 1;
      }
    }
  };
};

function clearAllTimer() {
  window.clearInterval(timerRepetition);
  isPlayingCard = false;
  video.playbackRate = 1;
  feedbackOnSliderVideo(false);
}

var play = function play() {
  setTimeout(function () {
    var playPromise = video.play();
    if (playPromise !== undefined) {
      playPromise.then(function (value) {
        video.play();
        playButton.src = '/media/workshop2/videoCommand/pauseButton.png';
      }).catch(function (e) {
        console.log(e);
        video.load();
        //video.pause();
      });
    }
  }, 250);
};

var pause = function pause() {
  //console.log("appel a pause");
  video.pause();
  playButton.src = '/media/workshop2/videoCommand/playButton.png';
};

var seekTo = function seekTo(startDurationParam) {
  console.log(startDurationParam);
  video.currentTime = startDurationParam;
};

var playPausecallback = function playPausecallback(e) {
  //console.log("callback play-pause, e : " + e);
  /*if(e != null && e !== undefined){
    e.preventDefault();
  }*/
  if (video.paused || video.ended) {
    videoFunctionalCoreManager.execute(new PlayCommand());
    //play();
  } else {
    //pause();
    videoFunctionalCoreManager.execute(new PauseCommand());
  }
};

//Update knob on a tablet
var updateKnobAndVideo = function updateKnobAndVideo(event) {
  //  var offsetLeftSlider = wrapperCommandAndRangeid.offsetLeft+rangeSliderTrack.offsetLeft + dividCommandeVideo.offsetLeft;
  var offsetLeftSlider = wrapperCommandAndRangeid.offsetLeft; //-   ;
  //console.log("aa :  " +  body );

  video.currentTime = Math.round(((event.targetTouches[0] ? event.targetTouches[0].pageX : event.changedTouches[event.changedTouches.length - 1].pageX) - offsetLeftSlider) * video.duration / NUMBER_OF_TICK);
  //Update know position
  knobMin.style.left = (event.targetTouches[0] ? event.targetTouches[0].pageX : event.changedTouches[event.changedTouches.length - 1].pageX) - offsetLeftSlider + "px";
  if (segmentFeedback.displayed) {
    if (video.currentTime > segmentFeedback.endDurationVideo) {
      feedbackOnSliderVideo(false);
    }
  }
};

//Update knob on a laptop
var updateKnobAndVideoComputer = function updateKnobAndVideoComputer(e) {
  //take into account offset on the left of the scroll bar (body scroll and centering the wrapper)

  // var pos = (e.pageX  - this.offsetLeft) / this.offsetWidth;
  //    video.currentTime = pos * video.duration;
  var offsetLeftSlider = wrapperCommandAndRangeid.offsetLeft - body.scrollLeft; //- window.scrollLeft  ;
  currentValueKnob = (e.pageX - offsetLeftSlider) * video.duration / NUMBER_OF_TICK;
  if (currentValueKnob < video.duration && currentValueKnob >= 0) {
    video.currentTime = (e.pageX - offsetLeftSlider) * video.duration / NUMBER_OF_TICK;
    knobMin.style.left = e.pageX - (offsetLeftSlider + WIDTH_MID_KNOB_MIN / 2) + "px";
    if (segmentFeedback.displayed) {
      if (video.currentTime > segmentFeedback.endDurationVideo) {
        feedbackOnSliderVideo(false);
      }
    }
  }
};

function feedbackOnSliderVideo(onOff) {
  segmentFeedback.endPosition = parseInt(segmentFeedback.startPostion) + parseInt(segmentFeedback.width);
  var sliderToV = sliderToVideo(segmentFeedback.startPostion, segmentFeedback.endPosition);
  segmentFeedback.startDurationVideo = sliderToV.startDuration;
  segmentFeedback.endDurationVideo = sliderToV.endDuration;
  segmentFeedback.displayed = onOff;
  if (onOff) {
    //segmentFeedback.divGraphicalObject.style.marginLeft = segmentFeedback.startPostion;
    //minus 2 because we need to get 2 frame before the segment
    segmentFeedback.divGraphicalObject.style.marginLeft = parseInt(segmentFeedback.startPostion) + "px"; //  segmentFeedback.startPostion;
    segmentFeedback.divGraphicalObject.style.visibility = "visible";
    segmentFeedback.divGraphicalObject.style.width = segmentFeedback.width;
  } else {
    segmentFeedback.divGraphicalObject.style.visibility = "hidden";
  }
}

/*

function feedbackOnSliderVideo(onOff) {
  segmentFeedback.endPosition = parseInt(segmentFeedback.startPostion) + parseInt(segmentFeedback.width) ;
  var sliderToV = sliderToVideo(segmentFeedback.startPostion, segmentFeedback.endPosition);
  segmentFeedback.startDurationVideo = sliderToV.startDuration;
  segmentFeedback.endDurationVideo = sliderToV.endDuration;
  segmentFeedback.displayed = onOff;
  if (onOff) {
    //segmentFeedback.divGraphicalObject.style.marginLeft = segmentFeedback.startPostion;
    //minus 2 because we need to get 2 frame before the segment
    segmentFeedback.divGraphicalObject.style.marginLeft = parseInt(segmentFeedback.startPostion) - 100 + "px"; //  segmentFeedback.startPostion;
    segmentFeedback.divGraphicalObject.style.visibility = "visible";
    segmentFeedback.divGraphicalObject.style.width = segmentFeedback.width ;
  } else {
    segmentFeedback.divGraphicalObject.style.visibility = "hidden";
  }
}
*/

function updateTimerVideo() {
  var minutes = Math.floor(video.currentTime / 60);
  var seconds = Math.floor(video.currentTime - minutes * 60);
  if (seconds < 10) seconds = "0" + seconds;
  timerVideo.innerHTML = minutes + ":" + seconds + "/" + videoDuration;
}

//start position on the slider and end position on the slider
function sliderToVideo(startP, endP) {
  if (startP < 0) {
    startP = 0;
  }
  var startDuration = Math.round(startP * video.duration / NUMBER_OF_TICK);
  var endDuration = Math.round(endP * video.duration / NUMBER_OF_TICK);

  return {
    startDuration: startDuration,
    endDuration: endDuration
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInZpZGVvRnVuY3Rpb25hbENvcmUuanMiXSwibmFtZXMiOlsidmlkZW8iLCJkb2N1bWVudCIsImdldEVsZW1lbnRCeUlkIiwid3JhcHBlclZpZGVvIiwic3BlZWRyYXRlIiwicGxheUJ1dHRvbiIsIm11dGVCdXR0b24iLCJrbm9iTWluIiwicmFuZ2VTbGlkZXJUcmFjayIsImRpdkNhcmRCb2FyZCIsImJvZHkiLCJnZXRFbGVtZW50c0J5VGFnTmFtZSIsIldJRFRIX1JBTkdFX1NMSURFUl9UUkFDSyIsInN0eWxlIiwid2lkdGgiLCJpc1BsYXlpbmdDYXJkIiwiY29tbWFuZHMiLCJWaWRlb0Z1bmN0aW9uYWxDb3JlTWFuYWdlciIsImV4ZWN1dGUiLCJjb21tYW5kIiwibmFtZSIsInN0YXJ0IiwiZW5kIiwibnVtYmVyT2ZSZXBldGl0aW9uIiwic3BlZWRSYXRlIiwiZSIsImxvZ2dlciIsInNlbmRBbmRMb2dDb21tYW5kIiwicHVzaCIsIndpbmRvdyIsImFkZEV2ZW50TGlzdGVuZXIiLCJzZXRUaW1lb3V0IiwibG9hZCIsInNjcm9sbFRvIiwidWEiLCJuYXZpZ2F0b3IiLCJ1c2VyQWdlbnQiLCJ0b0xvd2VyQ2FzZSIsImluZGV4T2YiLCJjb25zb2xlIiwibG9nIiwic3JjIiwiZXZlbnQiLCJ0b3BXaW5kb3ciLCJzY3JvbGxZIiwibGVmdFdpbmRvdyIsInNjcm9sbFgiLCJ0b3BCb2R5IiwibGVmdEJvZHkiLCJtdXRlQnV0dG9uQ2FsbGJhY2siLCJtdXRlZCIsImlubmVySFRNTCIsInJlcGV0UGFydE9mVmlkZW8iLCJwbGF5YmFja1JhdGUiLCJjdXJyZW50VGltZSIsInJlcGV0IiwicGxheSIsIm9udGltZXVwZGF0ZSIsImZlZWRiYWNrT25TbGlkZXJWaWRlbyIsImNsZWFyQWxsVGltZXIiLCJjbGVhckludGVydmFsIiwidGltZXJSZXBldGl0aW9uIiwicGxheVByb21pc2UiLCJ1bmRlZmluZWQiLCJ0aGVuIiwidmFsdWUiLCJjYXRjaCIsInBhdXNlIiwic2Vla1RvIiwic3RhcnREdXJhdGlvblBhcmFtIiwicGxheVBhdXNlY2FsbGJhY2siLCJwYXVzZWQiLCJlbmRlZCIsInZpZGVvRnVuY3Rpb25hbENvcmVNYW5hZ2VyIiwiUGxheUNvbW1hbmQiLCJQYXVzZUNvbW1hbmQiLCJ1cGRhdGVLbm9iQW5kVmlkZW8iLCJvZmZzZXRMZWZ0U2xpZGVyIiwid3JhcHBlckNvbW1hbmRBbmRSYW5nZWlkIiwib2Zmc2V0TGVmdCIsIk1hdGgiLCJyb3VuZCIsInRhcmdldFRvdWNoZXMiLCJwYWdlWCIsImNoYW5nZWRUb3VjaGVzIiwibGVuZ3RoIiwiZHVyYXRpb24iLCJOVU1CRVJfT0ZfVElDSyIsImxlZnQiLCJzZWdtZW50RmVlZGJhY2siLCJkaXNwbGF5ZWQiLCJlbmREdXJhdGlvblZpZGVvIiwidXBkYXRlS25vYkFuZFZpZGVvQ29tcHV0ZXIiLCJzY3JvbGxMZWZ0IiwiY3VycmVudFZhbHVlS25vYiIsIldJRFRIX01JRF9LTk9CX01JTiIsIm9uT2ZmIiwiZW5kUG9zaXRpb24iLCJwYXJzZUludCIsInN0YXJ0UG9zdGlvbiIsInNsaWRlclRvViIsInNsaWRlclRvVmlkZW8iLCJzdGFydER1cmF0aW9uVmlkZW8iLCJzdGFydER1cmF0aW9uIiwiZW5kRHVyYXRpb24iLCJkaXZHcmFwaGljYWxPYmplY3QiLCJtYXJnaW5MZWZ0IiwidmlzaWJpbGl0eSIsInVwZGF0ZVRpbWVyVmlkZW8iLCJtaW51dGVzIiwiZmxvb3IiLCJzZWNvbmRzIiwidGltZXJWaWRlbyIsInZpZGVvRHVyYXRpb24iLCJzdGFydFAiLCJlbmRQIl0sIm1hcHBpbmdzIjoiOztBQUFBOzs7OztBQU1BLElBQUlBLFFBQVFDLFNBQVNDLGNBQVQsQ0FBd0IsVUFBeEIsQ0FBWjs7QUFJQSxJQUFJQyxlQUFlRixTQUFTQyxjQUFULENBQXdCLFNBQXhCLENBQW5CO0FBQ0EsSUFBSUUsWUFBWSxDQUFoQjtBQUNBO0FBQ0EsSUFBSUMsYUFBYUosU0FBU0MsY0FBVCxDQUF3QixZQUF4QixDQUFqQjtBQUNBLElBQUlJLGFBQWFMLFNBQVNDLGNBQVQsQ0FBd0IsTUFBeEIsQ0FBakI7QUFDQTtBQUNBLElBQUlLLFVBQVVOLFNBQVNDLGNBQVQsQ0FBd0IseUJBQXhCLENBQWQ7QUFDQSxJQUFJTSxtQkFBbUJQLFNBQVNDLGNBQVQsQ0FBd0Isa0JBQXhCLENBQXZCOztBQUVBLElBQUlPLGVBQWVSLFNBQVNDLGNBQVQsQ0FBd0IsY0FBeEIsQ0FBbkI7QUFDQSxJQUFJUSxPQUFPVCxTQUFTVSxvQkFBVCxDQUE4QixNQUE5QixFQUFzQyxDQUF0QyxDQUFYOztBQUVBO0FBQ0EsSUFBSUMsMkJBQTJCLE9BQS9CO0FBQ0E7QUFDQUosaUJBQWlCSyxLQUFqQixDQUF1QkMsS0FBdkIsR0FBK0JGLHdCQUEvQjs7QUFFQSxJQUFJRyxnQkFBZ0IsS0FBcEI7O0FBSUEsSUFBSUMsV0FBVyxFQUFmO0FBQ0E7Ozs7O0FBS0EsSUFBSUMsNkJBQTZCLFNBQTdCQSwwQkFBNkIsR0FBVztBQUMxQztBQUNBLFNBQU87QUFDTDtBQUNBQyxhQUFTLGlCQUFTQyxPQUFULEVBQWtCO0FBQ3pCLGNBQVFBLFFBQVFELE9BQVIsQ0FBZ0JFLElBQXhCO0FBQ0UsYUFBSyxrQkFBTDtBQUEwQjtBQUN4QkQsb0JBQVFELE9BQVIsQ0FBZ0JDLFFBQVFFLEtBQXhCLEVBQThCRixRQUFRRyxHQUF0QyxFQUEwQ0gsUUFBUUksa0JBQWxELEVBQXFFSixRQUFRSyxTQUE3RTtBQUNBO0FBQ0Q7QUFDRCxhQUFLLDRCQUFMO0FBQ0VMLGtCQUFRRCxPQUFSLENBQWdCQyxRQUFRTSxDQUF4QjtBQUNBOztBQUVGO0FBQ0VOLGtCQUFRRCxPQUFSO0FBQ0E7QUFYSjs7QUFjQTtBQUNBUSxhQUFPQyxpQkFBUCxDQUF5QlIsT0FBekI7QUFDQTtBQUNBSCxlQUFTWSxJQUFULENBQWNULE9BQWQ7QUFDRDtBQUNEO0FBdEJLLEdBQVA7QUF3QkQsQ0ExQkQ7O0FBNkJBO0FBQ0FVLE9BQU9DLGdCQUFQLENBQXdCLE1BQXhCLEVBQStCLFlBQVc7QUFDeEM7QUFDQUMsYUFBVyxZQUFVO0FBQ25CO0FBQ0EvQixVQUFNZ0MsSUFBTjtBQUNBSCxXQUFPSSxRQUFQLENBQWdCLENBQWhCLEVBQW1CLENBQW5COztBQUVBLFFBQUlDLEtBQUtDLFVBQVVDLFNBQVYsQ0FBb0JDLFdBQXBCLEVBQVQ7QUFDQSxRQUFJSCxHQUFHSSxPQUFILENBQVcsUUFBWCxLQUF3QixDQUFDLENBQTdCLEVBQWdDO0FBQzlCLFVBQUlKLEdBQUdJLE9BQUgsQ0FBVyxRQUFYLElBQXVCLENBQUMsQ0FBNUIsRUFBK0I7QUFDN0I7QUFDRCxPQUZELE1BRU87QUFDTDtBQUNBQyxnQkFBUUMsR0FBUixDQUFZLGFBQVo7QUFDQXhDLGNBQU15QyxHQUFOLEdBQVksMENBQVo7QUFDQUYsZ0JBQVFDLEdBQVIsQ0FBWSxtQkFBbUJ4QyxNQUFNeUMsR0FBckM7QUFDQXpDLGNBQU1nQyxJQUFOO0FBQ0Q7QUFDRjtBQUNGLEdBakJELEVBaUJHLENBakJIO0FBa0JELENBcEJEO0FBcUJBSCxPQUFPQyxnQkFBUCxDQUF3QixRQUF4QixFQUFrQyxVQUFTWSxLQUFULEVBQWdCO0FBQ2hEQyxjQUFZLEtBQUtDLE9BQWpCO0FBQ0FDLGVBQVksS0FBS0MsT0FBakI7QUFDQTtBQUNELENBSkQsRUFJRyxLQUpIOztBQU1BcEMsS0FBS29CLGdCQUFMLENBQXNCLFFBQXRCLEVBQWdDLFVBQVNZLEtBQVQsRUFBZ0I7QUFDOUNLLFlBQVcsS0FBS0gsT0FBaEI7QUFDQUksYUFBVyxLQUFLRixPQUFoQjtBQUNBO0FBQ0QsQ0FKRCxFQUlHLEtBSkg7O0FBT0E7Ozs7Ozs7QUFPQSxJQUFJRyxxQkFBcUIsU0FBckJBLGtCQUFxQixDQUFTeEIsQ0FBVCxFQUFXO0FBQ2xDLE1BQUl6QixNQUFNa0QsS0FBTixLQUFnQixLQUFwQixFQUEyQjtBQUN6QjtBQUNBbEQsVUFBTWtELEtBQU4sR0FBYyxJQUFkO0FBQ0E7QUFDQTVDLGVBQVc2QyxTQUFYLEdBQXVCLFFBQXZCO0FBQ0QsR0FMRCxNQUtPO0FBQ0w7QUFDQW5ELFVBQU1rRCxLQUFOLEdBQWMsS0FBZDtBQUNBO0FBQ0E7QUFDQTVDLGVBQVc2QyxTQUFYLEdBQXVCLE1BQXZCO0FBQ0Q7QUFDRixDQWJEOztBQWVBLElBQUlDLG1CQUFtQixTQUFuQkEsZ0JBQW1CLENBQVUvQixLQUFWLEVBQWdCQyxHQUFoQixFQUFxQkMsa0JBQXJCLEVBQXdDQyxTQUF4QyxFQUFtRDtBQUN4RTtBQUNBVCxrQkFBZ0IsSUFBaEI7QUFDQWYsUUFBTXFELFlBQU4sR0FBcUI3QixTQUFyQjtBQUNBeEIsUUFBTXNELFdBQU4sR0FBb0JqQyxLQUFwQjtBQUNBLE1BQUlrQyxRQUFRaEMsa0JBQVo7O0FBRUE7QUFDQWlDO0FBQ0F4RCxRQUFNeUQsWUFBTixHQUFxQixZQUFXO0FBQzlCLFFBQUcxQyxhQUFILEVBQWlCO0FBQ2YsVUFBS08sTUFBTUQsS0FBUCxJQUFtQmtDLFFBQVEsQ0FBL0IsRUFBbUM7QUFDakMsWUFBSXZELE1BQU1zRCxXQUFOLEdBQW9CaEMsR0FBeEIsRUFBNkI7QUFDM0JpQztBQUNBdkQsZ0JBQU1zRCxXQUFOLEdBQW9CakMsS0FBcEI7QUFDRDtBQUNGLE9BTEQsTUFLTztBQUNMckIsY0FBTXlELFlBQU4sR0FBcUIsSUFBckI7QUFDQUMsOEJBQXNCLEtBQXRCO0FBQ0ExRCxjQUFNcUQsWUFBTixHQUFxQixDQUFyQjtBQUNEO0FBQ0Y7QUFDRixHQWJEO0FBY0QsQ0F2QkQ7O0FBeUJBLFNBQVNNLGFBQVQsR0FBeUI7QUFDdkI5QixTQUFPK0IsYUFBUCxDQUFxQkMsZUFBckI7QUFDQTlDLGtCQUFnQixLQUFoQjtBQUNBZixRQUFNcUQsWUFBTixHQUFxQixDQUFyQjtBQUNBSyx3QkFBc0IsS0FBdEI7QUFDRDs7QUFHRCxJQUFJRixPQUFPLFNBQVBBLElBQU8sR0FBWTtBQUNyQnpCLGFBQVcsWUFBWTtBQUNyQixRQUFJK0IsY0FBYzlELE1BQU13RCxJQUFOLEVBQWxCO0FBQ0EsUUFBSU0sZ0JBQWdCQyxTQUFwQixFQUErQjtBQUM3QkQsa0JBQVlFLElBQVosQ0FBaUIsVUFBVUMsS0FBVixFQUFpQjtBQUNoQ2pFLGNBQU13RCxJQUFOO0FBQ0FuRCxtQkFBV29DLEdBQVgsR0FBaUIsK0NBQWpCO0FBQ0QsT0FIRCxFQUdHeUIsS0FISCxDQUdTLFVBQVV6QyxDQUFWLEVBQWE7QUFDcEJjLGdCQUFRQyxHQUFSLENBQVlmLENBQVo7QUFDQXpCLGNBQU1nQyxJQUFOO0FBQ0E7QUFDRCxPQVBEO0FBU0Q7QUFDRixHQWJELEVBYUUsR0FiRjtBQWNELENBZkQ7O0FBaUJBLElBQUltQyxRQUFRLFNBQVJBLEtBQVEsR0FBWTtBQUN0QjtBQUNBbkUsUUFBTW1FLEtBQU47QUFDQTlELGFBQVdvQyxHQUFYLEdBQWUsOENBQWY7QUFDRCxDQUpEOztBQU1BLElBQUkyQixTQUFTLFNBQVRBLE1BQVMsQ0FBU0Msa0JBQVQsRUFBNEI7QUFDdkM5QixVQUFRQyxHQUFSLENBQVk2QixrQkFBWjtBQUNBckUsUUFBTXNELFdBQU4sR0FBb0JlLGtCQUFwQjtBQUNELENBSEQ7O0FBS0EsSUFBSUMsb0JBQW9CLFNBQXBCQSxpQkFBb0IsQ0FBUzdDLENBQVQsRUFBVztBQUNqQztBQUNBOzs7QUFHQSxNQUFJekIsTUFBTXVFLE1BQU4sSUFBZ0J2RSxNQUFNd0UsS0FBMUIsRUFBa0M7QUFDaENDLCtCQUEyQnZELE9BQTNCLENBQW1DLElBQUl3RCxXQUFKLEVBQW5DO0FBQ0E7QUFDQyxHQUhILE1BR1M7QUFDTDtBQUNGRCwrQkFBMkJ2RCxPQUEzQixDQUFtQyxJQUFJeUQsWUFBSixFQUFuQztBQUVEO0FBQ0YsQ0FiRDs7QUFnQkE7QUFDQSxJQUFJQyxxQkFBcUIsU0FBckJBLGtCQUFxQixDQUFTbEMsS0FBVCxFQUFnQjtBQUN2QztBQUNBLE1BQUltQyxtQkFBbUJDLHlCQUF5QkMsVUFBaEQsQ0FGdUMsQ0FFcUI7QUFDNUQ7O0FBRUEvRSxRQUFNc0QsV0FBTixHQUFvQjBCLEtBQUtDLEtBQUwsQ0FBWSxDQUFDLENBQUN2QyxNQUFNd0MsYUFBTixDQUFvQixDQUFwQixJQUF5QnhDLE1BQU13QyxhQUFOLENBQW9CLENBQXBCLEVBQXVCQyxLQUFoRCxHQUF3RHpDLE1BQU0wQyxjQUFOLENBQXFCMUMsTUFBTTBDLGNBQU4sQ0FBcUJDLE1BQXJCLEdBQThCLENBQW5ELEVBQXNERixLQUEvRyxJQUF5SE4sZ0JBQTFILElBQStJN0UsTUFBTXNGLFFBQXRKLEdBQWtLQyxjQUE3SyxDQUFwQjtBQUNBO0FBQ0FoRixVQUFRTSxLQUFSLENBQWMyRSxJQUFkLEdBQXVCLENBQUU5QyxNQUFNd0MsYUFBTixDQUFvQixDQUFwQixJQUF5QnhDLE1BQU13QyxhQUFOLENBQW9CLENBQXBCLEVBQXVCQyxLQUFoRCxHQUF3RHpDLE1BQU0wQyxjQUFOLENBQXFCMUMsTUFBTTBDLGNBQU4sQ0FBcUJDLE1BQXJCLEdBQThCLENBQW5ELEVBQXNERixLQUFoSCxJQUEwSE4sZ0JBQTVILEdBQWlKLElBQXRLO0FBQ0EsTUFBSVksZ0JBQWdCQyxTQUFwQixFQUErQjtBQUM3QixRQUFJMUYsTUFBTXNELFdBQU4sR0FBb0JtQyxnQkFBZ0JFLGdCQUF4QyxFQUEwRDtBQUN4RGpDLDRCQUFzQixLQUF0QjtBQUNEO0FBQ0Y7QUFDRixDQWJEOztBQWVBO0FBQ0EsSUFBSWtDLDZCQUE2QixTQUE3QkEsMEJBQTZCLENBQVNuRSxDQUFULEVBQVk7QUFDM0M7O0FBRUQ7QUFDQztBQUNBLE1BQUlvRCxtQkFBbUJDLHlCQUF5QkMsVUFBekIsR0FBc0NyRSxLQUFLbUYsVUFBbEUsQ0FMMkMsQ0FLbUM7QUFDOUVDLHFCQUFvQixDQUFDckUsRUFBRTBELEtBQUYsR0FBVU4sZ0JBQVgsSUFBK0I3RSxNQUFNc0YsUUFBdEMsR0FBa0RDLGNBQXJFO0FBQ0EsTUFBSU8sbUJBQW1COUYsTUFBTXNGLFFBQXpCLElBQXFDUSxvQkFBb0IsQ0FBN0QsRUFBZ0U7QUFDOUQ5RixVQUFNc0QsV0FBTixHQUFxQixDQUFDN0IsRUFBRTBELEtBQUYsR0FBVU4sZ0JBQVgsSUFBK0I3RSxNQUFNc0YsUUFBdEMsR0FBa0RDLGNBQXRFO0FBQ0FoRixZQUFRTSxLQUFSLENBQWMyRSxJQUFkLEdBQXFCL0QsRUFBRTBELEtBQUYsSUFBV04sbUJBQW1Ca0IscUJBQXFCLENBQW5ELElBQXdELElBQTdFO0FBQ0EsUUFBSU4sZ0JBQWdCQyxTQUFwQixFQUErQjtBQUM3QixVQUFJMUYsTUFBTXNELFdBQU4sR0FBb0JtQyxnQkFBZ0JFLGdCQUF4QyxFQUEwRDtBQUN4RGpDLDhCQUFzQixLQUF0QjtBQUNEO0FBQ0Y7QUFDRjtBQUNGLENBaEJEOztBQW9CQSxTQUFTQSxxQkFBVCxDQUErQnNDLEtBQS9CLEVBQXNDO0FBQ3BDUCxrQkFBZ0JRLFdBQWhCLEdBQThCQyxTQUFTVCxnQkFBZ0JVLFlBQXpCLElBQXlDRCxTQUFTVCxnQkFBZ0IzRSxLQUF6QixDQUF2RTtBQUNBLE1BQUlzRixZQUFZQyxjQUFjWixnQkFBZ0JVLFlBQTlCLEVBQTRDVixnQkFBZ0JRLFdBQTVELENBQWhCO0FBQ0FSLGtCQUFnQmEsa0JBQWhCLEdBQXFDRixVQUFVRyxhQUEvQztBQUNBZCxrQkFBZ0JFLGdCQUFoQixHQUFtQ1MsVUFBVUksV0FBN0M7QUFDQWYsa0JBQWdCQyxTQUFoQixHQUE0Qk0sS0FBNUI7QUFDQSxNQUFJQSxLQUFKLEVBQVc7QUFDVDtBQUNBO0FBQ0FQLG9CQUFnQmdCLGtCQUFoQixDQUFtQzVGLEtBQW5DLENBQXlDNkYsVUFBekMsR0FBc0RSLFNBQVNULGdCQUFnQlUsWUFBekIsSUFBMEMsSUFBaEcsQ0FIUyxDQUc2RjtBQUN0R1Ysb0JBQWdCZ0Isa0JBQWhCLENBQW1DNUYsS0FBbkMsQ0FBeUM4RixVQUF6QyxHQUFzRCxTQUF0RDtBQUNBbEIsb0JBQWdCZ0Isa0JBQWhCLENBQW1DNUYsS0FBbkMsQ0FBeUNDLEtBQXpDLEdBQWlEMkUsZ0JBQWdCM0UsS0FBakU7QUFDRCxHQU5ELE1BTU87QUFDTDJFLG9CQUFnQmdCLGtCQUFoQixDQUFtQzVGLEtBQW5DLENBQXlDOEYsVUFBekMsR0FBc0QsUUFBdEQ7QUFDRDtBQUNGOztBQUVEOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQXFCQSxTQUFTQyxnQkFBVCxHQUE0QjtBQUMxQixNQUFJQyxVQUFVN0IsS0FBSzhCLEtBQUwsQ0FBVzlHLE1BQU1zRCxXQUFOLEdBQW9CLEVBQS9CLENBQWQ7QUFDQSxNQUFJeUQsVUFBVS9CLEtBQUs4QixLQUFMLENBQVc5RyxNQUFNc0QsV0FBTixHQUFvQnVELFVBQVUsRUFBekMsQ0FBZDtBQUNBLE1BQUlFLFVBQVUsRUFBZCxFQUNFQSxVQUFVLE1BQU1BLE9BQWhCO0FBQ0ZDLGFBQVc3RCxTQUFYLEdBQXVCMEQsVUFBVSxHQUFWLEdBQWdCRSxPQUFoQixHQUEwQixHQUExQixHQUFnQ0UsYUFBdkQ7QUFDRDs7QUFFRDtBQUNBLFNBQVNaLGFBQVQsQ0FBdUJhLE1BQXZCLEVBQStCQyxJQUEvQixFQUFxQztBQUNuQyxNQUFHRCxTQUFTLENBQVosRUFBZTtBQUNiQSxhQUFTLENBQVQ7QUFDRDtBQUNELE1BQUlYLGdCQUFnQnZCLEtBQUtDLEtBQUwsQ0FBYWlDLFNBQVNsSCxNQUFNc0YsUUFBaEIsR0FBNEJDLGNBQXhDLENBQXBCO0FBQ0EsTUFBSWlCLGNBQWN4QixLQUFLQyxLQUFMLENBQWFrQyxPQUFPbkgsTUFBTXNGLFFBQWQsR0FBMEJDLGNBQXRDLENBQWxCOztBQUVBLFNBQU87QUFDTGdCLG1CQUFlQSxhQURWO0FBRUxDLGlCQUFhQTtBQUZSLEdBQVA7QUFJRCIsImZpbGUiOiJ2aWRlb0Z1bmN0aW9uYWxDb3JlLmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBEZXByZWNhdGVkIGlmIHVzaW5nIHRoZSB5b3V0dWJlIGFwaSBpbnN0ZWFkIG9mIGxvYWRlZCB2aWRlb1xuICogQHR5cGUge0hUTUxFbGVtZW50IHwgbnVsbH1cbiAqL1xuXG5cbnZhciB2aWRlbyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwidmlkZW9FQVRcIik7XG5cblxuXG52YXIgd3JhcHBlclZpZGVvID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJpZFZpZGVvXCIpO1xudmFyIHNwZWVkcmF0ZSA9IDE7XG4vLyBCdXR0b25zXG52YXIgcGxheUJ1dHRvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwicGxheS1wYXVzZVwiKTtcbnZhciBtdXRlQnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJtdXRlXCIpO1xuLy8gU2xpZGVyc1xudmFyIGtub2JNaW4gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInJhbmdlLXNsaWRlcl9oYW5kbGUtbWluXCIpO1xudmFyIHJhbmdlU2xpZGVyVHJhY2sgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInJhbmdlU2xpZGVyVHJhY2tcIik7XG5cbnZhciBkaXZDYXJkQm9hcmQgPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcImRpdkNhcmRCb2FyZFwiKTtcbnZhciBib2R5ID0gZG9jdW1lbnQuZ2V0RWxlbWVudHNCeVRhZ05hbWUoXCJCT0RZXCIpWzBdO1xuXG4vL0plIG5lIHNhaXNzIHBhcyBjb21tZW50IHJlbmRyZSBjZXR0ZSBsaWduZSBhdXRvbWF0aXF1ZSBwb3VyIGwnaXNudGFudCBjYXIgbGEgdGFpbGxlIGVzdCBlbiBhdXRvLi4uXG52YXIgV0lEVEhfUkFOR0VfU0xJREVSX1RSQUNLID0gXCI5NjBweFwiO1xuLy9Eb25jIHBvdXIgbCdpbnN0YW50IGplIHJlc3RlIGNvbW1lIMOnYVxucmFuZ2VTbGlkZXJUcmFjay5zdHlsZS53aWR0aCA9IFdJRFRIX1JBTkdFX1NMSURFUl9UUkFDSztcblxudmFyIGlzUGxheWluZ0NhcmQgPSBmYWxzZTtcblxuXG5cbnZhciBjb21tYW5kcyA9IFtdO1xuLyoqXG4gKiBBY2Nlc3MgcG9pbnQgdG8gdGhlIGZ1bmN0aW9uYWwgY29yZSwgeW91IGNhbiBqdXN0IGV4ZWN1dGUgY29tbWFuZCBmcm9tIGhlcmVcbiAqIEByZXR1cm4ge3tleGVjdXRlOiBleGVjdXRlfX1cbiAqIEBjb25zdHJ1Y3RvclxuICovXG52YXIgVmlkZW9GdW5jdGlvbmFsQ29yZU1hbmFnZXIgPSBmdW5jdGlvbigpIHtcbiAgLy9UaGlzIGlzIGEgY29tbWFuZCBwYXR0ZXJuLCBzZWUgOiBodHRwczovL3d3dy5kb2ZhY3RvcnkuY29tL2phdmFzY3JpcHQvY29tbWFuZC1kZXNpZ24tcGF0dGVyblxuICByZXR1cm4ge1xuICAgIC8vZXhlY3V0ZSBhIGNvbW1hbmRcbiAgICBleGVjdXRlOiBmdW5jdGlvbihjb21tYW5kKSB7XG4gICAgICBzd2l0Y2ggKGNvbW1hbmQuZXhlY3V0ZS5uYW1lKXtcbiAgICAgICAgY2FzZSBcInJlcGV0UGFydE9mVmlkZW9cIiA6IHtcbiAgICAgICAgICBjb21tYW5kLmV4ZWN1dGUoY29tbWFuZC5zdGFydCxjb21tYW5kLmVuZCxjb21tYW5kLm51bWJlck9mUmVwZXRpdGlvbixjb21tYW5kLnNwZWVkUmF0ZSk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgICAgY2FzZSBcInVwZGF0ZUtub2JBbmRWaWRlb0NvbXB1dGVyXCIgOlxuICAgICAgICAgIGNvbW1hbmQuZXhlY3V0ZShjb21tYW5kLmUpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICBjb21tYW5kLmV4ZWN1dGUoKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgXG4gICAgICAvL1dlIHNlbmQgdGhlIGNvbW1hbmQgdG8gdGhlIHNlcnZlciAodGhlIHNlcnZlciBsb2cgaXQgaW50byBhIGZpbGUsIHNlZSAuL3NyYy9zZXJ2ZXIvU2VydmVyTG9nZ2VyKVxuICAgICAgbG9nZ2VyLnNlbmRBbmRMb2dDb21tYW5kKGNvbW1hbmQpO1xuICAgICAgLy9hbmQgd2Ugc2F2ZSB0aGUgY29tbWFuZCBjcmVhdGVkXG4gICAgICBjb21tYW5kcy5wdXNoKGNvbW1hbmQpO1xuICAgIH1cbiAgICAvL1dlIGRpZCBub3QgaW1wbGVtZW50ZWQgdW5kbyByZWRvIGZvciB0aGlzIG1hbmFnZXIsIGJlY2F1c2UgdW5kbyBwbGF5IHBhdXNlIGlzIGtpbmQgb2YgdXNlbGVzcyByaWdodD9cbiAgfVxufTtcblxuXG4vL09uIGxvYWQgb2YgdGhlIHBhZ2VcbndpbmRvdy5hZGRFdmVudExpc3RlbmVyKFwibG9hZFwiLGZ1bmN0aW9uKCkge1xuICAvL1RoZSBzaXplIG9mIHRoZSBjb250cm9sbGVyIGlzIHRoZSBzYW1lIHRoYW4gdGhlIHNpemUgb2YgdGhlIHZpZGVvXG4gIHNldFRpbWVvdXQoZnVuY3Rpb24oKXtcbiAgICAvLyBUaGlzIGhpZGVzIHRoZSBhZGRyZXNzIGJhcjpcbiAgICB2aWRlby5sb2FkKCk7XG4gICAgd2luZG93LnNjcm9sbFRvKDAsIDEpO1xuICAgIFxuICAgIHZhciB1YSA9IG5hdmlnYXRvci51c2VyQWdlbnQudG9Mb3dlckNhc2UoKTtcbiAgICBpZiAodWEuaW5kZXhPZignc2FmYXJpJykgIT0gLTEpIHtcbiAgICAgIGlmICh1YS5pbmRleE9mKCdjaHJvbWUnKSA+IC0xKSB7XG4gICAgICAgIC8vdmlkZW8uc3JjID0gXCIuL3B1YmxpYy9tZWRpYS9FQVQzLndlYm1cIjtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vYWxlcnQoXCIyXCIpIC8vIFNhZmFyaVxuICAgICAgICBjb25zb2xlLmxvZyhcInRlc3Qgc2FmYXJpXCIpO1xuICAgICAgICB2aWRlby5zcmMgPSBcIi4uLy4uLy4uL3B1YmxpYy9tZWRpYS93b3Jrc2hvcDIvRUFUMy5tcDRcIjtcbiAgICAgICAgY29uc29sZS5sb2coXCJ0ZXN0IHNhZmFyaSA6IFwiICsgdmlkZW8uc3JjKTtcbiAgICAgICAgdmlkZW8ubG9hZCgpO1xuICAgICAgfVxuICAgIH1cbiAgfSwgMCk7XG59KTtcbndpbmRvdy5hZGRFdmVudExpc3RlbmVyKFwic2Nyb2xsXCIsIGZ1bmN0aW9uKGV2ZW50KSB7XG4gIHRvcFdpbmRvdyA9IHRoaXMuc2Nyb2xsWTtcbiAgbGVmdFdpbmRvdyA9dGhpcy5zY3JvbGxYO1xuICAvLyBjb25zb2xlLmxvZyhcIndpbmRvdyBzY3JvbGwgOiBcIiArIGxlZnRXaW5kb3cpO1xufSwgZmFsc2UpO1xuXG5ib2R5LmFkZEV2ZW50TGlzdGVuZXIoXCJzY3JvbGxcIiwgZnVuY3Rpb24oZXZlbnQpIHtcbiAgdG9wQm9keSA9ICB0aGlzLnNjcm9sbFk7XG4gIGxlZnRCb2R5ID0gdGhpcy5zY3JvbGxYO1xuICAvL2NvbnNvbGUubG9nKFwiIGJvZHkgOiBcIisgIGJvZHkuc2Nyb2xsTGVmdCAgKTtcbn0sIGZhbHNlKTtcblxuXG4vKipcbiAqIENhbGxiYWNrIHVzZWQgKlxuICotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gKiBETyBOT1QgVVNFIFRIRVNFIEZVTkNUSU9OUyBXSVRIT1VUIEEgQ09NTUFORCFcbiAqIFRoZSBmb2xsb3dpbmcgY29kZSBzaG91bGQgYmUgY29uc2lkZXJlZCBhcyBwcml2YXRlXG4vKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi9cblxudmFyIG11dGVCdXR0b25DYWxsYmFjayA9IGZ1bmN0aW9uKGUpe1xuICBpZiAodmlkZW8ubXV0ZWQgPT09IGZhbHNlKSB7XG4gICAgLy8gTXV0ZSB0aGUgdmlkZW9cbiAgICB2aWRlby5tdXRlZCA9IHRydWU7XG4gICAgLy8gVXBkYXRlIHRoZSBidXR0b24gdGV4dFxuICAgIG11dGVCdXR0b24uaW5uZXJIVE1MID0gXCJVbm11dGVcIjtcbiAgfSBlbHNlIHtcbiAgICAvLyBVbm11dGUgdGhlIHZpZGVvXG4gICAgdmlkZW8ubXV0ZWQgPSBmYWxzZTtcbiAgICAvL3RoaXMuc3JjPVwiL21lZGlhL3dvcmtzaG9wMi92aWRlb0NvbW1hbmQvdm9sdW1lRnVsbC5wbmdcIjtcbiAgICAvLyBVcGRhdGUgdGhlIGJ1dHRvbiB0ZXh0XG4gICAgbXV0ZUJ1dHRvbi5pbm5lckhUTUwgPSBcIk11dGVcIjtcbiAgfVxufTtcblxudmFyIHJlcGV0UGFydE9mVmlkZW8gPSBmdW5jdGlvbiAoc3RhcnQsZW5kLCBudW1iZXJPZlJlcGV0aXRpb24sc3BlZWRSYXRlKSB7XG4gIC8vIGNvbnNvbGUubG9nKFwiZnVuY3Rpb24gIC0gcmVwZXRQYXJ0T2ZWaWRlb1wiICwgc3RhcnQsZW5kLCBudW1iZXJPZlJlcGV0aXRpb24sc3BlZWRSYXRlKTtcbiAgaXNQbGF5aW5nQ2FyZCA9IHRydWU7XG4gIHZpZGVvLnBsYXliYWNrUmF0ZSA9IHNwZWVkUmF0ZTtcbiAgdmlkZW8uY3VycmVudFRpbWUgPSBzdGFydDtcbiAgdmFyIHJlcGV0ID0gbnVtYmVyT2ZSZXBldGl0aW9uO1xuICBcbiAgLy9jb25zb2xlLmxvZyhcImZ1bmN0aW9uICAtIHJlcGV0UGFydE9mVmlkZW8gW3BsYXkgcGFydF0gbDg3IHZpZGVvQ29tbWFuZFwiKTtcbiAgcGxheSgpO1xuICB2aWRlby5vbnRpbWV1cGRhdGUgPSBmdW5jdGlvbigpIHtcbiAgICBpZihpc1BsYXlpbmdDYXJkKXtcbiAgICAgIGlmICgoZW5kID4gc3RhcnQgKSAmJiAgcmVwZXQgPiAwICkge1xuICAgICAgICBpZiAodmlkZW8uY3VycmVudFRpbWUgPiBlbmQpIHtcbiAgICAgICAgICByZXBldC0tO1xuICAgICAgICAgIHZpZGVvLmN1cnJlbnRUaW1lID0gc3RhcnQ7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHZpZGVvLm9udGltZXVwZGF0ZSA9IG51bGw7XG4gICAgICAgIGZlZWRiYWNrT25TbGlkZXJWaWRlbyhmYWxzZSk7XG4gICAgICAgIHZpZGVvLnBsYXliYWNrUmF0ZSA9IDE7XG4gICAgICB9XG4gICAgfVxuICB9O1xufTtcblxuZnVuY3Rpb24gY2xlYXJBbGxUaW1lcigpIHtcbiAgd2luZG93LmNsZWFySW50ZXJ2YWwodGltZXJSZXBldGl0aW9uKTtcbiAgaXNQbGF5aW5nQ2FyZCA9IGZhbHNlO1xuICB2aWRlby5wbGF5YmFja1JhdGUgPSAxO1xuICBmZWVkYmFja09uU2xpZGVyVmlkZW8oZmFsc2UpO1xufVxuXG5cbnZhciBwbGF5ID0gZnVuY3Rpb24gKCkge1xuICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgcGxheVByb21pc2UgPSB2aWRlby5wbGF5KCk7XG4gICAgaWYgKHBsYXlQcm9taXNlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHBsYXlQcm9taXNlLnRoZW4oZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgICAgIHZpZGVvLnBsYXkoKTtcbiAgICAgICAgcGxheUJ1dHRvbi5zcmMgPSAnL21lZGlhL3dvcmtzaG9wMi92aWRlb0NvbW1hbmQvcGF1c2VCdXR0b24ucG5nJztcbiAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlKSB7XG4gICAgICAgIGNvbnNvbGUubG9nKGUpO1xuICAgICAgICB2aWRlby5sb2FkKCk7XG4gICAgICAgIC8vdmlkZW8ucGF1c2UoKTtcbiAgICAgIH0pXG4gICAgXG4gICAgfVxuICB9LDI1MCk7XG59O1xuXG52YXIgcGF1c2UgPSBmdW5jdGlvbiAoKSB7XG4gIC8vY29uc29sZS5sb2coXCJhcHBlbCBhIHBhdXNlXCIpO1xuICB2aWRlby5wYXVzZSgpO1xuICBwbGF5QnV0dG9uLnNyYz0nL21lZGlhL3dvcmtzaG9wMi92aWRlb0NvbW1hbmQvcGxheUJ1dHRvbi5wbmcnO1xufTtcblxudmFyIHNlZWtUbyA9IGZ1bmN0aW9uKHN0YXJ0RHVyYXRpb25QYXJhbSl7XG4gIGNvbnNvbGUubG9nKHN0YXJ0RHVyYXRpb25QYXJhbSk7XG4gIHZpZGVvLmN1cnJlbnRUaW1lID0gc3RhcnREdXJhdGlvblBhcmFtO1xufTtcblxudmFyIHBsYXlQYXVzZWNhbGxiYWNrID0gZnVuY3Rpb24oZSl7XG4gIC8vY29uc29sZS5sb2coXCJjYWxsYmFjayBwbGF5LXBhdXNlLCBlIDogXCIgKyBlKTtcbiAgLyppZihlICE9IG51bGwgJiYgZSAhPT0gdW5kZWZpbmVkKXtcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gIH0qL1xuICBpZiAodmlkZW8ucGF1c2VkIHx8IHZpZGVvLmVuZGVkICkge1xuICAgIHZpZGVvRnVuY3Rpb25hbENvcmVNYW5hZ2VyLmV4ZWN1dGUobmV3IFBsYXlDb21tYW5kKCkpO1xuICAgIC8vcGxheSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvL3BhdXNlKCk7XG4gICAgdmlkZW9GdW5jdGlvbmFsQ29yZU1hbmFnZXIuZXhlY3V0ZShuZXcgUGF1c2VDb21tYW5kKCkpO1xuICBcbiAgfVxufTtcblxuXG4vL1VwZGF0ZSBrbm9iIG9uIGEgdGFibGV0XG52YXIgdXBkYXRlS25vYkFuZFZpZGVvID0gZnVuY3Rpb24oZXZlbnQpIHtcbiAgLy8gIHZhciBvZmZzZXRMZWZ0U2xpZGVyID0gd3JhcHBlckNvbW1hbmRBbmRSYW5nZWlkLm9mZnNldExlZnQrcmFuZ2VTbGlkZXJUcmFjay5vZmZzZXRMZWZ0ICsgZGl2aWRDb21tYW5kZVZpZGVvLm9mZnNldExlZnQ7XG4gIHZhciBvZmZzZXRMZWZ0U2xpZGVyID0gd3JhcHBlckNvbW1hbmRBbmRSYW5nZWlkLm9mZnNldExlZnQ7IC8vLSAgIDtcbiAgLy9jb25zb2xlLmxvZyhcImFhIDogIFwiICsgIGJvZHkgKTtcbiAgXG4gIHZpZGVvLmN1cnJlbnRUaW1lID0gTWF0aC5yb3VuZCgoKChldmVudC50YXJnZXRUb3VjaGVzWzBdID8gZXZlbnQudGFyZ2V0VG91Y2hlc1swXS5wYWdlWCA6IGV2ZW50LmNoYW5nZWRUb3VjaGVzW2V2ZW50LmNoYW5nZWRUb3VjaGVzLmxlbmd0aCAtIDFdLnBhZ2VYKSAtIChvZmZzZXRMZWZ0U2xpZGVyKSkgKiB2aWRlby5kdXJhdGlvbikgLyBOVU1CRVJfT0ZfVElDSyk7XG4gIC8vVXBkYXRlIGtub3cgcG9zaXRpb25cbiAga25vYk1pbi5zdHlsZS5sZWZ0ID0gKCgoKGV2ZW50LnRhcmdldFRvdWNoZXNbMF0gPyBldmVudC50YXJnZXRUb3VjaGVzWzBdLnBhZ2VYIDogZXZlbnQuY2hhbmdlZFRvdWNoZXNbZXZlbnQuY2hhbmdlZFRvdWNoZXMubGVuZ3RoIC0gMV0ucGFnZVgpKSAtIG9mZnNldExlZnRTbGlkZXIpKSArIFwicHhcIjtcbiAgaWYgKHNlZ21lbnRGZWVkYmFjay5kaXNwbGF5ZWQpIHtcbiAgICBpZiAodmlkZW8uY3VycmVudFRpbWUgPiBzZWdtZW50RmVlZGJhY2suZW5kRHVyYXRpb25WaWRlbykge1xuICAgICAgZmVlZGJhY2tPblNsaWRlclZpZGVvKGZhbHNlKTtcbiAgICB9XG4gIH1cbn07XG5cbi8vVXBkYXRlIGtub2Igb24gYSBsYXB0b3BcbnZhciB1cGRhdGVLbm9iQW5kVmlkZW9Db21wdXRlciA9IGZ1bmN0aW9uKGUpIHtcbiAgLy90YWtlIGludG8gYWNjb3VudCBvZmZzZXQgb24gdGhlIGxlZnQgb2YgdGhlIHNjcm9sbCBiYXIgKGJvZHkgc2Nyb2xsIGFuZCBjZW50ZXJpbmcgdGhlIHdyYXBwZXIpXG4gIFxuIC8vIHZhciBwb3MgPSAoZS5wYWdlWCAgLSB0aGlzLm9mZnNldExlZnQpIC8gdGhpcy5vZmZzZXRXaWR0aDtcbiAgLy8gICAgdmlkZW8uY3VycmVudFRpbWUgPSBwb3MgKiB2aWRlby5kdXJhdGlvbjtcbiAgdmFyIG9mZnNldExlZnRTbGlkZXIgPSB3cmFwcGVyQ29tbWFuZEFuZFJhbmdlaWQub2Zmc2V0TGVmdCAtIGJvZHkuc2Nyb2xsTGVmdDsgLy8tIHdpbmRvdy5zY3JvbGxMZWZ0ICA7XG4gIGN1cnJlbnRWYWx1ZUtub2IgPSAoKGUucGFnZVggLSBvZmZzZXRMZWZ0U2xpZGVyKSAqIHZpZGVvLmR1cmF0aW9uKSAvIE5VTUJFUl9PRl9USUNLO1xuICBpZiAoY3VycmVudFZhbHVlS25vYiA8IHZpZGVvLmR1cmF0aW9uICYmIGN1cnJlbnRWYWx1ZUtub2IgPj0gMCkge1xuICAgIHZpZGVvLmN1cnJlbnRUaW1lID0gKChlLnBhZ2VYIC0gb2Zmc2V0TGVmdFNsaWRlcikgKiB2aWRlby5kdXJhdGlvbikgLyBOVU1CRVJfT0ZfVElDSztcbiAgICBrbm9iTWluLnN0eWxlLmxlZnQgPSBlLnBhZ2VYIC0gKG9mZnNldExlZnRTbGlkZXIgKyBXSURUSF9NSURfS05PQl9NSU4gLyAyKSArIFwicHhcIjtcbiAgICBpZiAoc2VnbWVudEZlZWRiYWNrLmRpc3BsYXllZCkge1xuICAgICAgaWYgKHZpZGVvLmN1cnJlbnRUaW1lID4gc2VnbWVudEZlZWRiYWNrLmVuZER1cmF0aW9uVmlkZW8pIHtcbiAgICAgICAgZmVlZGJhY2tPblNsaWRlclZpZGVvKGZhbHNlKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbn07XG5cblxuXG5mdW5jdGlvbiBmZWVkYmFja09uU2xpZGVyVmlkZW8ob25PZmYpIHtcbiAgc2VnbWVudEZlZWRiYWNrLmVuZFBvc2l0aW9uID0gcGFyc2VJbnQoc2VnbWVudEZlZWRiYWNrLnN0YXJ0UG9zdGlvbikgKyBwYXJzZUludChzZWdtZW50RmVlZGJhY2sud2lkdGgpO1xuICB2YXIgc2xpZGVyVG9WID0gc2xpZGVyVG9WaWRlbyhzZWdtZW50RmVlZGJhY2suc3RhcnRQb3N0aW9uLCBzZWdtZW50RmVlZGJhY2suZW5kUG9zaXRpb24pO1xuICBzZWdtZW50RmVlZGJhY2suc3RhcnREdXJhdGlvblZpZGVvID0gc2xpZGVyVG9WLnN0YXJ0RHVyYXRpb247XG4gIHNlZ21lbnRGZWVkYmFjay5lbmREdXJhdGlvblZpZGVvID0gc2xpZGVyVG9WLmVuZER1cmF0aW9uO1xuICBzZWdtZW50RmVlZGJhY2suZGlzcGxheWVkID0gb25PZmY7XG4gIGlmIChvbk9mZikge1xuICAgIC8vc2VnbWVudEZlZWRiYWNrLmRpdkdyYXBoaWNhbE9iamVjdC5zdHlsZS5tYXJnaW5MZWZ0ID0gc2VnbWVudEZlZWRiYWNrLnN0YXJ0UG9zdGlvbjtcbiAgICAvL21pbnVzIDIgYmVjYXVzZSB3ZSBuZWVkIHRvIGdldCAyIGZyYW1lIGJlZm9yZSB0aGUgc2VnbWVudFxuICAgIHNlZ21lbnRGZWVkYmFjay5kaXZHcmFwaGljYWxPYmplY3Quc3R5bGUubWFyZ2luTGVmdCA9IHBhcnNlSW50KHNlZ21lbnRGZWVkYmFjay5zdGFydFBvc3Rpb24pICArIFwicHhcIjsgLy8gIHNlZ21lbnRGZWVkYmFjay5zdGFydFBvc3Rpb247XG4gICAgc2VnbWVudEZlZWRiYWNrLmRpdkdyYXBoaWNhbE9iamVjdC5zdHlsZS52aXNpYmlsaXR5ID0gXCJ2aXNpYmxlXCI7XG4gICAgc2VnbWVudEZlZWRiYWNrLmRpdkdyYXBoaWNhbE9iamVjdC5zdHlsZS53aWR0aCA9IHNlZ21lbnRGZWVkYmFjay53aWR0aDtcbiAgfSBlbHNlIHtcbiAgICBzZWdtZW50RmVlZGJhY2suZGl2R3JhcGhpY2FsT2JqZWN0LnN0eWxlLnZpc2liaWxpdHkgPSBcImhpZGRlblwiO1xuICB9XG59XG5cbi8qXG5cbmZ1bmN0aW9uIGZlZWRiYWNrT25TbGlkZXJWaWRlbyhvbk9mZikge1xuICBzZWdtZW50RmVlZGJhY2suZW5kUG9zaXRpb24gPSBwYXJzZUludChzZWdtZW50RmVlZGJhY2suc3RhcnRQb3N0aW9uKSArIHBhcnNlSW50KHNlZ21lbnRGZWVkYmFjay53aWR0aCkgO1xuICB2YXIgc2xpZGVyVG9WID0gc2xpZGVyVG9WaWRlbyhzZWdtZW50RmVlZGJhY2suc3RhcnRQb3N0aW9uLCBzZWdtZW50RmVlZGJhY2suZW5kUG9zaXRpb24pO1xuICBzZWdtZW50RmVlZGJhY2suc3RhcnREdXJhdGlvblZpZGVvID0gc2xpZGVyVG9WLnN0YXJ0RHVyYXRpb247XG4gIHNlZ21lbnRGZWVkYmFjay5lbmREdXJhdGlvblZpZGVvID0gc2xpZGVyVG9WLmVuZER1cmF0aW9uO1xuICBzZWdtZW50RmVlZGJhY2suZGlzcGxheWVkID0gb25PZmY7XG4gIGlmIChvbk9mZikge1xuICAgIC8vc2VnbWVudEZlZWRiYWNrLmRpdkdyYXBoaWNhbE9iamVjdC5zdHlsZS5tYXJnaW5MZWZ0ID0gc2VnbWVudEZlZWRiYWNrLnN0YXJ0UG9zdGlvbjtcbiAgICAvL21pbnVzIDIgYmVjYXVzZSB3ZSBuZWVkIHRvIGdldCAyIGZyYW1lIGJlZm9yZSB0aGUgc2VnbWVudFxuICAgIHNlZ21lbnRGZWVkYmFjay5kaXZHcmFwaGljYWxPYmplY3Quc3R5bGUubWFyZ2luTGVmdCA9IHBhcnNlSW50KHNlZ21lbnRGZWVkYmFjay5zdGFydFBvc3Rpb24pIC0gMTAwICsgXCJweFwiOyAvLyAgc2VnbWVudEZlZWRiYWNrLnN0YXJ0UG9zdGlvbjtcbiAgICBzZWdtZW50RmVlZGJhY2suZGl2R3JhcGhpY2FsT2JqZWN0LnN0eWxlLnZpc2liaWxpdHkgPSBcInZpc2libGVcIjtcbiAgICBzZWdtZW50RmVlZGJhY2suZGl2R3JhcGhpY2FsT2JqZWN0LnN0eWxlLndpZHRoID0gc2VnbWVudEZlZWRiYWNrLndpZHRoIDtcbiAgfSBlbHNlIHtcbiAgICBzZWdtZW50RmVlZGJhY2suZGl2R3JhcGhpY2FsT2JqZWN0LnN0eWxlLnZpc2liaWxpdHkgPSBcImhpZGRlblwiO1xuICB9XG59XG4qL1xuXG5cbmZ1bmN0aW9uIHVwZGF0ZVRpbWVyVmlkZW8oKSB7XG4gIGxldCBtaW51dGVzID0gTWF0aC5mbG9vcih2aWRlby5jdXJyZW50VGltZSAvIDYwKTtcbiAgbGV0IHNlY29uZHMgPSBNYXRoLmZsb29yKHZpZGVvLmN1cnJlbnRUaW1lIC0gbWludXRlcyAqIDYwKTtcbiAgaWYgKHNlY29uZHMgPCAxMClcbiAgICBzZWNvbmRzID0gXCIwXCIgKyBzZWNvbmRzO1xuICB0aW1lclZpZGVvLmlubmVySFRNTCA9IG1pbnV0ZXMgKyBcIjpcIiArIHNlY29uZHMgKyBcIi9cIiArIHZpZGVvRHVyYXRpb247XG59XG5cbi8vc3RhcnQgcG9zaXRpb24gb24gdGhlIHNsaWRlciBhbmQgZW5kIHBvc2l0aW9uIG9uIHRoZSBzbGlkZXJcbmZ1bmN0aW9uIHNsaWRlclRvVmlkZW8oc3RhcnRQLCBlbmRQKSB7XG4gIGlmKHN0YXJ0UCA8IDAgKXtcbiAgICBzdGFydFAgPSAwO1xuICB9XG4gIHZhciBzdGFydER1cmF0aW9uID0gTWF0aC5yb3VuZCgoKHN0YXJ0UCAqIHZpZGVvLmR1cmF0aW9uKSAvIE5VTUJFUl9PRl9USUNLKSk7XG4gIHZhciBlbmREdXJhdGlvbiA9IE1hdGgucm91bmQoKChlbmRQICogdmlkZW8uZHVyYXRpb24pIC8gTlVNQkVSX09GX1RJQ0spKTtcbiAgXG4gIHJldHVybiB7XG4gICAgc3RhcnREdXJhdGlvbjogc3RhcnREdXJhdGlvbixcbiAgICBlbmREdXJhdGlvbjogZW5kRHVyYXRpb25cbiAgfTtcbn1cblxuIl19