"use strict";

var video_vjs = document.getElementById("videovjs");

var speedrate = 1;
// Buttons
var playButton = document.getElementById("play-pause");
var muteButton = document.getElementById("mute");
// Sliders
var knobMin = document.getElementById("range-slider_handle-min");
var rangeSliderTrack = document.getElementById("rangeSliderTrack");

var divCardBoard = document.getElementById("divCardBoard");
var body = document.getElementsByTagName("BODY")[0];

//Je ne saiss pas comment rendre cette ligne automatique pour l'isntant, pourtant la taille est en auto...
var WIDTH_RANGE_SLIDER_TRACK = "960px";
//Donc pour l'instant je reste comme Ã§a
rangeSliderTrack.style.width = WIDTH_RANGE_SLIDER_TRACK;

var isPlayingCard = false;

var mirrored = false;

var commands = [];
/**
 * Access point to the functional core, you can just execute command from here
 * @return {{execute: execute}}
 * @constructor
 */
var VideoFunctionalCoreManager = function VideoFunctionalCoreManager() {
  //This is a command pattern, see : https://www.dofactory.com/javascript/command-design-pattern
  return {
    //execute a command
    execute: function execute(command) {
      switch (command.execute.name) {
        case "repetPartOfVideo":
          {
            command.execute(command.start, command.end, command.numberOfRepetition, command.speedRate);
            break;
          }
        case "updateKnobAndVideoComputer":
          command.execute(command.e);
          break;
        default:
          command.execute();
          break;
      }
      //We send the command to the server (the server log it into a file, see ./src/server/ServerLogger)
      logger.sendAndLogCommand(command);
      //and we save the command created
      commands.push(command);
    }
    //We did not implemented undo redo for this manager, because undo play pause is kind of useless right?
  };
};

//On load of the page
window.addEventListener("load", function () {
  //The size of the controller is the same than the size of the video
  setTimeout(function () {
    // This hides the address bar:
    //console.log(videovjs);
    //videovjs.load();
    window.scrollTo(0, 1);

    var ua = navigator.userAgent.toLowerCase();
    if (ua.indexOf('safari') != -1) {
      if (ua.indexOf('chrome') > -1) {} else {
        //alert("2") // Safari
        console.log("test safari : " + video_vjs.src);
        video_vjs.load();
      }
    }
  }, 0);
});
window.addEventListener("scroll", function (event) {
  topWindow = this.scrollY;
  leftWindow = this.scrollX;
  // console.log("window scroll : " + leftWindow);
}, false);

body.addEventListener("scroll", function (event) {
  topBody = this.scrollY;
  leftBody = this.scrollX;
  //console.log(" body : "+  body.scrollLeft  );
}, false);

/**
 * Callback used *
 *-------------------------------
 * DO NOT USE THESE FUNCTIONS WITHOUT A COMMAND!
 * The following code should be considered as private
/*------------------------------- */

var muteButtonCallback = function muteButtonCallback(e) {
  if (video_vjs.muted === false) {
    // Mute the video
    video_vjs.muted = true;
    // Update the button text
    muteButton.innerHTML = "Unmute";
  } else {
    // Unmute the video
    video_vjs.muted = false;
    // Update the button text
    muteButton.innerHTML = "Mute";
  }
};

var repetPartOfVideo = function repetPartOfVideo(start, end, numberOfRepetition, speedRate) {
  // console.log("function  - repetPartOfVideo" , start,end, numberOfRepetition,speedRate);
  isPlayingCard = true;
  video_vjs.playbackRate = speedRate;
  video_vjs.currentTime = start;
  var repet = numberOfRepetition;

  //console.log("function  - repetPartOfVideo [play part] l87 videoCommand");
  play();
  video_vjs.ontimeupdate = function () {
    if (isPlayingCard) {
      if (end > start && repet > 0) {
        if (video_vjs.currentTime > end) {
          repet--;
          video_vjs.currentTime = start;
        }
      } else {
        video_vjs.ontimeupdate = null;
        feedbackOnSliderVideo(false);
        video_vjs.playbackRate = 1;
      }
    }
  };
};

function clearAllTimer() {
  window.clearInterval(timerRepetition);
  isPlayingCard = false;
  video_vjs.playbackRate = 1;
  feedbackOnSliderVideo(false);
}

var play = function play() {
  setTimeout(function () {
    var playPromise = video_vjs.play();
    if (playPromise !== undefined) {
      playPromise.then(function (value) {
        video.play();
        playButton.src = '/media/workshop2/videoCommand/pauseButton.png';
      }).catch(function (e) {
        video_vjs.load();
        //video.pause();
      });
    }
  }, 250);
};

var pause = function pause() {
  //console.log("appel a pause");
  video_vjs.pause();
  playButton.src = '/media/workshop2/videoCommand/playButton.png';
};

var seekTo = function seekTo(startDurationParam) {
  if (startDurationParam < video_vjs.currentTime) video_vjs.currentTime = startDurationParam;
};

var playPausecallback = function playPausecallback(e) {
  //console.log("callback play-pause, e : " + e);
  /*if(e != null && e !== undefined){
    e.preventDefault();
  }*/
  if (video_vjs.paused || video_vjs.ended) {
    videoFunctionalCoreManager.execute(new PlayCommand());
    //play();
  } else {
    //pause();
    videoFunctionalCoreManager.execute(new PauseCommand());
  }
};

var mirror = function mirror() {
  if (mirrored) {
    video_vjs.style.transform = "rotateY(" + 0 + "deg)";
    mirrored = false;
  } else {
    video_vjs.style.transform = "rotateY(" + 180 + "deg)";
    mirrored = true;
  }
};

var setSource = function setSource(source) {
  video_vjs.src = source;
};

//Update knob on a tablet
var updateKnobAndVideo = function updateKnobAndVideo(event) {
  //  var offsetLeftSlider = wrapperCommandAndRangeid.offsetLeft+rangeSliderTrack.offsetLeft + dividCommandeVideo.offsetLeft;
  var offsetLeftSlider = wrapperCommandAndRangeid.offsetLeft; //-   ;
  video_vjs.currentTime = Math.round(((event.targetTouches[0] ? event.targetTouches[0].pageX : event.changedTouches[event.changedTouches.length - 1].pageX) - offsetLeftSlider) * video_vjs.duration / NUMBER_OF_TICK);
  //Update know position
  knobMin.style.left = (event.targetTouches[0] ? event.targetTouches[0].pageX : event.changedTouches[event.changedTouches.length - 1].pageX) - offsetLeftSlider + "px";
  if (segmentFeedback.displayed) {
    if (video_vjs.currentTime > segmentFeedback.endDurationVideo) {
      feedbackOnSliderVideo(false);
    }
  }
};

//Update knob on a laptop
var updateKnobAndVideoComputer = function updateKnobAndVideoComputer(e) {
  //take into account offset on the left of the scroll bar (body scroll and centering the wrapper)
  // var pos = (e.pageX  - this.offsetLeft) / this.offsetWidth;
  //    video.currentTime = pos * video.duration;
  var offsetLeftSlider = wrapperCommandAndRangeid.offsetLeft - body.scrollLeft; //- window.scrollLeft  ;
  currentValueKnob = (e.pageX - offsetLeftSlider) * video_vjs.duration / NUMBER_OF_TICK;
  if (currentValueKnob < video_vjs.duration && currentValueKnob >= 0) {
    video_vjs.currentTime = (e.pageX - offsetLeftSlider) * video_vjs.duration / NUMBER_OF_TICK;
    knobMin.style.left = e.pageX - (offsetLeftSlider + WIDTH_MID_KNOB_MIN / 2) + "px";
    if (segmentFeedback.displayed) {
      if (video_vjs.currentTime > segmentFeedback.endDurationVideo) {
        feedbackOnSliderVideo(false);
      }
    }
  }
};

function feedbackOnSliderVideo(onOff) {
  segmentFeedback.endPosition = parseInt(segmentFeedback.startPostion) + parseInt(segmentFeedback.width);
  var sliderToV = sliderToVideo(segmentFeedback.startPostion, segmentFeedback.endPosition);
  segmentFeedback.startDurationVideo = sliderToV.startDuration;
  segmentFeedback.endDurationVideo = sliderToV.endDuration;
  segmentFeedback.displayed = onOff;
  if (onOff) {
    //segmentFeedback.divGraphicalObject.style.marginLeft = segmentFeedback.startPostion;
    //minus 2 because we need to get 2 frame before the segment
    segmentFeedback.divGraphicalObject.style.marginLeft = parseInt(segmentFeedback.startPostion) + "px"; //  segmentFeedback.startPostion;
    segmentFeedback.divGraphicalObject.style.visibility = "visible";
    segmentFeedback.divGraphicalObject.style.width = segmentFeedback.width;
  } else {
    segmentFeedback.divGraphicalObject.style.visibility = "hidden";
  }
}

/*

function feedbackOnSliderVideo(onOff) {
  segmentFeedback.endPosition = parseInt(segmentFeedback.startPostion) + parseInt(segmentFeedback.width) ;
  var sliderToV = sliderToVideo(segmentFeedback.startPostion, segmentFeedback.endPosition);
  segmentFeedback.startDurationVideo = sliderToV.startDuration;
  segmentFeedback.endDurationVideo = sliderToV.endDuration;
  segmentFeedback.displayed = onOff;
  if (onOff) {
    //segmentFeedback.divGraphicalObject.style.marginLeft = segmentFeedback.startPostion;
    //minus 2 because we need to get 2 frame before the segment
    segmentFeedback.divGraphicalObject.style.marginLeft = parseInt(segmentFeedback.startPostion) - 100 + "px"; //  segmentFeedback.startPostion;
    segmentFeedback.divGraphicalObject.style.visibility = "visible";
    segmentFeedback.divGraphicalObject.style.width = segmentFeedback.width ;
  } else {
    segmentFeedback.divGraphicalObject.style.visibility = "hidden";
  }
}
*/

function updateTimerVideo() {

  var minutes = Math.floor(video_vjs.currentTime / 60);
  var seconds = Math.floor(video_vjs.currentTime - minutes * 60);

  var minutesV = Math.floor(video_vjs.duration / 60);
  var secondsV = Math.floor(video_vjs.duration - minutes * 60);
  if (isNaN(minutesV) || isNaN(secondsV)) {
    minutesV = 0;
    secondsV = 0;
  }
  if (seconds < 10) seconds = "0" + seconds;
  //timerVideo.innerHTML = minutes + ":" + seconds + "/" + minutesV+":" +  secondsV ;
}

//start position on the slider and end position on the slider
function sliderToVideo(startP, endP) {
  if (startP < 0) {
    startP = 0;
  }
  var startDuration = Math.round(startP * video_vjs.duration / NUMBER_OF_TICK);
  var endDuration = Math.round(endP * video_vjs.duration / NUMBER_OF_TICK);

  return {
    startDuration: startDuration,
    endDuration: endDuration
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInZpZGVvRnVuY3Rpb25hbENvcmUuanMiXSwibmFtZXMiOlsidmlkZW9fdmpzIiwiZG9jdW1lbnQiLCJnZXRFbGVtZW50QnlJZCIsInNwZWVkcmF0ZSIsInBsYXlCdXR0b24iLCJtdXRlQnV0dG9uIiwia25vYk1pbiIsInJhbmdlU2xpZGVyVHJhY2siLCJkaXZDYXJkQm9hcmQiLCJib2R5IiwiZ2V0RWxlbWVudHNCeVRhZ05hbWUiLCJXSURUSF9SQU5HRV9TTElERVJfVFJBQ0siLCJzdHlsZSIsIndpZHRoIiwiaXNQbGF5aW5nQ2FyZCIsIm1pcnJvcmVkIiwiY29tbWFuZHMiLCJWaWRlb0Z1bmN0aW9uYWxDb3JlTWFuYWdlciIsImV4ZWN1dGUiLCJjb21tYW5kIiwibmFtZSIsInN0YXJ0IiwiZW5kIiwibnVtYmVyT2ZSZXBldGl0aW9uIiwic3BlZWRSYXRlIiwiZSIsImxvZ2dlciIsInNlbmRBbmRMb2dDb21tYW5kIiwicHVzaCIsIndpbmRvdyIsImFkZEV2ZW50TGlzdGVuZXIiLCJzZXRUaW1lb3V0Iiwic2Nyb2xsVG8iLCJ1YSIsIm5hdmlnYXRvciIsInVzZXJBZ2VudCIsInRvTG93ZXJDYXNlIiwiaW5kZXhPZiIsImNvbnNvbGUiLCJsb2ciLCJzcmMiLCJsb2FkIiwiZXZlbnQiLCJ0b3BXaW5kb3ciLCJzY3JvbGxZIiwibGVmdFdpbmRvdyIsInNjcm9sbFgiLCJ0b3BCb2R5IiwibGVmdEJvZHkiLCJtdXRlQnV0dG9uQ2FsbGJhY2siLCJtdXRlZCIsImlubmVySFRNTCIsInJlcGV0UGFydE9mVmlkZW8iLCJwbGF5YmFja1JhdGUiLCJjdXJyZW50VGltZSIsInJlcGV0IiwicGxheSIsIm9udGltZXVwZGF0ZSIsImZlZWRiYWNrT25TbGlkZXJWaWRlbyIsImNsZWFyQWxsVGltZXIiLCJjbGVhckludGVydmFsIiwidGltZXJSZXBldGl0aW9uIiwicGxheVByb21pc2UiLCJ1bmRlZmluZWQiLCJ0aGVuIiwidmFsdWUiLCJ2aWRlbyIsImNhdGNoIiwicGF1c2UiLCJzZWVrVG8iLCJzdGFydER1cmF0aW9uUGFyYW0iLCJwbGF5UGF1c2VjYWxsYmFjayIsInBhdXNlZCIsImVuZGVkIiwidmlkZW9GdW5jdGlvbmFsQ29yZU1hbmFnZXIiLCJQbGF5Q29tbWFuZCIsIlBhdXNlQ29tbWFuZCIsIm1pcnJvciIsInRyYW5zZm9ybSIsInNldFNvdXJjZSIsInNvdXJjZSIsInVwZGF0ZUtub2JBbmRWaWRlbyIsIm9mZnNldExlZnRTbGlkZXIiLCJ3cmFwcGVyQ29tbWFuZEFuZFJhbmdlaWQiLCJvZmZzZXRMZWZ0IiwiTWF0aCIsInJvdW5kIiwidGFyZ2V0VG91Y2hlcyIsInBhZ2VYIiwiY2hhbmdlZFRvdWNoZXMiLCJsZW5ndGgiLCJkdXJhdGlvbiIsIk5VTUJFUl9PRl9USUNLIiwibGVmdCIsInNlZ21lbnRGZWVkYmFjayIsImRpc3BsYXllZCIsImVuZER1cmF0aW9uVmlkZW8iLCJ1cGRhdGVLbm9iQW5kVmlkZW9Db21wdXRlciIsInNjcm9sbExlZnQiLCJjdXJyZW50VmFsdWVLbm9iIiwiV0lEVEhfTUlEX0tOT0JfTUlOIiwib25PZmYiLCJlbmRQb3NpdGlvbiIsInBhcnNlSW50Iiwic3RhcnRQb3N0aW9uIiwic2xpZGVyVG9WIiwic2xpZGVyVG9WaWRlbyIsInN0YXJ0RHVyYXRpb25WaWRlbyIsInN0YXJ0RHVyYXRpb24iLCJlbmREdXJhdGlvbiIsImRpdkdyYXBoaWNhbE9iamVjdCIsIm1hcmdpbkxlZnQiLCJ2aXNpYmlsaXR5IiwidXBkYXRlVGltZXJWaWRlbyIsIm1pbnV0ZXMiLCJmbG9vciIsInNlY29uZHMiLCJtaW51dGVzViIsInNlY29uZHNWIiwiaXNOYU4iLCJzdGFydFAiLCJlbmRQIl0sIm1hcHBpbmdzIjoiOztBQUFBLElBQUlBLFlBQVlDLFNBQVNDLGNBQVQsQ0FBd0IsVUFBeEIsQ0FBaEI7O0FBRUEsSUFBSUMsWUFBWSxDQUFoQjtBQUNBO0FBQ0EsSUFBSUMsYUFBYUgsU0FBU0MsY0FBVCxDQUF3QixZQUF4QixDQUFqQjtBQUNBLElBQUlHLGFBQWFKLFNB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RUxDLGlCQUFhQTtBQUZSLEdBQVA7QUFJRCIsImZpbGUiOiJ2aWRlb0Z1bmN0aW9uYWxDb3JlLmpzIiwic291cmNlc0NvbnRlbnQiOlsidmFyIHZpZGVvX3ZqcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwidmlkZW92anNcIik7XG5cbnZhciBzcGVlZHJhdGUgPSAxO1xuLy8gQnV0dG9uc1xudmFyIHBsYXlCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInBsYXktcGF1c2VcIik7XG52YXIgbXV0ZUJ1dHRvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwibXV0ZVwiKTtcbi8vIFNsaWRlcnNcbnZhciBrbm9iTWluID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJyYW5nZS1zbGlkZXJfaGFuZGxlLW1pblwiKTtcbnZhciByYW5nZVNsaWRlclRyYWNrID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJyYW5nZVNsaWRlclRyYWNrXCIpO1xuXG52YXIgZGl2Q2FyZEJvYXJkID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJkaXZDYXJkQm9hcmRcIik7XG52YXIgYm9keSA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKFwiQk9EWVwiKVswXTtcblxuLy9KZSBuZSBzYWlzcyBwYXMgY29tbWVudCByZW5kcmUgY2V0dGUgbGlnbmUgYXV0b21hdGlxdWUgcG91ciBsJ2lzbnRhbnQsIHBvdXJ0YW50IGxhIHRhaWxsZSBlc3QgZW4gYXV0by4uLlxudmFyIFdJRFRIX1JBTkdFX1NMSURFUl9UUkFDSyA9IFwiOTYwcHhcIjtcbi8vRG9uYyBwb3VyIGwnaW5zdGFudCBqZSByZXN0ZSBjb21tZSDDp2FcbnJhbmdlU2xpZGVyVHJhY2suc3R5bGUud2lkdGggPSBXSURUSF9SQU5HRV9TTElERVJfVFJBQ0s7XG5cbnZhciBpc1BsYXlpbmdDYXJkID0gZmFsc2U7XG5cbnZhciBtaXJyb3JlZCA9IGZhbHNlO1xuXG52YXIgY29tbWFuZHMgPSBbXTtcbi8qKlxuICogQWNjZXNzIHBvaW50IHRvIHRoZSBmdW5jdGlvbmFsIGNvcmUsIHlvdSBjYW4ganVzdCBleGVjdXRlIGNvbW1hbmQgZnJvbSBoZXJlXG4gKiBAcmV0dXJuIHt7ZXhlY3V0ZTogZXhlY3V0ZX19XG4gKiBAY29uc3RydWN0b3JcbiAqL1xudmFyIFZpZGVvRnVuY3Rpb25hbENvcmVNYW5hZ2VyID0gZnVuY3Rpb24oKSB7XG4gIC8vVGhpcyBpcyBhIGNvbW1hbmQgcGF0dGVybiwgc2VlIDogaHR0cHM6Ly93d3cuZG9mYWN0b3J5LmNvbS9qYXZhc2NyaXB0L2NvbW1hbmQtZGVzaWduLXBhdHRlcm5cbiAgcmV0dXJuIHtcbiAgICAvL2V4ZWN1dGUgYSBjb21tYW5kXG4gICAgZXhlY3V0ZTogZnVuY3Rpb24oY29tbWFuZCkge1xuICAgICAgc3dpdGNoIChjb21tYW5kLmV4ZWN1dGUubmFtZSl7XG4gICAgICAgIGNhc2UgXCJyZXBldFBhcnRPZlZpZGVvXCIgOiB7XG4gICAgICAgICAgY29tbWFuZC5leGVjdXRlKGNvbW1hbmQuc3RhcnQsY29tbWFuZC5lbmQsY29tbWFuZC5udW1iZXJPZlJlcGV0aXRpb24sY29tbWFuZC5zcGVlZFJhdGUpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGNhc2UgXCJ1cGRhdGVLbm9iQW5kVmlkZW9Db21wdXRlclwiIDpcbiAgICAgICAgICBjb21tYW5kLmV4ZWN1dGUoY29tbWFuZC5lKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICBjb21tYW5kLmV4ZWN1dGUoKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgIH1cbiAgICAgIC8vV2Ugc2VuZCB0aGUgY29tbWFuZCB0byB0aGUgc2VydmVyICh0aGUgc2VydmVyIGxvZyBpdCBpbnRvIGEgZmlsZSwgc2VlIC4vc3JjL3NlcnZlci9TZXJ2ZXJMb2dnZXIpXG4gICAgICBsb2dnZXIuc2VuZEFuZExvZ0NvbW1hbmQoY29tbWFuZCk7XG4gICAgICAvL2FuZCB3ZSBzYXZlIHRoZSBjb21tYW5kIGNyZWF0ZWRcbiAgICAgIGNvbW1hbmRzLnB1c2goY29tbWFuZCk7XG4gICAgfVxuICAgIC8vV2UgZGlkIG5vdCBpbXBsZW1lbnRlZCB1bmRvIHJlZG8gZm9yIHRoaXMgbWFuYWdlciwgYmVjYXVzZSB1bmRvIHBsYXkgcGF1c2UgaXMga2luZCBvZiB1c2VsZXNzIHJpZ2h0P1xuICB9XG59O1xuXG5cbi8vT24gbG9hZCBvZiB0aGUgcGFnZVxud2luZG93LmFkZEV2ZW50TGlzdGVuZXIoXCJsb2FkXCIsZnVuY3Rpb24oKSB7XG4gIC8vVGhlIHNpemUgb2YgdGhlIGNvbnRyb2xsZXIgaXMgdGhlIHNhbWUgdGhhbiB0aGUgc2l6ZSBvZiB0aGUgdmlkZW9cbiAgc2V0VGltZW91dChmdW5jdGlvbigpe1xuICAgIC8vIFRoaXMgaGlkZXMgdGhlIGFkZHJlc3MgYmFyOlxuICAgIC8vY29uc29sZS5sb2codmlkZW92anMpO1xuICAgIC8vdmlkZW92anMubG9hZCgpO1xuICAgIHdpbmRvdy5zY3JvbGxUbygwLCAxKTtcbiAgICBcbiAgICB2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCk7XG4gICAgaWYgKHVhLmluZGV4T2YoJ3NhZmFyaScpICE9IC0xKSB7XG4gICAgICBpZiAodWEuaW5kZXhPZignY2hyb21lJykgPiAtMSkge1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy9hbGVydChcIjJcIikgLy8gU2FmYXJpXG4gICAgICAgIGNvbnNvbGUubG9nKFwidGVzdCBzYWZhcmkgOiBcIiArIHZpZGVvX3Zqcy5zcmMpO1xuICAgICAgICB2aWRlb192anMubG9hZCgpO1xuICAgICAgICBcbiAgICAgIH1cbiAgICB9XG4gIH0sIDApO1xufSk7XG53aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihcInNjcm9sbFwiLCBmdW5jdGlvbihldmVudCkge1xuICB0b3BXaW5kb3cgPSB0aGlzLnNjcm9sbFk7XG4gIGxlZnRXaW5kb3cgPXRoaXMuc2Nyb2xsWDtcbiAgLy8gY29uc29sZS5sb2coXCJ3aW5kb3cgc2Nyb2xsIDogXCIgKyBsZWZ0V2luZG93KTtcbn0sIGZhbHNlKTtcblxuYm9keS5hZGRFdmVudExpc3RlbmVyKFwic2Nyb2xsXCIsIGZ1bmN0aW9uKGV2ZW50KSB7XG4gIHRvcEJvZHkgPSAgdGhpcy5zY3JvbGxZO1xuICBsZWZ0Qm9keSA9IHRoaXMuc2Nyb2xsWDtcbiAgLy9jb25zb2xlLmxvZyhcIiBib2R5IDogXCIrICBib2R5LnNjcm9sbExlZnQgICk7XG59LCBmYWxzZSk7XG5cblxuLyoqXG4gKiBDYWxsYmFjayB1c2VkICpcbiAqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICogRE8gTk9UIFVTRSBUSEVTRSBGVU5DVElPTlMgV0lUSE9VVCBBIENPTU1BTkQhXG4gKiBUaGUgZm9sbG93aW5nIGNvZGUgc2hvdWxkIGJlIGNvbnNpZGVyZWQgYXMgcHJpdmF0ZVxuLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovXG5cbnZhciBtdXRlQnV0dG9uQ2FsbGJhY2sgPSBmdW5jdGlvbihlKXtcbiAgaWYgKHZpZGVvX3Zqcy5tdXRlZCA9PT0gZmFsc2UpIHtcbiAgICAvLyBNdXRlIHRoZSB2aWRlb1xuICAgIHZpZGVvX3Zqcy5tdXRlZCA9IHRydWU7XG4gICAgLy8gVXBkYXRlIHRoZSBidXR0b24gdGV4dFxuICAgIG11dGVCdXR0b24uaW5uZXJIVE1MID0gXCJVbm11dGVcIjtcbiAgfSBlbHNlIHtcbiAgICAvLyBVbm11dGUgdGhlIHZpZGVvXG4gICAgdmlkZW9fdmpzLm11dGVkID0gZmFsc2U7XG4gICAgLy8gVXBkYXRlIHRoZSBidXR0b24gdGV4dFxuICAgIG11dGVCdXR0b24uaW5uZXJIVE1MID0gXCJNdXRlXCI7XG4gIH1cbn07XG5cbnZhciByZXBldFBhcnRPZlZpZGVvID0gZnVuY3Rpb24gKHN0YXJ0LGVuZCwgbnVtYmVyT2ZSZXBldGl0aW9uLHNwZWVkUmF0ZSkge1xuICAvLyBjb25zb2xlLmxvZyhcImZ1bmN0aW9uICAtIHJlcGV0UGFydE9mVmlkZW9cIiAsIHN0YXJ0LGVuZCwgbnVtYmVyT2ZSZXBldGl0aW9uLHNwZWVkUmF0ZSk7XG4gIGlzUGxheWluZ0NhcmQgPSB0cnVlO1xuICB2aWRlb192anMucGxheWJhY2tSYXRlID0gc3BlZWRSYXRlO1xuICB2aWRlb192anMuY3VycmVudFRpbWUgPSBzdGFydDtcbiAgdmFyIHJlcGV0ID0gbnVtYmVyT2ZSZXBldGl0aW9uO1xuICBcbiAgLy9jb25zb2xlLmxvZyhcImZ1bmN0aW9uICAtIHJlcGV0UGFydE9mVmlkZW8gW3BsYXkgcGFydF0gbDg3IHZpZGVvQ29tbWFuZFwiKTtcbiAgcGxheSgpO1xuICB2aWRlb192anMub250aW1ldXBkYXRlID0gZnVuY3Rpb24oKSB7XG4gICAgaWYoaXNQbGF5aW5nQ2FyZCl7XG4gICAgICBpZiAoKGVuZCA+IHN0YXJ0ICkgJiYgIHJlcGV0ID4gMCApIHtcbiAgICAgICAgaWYgKHZpZGVvX3Zqcy5jdXJyZW50VGltZSA+IGVuZCkge1xuICAgICAgICAgIHJlcGV0LS07XG4gICAgICAgICAgdmlkZW9fdmpzLmN1cnJlbnRUaW1lID0gc3RhcnQ7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHZpZGVvX3Zqcy5vbnRpbWV1cGRhdGUgPSBudWxsO1xuICAgICAgICBmZWVkYmFja09uU2xpZGVyVmlkZW8oZmFsc2UpO1xuICAgICAgICB2aWRlb192anMucGxheWJhY2tSYXRlID0gMTtcbiAgICAgIH1cbiAgICB9XG4gIH07XG59O1xuXG5mdW5jdGlvbiBjbGVhckFsbFRpbWVyKCkge1xuICB3aW5kb3cuY2xlYXJJbnRlcnZhbCh0aW1lclJlcGV0aXRpb24pO1xuICBpc1BsYXlpbmdDYXJkID0gZmFsc2U7XG4gIHZpZGVvX3Zqcy5wbGF5YmFja1JhdGUgPSAxO1xuICBmZWVkYmFja09uU2xpZGVyVmlkZW8oZmFsc2UpO1xufVxuXG5cbnZhciBwbGF5ID0gZnVuY3Rpb24gKCkge1xuICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgcGxheVByb21pc2UgPSB2aWRlb192anMucGxheSgpO1xuICAgIGlmIChwbGF5UHJvbWlzZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBwbGF5UHJvbWlzZS50aGVuKGZ1bmN0aW9uICh2YWx1ZSkge1xuICAgICAgICB2aWRlby5wbGF5KCk7XG4gICAgICAgIHBsYXlCdXR0b24uc3JjID0gJy9tZWRpYS93b3Jrc2hvcDIvdmlkZW9Db21tYW5kL3BhdXNlQnV0dG9uLnBuZyc7XG4gICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZSkge1xuICAgICAgICB2aWRlb192anMubG9hZCgpO1xuICAgICAgICAvL3ZpZGVvLnBhdXNlKCk7XG4gICAgICB9KVxuICAgIFxuICAgIH1cbiAgfSwyNTApO1xufTtcblxudmFyIHBhdXNlID0gZnVuY3Rpb24gKCkge1xuICAvL2NvbnNvbGUubG9nKFwiYXBwZWwgYSBwYXVzZVwiKTtcbiAgdmlkZW9fdmpzLnBhdXNlKCk7XG4gIHBsYXlCdXR0b24uc3JjPScvbWVkaWEvd29ya3Nob3AyL3ZpZGVvQ29tbWFuZC9wbGF5QnV0dG9uLnBuZyc7XG59O1xuXG52YXIgc2Vla1RvID0gZnVuY3Rpb24oc3RhcnREdXJhdGlvblBhcmFtKXtcbiAgaWYoc3RhcnREdXJhdGlvblBhcmFtIDwgdmlkZW9fdmpzLmN1cnJlbnRUaW1lIClcbiAgICB2aWRlb192anMuY3VycmVudFRpbWUgPSBzdGFydER1cmF0aW9uUGFyYW07XG59O1xuXG52YXIgcGxheVBhdXNlY2FsbGJhY2sgPSBmdW5jdGlvbihlKXtcbiAgLy9jb25zb2xlLmxvZyhcImNhbGxiYWNrIHBsYXktcGF1c2UsIGUgOiBcIiArIGUpO1xuICAvKmlmKGUgIT0gbnVsbCAmJiBlICE9PSB1bmRlZmluZWQpe1xuICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgfSovXG4gIGlmICh2aWRlb192anMucGF1c2VkIHx8IHZpZGVvX3Zqcy5lbmRlZCApIHtcbiAgICB2aWRlb0Z1bmN0aW9uYWxDb3JlTWFuYWdlci5leGVjdXRlKG5ldyBQbGF5Q29tbWFuZCgpKTtcbiAgICAvL3BsYXkoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy9wYXVzZSgpO1xuICAgIHZpZGVvRnVuY3Rpb25hbENvcmVNYW5hZ2VyLmV4ZWN1dGUobmV3IFBhdXNlQ29tbWFuZCgpKTtcbiAgXG4gIH1cbn07XG5cbnZhciBtaXJyb3IgPSBmdW5jdGlvbiAoKSB7XG4gIGlmKG1pcnJvcmVkKXtcbiAgICB2aWRlb192anMuc3R5bGUudHJhbnNmb3JtID0gIFwicm90YXRlWShcIisgMCArXCJkZWcpXCI7XG4gICAgbWlycm9yZWQgPSBmYWxzZTtcbiAgfSBlbHNlIHtcbiAgICB2aWRlb192anMuc3R5bGUudHJhbnNmb3JtID0gIFwicm90YXRlWShcIisgMTgwICtcImRlZylcIjtcbiAgICBtaXJyb3JlZCA9IHRydWU7XG4gIH1cbn07XG5cbnZhciBzZXRTb3VyY2UgPSBmdW5jdGlvbihzb3VyY2Upe1xuICB2aWRlb192anMuc3JjID0gc291cmNlO1xufTtcblxuLy9VcGRhdGUga25vYiBvbiBhIHRhYmxldFxudmFyIHVwZGF0ZUtub2JBbmRWaWRlbyA9IGZ1bmN0aW9uKGV2ZW50KSB7XG4gIC8vICB2YXIgb2Zmc2V0TGVmdFNsaWRlciA9IHdyYXBwZXJDb21tYW5kQW5kUmFuZ2VpZC5vZmZzZXRMZWZ0K3JhbmdlU2xpZGVyVHJhY2sub2Zmc2V0TGVmdCArIGRpdmlkQ29tbWFuZGVWaWRlby5vZmZzZXRMZWZ0O1xuICB2YXIgb2Zmc2V0TGVmdFNsaWRlciA9IHdyYXBwZXJDb21tYW5kQW5kUmFuZ2VpZC5vZmZzZXRMZWZ0OyAvLy0gICA7XG4gIHZpZGVvX3Zqcy5jdXJyZW50VGltZSA9IE1hdGgucm91bmQoKCgoZXZlbnQudGFyZ2V0VG91Y2hlc1swXSA/IGV2ZW50LnRhcmdldFRvdWNoZXNbMF0ucGFnZVggOiBldmVudC5jaGFuZ2VkVG91Y2hlc1tldmVudC5jaGFuZ2VkVG91Y2hlcy5sZW5ndGggLSAxXS5wYWdlWCkgLSAob2Zmc2V0TGVmdFNsaWRlcikpICogdmlkZW9fdmpzLmR1cmF0aW9uKSAvIE5VTUJFUl9PRl9USUNLKTtcbiAgLy9VcGRhdGUga25vdyBwb3NpdGlvblxuICBrbm9iTWluLnN0eWxlLmxlZnQgPSAoKCgoZXZlbnQudGFyZ2V0VG91Y2hlc1swXSA/IGV2ZW50LnRhcmdldFRvdWNoZXNbMF0ucGFnZVggOiBldmVudC5jaGFuZ2VkVG91Y2hlc1tldmVudC5jaGFuZ2VkVG91Y2hlcy5sZW5ndGggLSAxXS5wYWdlWCkpIC0gb2Zmc2V0TGVmdFNsaWRlcikpICsgXCJweFwiO1xuICBpZiAoc2VnbWVudEZlZWRiYWNrLmRpc3BsYXllZCkge1xuICAgIGlmICh2aWRlb192anMuY3VycmVudFRpbWUgPiBzZWdtZW50RmVlZGJhY2suZW5kRHVyYXRpb25WaWRlbykge1xuICAgICAgZmVlZGJhY2tPblNsaWRlclZpZGVvKGZhbHNlKTtcbiAgICB9XG4gIH1cbn07XG5cblxuXG4vL1VwZGF0ZSBrbm9iIG9uIGEgbGFwdG9wXG52YXIgdXBkYXRlS25vYkFuZFZpZGVvQ29tcHV0ZXIgPSBmdW5jdGlvbihlKSB7XG4gIC8vdGFrZSBpbnRvIGFjY291bnQgb2Zmc2V0IG9uIHRoZSBsZWZ0IG9mIHRoZSBzY3JvbGwgYmFyIChib2R5IHNjcm9sbCBhbmQgY2VudGVyaW5nIHRoZSB3cmFwcGVyKVxuIC8vIHZhciBwb3MgPSAoZS5wYWdlWCAgLSB0aGlzLm9mZnNldExlZnQpIC8gdGhpcy5vZmZzZXRXaWR0aDtcbiAgLy8gICAgdmlkZW8uY3VycmVudFRpbWUgPSBwb3MgKiB2aWRlby5kdXJhdGlvbjtcbiAgdmFyIG9mZnNldExlZnRTbGlkZXIgPSB3cmFwcGVyQ29tbWFuZEFuZFJhbmdlaWQub2Zmc2V0TGVmdCAtIGJvZHkuc2Nyb2xsTGVmdDsgLy8tIHdpbmRvdy5zY3JvbGxMZWZ0ICA7XG4gIGN1cnJlbnRWYWx1ZUtub2IgPSAoKGUucGFnZVggLSBvZmZzZXRMZWZ0U2xpZGVyKSAqIHZpZGVvX3Zqcy5kdXJhdGlvbikgLyBOVU1CRVJfT0ZfVElDSztcbiAgaWYgKGN1cnJlbnRWYWx1ZUtub2IgPCB2aWRlb192anMuZHVyYXRpb24gJiYgY3VycmVudFZhbHVlS25vYiA+PSAwKSB7XG4gICAgdmlkZW9fdmpzLmN1cnJlbnRUaW1lID0gKChlLnBhZ2VYIC0gb2Zmc2V0TGVmdFNsaWRlcikgKiB2aWRlb192anMuZHVyYXRpb24pIC8gTlVNQkVSX09GX1RJQ0s7XG4gICAga25vYk1pbi5zdHlsZS5sZWZ0ID0gZS5wYWdlWCAtIChvZmZzZXRMZWZ0U2xpZGVyICsgV0lEVEhfTUlEX0tOT0JfTUlOIC8gMikgKyBcInB4XCI7XG4gICAgaWYgKHNlZ21lbnRGZWVkYmFjay5kaXNwbGF5ZWQpIHtcbiAgICAgIGlmICh2aWRlb192anMuY3VycmVudFRpbWUgPiBzZWdtZW50RmVlZGJhY2suZW5kRHVyYXRpb25WaWRlbykge1xuICAgICAgICBmZWVkYmFja09uU2xpZGVyVmlkZW8oZmFsc2UpO1xuICAgICAgfVxuICAgIH1cbiAgfVxufTtcblxuXG5cbmZ1bmN0aW9uIGZlZWRiYWNrT25TbGlkZXJWaWRlbyhvbk9mZikge1xuICBzZWdtZW50RmVlZGJhY2suZW5kUG9zaXRpb24gPSBwYXJzZUludChzZWdtZW50RmVlZGJhY2suc3RhcnRQb3N0aW9uKSArIHBhcnNlSW50KHNlZ21lbnRGZWVkYmFjay53aWR0aCk7XG4gIHZhciBzbGlkZXJUb1YgPSBzbGlkZXJUb1ZpZGVvKHNlZ21lbnRGZWVkYmFjay5zdGFydFBvc3Rpb24sIHNlZ21lbnRGZWVkYmFjay5lbmRQb3NpdGlvbik7XG4gIHNlZ21lbnRGZWVkYmFjay5zdGFydER1cmF0aW9uVmlkZW8gPSBzbGlkZXJUb1Yuc3RhcnREdXJhdGlvbjtcbiAgc2VnbWVudEZlZWRiYWNrLmVuZER1cmF0aW9uVmlkZW8gPSBzbGlkZXJUb1YuZW5kRHVyYXRpb247XG4gIHNlZ21lbnRGZWVkYmFjay5kaXNwbGF5ZWQgPSBvbk9mZjtcbiAgaWYgKG9uT2ZmKSB7XG4gICAgLy9zZWdtZW50RmVlZGJhY2suZGl2R3JhcGhpY2FsT2JqZWN0LnN0eWxlLm1hcmdpbkxlZnQgPSBzZWdtZW50RmVlZGJhY2suc3RhcnRQb3N0aW9uO1xuICAgIC8vbWludXMgMiBiZWNhdXNlIHdlIG5lZWQgdG8gZ2V0IDIgZnJhbWUgYmVmb3JlIHRoZSBzZWdtZW50XG4gICAgc2VnbWVudEZlZWRiYWNrLmRpdkdyYXBoaWNhbE9iamVjdC5zdHlsZS5tYXJnaW5MZWZ0ID0gcGFyc2VJbnQoc2VnbWVudEZlZWRiYWNrLnN0YXJ0UG9zdGlvbikgICsgXCJweFwiOyAvLyAgc2VnbWVudEZlZWRiYWNrLnN0YXJ0UG9zdGlvbjtcbiAgICBzZWdtZW50RmVlZGJhY2suZGl2R3JhcGhpY2FsT2JqZWN0LnN0eWxlLnZpc2liaWxpdHkgPSBcInZpc2libGVcIjtcbiAgICBzZWdtZW50RmVlZGJhY2suZGl2R3JhcGhpY2FsT2JqZWN0LnN0eWxlLndpZHRoID0gc2VnbWVudEZlZWRiYWNrLndpZHRoO1xuICB9IGVsc2Uge1xuICAgIHNlZ21lbnRGZWVkYmFjay5kaXZHcmFwaGljYWxPYmplY3Quc3R5bGUudmlzaWJpbGl0eSA9IFwiaGlkZGVuXCI7XG4gIH1cbn1cblxuLypcblxuZnVuY3Rpb24gZmVlZGJhY2tPblNsaWRlclZpZGVvKG9uT2ZmKSB7XG4gIHNlZ21lbnRGZWVkYmFjay5lbmRQb3NpdGlvbiA9IHBhcnNlSW50KHNlZ21lbnRGZWVkYmFjay5zdGFydFBvc3Rpb24pICsgcGFyc2VJbnQoc2VnbWVudEZlZWRiYWNrLndpZHRoKSA7XG4gIHZhciBzbGlkZXJUb1YgPSBzbGlkZXJUb1ZpZGVvKHNlZ21lbnRGZWVkYmFjay5zdGFydFBvc3Rpb24sIHNlZ21lbnRGZWVkYmFjay5lbmRQb3NpdGlvbik7XG4gIHNlZ21lbnRGZWVkYmFjay5zdGFydER1cmF0aW9uVmlkZW8gPSBzbGlkZXJUb1Yuc3RhcnREdXJhdGlvbjtcbiAgc2VnbWVudEZlZWRiYWNrLmVuZER1cmF0aW9uVmlkZW8gPSBzbGlkZXJUb1YuZW5kRHVyYXRpb247XG4gIHNlZ21lbnRGZWVkYmFjay5kaXNwbGF5ZWQgPSBvbk9mZjtcbiAgaWYgKG9uT2ZmKSB7XG4gICAgLy9zZWdtZW50RmVlZGJhY2suZGl2R3JhcGhpY2FsT2JqZWN0LnN0eWxlLm1hcmdpbkxlZnQgPSBzZWdtZW50RmVlZGJhY2suc3RhcnRQb3N0aW9uO1xuICAgIC8vbWludXMgMiBiZWNhdXNlIHdlIG5lZWQgdG8gZ2V0IDIgZnJhbWUgYmVmb3JlIHRoZSBzZWdtZW50XG4gICAgc2VnbWVudEZlZWRiYWNrLmRpdkdyYXBoaWNhbE9iamVjdC5zdHlsZS5tYXJnaW5MZWZ0ID0gcGFyc2VJbnQoc2VnbWVudEZlZWRiYWNrLnN0YXJ0UG9zdGlvbikgLSAxMDAgKyBcInB4XCI7IC8vICBzZWdtZW50RmVlZGJhY2suc3RhcnRQb3N0aW9uO1xuICAgIHNlZ21lbnRGZWVkYmFjay5kaXZHcmFwaGljYWxPYmplY3Quc3R5bGUudmlzaWJpbGl0eSA9IFwidmlzaWJsZVwiO1xuICAgIHNlZ21lbnRGZWVkYmFjay5kaXZHcmFwaGljYWxPYmplY3Quc3R5bGUud2lkdGggPSBzZWdtZW50RmVlZGJhY2sud2lkdGggO1xuICB9IGVsc2Uge1xuICAgIHNlZ21lbnRGZWVkYmFjay5kaXZHcmFwaGljYWxPYmplY3Quc3R5bGUudmlzaWJpbGl0eSA9IFwiaGlkZGVuXCI7XG4gIH1cbn1cbiovXG5cblxuZnVuY3Rpb24gdXBkYXRlVGltZXJWaWRlbygpIHtcbiAgXG4gIGxldCBtaW51dGVzID0gTWF0aC5mbG9vcih2aWRlb192anMuY3VycmVudFRpbWUgLyA2MCk7XG4gIGxldCBzZWNvbmRzID0gTWF0aC5mbG9vcih2aWRlb192anMuY3VycmVudFRpbWUgLSBtaW51dGVzICogNjApO1xuICBcbiAgXG4gIGxldCBtaW51dGVzViA9IE1hdGguZmxvb3IodmlkZW9fdmpzLmR1cmF0aW9uIC8gNjApO1xuICBsZXQgc2Vjb25kc1YgPSBNYXRoLmZsb29yKHZpZGVvX3Zqcy5kdXJhdGlvbiAtIG1pbnV0ZXMgKiA2MCk7XG4gIGlmKGlzTmFOKG1pbnV0ZXNWKSB8fCBpc05hTihzZWNvbmRzVikpe1xuICAgIG1pbnV0ZXNWID0gMDtcbiAgICBzZWNvbmRzViA9IDA7XG4gIH1cbiAgaWYgKHNlY29uZHMgPCAxMClcbiAgICBzZWNvbmRzID0gXCIwXCIgKyBzZWNvbmRzO1xuICAvL3RpbWVyVmlkZW8uaW5uZXJIVE1MID0gbWludXRlcyArIFwiOlwiICsgc2Vjb25kcyArIFwiL1wiICsgbWludXRlc1YrXCI6XCIgKyAgc2Vjb25kc1YgO1xufVxuXG4vL3N0YXJ0IHBvc2l0aW9uIG9uIHRoZSBzbGlkZXIgYW5kIGVuZCBwb3NpdGlvbiBvbiB0aGUgc2xpZGVyXG5mdW5jdGlvbiBzbGlkZXJUb1ZpZGVvKHN0YXJ0UCwgZW5kUCkge1xuICBpZihzdGFydFAgPCAwICl7XG4gICAgc3RhcnRQID0gMDtcbiAgfVxuICB2YXIgc3RhcnREdXJhdGlvbiA9IE1hdGgucm91bmQoKChzdGFydFAgKiB2aWRlb192anMuZHVyYXRpb24pIC8gTlVNQkVSX09GX1RJQ0spKTtcbiAgdmFyIGVuZER1cmF0aW9uID0gTWF0aC5yb3VuZCgoKGVuZFAgKiB2aWRlb192anMuZHVyYXRpb24pIC8gTlVNQkVSX09GX1RJQ0spKTtcbiAgXG4gIHJldHVybiB7XG4gICAgc3RhcnREdXJhdGlvbjogc3RhcnREdXJhdGlvbixcbiAgICBlbmREdXJhdGlvbjogZW5kRHVyYXRpb25cbiAgfTtcbn1cblxuIl19