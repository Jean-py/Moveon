"use strict";

/**
 * Deprecated if using the youtube api instead of loaded video
 * @type {HTMLElement | null}
 */

var video = document.getElementById("videoEAT");

var wrapperVideo = document.getElementById("idVideo");
var speedrate = 1;
// Buttons
var playButton = document.getElementById("play-pause");
var muteButton = document.getElementById("mute");
// Sliders
var knobMin = document.getElementById("range-slider_handle-min");
var rangeSliderTrack = document.getElementById("rangeSliderTrack");

var divCardBoard = document.getElementById("divCardBoard");
var body = document.getElementsByTagName("BODY")[0];

//Je ne saiss pas comment rendre cette ligne automatique pour l'isntant car la taille est en auto...
var WIDTH_RANGE_SLIDER_TRACK = "960px";
//Donc pour l'instant je reste comme Ã§a
rangeSliderTrack.style.width = WIDTH_RANGE_SLIDER_TRACK;

var isPlayingCard = false;

var mirrored = false;

var commands = [];
/**
 * Access point to the functional core, you can just execute command from here
 * @return {{execute: execute}}
 * @constructor
 */
var VideoFunctionalCoreManager = function VideoFunctionalCoreManager() {
  //This is a command pattern, see : https://www.dofactory.com/javascript/command-design-pattern
  return {
    //execute a command
    execute: function execute(command) {
      switch (command.execute.name) {
        case "repetPartOfVideo":
          {
            command.execute(command.start, command.end, command.numberOfRepetition, command.speedRate);
            break;
          }
        case "updateKnobAndVideoComputer":
          command.execute(command.e);
          break;

        default:
          command.execute();
          break;
      }

      //We send the command to the server (the server log it into a file, see ./src/server/ServerLogger)
      logger.sendAndLogCommand(command);
      //and we save the command created
      commands.push(command);
    }
    //We did not implemented undo redo for this manager, because undo play pause is kind of useless right?
  };
};

//On load of the page
window.addEventListener("load", function () {
  //The size of the controller is the same than the size of the video
  setTimeout(function () {
    // This hides the address bar:
    video.load();
    window.scrollTo(0, 1);

    var ua = navigator.userAgent.toLowerCase();
    if (ua.indexOf('safari') != -1) {
      if (ua.indexOf('chrome') > -1) {
        //video.src = "./public/media/EAT3.webm";
      } else {
        //alert("2") // Safari
        console.log("test safari");
        console.log("test safari : " + video.src);
        video.load();
      }
    }
  }, 0);
});
window.addEventListener("scroll", function (event) {
  topWindow = this.scrollY;
  leftWindow = this.scrollX;
  // console.log("window scroll : " + leftWindow);
}, false);

body.addEventListener("scroll", function (event) {
  topBody = this.scrollY;
  leftBody = this.scrollX;
  //console.log(" body : "+  body.scrollLeft  );
}, false);

/**
 * Callback used *
 *-------------------------------
 * DO NOT USE THESE FUNCTIONS WITHOUT A COMMAND!
 * The following code should be considered as private
/*------------------------------- */

var muteButtonCallback = function muteButtonCallback(e) {
  if (video.muted === false) {
    // Mute the video
    video.muted = true;
    // Update the button text
    muteButton.innerHTML = "Unmute";
  } else {
    // Unmute the video
    video.muted = false;
    //this.src="/media/workshop2/videoCommand/volumeFull.png";
    // Update the button text
    muteButton.innerHTML = "Mute";
  }
};

var repetPartOfVideo = function repetPartOfVideo(start, end, numberOfRepetition, speedRate) {
  // console.log("function  - repetPartOfVideo" , start,end, numberOfRepetition,speedRate);
  isPlayingCard = true;
  video.playbackRate = speedRate;
  video.currentTime = start;
  var repet = numberOfRepetition;

  //console.log("function  - repetPartOfVideo [play part] l87 videoCommand");
  play();
  video.ontimeupdate = function () {
    if (isPlayingCard) {
      if (end > start && repet > 0) {
        if (video.currentTime > end) {
          repet--;
          video.currentTime = start;
        }
      } else {
        video.ontimeupdate = null;
        feedbackOnSliderVideo(false);
        video.playbackRate = 1;
      }
    }
  };
};

function clearAllTimer() {
  window.clearInterval(timerRepetition);
  isPlayingCard = false;
  video.playbackRate = 1;
  feedbackOnSliderVideo(false);
}

var play = function play() {
  setTimeout(function () {
    var playPromise = video.play();
    if (playPromise !== undefined) {
      playPromise.then(function (value) {
        video.play();
        playButton.src = '/media/workshop2/videoCommand/pauseButton.png';
      }).catch(function (e) {
        console.log(e);
        video.load();
        //video.pause();
      });
    }
  }, 250);
};

var pause = function pause() {
  //console.log("appel a pause");
  video.pause();
  playButton.src = '/media/workshop2/videoCommand/playButton.png';
};

var seekTo = function seekTo(startDurationParam) {
  video.currentTime = startDurationParam;
};

var playPausecallback = function playPausecallback(e) {
  //console.log("callback play-pause, e : " + e);
  /*if(e != null && e !== undefined){
    e.preventDefault();
  }*/
  if (video.paused || video.ended) {
    videoFunctionalCoreManager.execute(new PlayCommand());
    //play();
  } else {
    //pause();
    videoFunctionalCoreManager.execute(new PauseCommand());
  }
};

var mirror = function mirror() {
  if (mirrored) {
    video.style.transform = "rotateY(" + 0 + "deg)";
    mirrored = false;
  } else {
    video.style.transform = "rotateY(" + 180 + "deg)";
    mirrored = true;
  }
};

var setSource = function setSource(source) {
  video.src = source;
};

//Update knob on a tablet
var updateKnobAndVideo = function updateKnobAndVideo(event) {
  //  var offsetLeftSlider = wrapperCommandAndRangeid.offsetLeft+rangeSliderTrack.offsetLeft + dividCommandeVideo.offsetLeft;
  var offsetLeftSlider = wrapperCommandAndRangeid.offsetLeft; //-   ;
  //console.log("aa :  " +  body );

  video.currentTime = Math.round(((event.targetTouches[0] ? event.targetTouches[0].pageX : event.changedTouches[event.changedTouches.length - 1].pageX) - offsetLeftSlider) * video.duration / NUMBER_OF_TICK);
  //Update know position
  knobMin.style.left = (event.targetTouches[0] ? event.targetTouches[0].pageX : event.changedTouches[event.changedTouches.length - 1].pageX) - offsetLeftSlider + "px";
  if (segmentFeedback.displayed) {
    if (video.currentTime > segmentFeedback.endDurationVideo) {
      feedbackOnSliderVideo(false);
    }
  }
};

//Update knob on a laptop
var updateKnobAndVideoComputer = function updateKnobAndVideoComputer(e) {
  //take into account offset on the left of the scroll bar (body scroll and centering the wrapper)

  // var pos = (e.pageX  - this.offsetLeft) / this.offsetWidth;
  //    video.currentTime = pos * video.duration;
  var offsetLeftSlider = wrapperCommandAndRangeid.offsetLeft - body.scrollLeft; //- window.scrollLeft  ;
  currentValueKnob = (e.pageX - offsetLeftSlider) * video.duration / NUMBER_OF_TICK;
  if (currentValueKnob < video.duration && currentValueKnob >= 0) {
    video.currentTime = (e.pageX - offsetLeftSlider) * video.duration / NUMBER_OF_TICK;
    knobMin.style.left = e.pageX - (offsetLeftSlider + WIDTH_MID_KNOB_MIN / 2) + "px";
    if (segmentFeedback.displayed) {
      if (video.currentTime > segmentFeedback.endDurationVideo) {
        feedbackOnSliderVideo(false);
      }
    }
  }
};

function feedbackOnSliderVideo(onOff) {
  segmentFeedback.endPosition = parseInt(segmentFeedback.startPostion) + parseInt(segmentFeedback.width);
  var sliderToV = sliderToVideo(segmentFeedback.startPostion, segmentFeedback.endPosition);
  segmentFeedback.startDurationVideo = sliderToV.startDuration;
  segmentFeedback.endDurationVideo = sliderToV.endDuration;
  segmentFeedback.displayed = onOff;
  if (onOff) {
    //segmentFeedback.divGraphicalObject.style.marginLeft = segmentFeedback.startPostion;
    //minus 2 because we need to get 2 frame before the segment
    segmentFeedback.divGraphicalObject.style.marginLeft = parseInt(segmentFeedback.startPostion) + "px"; //  segmentFeedback.startPostion;
    segmentFeedback.divGraphicalObject.style.visibility = "visible";
    segmentFeedback.divGraphicalObject.style.width = segmentFeedback.width;
  } else {
    segmentFeedback.divGraphicalObject.style.visibility = "hidden";
  }
}

/*

function feedbackOnSliderVideo(onOff) {
  segmentFeedback.endPosition = parseInt(segmentFeedback.startPostion) + parseInt(segmentFeedback.width) ;
  var sliderToV = sliderToVideo(segmentFeedback.startPostion, segmentFeedback.endPosition);
  segmentFeedback.startDurationVideo = sliderToV.startDuration;
  segmentFeedback.endDurationVideo = sliderToV.endDuration;
  segmentFeedback.displayed = onOff;
  if (onOff) {
    //segmentFeedback.divGraphicalObject.style.marginLeft = segmentFeedback.startPostion;
    //minus 2 because we need to get 2 frame before the segment
    segmentFeedback.divGraphicalObject.style.marginLeft = parseInt(segmentFeedback.startPostion) - 100 + "px"; //  segmentFeedback.startPostion;
    segmentFeedback.divGraphicalObject.style.visibility = "visible";
    segmentFeedback.divGraphicalObject.style.width = segmentFeedback.width ;
  } else {
    segmentFeedback.divGraphicalObject.style.visibility = "hidden";
  }
}
*/

function updateTimerVideo() {

  var minutes = Math.floor(video.currentTime / 60);
  var seconds = Math.floor(video.currentTime - minutes * 60);

  var minutesV = Math.floor(video.duration / 60);
  var secondsV = Math.floor(video.duration - minutes * 60);
  if (isNaN(minutesV) || isNaN(secondsV)) {
    minutesV = 0;
    secondsV = 0;
  }
  if (seconds < 10) seconds = "0" + seconds;
  timerVideo.innerHTML = minutes + ":" + seconds + "/" + minutesV + ":" + secondsV;
}

//start position on the slider and end position on the slider
function sliderToVideo(startP, endP) {
  if (startP < 0) {
    startP = 0;
  }
  var startDuration = Math.round(startP * video.duration / NUMBER_OF_TICK);
  var endDuration = Math.round(endP * video.duration / NUMBER_OF_TICK);

  return {
    startDuration: startDuration,
    endDuration: endDuration
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInZpZGVvRnVuY3Rpb25hbENvcmUuanMiXSwibmFtZXMiOlsidmlkZW8iLCJkb2N1bWVudCIsImdldEVsZW1lbnRCeUlkIiwid3JhcHBlclZpZGVvIiwic3BlZWRyYXRlIiwicGxheUJ1dHRvbiIsIm11dGVCdXR0b24iLCJrbm9iTWluIiwicmFuZ2VTbGlkZXJUcmFjayIsImRpdkNhcmRCb2FyZCIsImJvZHkiLCJnZXRFbGVtZW50c0J5VGFnTmFtZSIsIldJRFRIX1JBTkdFX1NMSURFUl9UUkFDSyIsInN0eWxlIiwid2lkdGgiLCJpc1BsYXlpbmdDYXJkIiwibWlycm9yZWQiLCJjb21tYW5kcyIsIlZpZGVvRnVuY3Rpb25hbENvcmVNYW5hZ2VyIiwiZXhlY3V0ZSIsImNvbW1hbmQiLCJuYW1lIiwic3RhcnQiLCJlbmQiLCJudW1iZXJPZlJlcGV0aXRpb24iLCJzcGVlZFJhdGUiLCJlIiwibG9nZ2VyIiwic2VuZEFuZExvZ0NvbW1hbmQiLCJwdXNoIiwid2luZG93IiwiYWRkRXZlbnRMaXN0ZW5lciIsInNldFRpbWVvdXQiLCJsb2FkIiwic2Nyb2xsVG8iLCJ1YSIsIm5hdmlnYXRvciIsInVzZXJBZ2VudCIsInRvTG93ZXJDYXNlIiwiaW5kZXhPZiIsImNvbnNvbGUiLCJsb2ciLCJzcmMiLCJldmVudCIsInRvcFdpbmRvdyIsInNjcm9sbFkiLCJsZWZ0V2luZG93Iiwic2Nyb2xsWCIsInRvcEJvZHkiLCJsZWZ0Qm9keSIsIm11dGVCdXR0b25DYWxsYmFjayIsIm11dGVkIiwiaW5uZXJIVE1MIiwicmVwZXRQYXJ0T2ZWaWRlbyIsInBsYXliYWNrUmF0ZSIsImN1cnJlbnRUaW1lIiwicmVwZXQiLCJwbGF5Iiwib250aW1ldXBkYXRlIiwiZmVlZGJhY2tPblNsaWRlclZpZGVvIiwiY2xlYXJBbGxUaW1lciIsImNsZWFySW50ZXJ2YWwiLCJ0aW1lclJlcGV0aXRpb24iLCJwbGF5UHJvbWlzZSIsInVuZGVmaW5lZCIsInRoZW4iLCJ2YWx1ZSIsImNhdGNoIiwicGF1c2UiLCJzZWVrVG8iLCJzdGFydER1cmF0aW9uUGFyYW0iLCJwbGF5UGF1c2VjYWxsYmFjayIsInBhdXNlZCIsImVuZGVkIiwidmlkZW9GdW5jdGlvbmFsQ29yZU1hbmFnZXIiLCJQbGF5Q29tbWFuZCIsIlBhdXNlQ29tbWFuZCIsIm1pcnJvciIsInRyYW5zZm9ybSIsInNldFNvdXJjZSIsInNvdXJjZSIsInVwZGF0ZUtub2JBbmRWaWRlbyIsIm9mZnNldExlZnRTbGlkZXIiLCJ3cmFwcGVyQ29tbWFuZEFuZFJhbmdlaWQiLCJvZmZzZXRMZWZ0IiwiTWF0aCIsInJvdW5kIiwidGFyZ2V0VG91Y2hlcyIsInBhZ2VYIiwiY2hhbmdlZFRvdWNoZXMiLCJsZW5ndGgiLCJkdXJhdGlvbiIsIk5VTUJFUl9PRl9USUNLIiwibGVmdCIsInNlZ21lbnRGZWVkYmFjayIsImRpc3BsYXllZCIsImVuZER1cmF0aW9uVmlkZW8iLCJ1cGRhdGVLbm9iQW5kVmlkZW9Db21wdXRlciIsInNjcm9sbExlZnQiLCJjdXJyZW50VmFsdWVLbm9iIiwiV0lEVEhfTUlEX0tOT0JfTUlOIiwib25PZmYiLCJlbmRQb3NpdGlvbiIsInBhcnNlSW50Iiwic3RhcnRQb3N0aW9uIiwic2xpZGVyVG9WIiwic2xpZGVyVG9WaWRlbyIsInN0YXJ0RHVyYXRpb25WaWRlbyIsInN0YXJ0RHVyYXRpb24iLCJlbmREdXJhdGlvbiIsImRpdkdyYXBoaWNhbE9iamVjdCIsIm1hcmdpbkxlZnQiLCJ2aXNpYmlsaXR5IiwidXBkYXRlVGltZXJWaWRlbyIsIm1pbnV0ZXMiLCJmbG9vciIsInNlY29uZHMiLCJtaW51dGVzViIsInNlY29uZHNWIiwiaXNOYU4iLCJ0aW1lclZpZGVvIiwic3RhcnRQIiwiZW5kUCJdLCJtYXBwaW5ncyI6Ijs7QUFBQTs7Ozs7QUFNQSxJQUFJQSxRQUFRQyxTQUFTQyxjQUFULENBQXdCLFVBQXhCLENBQVo7O0FBS0EsSUFBSUMsZUFBZUYsU0FBU0MsY0FBVCxDQUF3QixTQUF4QixDQUFuQjtBQUNBLElBQUlFLFlBQVksQ0FBaEI7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O0FBQ2JBLGFBQVMsQ0FBVDtBQUNEO0FBQ0QsTUFBSWIsZ0JBQWdCdkIsS0FBS0MsS0FBTCxDQUFhbUMsU0FBU3pILE1BQU0yRixRQUFoQixHQUE0QkMsY0FBeEMsQ0FBcEI7QUFDQSxNQUFJaUIsY0FBY3hCLEtBQUtDLEtBQUwsQ0FBYW9DLE9BQU8xSCxNQUFNMkYsUUFBZCxHQUEwQkMsY0FBdEMsQ0FBbEI7O0FBRUEsU0FBTztBQUNMZ0IsbUJBQWVBLGFBRFY7QUFFTEMsaUJBQWFBO0FBRlIsR0FBUDtBQUlEIiwiZmlsZSI6InZpZGVvRnVuY3Rpb25hbENvcmUuanMiLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIERlcHJlY2F0ZWQgaWYgdXNpbmcgdGhlIHlvdXR1YmUgYXBpIGluc3RlYWQgb2YgbG9hZGVkIHZpZGVvXG4gKiBAdHlwZSB7SFRNTEVsZW1lbnQgfCBudWxsfVxuICovXG5cblxudmFyIHZpZGVvID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJ2aWRlb0VBVFwiKTtcblxuXG5cblxudmFyIHdyYXBwZXJWaWRlbyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiaWRWaWRlb1wiKTtcbnZhciBzcGVlZHJhdGUgPSAxO1xuLy8gQnV0dG9uc1xudmFyIHBsYXlCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcInBsYXktcGF1c2VcIik7XG52YXIgbXV0ZUJ1dHRvbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwibXV0ZVwiKTtcbi8vIFNsaWRlcnNcbnZhciBrbm9iTWluID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJyYW5nZS1zbGlkZXJfaGFuZGxlLW1pblwiKTtcbnZhciByYW5nZVNsaWRlclRyYWNrID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJyYW5nZVNsaWRlclRyYWNrXCIpO1xuXG52YXIgZGl2Q2FyZEJvYXJkID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJkaXZDYXJkQm9hcmRcIik7XG52YXIgYm9keSA9IGRvY3VtZW50LmdldEVsZW1lbnRzQnlUYWdOYW1lKFwiQk9EWVwiKVswXTtcblxuLy9KZSBuZSBzYWlzcyBwYXMgY29tbWVudCByZW5kcmUgY2V0dGUgbGlnbmUgYXV0b21hdGlxdWUgcG91ciBsJ2lzbnRhbnQgY2FyIGxhIHRhaWxsZSBlc3QgZW4gYXV0by4uLlxudmFyIFdJRFRIX1JBTkdFX1NMSURFUl9UUkFDSyA9IFwiOTYwcHhcIjtcbi8vRG9uYyBwb3VyIGwnaW5zdGFudCBqZSByZXN0ZSBjb21tZSDDp2FcbnJhbmdlU2xpZGVyVHJhY2suc3R5bGUud2lkdGggPSBXSURUSF9SQU5HRV9TTElERVJfVFJBQ0s7XG5cbnZhciBpc1BsYXlpbmdDYXJkID0gZmFsc2U7XG5cbnZhciBtaXJyb3JlZCA9IGZhbHNlO1xuXG52YXIgY29tbWFuZHMgPSBbXTtcbi8qKlxuICogQWNjZXNzIHBvaW50IHRvIHRoZSBmdW5jdGlvbmFsIGNvcmUsIHlvdSBjYW4ganVzdCBleGVjdXRlIGNvbW1hbmQgZnJvbSBoZXJlXG4gKiBAcmV0dXJuIHt7ZXhlY3V0ZTogZXhlY3V0ZX19XG4gKiBAY29uc3RydWN0b3JcbiAqL1xudmFyIFZpZGVvRnVuY3Rpb25hbENvcmVNYW5hZ2VyID0gZnVuY3Rpb24oKSB7XG4gIC8vVGhpcyBpcyBhIGNvbW1hbmQgcGF0dGVybiwgc2VlIDogaHR0cHM6Ly93d3cuZG9mYWN0b3J5LmNvbS9qYXZhc2NyaXB0L2NvbW1hbmQtZGVzaWduLXBhdHRlcm5cbiAgcmV0dXJuIHtcbiAgICAvL2V4ZWN1dGUgYSBjb21tYW5kXG4gICAgZXhlY3V0ZTogZnVuY3Rpb24oY29tbWFuZCkge1xuICAgICAgc3dpdGNoIChjb21tYW5kLmV4ZWN1dGUubmFtZSl7XG4gICAgICAgIGNhc2UgXCJyZXBldFBhcnRPZlZpZGVvXCIgOiB7XG4gICAgICAgICAgY29tbWFuZC5leGVjdXRlKGNvbW1hbmQuc3RhcnQsY29tbWFuZC5lbmQsY29tbWFuZC5udW1iZXJPZlJlcGV0aXRpb24sY29tbWFuZC5zcGVlZFJhdGUpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIGNhc2UgXCJ1cGRhdGVLbm9iQW5kVmlkZW9Db21wdXRlclwiIDpcbiAgICAgICAgICBjb21tYW5kLmV4ZWN1dGUoY29tbWFuZC5lKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgXG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgY29tbWFuZC5leGVjdXRlKCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gIFxuICAgICAgLy9XZSBzZW5kIHRoZSBjb21tYW5kIHRvIHRoZSBzZXJ2ZXIgKHRoZSBzZXJ2ZXIgbG9nIGl0IGludG8gYSBmaWxlLCBzZWUgLi9zcmMvc2VydmVyL1NlcnZlckxvZ2dlcilcbiAgICAgIGxvZ2dlci5zZW5kQW5kTG9nQ29tbWFuZChjb21tYW5kKTtcbiAgICAgIC8vYW5kIHdlIHNhdmUgdGhlIGNvbW1hbmQgY3JlYXRlZFxuICAgICAgY29tbWFuZHMucHVzaChjb21tYW5kKTtcbiAgICB9XG4gICAgLy9XZSBkaWQgbm90IGltcGxlbWVudGVkIHVuZG8gcmVkbyBmb3IgdGhpcyBtYW5hZ2VyLCBiZWNhdXNlIHVuZG8gcGxheSBwYXVzZSBpcyBraW5kIG9mIHVzZWxlc3MgcmlnaHQ/XG4gIH1cbn07XG5cblxuLy9PbiBsb2FkIG9mIHRoZSBwYWdlXG53aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihcImxvYWRcIixmdW5jdGlvbigpIHtcbiAgLy9UaGUgc2l6ZSBvZiB0aGUgY29udHJvbGxlciBpcyB0aGUgc2FtZSB0aGFuIHRoZSBzaXplIG9mIHRoZSB2aWRlb1xuICBzZXRUaW1lb3V0KGZ1bmN0aW9uKCl7XG4gICAgLy8gVGhpcyBoaWRlcyB0aGUgYWRkcmVzcyBiYXI6XG4gICAgdmlkZW8ubG9hZCgpO1xuICAgIHdpbmRvdy5zY3JvbGxUbygwLCAxKTtcbiAgICBcbiAgICB2YXIgdWEgPSBuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCk7XG4gICAgaWYgKHVhLmluZGV4T2YoJ3NhZmFyaScpICE9IC0xKSB7XG4gICAgICBpZiAodWEuaW5kZXhPZignY2hyb21lJykgPiAtMSkge1xuICAgICAgICAvL3ZpZGVvLnNyYyA9IFwiLi9wdWJsaWMvbWVkaWEvRUFUMy53ZWJtXCI7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvL2FsZXJ0KFwiMlwiKSAvLyBTYWZhcmlcbiAgICAgICAgY29uc29sZS5sb2coXCJ0ZXN0IHNhZmFyaVwiKTtcbiAgICAgICAgY29uc29sZS5sb2coXCJ0ZXN0IHNhZmFyaSA6IFwiICsgdmlkZW8uc3JjKTtcbiAgICAgICAgdmlkZW8ubG9hZCgpO1xuICAgICAgICBcbiAgICAgIH1cbiAgICB9XG4gIH0sIDApO1xufSk7XG53aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihcInNjcm9sbFwiLCBmdW5jdGlvbihldmVudCkge1xuICB0b3BXaW5kb3cgPSB0aGlzLnNjcm9sbFk7XG4gIGxlZnRXaW5kb3cgPXRoaXMuc2Nyb2xsWDtcbiAgLy8gY29uc29sZS5sb2coXCJ3aW5kb3cgc2Nyb2xsIDogXCIgKyBsZWZ0V2luZG93KTtcbn0sIGZhbHNlKTtcblxuYm9keS5hZGRFdmVudExpc3RlbmVyKFwic2Nyb2xsXCIsIGZ1bmN0aW9uKGV2ZW50KSB7XG4gIHRvcEJvZHkgPSAgdGhpcy5zY3JvbGxZO1xuICBsZWZ0Qm9keSA9IHRoaXMuc2Nyb2xsWDtcbiAgLy9jb25zb2xlLmxvZyhcIiBib2R5IDogXCIrICBib2R5LnNjcm9sbExlZnQgICk7XG59LCBmYWxzZSk7XG5cblxuLyoqXG4gKiBDYWxsYmFjayB1c2VkICpcbiAqLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLVxuICogRE8gTk9UIFVTRSBUSEVTRSBGVU5DVElPTlMgV0lUSE9VVCBBIENPTU1BTkQhXG4gKiBUaGUgZm9sbG93aW5nIGNvZGUgc2hvdWxkIGJlIGNvbnNpZGVyZWQgYXMgcHJpdmF0ZVxuLyotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tICovXG5cbnZhciBtdXRlQnV0dG9uQ2FsbGJhY2sgPSBmdW5jdGlvbihlKXtcbiAgaWYgKHZpZGVvLm11dGVkID09PSBmYWxzZSkge1xuICAgIC8vIE11dGUgdGhlIHZpZGVvXG4gICAgdmlkZW8ubXV0ZWQgPSB0cnVlO1xuICAgIC8vIFVwZGF0ZSB0aGUgYnV0dG9uIHRleHRcbiAgICBtdXRlQnV0dG9uLmlubmVySFRNTCA9IFwiVW5tdXRlXCI7XG4gIH0gZWxzZSB7XG4gICAgLy8gVW5tdXRlIHRoZSB2aWRlb1xuICAgIHZpZGVvLm11dGVkID0gZmFsc2U7XG4gICAgLy90aGlzLnNyYz1cIi9tZWRpYS93b3Jrc2hvcDIvdmlkZW9Db21tYW5kL3ZvbHVtZUZ1bGwucG5nXCI7XG4gICAgLy8gVXBkYXRlIHRoZSBidXR0b24gdGV4dFxuICAgIG11dGVCdXR0b24uaW5uZXJIVE1MID0gXCJNdXRlXCI7XG4gIH1cbn07XG5cbnZhciByZXBldFBhcnRPZlZpZGVvID0gZnVuY3Rpb24gKHN0YXJ0LGVuZCwgbnVtYmVyT2ZSZXBldGl0aW9uLHNwZWVkUmF0ZSkge1xuICAvLyBjb25zb2xlLmxvZyhcImZ1bmN0aW9uICAtIHJlcGV0UGFydE9mVmlkZW9cIiAsIHN0YXJ0LGVuZCwgbnVtYmVyT2ZSZXBldGl0aW9uLHNwZWVkUmF0ZSk7XG4gIGlzUGxheWluZ0NhcmQgPSB0cnVlO1xuICB2aWRlby5wbGF5YmFja1JhdGUgPSBzcGVlZFJhdGU7XG4gIHZpZGVvLmN1cnJlbnRUaW1lID0gc3RhcnQ7XG4gIHZhciByZXBldCA9IG51bWJlck9mUmVwZXRpdGlvbjtcbiAgXG4gIC8vY29uc29sZS5sb2coXCJmdW5jdGlvbiAgLSByZXBldFBhcnRPZlZpZGVvIFtwbGF5IHBhcnRdIGw4NyB2aWRlb0NvbW1hbmRcIik7XG4gIHBsYXkoKTtcbiAgdmlkZW8ub250aW1ldXBkYXRlID0gZnVuY3Rpb24oKSB7XG4gICAgaWYoaXNQbGF5aW5nQ2FyZCl7XG4gICAgICBpZiAoKGVuZCA+IHN0YXJ0ICkgJiYgIHJlcGV0ID4gMCApIHtcbiAgICAgICAgaWYgKHZpZGVvLmN1cnJlbnRUaW1lID4gZW5kKSB7XG4gICAgICAgICAgcmVwZXQtLTtcbiAgICAgICAgICB2aWRlby5jdXJyZW50VGltZSA9IHN0YXJ0O1xuICAgICAgICB9XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB2aWRlby5vbnRpbWV1cGRhdGUgPSBudWxsO1xuICAgICAgICBmZWVkYmFja09uU2xpZGVyVmlkZW8oZmFsc2UpO1xuICAgICAgICB2aWRlby5wbGF5YmFja1JhdGUgPSAxO1xuICAgICAgfVxuICAgIH1cbiAgfTtcbn07XG5cbmZ1bmN0aW9uIGNsZWFyQWxsVGltZXIoKSB7XG4gIHdpbmRvdy5jbGVhckludGVydmFsKHRpbWVyUmVwZXRpdGlvbik7XG4gIGlzUGxheWluZ0NhcmQgPSBmYWxzZTtcbiAgdmlkZW8ucGxheWJhY2tSYXRlID0gMTtcbiAgZmVlZGJhY2tPblNsaWRlclZpZGVvKGZhbHNlKTtcbn1cblxuXG52YXIgcGxheSA9IGZ1bmN0aW9uICgpIHtcbiAgc2V0VGltZW91dChmdW5jdGlvbiAoKSB7XG4gICAgdmFyIHBsYXlQcm9taXNlID0gdmlkZW8ucGxheSgpO1xuICAgIGlmIChwbGF5UHJvbWlzZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBwbGF5UHJvbWlzZS50aGVuKGZ1bmN0aW9uICh2YWx1ZSkge1xuICAgICAgICB2aWRlby5wbGF5KCk7XG4gICAgICAgIHBsYXlCdXR0b24uc3JjID0gJy9tZWRpYS93b3Jrc2hvcDIvdmlkZW9Db21tYW5kL3BhdXNlQnV0dG9uLnBuZyc7XG4gICAgICB9KS5jYXRjaChmdW5jdGlvbiAoZSkge1xuICAgICAgICBjb25zb2xlLmxvZyhlKTtcbiAgICAgICAgdmlkZW8ubG9hZCgpO1xuICAgICAgICAvL3ZpZGVvLnBhdXNlKCk7XG4gICAgICB9KVxuICAgIFxuICAgIH1cbiAgfSwyNTApO1xufTtcblxudmFyIHBhdXNlID0gZnVuY3Rpb24gKCkge1xuICAvL2NvbnNvbGUubG9nKFwiYXBwZWwgYSBwYXVzZVwiKTtcbiAgdmlkZW8ucGF1c2UoKTtcbiAgcGxheUJ1dHRvbi5zcmM9Jy9tZWRpYS93b3Jrc2hvcDIvdmlkZW9Db21tYW5kL3BsYXlCdXR0b24ucG5nJztcbn07XG5cbnZhciBzZWVrVG8gPSBmdW5jdGlvbihzdGFydER1cmF0aW9uUGFyYW0pe1xuICB2aWRlby5jdXJyZW50VGltZSA9IHN0YXJ0RHVyYXRpb25QYXJhbTtcbn07XG5cbnZhciBwbGF5UGF1c2VjYWxsYmFjayA9IGZ1bmN0aW9uKGUpe1xuICAvL2NvbnNvbGUubG9nKFwiY2FsbGJhY2sgcGxheS1wYXVzZSwgZSA6IFwiICsgZSk7XG4gIC8qaWYoZSAhPSBudWxsICYmIGUgIT09IHVuZGVmaW5lZCl7XG4gICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICB9Ki9cbiAgaWYgKHZpZGVvLnBhdXNlZCB8fCB2aWRlby5lbmRlZCApIHtcbiAgICB2aWRlb0Z1bmN0aW9uYWxDb3JlTWFuYWdlci5leGVjdXRlKG5ldyBQbGF5Q29tbWFuZCgpKTtcbiAgICAvL3BsYXkoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgLy9wYXVzZSgpO1xuICAgIHZpZGVvRnVuY3Rpb25hbENvcmVNYW5hZ2VyLmV4ZWN1dGUobmV3IFBhdXNlQ29tbWFuZCgpKTtcbiAgXG4gIH1cbn07XG5cbnZhciBtaXJyb3IgPSBmdW5jdGlvbiAoKSB7XG4gIGlmKG1pcnJvcmVkKXtcbiAgICB2aWRlby5zdHlsZS50cmFuc2Zvcm0gPSAgXCJyb3RhdGVZKFwiKyAwICtcImRlZylcIjtcbiAgICBtaXJyb3JlZCA9IGZhbHNlO1xuICB9IGVsc2Uge1xuICAgIHZpZGVvLnN0eWxlLnRyYW5zZm9ybSA9ICBcInJvdGF0ZVkoXCIrIDE4MCArXCJkZWcpXCI7XG4gICAgbWlycm9yZWQgPSB0cnVlO1xuICB9XG59O1xuXG52YXIgc2V0U291cmNlID0gZnVuY3Rpb24oc291cmNlKXtcbiAgdmlkZW8uc3JjID0gc291cmNlO1xufTtcblxuLy9VcGRhdGUga25vYiBvbiBhIHRhYmxldFxudmFyIHVwZGF0ZUtub2JBbmRWaWRlbyA9IGZ1bmN0aW9uKGV2ZW50KSB7XG4gIC8vICB2YXIgb2Zmc2V0TGVmdFNsaWRlciA9IHdyYXBwZXJDb21tYW5kQW5kUmFuZ2VpZC5vZmZzZXRMZWZ0K3JhbmdlU2xpZGVyVHJhY2sub2Zmc2V0TGVmdCArIGRpdmlkQ29tbWFuZGVWaWRlby5vZmZzZXRMZWZ0O1xuICB2YXIgb2Zmc2V0TGVmdFNsaWRlciA9IHdyYXBwZXJDb21tYW5kQW5kUmFuZ2VpZC5vZmZzZXRMZWZ0OyAvLy0gICA7XG4gIC8vY29uc29sZS5sb2coXCJhYSA6ICBcIiArICBib2R5ICk7XG4gIFxuICB2aWRlby5jdXJyZW50VGltZSA9IE1hdGgucm91bmQoKCgoZXZlbnQudGFyZ2V0VG91Y2hlc1swXSA/IGV2ZW50LnRhcmdldFRvdWNoZXNbMF0ucGFnZVggOiBldmVudC5jaGFuZ2VkVG91Y2hlc1tldmVudC5jaGFuZ2VkVG91Y2hlcy5sZW5ndGggLSAxXS5wYWdlWCkgLSAob2Zmc2V0TGVmdFNsaWRlcikpICogdmlkZW8uZHVyYXRpb24pIC8gTlVNQkVSX09GX1RJQ0spO1xuICAvL1VwZGF0ZSBrbm93IHBvc2l0aW9uXG4gIGtub2JNaW4uc3R5bGUubGVmdCA9ICgoKChldmVudC50YXJnZXRUb3VjaGVzWzBdID8gZXZlbnQudGFyZ2V0VG91Y2hlc1swXS5wYWdlWCA6IGV2ZW50LmNoYW5nZWRUb3VjaGVzW2V2ZW50LmNoYW5nZWRUb3VjaGVzLmxlbmd0aCAtIDFdLnBhZ2VYKSkgLSBvZmZzZXRMZWZ0U2xpZGVyKSkgKyBcInB4XCI7XG4gIGlmIChzZWdtZW50RmVlZGJhY2suZGlzcGxheWVkKSB7XG4gICAgaWYgKHZpZGVvLmN1cnJlbnRUaW1lID4gc2VnbWVudEZlZWRiYWNrLmVuZER1cmF0aW9uVmlkZW8pIHtcbiAgICAgIGZlZWRiYWNrT25TbGlkZXJWaWRlbyhmYWxzZSk7XG4gICAgfVxuICB9XG59O1xuXG5cblxuLy9VcGRhdGUga25vYiBvbiBhIGxhcHRvcFxudmFyIHVwZGF0ZUtub2JBbmRWaWRlb0NvbXB1dGVyID0gZnVuY3Rpb24oZSkge1xuICAvL3Rha2UgaW50byBhY2NvdW50IG9mZnNldCBvbiB0aGUgbGVmdCBvZiB0aGUgc2Nyb2xsIGJhciAoYm9keSBzY3JvbGwgYW5kIGNlbnRlcmluZyB0aGUgd3JhcHBlcilcbiAgXG4gLy8gdmFyIHBvcyA9IChlLnBhZ2VYICAtIHRoaXMub2Zmc2V0TGVmdCkgLyB0aGlzLm9mZnNldFdpZHRoO1xuICAvLyAgICB2aWRlby5jdXJyZW50VGltZSA9IHBvcyAqIHZpZGVvLmR1cmF0aW9uO1xuICB2YXIgb2Zmc2V0TGVmdFNsaWRlciA9IHdyYXBwZXJDb21tYW5kQW5kUmFuZ2VpZC5vZmZzZXRMZWZ0IC0gYm9keS5zY3JvbGxMZWZ0OyAvLy0gd2luZG93LnNjcm9sbExlZnQgIDtcbiAgY3VycmVudFZhbHVlS25vYiA9ICgoZS5wYWdlWCAtIG9mZnNldExlZnRTbGlkZXIpICogdmlkZW8uZHVyYXRpb24pIC8gTlVNQkVSX09GX1RJQ0s7XG4gIGlmIChjdXJyZW50VmFsdWVLbm9iIDwgdmlkZW8uZHVyYXRpb24gJiYgY3VycmVudFZhbHVlS25vYiA+PSAwKSB7XG4gICAgdmlkZW8uY3VycmVudFRpbWUgPSAoKGUucGFnZVggLSBvZmZzZXRMZWZ0U2xpZGVyKSAqIHZpZGVvLmR1cmF0aW9uKSAvIE5VTUJFUl9PRl9USUNLO1xuICAgIGtub2JNaW4uc3R5bGUubGVmdCA9IGUucGFnZVggLSAob2Zmc2V0TGVmdFNsaWRlciArIFdJRFRIX01JRF9LTk9CX01JTiAvIDIpICsgXCJweFwiO1xuICAgIGlmIChzZWdtZW50RmVlZGJhY2suZGlzcGxheWVkKSB7XG4gICAgICBpZiAodmlkZW8uY3VycmVudFRpbWUgPiBzZWdtZW50RmVlZGJhY2suZW5kRHVyYXRpb25WaWRlbykge1xuICAgICAgICBmZWVkYmFja09uU2xpZGVyVmlkZW8oZmFsc2UpO1xuICAgICAgfVxuICAgIH1cbiAgfVxufTtcblxuXG5cbmZ1bmN0aW9uIGZlZWRiYWNrT25TbGlkZXJWaWRlbyhvbk9mZikge1xuICBzZWdtZW50RmVlZGJhY2suZW5kUG9zaXRpb24gPSBwYXJzZUludChzZWdtZW50RmVlZGJhY2suc3RhcnRQb3N0aW9uKSArIHBhcnNlSW50KHNlZ21lbnRGZWVkYmFjay53aWR0aCk7XG4gIHZhciBzbGlkZXJUb1YgPSBzbGlkZXJUb1ZpZGVvKHNlZ21lbnRGZWVkYmFjay5zdGFydFBvc3Rpb24sIHNlZ21lbnRGZWVkYmFjay5lbmRQb3NpdGlvbik7XG4gIHNlZ21lbnRGZWVkYmFjay5zdGFydER1cmF0aW9uVmlkZW8gPSBzbGlkZXJUb1Yuc3RhcnREdXJhdGlvbjtcbiAgc2VnbWVudEZlZWRiYWNrLmVuZER1cmF0aW9uVmlkZW8gPSBzbGlkZXJUb1YuZW5kRHVyYXRpb247XG4gIHNlZ21lbnRGZWVkYmFjay5kaXNwbGF5ZWQgPSBvbk9mZjtcbiAgaWYgKG9uT2ZmKSB7XG4gICAgLy9zZWdtZW50RmVlZGJhY2suZGl2R3JhcGhpY2FsT2JqZWN0LnN0eWxlLm1hcmdpbkxlZnQgPSBzZWdtZW50RmVlZGJhY2suc3RhcnRQb3N0aW9uO1xuICAgIC8vbWludXMgMiBiZWNhdXNlIHdlIG5lZWQgdG8gZ2V0IDIgZnJhbWUgYmVmb3JlIHRoZSBzZWdtZW50XG4gICAgc2VnbWVudEZlZWRiYWNrLmRpdkdyYXBoaWNhbE9iamVjdC5zdHlsZS5tYXJnaW5MZWZ0ID0gcGFyc2VJbnQoc2VnbWVudEZlZWRiYWNrLnN0YXJ0UG9zdGlvbikgICsgXCJweFwiOyAvLyAgc2VnbWVudEZlZWRiYWNrLnN0YXJ0UG9zdGlvbjtcbiAgICBzZWdtZW50RmVlZGJhY2suZGl2R3JhcGhpY2FsT2JqZWN0LnN0eWxlLnZpc2liaWxpdHkgPSBcInZpc2libGVcIjtcbiAgICBzZWdtZW50RmVlZGJhY2suZGl2R3JhcGhpY2FsT2JqZWN0LnN0eWxlLndpZHRoID0gc2VnbWVudEZlZWRiYWNrLndpZHRoO1xuICB9IGVsc2Uge1xuICAgIHNlZ21lbnRGZWVkYmFjay5kaXZHcmFwaGljYWxPYmplY3Quc3R5bGUudmlzaWJpbGl0eSA9IFwiaGlkZGVuXCI7XG4gIH1cbn1cblxuLypcblxuZnVuY3Rpb24gZmVlZGJhY2tPblNsaWRlclZpZGVvKG9uT2ZmKSB7XG4gIHNlZ21lbnRGZWVkYmFjay5lbmRQb3NpdGlvbiA9IHBhcnNlSW50KHNlZ21lbnRGZWVkYmFjay5zdGFydFBvc3Rpb24pICsgcGFyc2VJbnQoc2VnbWVudEZlZWRiYWNrLndpZHRoKSA7XG4gIHZhciBzbGlkZXJUb1YgPSBzbGlkZXJUb1ZpZGVvKHNlZ21lbnRGZWVkYmFjay5zdGFydFBvc3Rpb24sIHNlZ21lbnRGZWVkYmFjay5lbmRQb3NpdGlvbik7XG4gIHNlZ21lbnRGZWVkYmFjay5zdGFydER1cmF0aW9uVmlkZW8gPSBzbGlkZXJUb1Yuc3RhcnREdXJhdGlvbjtcbiAgc2VnbWVudEZlZWRiYWNrLmVuZER1cmF0aW9uVmlkZW8gPSBzbGlkZXJUb1YuZW5kRHVyYXRpb247XG4gIHNlZ21lbnRGZWVkYmFjay5kaXNwbGF5ZWQgPSBvbk9mZjtcbiAgaWYgKG9uT2ZmKSB7XG4gICAgLy9zZWdtZW50RmVlZGJhY2suZGl2R3JhcGhpY2FsT2JqZWN0LnN0eWxlLm1hcmdpbkxlZnQgPSBzZWdtZW50RmVlZGJhY2suc3RhcnRQb3N0aW9uO1xuICAgIC8vbWludXMgMiBiZWNhdXNlIHdlIG5lZWQgdG8gZ2V0IDIgZnJhbWUgYmVmb3JlIHRoZSBzZWdtZW50XG4gICAgc2VnbWVudEZlZWRiYWNrLmRpdkdyYXBoaWNhbE9iamVjdC5zdHlsZS5tYXJnaW5MZWZ0ID0gcGFyc2VJbnQoc2VnbWVudEZlZWRiYWNrLnN0YXJ0UG9zdGlvbikgLSAxMDAgKyBcInB4XCI7IC8vICBzZWdtZW50RmVlZGJhY2suc3RhcnRQb3N0aW9uO1xuICAgIHNlZ21lbnRGZWVkYmFjay5kaXZHcmFwaGljYWxPYmplY3Quc3R5bGUudmlzaWJpbGl0eSA9IFwidmlzaWJsZVwiO1xuICAgIHNlZ21lbnRGZWVkYmFjay5kaXZHcmFwaGljYWxPYmplY3Quc3R5bGUud2lkdGggPSBzZWdtZW50RmVlZGJhY2sud2lkdGggO1xuICB9IGVsc2Uge1xuICAgIHNlZ21lbnRGZWVkYmFjay5kaXZHcmFwaGljYWxPYmplY3Quc3R5bGUudmlzaWJpbGl0eSA9IFwiaGlkZGVuXCI7XG4gIH1cbn1cbiovXG5cblxuZnVuY3Rpb24gdXBkYXRlVGltZXJWaWRlbygpIHtcbiAgXG4gIGxldCBtaW51dGVzID0gTWF0aC5mbG9vcih2aWRlby5jdXJyZW50VGltZSAvIDYwKTtcbiAgbGV0IHNlY29uZHMgPSBNYXRoLmZsb29yKHZpZGVvLmN1cnJlbnRUaW1lIC0gbWludXRlcyAqIDYwKTtcbiAgXG4gIFxuICBsZXQgbWludXRlc1YgPSBNYXRoLmZsb29yKHZpZGVvLmR1cmF0aW9uIC8gNjApO1xuICBsZXQgc2Vjb25kc1YgPSBNYXRoLmZsb29yKHZpZGVvLmR1cmF0aW9uIC0gbWludXRlcyAqIDYwKTtcbiAgaWYoaXNOYU4obWludXRlc1YpIHx8IGlzTmFOKHNlY29uZHNWKSl7XG4gICAgbWludXRlc1YgPSAwO1xuICAgIHNlY29uZHNWID0gMDtcbiAgfVxuICBpZiAoc2Vjb25kcyA8IDEwKVxuICAgIHNlY29uZHMgPSBcIjBcIiArIHNlY29uZHM7XG4gIHRpbWVyVmlkZW8uaW5uZXJIVE1MID0gbWludXRlcyArIFwiOlwiICsgc2Vjb25kcyArIFwiL1wiICsgbWludXRlc1YrXCI6XCIgKyAgc2Vjb25kc1YgO1xufVxuXG4vL3N0YXJ0IHBvc2l0aW9uIG9uIHRoZSBzbGlkZXIgYW5kIGVuZCBwb3NpdGlvbiBvbiB0aGUgc2xpZGVyXG5mdW5jdGlvbiBzbGlkZXJUb1ZpZGVvKHN0YXJ0UCwgZW5kUCkge1xuICBpZihzdGFydFAgPCAwICl7XG4gICAgc3RhcnRQID0gMDtcbiAgfVxuICB2YXIgc3RhcnREdXJhdGlvbiA9IE1hdGgucm91bmQoKChzdGFydFAgKiB2aWRlby5kdXJhdGlvbikgLyBOVU1CRVJfT0ZfVElDSykpO1xuICB2YXIgZW5kRHVyYXRpb24gPSBNYXRoLnJvdW5kKCgoZW5kUCAqIHZpZGVvLmR1cmF0aW9uKSAvIE5VTUJFUl9PRl9USUNLKSk7XG4gIFxuICByZXR1cm4ge1xuICAgIHN0YXJ0RHVyYXRpb246IHN0YXJ0RHVyYXRpb24sXG4gICAgZW5kRHVyYXRpb246IGVuZER1cmF0aW9uXG4gIH07XG59XG5cbiJdfQ==