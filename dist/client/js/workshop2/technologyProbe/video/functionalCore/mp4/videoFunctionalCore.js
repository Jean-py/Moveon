"use strict";

var videovjs = document.getElementById("videovjscontrol");

var speedrate = 1;
// Buttons
var playButton = document.getElementById("play-pause");
var muteButton = document.getElementById("mute");
// Sliders
var knobMin = document.getElementById("range-slider_handle-min");
var rangeSliderTrack = document.getElementById("rangeSliderTrack");

var divCardBoard = document.getElementById("divCardBoard");
var body = document.getElementsByTagName("BODY")[0];

//Je ne saiss pas comment rendre cette ligne automatique pour l'isntant, pourtant la taille est en auto...
var WIDTH_RANGE_SLIDER_TRACK = "960px";
//Donc pour l'instant je reste comme Ã§a
rangeSliderTrack.style.width = WIDTH_RANGE_SLIDER_TRACK;

var isPlayingCard = false;

var mirrored = false;

var commands = [];
/**
 * Access point to the functional core, you can just execute command from here
 * @return {{execute: execute}}
 * @constructor
 */
var VideoFunctionalCoreManager = function VideoFunctionalCoreManager() {
  //This is a command pattern, see : https://www.dofactory.com/javascript/command-design-pattern
  return {
    //execute a command
    execute: function execute(command) {
      switch (command.execute.name) {
        case "repetPartOfVideo":
          {
            command.execute(command.start, command.end, command.numberOfRepetition, command.speedRate);
            break;
          }
        case "updateKnobAndVideoComputer":
          command.execute(command.e);
          break;
        default:
          command.execute();
          break;
      }
      //We send the command to the server (the server log it into a file, see ./src/server/ServerLogger)
      logger.sendAndLogCommand(command);
      //and we save the command created
      commands.push(command);
    }
    //We did not implemented undo redo for this manager, because undo play pause is kind of useless right?
  };
};

//On load of the page
window.addEventListener("load", function () {
  //The size of the controller is the same than the size of the video
  setTimeout(function () {
    // This hides the address bar:
    //console.log(videovjs);
    //videovjs.load();
    window.scrollTo(0, 1);

    var ua = navigator.userAgent.toLowerCase();
    if (ua.indexOf('safari') != -1) {
      if (ua.indexOf('chrome') > -1) {} else {
        //alert("2") // Safari
        console.log("test safari : " + videovjs.src);
        videovjs.load();
      }
    }
  }, 0);
});
window.addEventListener("scroll", function (event) {
  topWindow = this.scrollY;
  leftWindow = this.scrollX;
  // console.log("window scroll : " + leftWindow);
}, false);

body.addEventListener("scroll", function (event) {
  topBody = this.scrollY;
  leftBody = this.scrollX;
  //console.log(" body : "+  body.scrollLeft  );
}, false);

/**
 * Callback used *
 *-------------------------------
 * DO NOT USE THESE FUNCTIONS WITHOUT A COMMAND!
 * The following code should be considered as private
/*------------------------------- */

var muteButtonCallback = function muteButtonCallback(e) {
  if (videovjs.muted === false) {
    // Mute the video
    videovjs.muted = true;
    // Update the button text
    muteButton.innerHTML = "Unmute";
  } else {
    // Unmute the video
    videovjs.muted = false;
    // Update the button text
    muteButton.innerHTML = "Mute";
  }
};

var repetPartOfVideo = function repetPartOfVideo(start, end, numberOfRepetition, speedRate) {
  // console.log("function  - repetPartOfVideo" , start,end, numberOfRepetition,speedRate);
  isPlayingCard = true;
  videovjs.playbackRate = speedRate;
  videovjs.currentTime = start;
  var repet = numberOfRepetition;

  //console.log("function  - repetPartOfVideo [play part] l87 videoCommand");
  play();
  videovjs.ontimeupdate = function () {
    if (isPlayingCard) {
      if (end > start && repet > 0) {
        if (videovjs.currentTime > end) {
          repet--;
          videovjs.currentTime = start;
        }
      } else {
        videovjs.ontimeupdate = null;
        feedbackOnSliderVideo(false);
        videovjs.playbackRate = 1;
      }
    }
  };
};

function clearAllTimer() {
  window.clearInterval(timerRepetition);
  isPlayingCard = false;
  videovjs.playbackRate = 1;
  feedbackOnSliderVideo(false);
}

var play = function play() {
  setTimeout(function () {
    var playPromise = videovjs.play();
    if (playPromise !== undefined) {
      playPromise.then(function (value) {
        video.play();
        playButton.src = '/media/workshop2/videoCommand/pauseButton.png';
      }).catch(function (e) {
        videovjs.load();
        //video.pause();
      });
    }
  }, 250);
};

var pause = function pause() {
  //console.log("appel a pause");
  videovjs.pause();
  playButton.src = '/media/workshop2/videoCommand/playButton.png';
};

var seekTo = function seekTo(startDurationParam) {
  if (startDurationParam < videovjs.currentTime) videovjs.currentTime = startDurationParam;
};

var playPausecallback = function playPausecallback(e) {
  //console.log("callback play-pause, e : " + e);
  /*if(e != null && e !== undefined){
    e.preventDefault();
  }*/
  if (videovjs.paused || videovjs.ended) {
    videoFunctionalCoreManager.execute(new PlayCommand());
    //play();
  } else {
    //pause();
    videoFunctionalCoreManager.execute(new PauseCommand());
  }
};

var mirror = function mirror() {
  if (mirrored) {
    videovjs.style.transform = "rotateY(" + 0 + "deg)";
    mirrored = false;
  } else {
    videovjs.style.transform = "rotateY(" + 180 + "deg)";
    mirrored = true;
  }
};

var setSource = function setSource(source) {
  videovjs.src = source;
};

//Update knob on a tablet
var updateKnobAndVideo = function updateKnobAndVideo(event) {
  //  var offsetLeftSlider = wrapperCommandAndRangeid.offsetLeft+rangeSliderTrack.offsetLeft + dividCommandeVideo.offsetLeft;
  var offsetLeftSlider = wrapperCommandAndRangeid.offsetLeft; //-   ;
  //console.log("aa :  " +  body );

  videovjs.currentTime = Math.round(((event.targetTouches[0] ? event.targetTouches[0].pageX : event.changedTouches[event.changedTouches.length - 1].pageX) - offsetLeftSlider) * videovjs.duration / NUMBER_OF_TICK);
  //Update know position
  knobMin.style.left = (event.targetTouches[0] ? event.targetTouches[0].pageX : event.changedTouches[event.changedTouches.length - 1].pageX) - offsetLeftSlider + "px";
  if (segmentFeedback.displayed) {
    if (videovjs.currentTime > segmentFeedback.endDurationVideo) {
      feedbackOnSliderVideo(false);
    }
  }
};

//Update knob on a laptop
var updateKnobAndVideoComputer = function updateKnobAndVideoComputer(e) {
  //take into account offset on the left of the scroll bar (body scroll and centering the wrapper)

  // var pos = (e.pageX  - this.offsetLeft) / this.offsetWidth;
  //    video.currentTime = pos * video.duration;
  var offsetLeftSlider = wrapperCommandAndRangeid.offsetLeft - body.scrollLeft; //- window.scrollLeft  ;
  currentValueKnob = (e.pageX - offsetLeftSlider) * videovjs.duration / NUMBER_OF_TICK;
  if (currentValueKnob < videovjs.duration && currentValueKnob >= 0) {
    videovjs.currentTime = (e.pageX - offsetLeftSlider) * videovjs.duration / NUMBER_OF_TICK;
    knobMin.style.left = e.pageX - (offsetLeftSlider + WIDTH_MID_KNOB_MIN / 2) + "px";
    if (segmentFeedback.displayed) {
      if (videovjs.currentTime > segmentFeedback.endDurationVideo) {
        feedbackOnSliderVideo(false);
      }
    }
  }
};

function feedbackOnSliderVideo(onOff) {
  segmentFeedback.endPosition = parseInt(segmentFeedback.startPostion) + parseInt(segmentFeedback.width);
  var sliderToV = sliderToVideo(segmentFeedback.startPostion, segmentFeedback.endPosition);
  segmentFeedback.startDurationVideo = sliderToV.startDuration;
  segmentFeedback.endDurationVideo = sliderToV.endDuration;
  segmentFeedback.displayed = onOff;
  if (onOff) {
    //segmentFeedback.divGraphicalObject.style.marginLeft = segmentFeedback.startPostion;
    //minus 2 because we need to get 2 frame before the segment
    segmentFeedback.divGraphicalObject.style.marginLeft = parseInt(segmentFeedback.startPostion) + "px"; //  segmentFeedback.startPostion;
    segmentFeedback.divGraphicalObject.style.visibility = "visible";
    segmentFeedback.divGraphicalObject.style.width = segmentFeedback.width;
  } else {
    segmentFeedback.divGraphicalObject.style.visibility = "hidden";
  }
}

/*

function feedbackOnSliderVideo(onOff) {
  segmentFeedback.endPosition = parseInt(segmentFeedback.startPostion) + parseInt(segmentFeedback.width) ;
  var sliderToV = sliderToVideo(segmentFeedback.startPostion, segmentFeedback.endPosition);
  segmentFeedback.startDurationVideo = sliderToV.startDuration;
  segmentFeedback.endDurationVideo = sliderToV.endDuration;
  segmentFeedback.displayed = onOff;
  if (onOff) {
    //segmentFeedback.divGraphicalObject.style.marginLeft = segmentFeedback.startPostion;
    //minus 2 because we need to get 2 frame before the segment
    segmentFeedback.divGraphicalObject.style.marginLeft = parseInt(segmentFeedback.startPostion) - 100 + "px"; //  segmentFeedback.startPostion;
    segmentFeedback.divGraphicalObject.style.visibility = "visible";
    segmentFeedback.divGraphicalObject.style.width = segmentFeedback.width ;
  } else {
    segmentFeedback.divGraphicalObject.style.visibility = "hidden";
  }
}
*/

function updateTimerVideo() {

  var minutes = Math.floor(videovjs.currentTime / 60);
  var seconds = Math.floor(videovjs.currentTime - minutes * 60);

  var minutesV = Math.floor(videovjs.duration / 60);
  var secondsV = Math.floor(videovjs.duration - minutes * 60);
  if (isNaN(minutesV) || isNaN(secondsV)) {
    minutesV = 0;
    secondsV = 0;
  }
  if (seconds < 10) seconds = "0" + seconds;
  timerVideo.innerHTML = minutes + ":" + seconds + "/" + minutesV + ":" + secondsV;
}

//start position on the slider and end position on the slider
function sliderToVideo(startP, endP) {
  if (startP < 0) {
    startP = 0;
  }
  var startDuration = Math.round(startP * videovjs.duration / NUMBER_OF_TICK);
  var endDuration = Math.round(endP * videovjs.duration / NUMBER_OF_TICK);

  return {
    startDuration: startDuration,
    endDuration: endDuration
  };
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInZpZGVvRnVuY3Rpb25hbENvcmUuanMiXSwibmFtZXMiOlsidmlkZW92anMiLCJkb2N1bWVudCIsImdldEVsZW1lbnRCeUlkIiwic3BlZWRyYXRlIiwicGxheUJ1dHRvbiIsIm11dGVCdXR0b24iLCJrbm9iTWluIiwicmFuZ2VTbGlkZXJUcmFjayIsImRpdkNhcmRCb2FyZCIsImJvZHkiLCJnZXRFbGVtZW50c0J5VGFnTmFtZSIsIldJRFRIX1JBTkdFX1NMSURFUl9UUkFDSyIsInN0eWxlIiwid2lkdGgiLCJpc1BsYXlpbmdDYXJkIiwibWlycm9yZWQiLCJjb21tYW5kcyIsIlZpZGVvRnVuY3Rpb25hbENvcmVNYW5hZ2VyIiwiZXhlY3V0ZSIsImNvbW1hbmQiLCJuYW1lIiwic3RhcnQiLCJlbmQiLCJudW1iZXJPZlJlcGV0aXRpb24iLCJzcGVlZFJhdGUiLCJlIiwibG9nZ2VyIiwic2VuZEFuZExvZ0NvbW1hbmQiLCJwdXNoIiwid2luZG93IiwiYWRkRXZlbnRMaXN0ZW5lciIsInNldFRpbWVvdXQiLCJzY3JvbGxUbyIsInVhIiwibmF2aWdhdG9yIiwidXNlckFnZW50IiwidG9Mb3dlckNhc2UiLCJpbmRleE9mIiwiY29uc29sZSIsImxvZyIsInNyYyIsImxvYWQiLCJldmVudCIsInRvcFdpbmRvdyIsInNjcm9sbFkiLCJsZWZ0V2luZG93Iiwic2Nyb2xsWCIsInRvcEJvZHkiLCJsZWZ0Qm9keSIsIm11dGVCdXR0b25DYWxsYmFjayIsIm11dGVkIiwiaW5uZXJIVE1MIiwicmVwZXRQYXJ0T2ZWaWRlbyIsInBsYXliYWNrUmF0ZSIsImN1cnJlbnRUaW1lIiwicmVwZXQiLCJwbGF5Iiwib250aW1ldXBkYXRlIiwiZmVlZGJhY2tPblNsaWRlclZpZGVvIiwiY2xlYXJBbGxUaW1lciIsImNsZWFySW50ZXJ2YWwiLCJ0aW1lclJlcGV0aXRpb24iLCJwbGF5UHJvbWlzZSIsInVuZGVmaW5lZCIsInRoZW4iLCJ2YWx1ZSIsInZpZGVvIiwiY2F0Y2giLCJwYXVzZSIsInNlZWtUbyIsInN0YXJ0RHVyYXRpb25QYXJhbSIsInBsYXlQYXVzZWNhbGxiYWNrIiwicGF1c2VkIiwiZW5kZWQiLCJ2aWRlb0Z1bmN0aW9uYWxDb3JlTWFuYWdlciIsIlBsYXlDb21tYW5kIiwiUGF1c2VDb21tYW5kIiwibWlycm9yIiwidHJhbnNmb3JtIiwic2V0U291cmNlIiwic291cmNlIiwidXBkYXRlS25vYkFuZFZpZGVvIiwib2Zmc2V0TGVmdFNsaWRlciIsIndyYXBwZXJDb21tYW5kQW5kUmFuZ2VpZCIsIm9mZnNldExlZnQiLCJNYXRoIiwicm91bmQiLCJ0YXJnZXRUb3VjaGVzIiwicGFnZVgiLCJjaGFuZ2VkVG91Y2hlcyIsImxlbmd0aCIsImR1cmF0aW9uIiwiTlVNQkVSX09GX1RJQ0siLCJsZWZ0Iiwic2VnbWVudEZlZWRiYWNrIiwiZGlzcGxheWVkIiwiZW5kRHVyYXRpb25WaWRlbyIsInVwZGF0ZUtub2JBbmRWaWRlb0NvbXB1dGVyIiwic2Nyb2xsTGVmdCIsImN1cnJlbnRWYWx1ZUtub2IiLCJXSURUSF9NSURfS05PQl9NSU4iLCJvbk9mZiIsImVuZFBvc2l0aW9uIiwicGFyc2VJbnQiLCJzdGFydFBvc3Rpb24iLCJzbGlkZXJUb1YiLCJzbGlkZXJUb1ZpZGVvIiwic3RhcnREdXJhdGlvblZpZGVvIiwic3RhcnREdXJhdGlvbiIsImVuZER1cmF0aW9uIiwiZGl2R3JhcGhpY2FsT2JqZWN0IiwibWFyZ2luTGVmdCIsInZpc2liaWxpdHkiLCJ1cGRhdGVUaW1lclZpZGVvIiwibWludXRlcyIsImZsb29yIiwic2Vjb25kcyIsIm1pbnV0ZXNWIiwic2Vjb25kc1YiLCJpc05hTiIsInRpbWVyVmlkZW8iLCJzdGFydFAiLCJlbmRQIl0sIm1hcHBpbmdzIjoiOztBQUFBLElBQUlBLFdBQVdDLFNBQVNDLGNBQVQsQ0FBd0IsaUJBQXhCLENBQWY7O0FBRUEsSUFBSUMsWUFBWSxDQUFoQjtBQUNBO0FBQ0EsSUFBSUMsYUFBYUgsU0FBU0MsY0FBVCxDQUF3QixZQUF4QixDQUFqQjtBQUNBLElB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O0FBQ0EsTUFBSWlCLGNBQWN4QixLQUFLQyxLQUFMLENBQWFvQyxPQUFPMUgsU0FBUzJGLFFBQWpCLEdBQTZCQyxjQUF6QyxDQUFsQjs7QUFFQSxTQUFPO0FBQ0xnQixtQkFBZUEsYUFEVjtBQUVMQyxpQkFBYUE7QUFGUixHQUFQO0FBSUQiLCJmaWxlIjoidmlkZW9GdW5jdGlvbmFsQ29yZS5qcyIsInNvdXJjZXNDb250ZW50IjpbInZhciB2aWRlb3ZqcyA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwidmlkZW92anNjb250cm9sXCIpO1xuXG52YXIgc3BlZWRyYXRlID0gMTtcbi8vIEJ1dHRvbnNcbnZhciBwbGF5QnV0dG9uID0gZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoXCJwbGF5LXBhdXNlXCIpO1xudmFyIG11dGVCdXR0b24gPSBkb2N1bWVudC5nZXRFbGVtZW50QnlJZChcIm11dGVcIik7XG4vLyBTbGlkZXJzXG52YXIga25vYk1pbiA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwicmFuZ2Utc2xpZGVyX2hhbmRsZS1taW5cIik7XG52YXIgcmFuZ2VTbGlkZXJUcmFjayA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwicmFuZ2VTbGlkZXJUcmFja1wiKTtcblxudmFyIGRpdkNhcmRCb2FyZCA9IGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKFwiZGl2Q2FyZEJvYXJkXCIpO1xudmFyIGJvZHkgPSBkb2N1bWVudC5nZXRFbGVtZW50c0J5VGFnTmFtZShcIkJPRFlcIilbMF07XG5cbi8vSmUgbmUgc2Fpc3MgcGFzIGNvbW1lbnQgcmVuZHJlIGNldHRlIGxpZ25lIGF1dG9tYXRpcXVlIHBvdXIgbCdpc250YW50LCBwb3VydGFudCBsYSB0YWlsbGUgZXN0IGVuIGF1dG8uLi5cbnZhciBXSURUSF9SQU5HRV9TTElERVJfVFJBQ0sgPSBcIjk2MHB4XCI7XG4vL0RvbmMgcG91ciBsJ2luc3RhbnQgamUgcmVzdGUgY29tbWUgw6dhXG5yYW5nZVNsaWRlclRyYWNrLnN0eWxlLndpZHRoID0gV0lEVEhfUkFOR0VfU0xJREVSX1RSQUNLO1xuXG52YXIgaXNQbGF5aW5nQ2FyZCA9IGZhbHNlO1xuXG52YXIgbWlycm9yZWQgPSBmYWxzZTtcblxudmFyIGNvbW1hbmRzID0gW107XG4vKipcbiAqIEFjY2VzcyBwb2ludCB0byB0aGUgZnVuY3Rpb25hbCBjb3JlLCB5b3UgY2FuIGp1c3QgZXhlY3V0ZSBjb21tYW5kIGZyb20gaGVyZVxuICogQHJldHVybiB7e2V4ZWN1dGU6IGV4ZWN1dGV9fVxuICogQGNvbnN0cnVjdG9yXG4gKi9cbnZhciBWaWRlb0Z1bmN0aW9uYWxDb3JlTWFuYWdlciA9IGZ1bmN0aW9uKCkge1xuICAvL1RoaXMgaXMgYSBjb21tYW5kIHBhdHRlcm4sIHNlZSA6IGh0dHBzOi8vd3d3LmRvZmFjdG9yeS5jb20vamF2YXNjcmlwdC9jb21tYW5kLWRlc2lnbi1wYXR0ZXJuXG4gIHJldHVybiB7XG4gICAgLy9leGVjdXRlIGEgY29tbWFuZFxuICAgIGV4ZWN1dGU6IGZ1bmN0aW9uKGNvbW1hbmQpIHtcbiAgICAgIHN3aXRjaCAoY29tbWFuZC5leGVjdXRlLm5hbWUpe1xuICAgICAgICBjYXNlIFwicmVwZXRQYXJ0T2ZWaWRlb1wiIDoge1xuICAgICAgICAgIGNvbW1hbmQuZXhlY3V0ZShjb21tYW5kLnN0YXJ0LGNvbW1hbmQuZW5kLGNvbW1hbmQubnVtYmVyT2ZSZXBldGl0aW9uLGNvbW1hbmQuc3BlZWRSYXRlKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgICBjYXNlIFwidXBkYXRlS25vYkFuZFZpZGVvQ29tcHV0ZXJcIiA6XG4gICAgICAgICAgY29tbWFuZC5leGVjdXRlKGNvbW1hbmQuZSk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGRlZmF1bHQ6XG4gICAgICAgICAgY29tbWFuZC5leGVjdXRlKCk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICB9XG4gICAgICAvL1dlIHNlbmQgdGhlIGNvbW1hbmQgdG8gdGhlIHNlcnZlciAodGhlIHNlcnZlciBsb2cgaXQgaW50byBhIGZpbGUsIHNlZSAuL3NyYy9zZXJ2ZXIvU2VydmVyTG9nZ2VyKVxuICAgICAgbG9nZ2VyLnNlbmRBbmRMb2dDb21tYW5kKGNvbW1hbmQpO1xuICAgICAgLy9hbmQgd2Ugc2F2ZSB0aGUgY29tbWFuZCBjcmVhdGVkXG4gICAgICBjb21tYW5kcy5wdXNoKGNvbW1hbmQpO1xuICAgIH1cbiAgICAvL1dlIGRpZCBub3QgaW1wbGVtZW50ZWQgdW5kbyByZWRvIGZvciB0aGlzIG1hbmFnZXIsIGJlY2F1c2UgdW5kbyBwbGF5IHBhdXNlIGlzIGtpbmQgb2YgdXNlbGVzcyByaWdodD9cbiAgfVxufTtcblxuXG4vL09uIGxvYWQgb2YgdGhlIHBhZ2VcbndpbmRvdy5hZGRFdmVudExpc3RlbmVyKFwibG9hZFwiLGZ1bmN0aW9uKCkge1xuICAvL1RoZSBzaXplIG9mIHRoZSBjb250cm9sbGVyIGlzIHRoZSBzYW1lIHRoYW4gdGhlIHNpemUgb2YgdGhlIHZpZGVvXG4gIHNldFRpbWVvdXQoZnVuY3Rpb24oKXtcbiAgICAvLyBUaGlzIGhpZGVzIHRoZSBhZGRyZXNzIGJhcjpcbiAgICAvL2NvbnNvbGUubG9nKHZpZGVvdmpzKTtcbiAgICAvL3ZpZGVvdmpzLmxvYWQoKTtcbiAgICB3aW5kb3cuc2Nyb2xsVG8oMCwgMSk7XG4gICAgXG4gICAgdmFyIHVhID0gbmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpO1xuICAgIGlmICh1YS5pbmRleE9mKCdzYWZhcmknKSAhPSAtMSkge1xuICAgICAgaWYgKHVhLmluZGV4T2YoJ2Nocm9tZScpID4gLTEpIHtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vYWxlcnQoXCIyXCIpIC8vIFNhZmFyaVxuICAgICAgICBjb25zb2xlLmxvZyhcInRlc3Qgc2FmYXJpIDogXCIgKyB2aWRlb3Zqcy5zcmMpO1xuICAgICAgICB2aWRlb3Zqcy5sb2FkKCk7XG4gICAgICAgIFxuICAgICAgfVxuICAgIH1cbiAgfSwgMCk7XG59KTtcbndpbmRvdy5hZGRFdmVudExpc3RlbmVyKFwic2Nyb2xsXCIsIGZ1bmN0aW9uKGV2ZW50KSB7XG4gIHRvcFdpbmRvdyA9IHRoaXMuc2Nyb2xsWTtcbiAgbGVmdFdpbmRvdyA9dGhpcy5zY3JvbGxYO1xuICAvLyBjb25zb2xlLmxvZyhcIndpbmRvdyBzY3JvbGwgOiBcIiArIGxlZnRXaW5kb3cpO1xufSwgZmFsc2UpO1xuXG5ib2R5LmFkZEV2ZW50TGlzdGVuZXIoXCJzY3JvbGxcIiwgZnVuY3Rpb24oZXZlbnQpIHtcbiAgdG9wQm9keSA9ICB0aGlzLnNjcm9sbFk7XG4gIGxlZnRCb2R5ID0gdGhpcy5zY3JvbGxYO1xuICAvL2NvbnNvbGUubG9nKFwiIGJvZHkgOiBcIisgIGJvZHkuc2Nyb2xsTGVmdCAgKTtcbn0sIGZhbHNlKTtcblxuXG4vKipcbiAqIENhbGxiYWNrIHVzZWQgKlxuICotLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tXG4gKiBETyBOT1QgVVNFIFRIRVNFIEZVTkNUSU9OUyBXSVRIT1VUIEEgQ09NTUFORCFcbiAqIFRoZSBmb2xsb3dpbmcgY29kZSBzaG91bGQgYmUgY29uc2lkZXJlZCBhcyBwcml2YXRlXG4vKi0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0tLS0gKi9cblxudmFyIG11dGVCdXR0b25DYWxsYmFjayA9IGZ1bmN0aW9uKGUpe1xuICBpZiAodmlkZW92anMubXV0ZWQgPT09IGZhbHNlKSB7XG4gICAgLy8gTXV0ZSB0aGUgdmlkZW9cbiAgICB2aWRlb3Zqcy5tdXRlZCA9IHRydWU7XG4gICAgLy8gVXBkYXRlIHRoZSBidXR0b24gdGV4dFxuICAgIG11dGVCdXR0b24uaW5uZXJIVE1MID0gXCJVbm11dGVcIjtcbiAgfSBlbHNlIHtcbiAgICAvLyBVbm11dGUgdGhlIHZpZGVvXG4gICAgdmlkZW92anMubXV0ZWQgPSBmYWxzZTtcbiAgICAvLyBVcGRhdGUgdGhlIGJ1dHRvbiB0ZXh0XG4gICAgbXV0ZUJ1dHRvbi5pbm5lckhUTUwgPSBcIk11dGVcIjtcbiAgfVxufTtcblxudmFyIHJlcGV0UGFydE9mVmlkZW8gPSBmdW5jdGlvbiAoc3RhcnQsZW5kLCBudW1iZXJPZlJlcGV0aXRpb24sc3BlZWRSYXRlKSB7XG4gIC8vIGNvbnNvbGUubG9nKFwiZnVuY3Rpb24gIC0gcmVwZXRQYXJ0T2ZWaWRlb1wiICwgc3RhcnQsZW5kLCBudW1iZXJPZlJlcGV0aXRpb24sc3BlZWRSYXRlKTtcbiAgaXNQbGF5aW5nQ2FyZCA9IHRydWU7XG4gIHZpZGVvdmpzLnBsYXliYWNrUmF0ZSA9IHNwZWVkUmF0ZTtcbiAgdmlkZW92anMuY3VycmVudFRpbWUgPSBzdGFydDtcbiAgdmFyIHJlcGV0ID0gbnVtYmVyT2ZSZXBldGl0aW9uO1xuICBcbiAgLy9jb25zb2xlLmxvZyhcImZ1bmN0aW9uICAtIHJlcGV0UGFydE9mVmlkZW8gW3BsYXkgcGFydF0gbDg3IHZpZGVvQ29tbWFuZFwiKTtcbiAgcGxheSgpO1xuICB2aWRlb3Zqcy5vbnRpbWV1cGRhdGUgPSBmdW5jdGlvbigpIHtcbiAgICBpZihpc1BsYXlpbmdDYXJkKXtcbiAgICAgIGlmICgoZW5kID4gc3RhcnQgKSAmJiAgcmVwZXQgPiAwICkge1xuICAgICAgICBpZiAodmlkZW92anMuY3VycmVudFRpbWUgPiBlbmQpIHtcbiAgICAgICAgICByZXBldC0tO1xuICAgICAgICAgIHZpZGVvdmpzLmN1cnJlbnRUaW1lID0gc3RhcnQ7XG4gICAgICAgIH1cbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHZpZGVvdmpzLm9udGltZXVwZGF0ZSA9IG51bGw7XG4gICAgICAgIGZlZWRiYWNrT25TbGlkZXJWaWRlbyhmYWxzZSk7XG4gICAgICAgIHZpZGVvdmpzLnBsYXliYWNrUmF0ZSA9IDE7XG4gICAgICB9XG4gICAgfVxuICB9O1xufTtcblxuZnVuY3Rpb24gY2xlYXJBbGxUaW1lcigpIHtcbiAgd2luZG93LmNsZWFySW50ZXJ2YWwodGltZXJSZXBldGl0aW9uKTtcbiAgaXNQbGF5aW5nQ2FyZCA9IGZhbHNlO1xuICB2aWRlb3Zqcy5wbGF5YmFja1JhdGUgPSAxO1xuICBmZWVkYmFja09uU2xpZGVyVmlkZW8oZmFsc2UpO1xufVxuXG5cbnZhciBwbGF5ID0gZnVuY3Rpb24gKCkge1xuICBzZXRUaW1lb3V0KGZ1bmN0aW9uICgpIHtcbiAgICB2YXIgcGxheVByb21pc2UgPSB2aWRlb3Zqcy5wbGF5KCk7XG4gICAgaWYgKHBsYXlQcm9taXNlICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIHBsYXlQcm9taXNlLnRoZW4oZnVuY3Rpb24gKHZhbHVlKSB7XG4gICAgICAgIHZpZGVvLnBsYXkoKTtcbiAgICAgICAgcGxheUJ1dHRvbi5zcmMgPSAnL21lZGlhL3dvcmtzaG9wMi92aWRlb0NvbW1hbmQvcGF1c2VCdXR0b24ucG5nJztcbiAgICAgIH0pLmNhdGNoKGZ1bmN0aW9uIChlKSB7XG4gICAgICAgIHZpZGVvdmpzLmxvYWQoKTtcbiAgICAgICAgLy92aWRlby5wYXVzZSgpO1xuICAgICAgfSlcbiAgICBcbiAgICB9XG4gIH0sMjUwKTtcbn07XG5cbnZhciBwYXVzZSA9IGZ1bmN0aW9uICgpIHtcbiAgLy9jb25zb2xlLmxvZyhcImFwcGVsIGEgcGF1c2VcIik7XG4gIHZpZGVvdmpzLnBhdXNlKCk7XG4gIHBsYXlCdXR0b24uc3JjPScvbWVkaWEvd29ya3Nob3AyL3ZpZGVvQ29tbWFuZC9wbGF5QnV0dG9uLnBuZyc7XG59O1xuXG52YXIgc2Vla1RvID0gZnVuY3Rpb24oc3RhcnREdXJhdGlvblBhcmFtKXtcbiAgaWYoc3RhcnREdXJhdGlvblBhcmFtIDwgdmlkZW92anMuY3VycmVudFRpbWUgKVxuICAgIHZpZGVvdmpzLmN1cnJlbnRUaW1lID0gc3RhcnREdXJhdGlvblBhcmFtO1xufTtcblxudmFyIHBsYXlQYXVzZWNhbGxiYWNrID0gZnVuY3Rpb24oZSl7XG4gIC8vY29uc29sZS5sb2coXCJjYWxsYmFjayBwbGF5LXBhdXNlLCBlIDogXCIgKyBlKTtcbiAgLyppZihlICE9IG51bGwgJiYgZSAhPT0gdW5kZWZpbmVkKXtcbiAgICBlLnByZXZlbnREZWZhdWx0KCk7XG4gIH0qL1xuICBpZiAodmlkZW92anMucGF1c2VkIHx8IHZpZGVvdmpzLmVuZGVkICkge1xuICAgIHZpZGVvRnVuY3Rpb25hbENvcmVNYW5hZ2VyLmV4ZWN1dGUobmV3IFBsYXlDb21tYW5kKCkpO1xuICAgIC8vcGxheSgpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvL3BhdXNlKCk7XG4gICAgdmlkZW9GdW5jdGlvbmFsQ29yZU1hbmFnZXIuZXhlY3V0ZShuZXcgUGF1c2VDb21tYW5kKCkpO1xuICBcbiAgfVxufTtcblxudmFyIG1pcnJvciA9IGZ1bmN0aW9uICgpIHtcbiAgaWYobWlycm9yZWQpe1xuICAgIHZpZGVvdmpzLnN0eWxlLnRyYW5zZm9ybSA9ICBcInJvdGF0ZVkoXCIrIDAgK1wiZGVnKVwiO1xuICAgIG1pcnJvcmVkID0gZmFsc2U7XG4gIH0gZWxzZSB7XG4gICAgdmlkZW92anMuc3R5bGUudHJhbnNmb3JtID0gIFwicm90YXRlWShcIisgMTgwICtcImRlZylcIjtcbiAgICBtaXJyb3JlZCA9IHRydWU7XG4gIH1cbn07XG5cbnZhciBzZXRTb3VyY2UgPSBmdW5jdGlvbihzb3VyY2Upe1xuICB2aWRlb3Zqcy5zcmMgPSBzb3VyY2U7XG59O1xuXG4vL1VwZGF0ZSBrbm9iIG9uIGEgdGFibGV0XG52YXIgdXBkYXRlS25vYkFuZFZpZGVvID0gZnVuY3Rpb24oZXZlbnQpIHtcbiAgLy8gIHZhciBvZmZzZXRMZWZ0U2xpZGVyID0gd3JhcHBlckNvbW1hbmRBbmRSYW5nZWlkLm9mZnNldExlZnQrcmFuZ2VTbGlkZXJUcmFjay5vZmZzZXRMZWZ0ICsgZGl2aWRDb21tYW5kZVZpZGVvLm9mZnNldExlZnQ7XG4gIHZhciBvZmZzZXRMZWZ0U2xpZGVyID0gd3JhcHBlckNvbW1hbmRBbmRSYW5nZWlkLm9mZnNldExlZnQ7IC8vLSAgIDtcbiAgLy9jb25zb2xlLmxvZyhcImFhIDogIFwiICsgIGJvZHkgKTtcbiAgXG4gIHZpZGVvdmpzLmN1cnJlbnRUaW1lID0gTWF0aC5yb3VuZCgoKChldmVudC50YXJnZXRUb3VjaGVzWzBdID8gZXZlbnQudGFyZ2V0VG91Y2hlc1swXS5wYWdlWCA6IGV2ZW50LmNoYW5nZWRUb3VjaGVzW2V2ZW50LmNoYW5nZWRUb3VjaGVzLmxlbmd0aCAtIDFdLnBhZ2VYKSAtIChvZmZzZXRMZWZ0U2xpZGVyKSkgKiB2aWRlb3Zqcy5kdXJhdGlvbikgLyBOVU1CRVJfT0ZfVElDSyk7XG4gIC8vVXBkYXRlIGtub3cgcG9zaXRpb25cbiAga25vYk1pbi5zdHlsZS5sZWZ0ID0gKCgoKGV2ZW50LnRhcmdldFRvdWNoZXNbMF0gPyBldmVudC50YXJnZXRUb3VjaGVzWzBdLnBhZ2VYIDogZXZlbnQuY2hhbmdlZFRvdWNoZXNbZXZlbnQuY2hhbmdlZFRvdWNoZXMubGVuZ3RoIC0gMV0ucGFnZVgpKSAtIG9mZnNldExlZnRTbGlkZXIpKSArIFwicHhcIjtcbiAgaWYgKHNlZ21lbnRGZWVkYmFjay5kaXNwbGF5ZWQpIHtcbiAgICBpZiAodmlkZW92anMuY3VycmVudFRpbWUgPiBzZWdtZW50RmVlZGJhY2suZW5kRHVyYXRpb25WaWRlbykge1xuICAgICAgZmVlZGJhY2tPblNsaWRlclZpZGVvKGZhbHNlKTtcbiAgICB9XG4gIH1cbn07XG5cblxuXG4vL1VwZGF0ZSBrbm9iIG9uIGEgbGFwdG9wXG52YXIgdXBkYXRlS25vYkFuZFZpZGVvQ29tcHV0ZXIgPSBmdW5jdGlvbihlKSB7XG4gIC8vdGFrZSBpbnRvIGFjY291bnQgb2Zmc2V0IG9uIHRoZSBsZWZ0IG9mIHRoZSBzY3JvbGwgYmFyIChib2R5IHNjcm9sbCBhbmQgY2VudGVyaW5nIHRoZSB3cmFwcGVyKVxuICBcbiAvLyB2YXIgcG9zID0gKGUucGFnZVggIC0gdGhpcy5vZmZzZXRMZWZ0KSAvIHRoaXMub2Zmc2V0V2lkdGg7XG4gIC8vICAgIHZpZGVvLmN1cnJlbnRUaW1lID0gcG9zICogdmlkZW8uZHVyYXRpb247XG4gIHZhciBvZmZzZXRMZWZ0U2xpZGVyID0gd3JhcHBlckNvbW1hbmRBbmRSYW5nZWlkLm9mZnNldExlZnQgLSBib2R5LnNjcm9sbExlZnQ7IC8vLSB3aW5kb3cuc2Nyb2xsTGVmdCAgO1xuICBjdXJyZW50VmFsdWVLbm9iID0gKChlLnBhZ2VYIC0gb2Zmc2V0TGVmdFNsaWRlcikgKiB2aWRlb3Zqcy5kdXJhdGlvbikgLyBOVU1CRVJfT0ZfVElDSztcbiAgaWYgKGN1cnJlbnRWYWx1ZUtub2IgPCB2aWRlb3Zqcy5kdXJhdGlvbiAmJiBjdXJyZW50VmFsdWVLbm9iID49IDApIHtcbiAgICB2aWRlb3Zqcy5jdXJyZW50VGltZSA9ICgoZS5wYWdlWCAtIG9mZnNldExlZnRTbGlkZXIpICogdmlkZW92anMuZHVyYXRpb24pIC8gTlVNQkVSX09GX1RJQ0s7XG4gICAga25vYk1pbi5zdHlsZS5sZWZ0ID0gZS5wYWdlWCAtIChvZmZzZXRMZWZ0U2xpZGVyICsgV0lEVEhfTUlEX0tOT0JfTUlOIC8gMikgKyBcInB4XCI7XG4gICAgaWYgKHNlZ21lbnRGZWVkYmFjay5kaXNwbGF5ZWQpIHtcbiAgICAgIGlmICh2aWRlb3Zqcy5jdXJyZW50VGltZSA+IHNlZ21lbnRGZWVkYmFjay5lbmREdXJhdGlvblZpZGVvKSB7XG4gICAgICAgIGZlZWRiYWNrT25TbGlkZXJWaWRlbyhmYWxzZSk7XG4gICAgICB9XG4gICAgfVxuICB9XG59O1xuXG5cblxuZnVuY3Rpb24gZmVlZGJhY2tPblNsaWRlclZpZGVvKG9uT2ZmKSB7XG4gIHNlZ21lbnRGZWVkYmFjay5lbmRQb3NpdGlvbiA9IHBhcnNlSW50KHNlZ21lbnRGZWVkYmFjay5zdGFydFBvc3Rpb24pICsgcGFyc2VJbnQoc2VnbWVudEZlZWRiYWNrLndpZHRoKTtcbiAgdmFyIHNsaWRlclRvViA9IHNsaWRlclRvVmlkZW8oc2VnbWVudEZlZWRiYWNrLnN0YXJ0UG9zdGlvbiwgc2VnbWVudEZlZWRiYWNrLmVuZFBvc2l0aW9uKTtcbiAgc2VnbWVudEZlZWRiYWNrLnN0YXJ0RHVyYXRpb25WaWRlbyA9IHNsaWRlclRvVi5zdGFydER1cmF0aW9uO1xuICBzZWdtZW50RmVlZGJhY2suZW5kRHVyYXRpb25WaWRlbyA9IHNsaWRlclRvVi5lbmREdXJhdGlvbjtcbiAgc2VnbWVudEZlZWRiYWNrLmRpc3BsYXllZCA9IG9uT2ZmO1xuICBpZiAob25PZmYpIHtcbiAgICAvL3NlZ21lbnRGZWVkYmFjay5kaXZHcmFwaGljYWxPYmplY3Quc3R5bGUubWFyZ2luTGVmdCA9IHNlZ21lbnRGZWVkYmFjay5zdGFydFBvc3Rpb247XG4gICAgLy9taW51cyAyIGJlY2F1c2Ugd2UgbmVlZCB0byBnZXQgMiBmcmFtZSBiZWZvcmUgdGhlIHNlZ21lbnRcbiAgICBzZWdtZW50RmVlZGJhY2suZGl2R3JhcGhpY2FsT2JqZWN0LnN0eWxlLm1hcmdpbkxlZnQgPSBwYXJzZUludChzZWdtZW50RmVlZGJhY2suc3RhcnRQb3N0aW9uKSAgKyBcInB4XCI7IC8vICBzZWdtZW50RmVlZGJhY2suc3RhcnRQb3N0aW9uO1xuICAgIHNlZ21lbnRGZWVkYmFjay5kaXZHcmFwaGljYWxPYmplY3Quc3R5bGUudmlzaWJpbGl0eSA9IFwidmlzaWJsZVwiO1xuICAgIHNlZ21lbnRGZWVkYmFjay5kaXZHcmFwaGljYWxPYmplY3Quc3R5bGUud2lkdGggPSBzZWdtZW50RmVlZGJhY2sud2lkdGg7XG4gIH0gZWxzZSB7XG4gICAgc2VnbWVudEZlZWRiYWNrLmRpdkdyYXBoaWNhbE9iamVjdC5zdHlsZS52aXNpYmlsaXR5ID0gXCJoaWRkZW5cIjtcbiAgfVxufVxuXG4vKlxuXG5mdW5jdGlvbiBmZWVkYmFja09uU2xpZGVyVmlkZW8ob25PZmYpIHtcbiAgc2VnbWVudEZlZWRiYWNrLmVuZFBvc2l0aW9uID0gcGFyc2VJbnQoc2VnbWVudEZlZWRiYWNrLnN0YXJ0UG9zdGlvbikgKyBwYXJzZUludChzZWdtZW50RmVlZGJhY2sud2lkdGgpIDtcbiAgdmFyIHNsaWRlclRvViA9IHNsaWRlclRvVmlkZW8oc2VnbWVudEZlZWRiYWNrLnN0YXJ0UG9zdGlvbiwgc2VnbWVudEZlZWRiYWNrLmVuZFBvc2l0aW9uKTtcbiAgc2VnbWVudEZlZWRiYWNrLnN0YXJ0RHVyYXRpb25WaWRlbyA9IHNsaWRlclRvVi5zdGFydER1cmF0aW9uO1xuICBzZWdtZW50RmVlZGJhY2suZW5kRHVyYXRpb25WaWRlbyA9IHNsaWRlclRvVi5lbmREdXJhdGlvbjtcbiAgc2VnbWVudEZlZWRiYWNrLmRpc3BsYXllZCA9IG9uT2ZmO1xuICBpZiAob25PZmYpIHtcbiAgICAvL3NlZ21lbnRGZWVkYmFjay5kaXZHcmFwaGljYWxPYmplY3Quc3R5bGUubWFyZ2luTGVmdCA9IHNlZ21lbnRGZWVkYmFjay5zdGFydFBvc3Rpb247XG4gICAgLy9taW51cyAyIGJlY2F1c2Ugd2UgbmVlZCB0byBnZXQgMiBmcmFtZSBiZWZvcmUgdGhlIHNlZ21lbnRcbiAgICBzZWdtZW50RmVlZGJhY2suZGl2R3JhcGhpY2FsT2JqZWN0LnN0eWxlLm1hcmdpbkxlZnQgPSBwYXJzZUludChzZWdtZW50RmVlZGJhY2suc3RhcnRQb3N0aW9uKSAtIDEwMCArIFwicHhcIjsgLy8gIHNlZ21lbnRGZWVkYmFjay5zdGFydFBvc3Rpb247XG4gICAgc2VnbWVudEZlZWRiYWNrLmRpdkdyYXBoaWNhbE9iamVjdC5zdHlsZS52aXNpYmlsaXR5ID0gXCJ2aXNpYmxlXCI7XG4gICAgc2VnbWVudEZlZWRiYWNrLmRpdkdyYXBoaWNhbE9iamVjdC5zdHlsZS53aWR0aCA9IHNlZ21lbnRGZWVkYmFjay53aWR0aCA7XG4gIH0gZWxzZSB7XG4gICAgc2VnbWVudEZlZWRiYWNrLmRpdkdyYXBoaWNhbE9iamVjdC5zdHlsZS52aXNpYmlsaXR5ID0gXCJoaWRkZW5cIjtcbiAgfVxufVxuKi9cblxuXG5mdW5jdGlvbiB1cGRhdGVUaW1lclZpZGVvKCkge1xuICBcbiAgbGV0IG1pbnV0ZXMgPSBNYXRoLmZsb29yKHZpZGVvdmpzLmN1cnJlbnRUaW1lIC8gNjApO1xuICBsZXQgc2Vjb25kcyA9IE1hdGguZmxvb3IodmlkZW92anMuY3VycmVudFRpbWUgLSBtaW51dGVzICogNjApO1xuICBcbiAgXG4gIGxldCBtaW51dGVzViA9IE1hdGguZmxvb3IodmlkZW92anMuZHVyYXRpb24gLyA2MCk7XG4gIGxldCBzZWNvbmRzViA9IE1hdGguZmxvb3IodmlkZW92anMuZHVyYXRpb24gLSBtaW51dGVzICogNjApO1xuICBpZihpc05hTihtaW51dGVzVikgfHwgaXNOYU4oc2Vjb25kc1YpKXtcbiAgICBtaW51dGVzViA9IDA7XG4gICAgc2Vjb25kc1YgPSAwO1xuICB9XG4gIGlmIChzZWNvbmRzIDwgMTApXG4gICAgc2Vjb25kcyA9IFwiMFwiICsgc2Vjb25kcztcbiAgdGltZXJWaWRlby5pbm5lckhUTUwgPSBtaW51dGVzICsgXCI6XCIgKyBzZWNvbmRzICsgXCIvXCIgKyBtaW51dGVzVitcIjpcIiArICBzZWNvbmRzViA7XG59XG5cbi8vc3RhcnQgcG9zaXRpb24gb24gdGhlIHNsaWRlciBhbmQgZW5kIHBvc2l0aW9uIG9uIHRoZSBzbGlkZXJcbmZ1bmN0aW9uIHNsaWRlclRvVmlkZW8oc3RhcnRQLCBlbmRQKSB7XG4gIGlmKHN0YXJ0UCA8IDAgKXtcbiAgICBzdGFydFAgPSAwO1xuICB9XG4gIHZhciBzdGFydER1cmF0aW9uID0gTWF0aC5yb3VuZCgoKHN0YXJ0UCAqIHZpZGVvdmpzLmR1cmF0aW9uKSAvIE5VTUJFUl9PRl9USUNLKSk7XG4gIHZhciBlbmREdXJhdGlvbiA9IE1hdGgucm91bmQoKChlbmRQICogdmlkZW92anMuZHVyYXRpb24pIC8gTlVNQkVSX09GX1RJQ0spKTtcbiAgXG4gIHJldHVybiB7XG4gICAgc3RhcnREdXJhdGlvbjogc3RhcnREdXJhdGlvbixcbiAgICBlbmREdXJhdGlvbjogZW5kRHVyYXRpb25cbiAgfTtcbn1cblxuIl19